<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏Å‡∏£‡∏±‡∏ö‡∏™‡πÄ‡∏õ‡∏ô‡∏à‡∏≥‡∏•‡∏≠‡∏á (Virtual Castanets)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');

        body {
            margin: 0;
            padding: 0;
            background-color: #fceeb5;
            background-image: radial-gradient(#ffeebb 20%, #eebd73 80%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-family: 'Sarabun', sans-serif;
            overflow: hidden;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        h1 {
            color: #5d4037;
            margin-bottom: 5px;
            font-size: 1.5rem;
            text-shadow: 1px 1px 0px rgba(255,255,255,0.5);
            text-align: center;
        }

        .instruction {
            color: #795548;
            font-size: 0.9rem;
            margin-bottom: 15px;
            opacity: 0.8;
            text-align: center;
        }

        .container {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
            width: 100%;
            max-width: 600px;
            margin-bottom: 20px;
        }

        /* ‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏±‡∏ö (Castanet) */
        .castanet {
            width: 38vw;
            height: 43vw;
            max-width: 180px;
            max-height: 220px;
            background: radial-gradient(circle at 30% 30%, #8d6e63, #3e2723);
            border-radius: 50% 50% 45% 45% / 60% 60% 40% 40%;
            position: relative;
            box-shadow: 
                0 10px 20px rgba(0,0,0,0.4),
                inset 0 0 20px rgba(0,0,0,0.8);
            cursor: pointer;
            transition: transform 0.05s ease-out;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            border: 4px solid #3e2723;
        }

        .castanet::after {
            content: '';
            position: absolute;
            top: 25%;
            width: 70%;
            height: 60%;
            background: radial-gradient(circle at 40% 40%, rgba(255,255,255,0.1), transparent 60%);
            border-radius: 50%;
            pointer-events: none;
        }

        .ear {
            width: 40px;
            height: 30px;
            background: #3e2723;
            border-radius: 10px 10px 0 0;
            position: absolute;
            top: -20px;
            z-index: -1;
        }

        .string {
            position: absolute;
            top: -50px;
            width: 60px;
            height: 60px;
            border: 6px solid #d32f2f;
            border-radius: 50%;
            z-index: -2;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .knot {
            position: absolute;
            top: -25px;
            width: 20px;
            height: 20px;
            background: #b71c1c;
            border-radius: 50%;
            z-index: -1;
        }

        .castanet.active {
            transform: scale(0.92) translateY(5px);
            box-shadow: 
                0 2px 5px rgba(0,0,0,0.4),
                inset 0 0 30px rgba(0,0,0,0.9);
        }

        .label {
            position: absolute;
            bottom: 20px;
            color: rgba(255,255,255,0.3);
            font-weight: bold;
            font-size: 1.2rem;
            pointer-events: none;
        }

        /* ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á */
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            margin-top: 10px;
        }

        .record-btn {
            background-color: white;
            color: #d32f2f;
            border: 2px solid #d32f2f;
            padding: 10px 24px;
            border-radius: 30px;
            font-size: 1rem;
            font-family: 'Sarabun', sans-serif;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .record-btn:hover {
            background-color: #ffebee;
        }

        /* ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å */
        .record-btn.recording {
            background-color: #d32f2f;
            color: white;
            animation: pulse-red 1.5s infinite;
            border-color: #b71c1c;
        }

        .dot {
            width: 12px;
            height: 12px;
            background-color: #d32f2f;
            border-radius: 50%;
            transition: background-color 0.3s;
        }

        .record-btn.recording .dot {
            background-color: white;
            animation: blink 1s infinite;
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(211, 47, 47, 0); }
            100% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0); }
        }

        @keyframes blink {
            50% { opacity: 0; }
        }

        #status-msg {
            margin-top: 10px;
            height: 20px;
            font-size: 0.9rem;
            color: #d32f2f;
            font-weight: bold;
        }

        /* Overlay */
        #start-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            flex-direction: column;
            color: white;
            text-align: center;
        }

        #start-btn {
            padding: 15px 30px;
            font-size: 1.5rem;
            background: #d32f2f;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Sarabun', sans-serif;
            margin-top: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Responsive */
        @media (max-width: 400px) {
            .castanet { width: 42vw; height: 48vw; }
            h1 { font-size: 1.2rem; }
            .record-btn { padding: 8px 16px; font-size: 0.9rem; }
        }
    </style>
</head>
<body>

    <div id="start-overlay">
        <h2>üéµ ‡∏Å‡∏£‡∏±‡∏ö‡∏™‡πÄ‡∏õ‡∏ô‡∏à‡∏≥‡∏•‡∏≠‡∏á</h2>
        <p>‡πÅ‡∏ï‡∏∞‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
        <button id="start-btn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô (Start)</button>
    </div>

    <h1>Castanets Simulator</h1>
    <p class="instruction">‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏±‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° A / L</p>

    <div class="container">
        <div class="castanet" id="left-castanet" data-pitch="low">
            <div class="ear"></div>
            <div class="knot"></div>
            <div class="string"></div>
            <span class="label">L</span>
        </div>

        <div class="castanet" id="right-castanet" data-pitch="high">
            <div class="ear"></div>
            <div class="knot"></div>
            <div class="string"></div>
            <span class="label">R</span>
        </div>
    </div>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -->
    <div class="controls">
        <button id="record-btn" class="record-btn">
            <span class="dot"></span>
            <span id="record-text">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á</span>
        </button>
    </div>
    <div id="status-msg"></div>

    <script>
        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á (Web Audio & Recorder) ---
        let audioCtx;
        let destNode; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà Recorder
        let mediaRecorder;
        let recordedChunks = [];
        let isRecording = false;
        
        function initAudio() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á Destination Node ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á (Stream)
                destNode = audioCtx.createMediaStreamDestination();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function playCastanetSound(type) {
            if (!audioCtx) initAudio();

            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            const filter = audioCtx.createBiquadFilter();

            filter.type = "bandpass";
            filter.Q.value = 5;

            if (type === 'high') {
                osc.frequency.setValueAtTime(1400, t);
                filter.frequency.setValueAtTime(1400, t);
            } else {
                osc.frequency.setValueAtTime(1100, t);
                filter.frequency.setValueAtTime(1100, t);
            }
            
            osc.type = 'triangle';

            osc.connect(filter);
            filter.connect(gainNode);
            
            // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏≠‡∏Å‡∏•‡∏≥‡πÇ‡∏û‡∏á
            gainNode.connect(audioCtx.destination);
            
            // *‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç* ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πâ‡∏ß‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            if (destNode) {
                gainNode.connect(destNode);
            }

            gainNode.gain.setValueAtTime(0, t);
            gainNode.gain.linearRampToValueAtTime(1, t + 0.005);
            gainNode.gain.exponentialRampToValueAtTime(0.01, t + 0.1);

            osc.start(t);
            osc.stop(t + 0.15);
        }

        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Recorder Logic) ---
        const recordBtn = document.getElementById('record-btn');
        const recordText = document.getElementById('record-text');
        const statusMsg = document.getElementById('status-msg');

        recordBtn.addEventListener('click', toggleRecording);

        function toggleRecording() {
            if (!audioCtx) initAudio();

            if (!isRecording) {
                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                startRecording();
            } else {
                // ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                stopRecording();
            }
        }

        function startRecording() {
            recordedChunks = [];
            // ‡πÉ‡∏ä‡πâ Stream ‡∏à‡∏≤‡∏Å Web Audio API
            const stream = destNode.stream;
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Browser Support
            const options = { mimeType: 'audio/webm' };
            try {
                mediaRecorder = new MediaRecorder(stream, options);
            } catch (e) {
                // Fallback ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Safari ‡∏ö‡∏≤‡∏á‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô
                mediaRecorder = new MediaRecorder(stream);
            }

            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) {
                    recordedChunks.push(e.data);
                }
            };

            mediaRecorder.onstop = saveRecording;
            mediaRecorder.start();

            isRecording = true;
            recordBtn.classList.add('recording');
            recordText.textContent = "‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å";
            statusMsg.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å... ‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!";
        }

        function stopRecording() {
            mediaRecorder.stop();
            isRecording = false;
            recordBtn.classList.remove('recording');
            recordText.textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á";
            statusMsg.textContent = "";
        }

        function saveRecording() {
            const blob = new Blob(recordedChunks, { type: 'audio/webm' });
            const url = URL.createObjectURL(blob);
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤
            const date = new Date();
            const timestamp = `${date.getHours()}-${date.getMinutes()}-${date.getSeconds()}`;
            a.download = `castanets-recording-${timestamp}.webm`;
            
            document.body.appendChild(a);
            a.click();
            
            // Clean up
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                statusMsg.textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!";
                setTimeout(() => { statusMsg.textContent = ""; }, 3000);
            }, 100);
        }

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Interaction (UI & Touch) ---
        
        const leftCastanet = document.getElementById('left-castanet');
        const rightCastanet = document.getElementById('right-castanet');
        const startOverlay = document.getElementById('start-overlay');
        const startBtn = document.getElementById('start-btn');

        startBtn.addEventListener('click', () => {
            initAudio();
            startOverlay.style.opacity = '0';
            setTimeout(() => {
                startOverlay.style.display = 'none';
            }, 500);
        });

        function triggerCastanet(element) {
            const pitch = element.getAttribute('data-pitch');
            playCastanetSound(pitch);

            element.classList.remove('active');
            void element.offsetWidth;
            element.classList.add('active');
            
            setTimeout(() => {
                element.classList.remove('active');
            }, 100);
        }

        function handleTouch(e) {
            e.preventDefault();
            for (let i = 0; i < e.changedTouches.length; i++) {
                const touch = e.changedTouches[i];
                const target = document.elementFromPoint(touch.clientX, touch.clientY);
                
                if (leftCastanet.contains(target)) {
                    triggerCastanet(leftCastanet);
                } else if (rightCastanet.contains(target)) {
                    triggerCastanet(rightCastanet);
                }
            }
        }

        document.addEventListener('touchstart', handleTouch, { passive: false });

        leftCastanet.addEventListener('mousedown', (e) => {
            if(e.button === 0) triggerCastanet(leftCastanet);
        });
        rightCastanet.addEventListener('mousedown', (e) => {
            if(e.button === 0) triggerCastanet(rightCastanet);
        });

        document.addEventListener('keydown', (e) => {
            if (e.repeat) return;
            if (e.key === 'a' || e.key === 'A' || e.key === 'ArrowLeft') {
                triggerCastanet(leftCastanet);
            }
            if (e.key === 'l' || e.key === 'L' || e.key === 'ArrowRight') {
                triggerCastanet(rightCastanet);
            }
        });

    </script>
</body>
</html>