<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Realistic Virtual Harp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');

        body {
            font-family: 'Sarabun', sans-serif;
            background: radial-gradient(circle at center, #2c1a0e, #0f0803);
            overflow: hidden;
            touch-action: none; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        }

        #canvas-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.02);
            cursor: pointer;
        }

        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #d4af37;
            z-index: 10;
            transition: opacity 0.5s;
        }

        .hidden {
            opacity: 0;
            pointer-events: none;
        }

        .instruction {
            margin-top: 10px;
            font-size: 1rem;
            color: #aaa;
            text-align: center;
        }

        /* ‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡∏õ‡∏∏‡πà‡∏° */
        .btn-start {
            padding: 15px 40px;
            font-size: 1.5rem;
            border: 2px solid #d4af37;
            background: transparent;
            color: #d4af37;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .btn-start:hover {
            background: #d4af37;
            color: #000;
            box-shadow: 0 0 20px #d4af37;
        }

        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 5;
        }

        .control-btn {
            background: rgba(255,255,255,0.1);
            color: #d4af37;
            border: 1px solid #d4af37;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .control-btn:hover {
            background: rgba(212, 175, 55, 0.2);
        }
    </style>
</head>
<body>

    <div id="canvas-container">
        <canvas id="harpCanvas"></canvas>
        
        <!-- UI ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô -->
        <div id="overlay">
            <h1 class="text-4xl md:text-6xl font-bold mb-4 text-[#d4af37] drop-shadow-lg">Virtual Harp</h1>
            <p class="text-xl text-gray-300 mb-8">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏Æ‡∏≤‡∏£‡πå‡∏õ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏°‡∏à‡∏£‡∏¥‡∏á</p>
            <button id="startBtn" class="btn-start">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button>
            <p class="instruction mt-4">‡∏•‡∏≤‡∏Å‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡∏¥‡πâ‡∏ß‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</p>
        </div>

        <div id="controls">
            <button class="control-btn" id="toggleLabels">‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á ‡πÇ‡∏ô‡πâ‡∏ï</button>
            <button class="control-btn" id="recordBtn">üî¥ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
        </div>
    </div>

<script>
    /**
     * Virtual Harp - High Performance Audio & Physics
     */

    // --- Audio Context & Synthesis ---
    let audioCtx;
    let masterGain;
    let convolver; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Reverb
    let compressor; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡πÇ‡∏ô‡πâ‡∏ï
    let dest; // Destination ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;

    function initAudio() {
        if (!audioCtx) {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
            
            // Master Gain
            masterGain = audioCtx.createGain();
            masterGain.gain.value = 0.8;

            // Reverb Effect (Convolver)
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Impulse Response ‡πÅ‡∏ö‡∏ö‡∏™‡∏±‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Å‡∏±‡∏á‡∏ß‡∏≤‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÇ‡∏ñ‡∏á
            convolver = audioCtx.createConvolver();
            convolver.buffer = createImpulseResponse(2.0, 2.0); // 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ reverb

            // Compressor: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏ï‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡πÇ‡∏ô‡πâ‡∏ï‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô (Dynamics Stability)
            compressor = audioCtx.createDynamicsCompressor();
            compressor.threshold.setValueAtTime(-20, audioCtx.currentTime);
            compressor.knee.setValueAtTime(30, audioCtx.currentTime);
            compressor.ratio.setValueAtTime(12, audioCtx.currentTime);
            compressor.attack.setValueAtTime(0.003, audioCtx.currentTime);
            compressor.release.setValueAtTime(0.25, audioCtx.currentTime);

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Destination ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Recorder
            dest = audioCtx.createMediaStreamDestination();
            
            // Connect chain:
            // 1. Dry Signal: Master -> Compressor
            masterGain.connect(compressor);
            
            // 2. Wet Signal: Master -> Convolver -> Compressor
            masterGain.connect(convolver);
            convolver.connect(compressor);

            // Final Output:
            // 1. ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏•‡∏≥‡πÇ‡∏û‡∏á (Speakers)
            compressor.connect(audioCtx.destination);
            // 2. ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ï‡∏±‡∏ß‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á (Recorder)
            compressor.connect(dest);
        }
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Impulse Response ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Reverb
    function createImpulseResponse(duration, decay) {
        const rate = audioCtx.sampleRate;
        const length = rate * duration;
        const impulse = audioCtx.createBuffer(2, length, rate);
        const left = impulse.getChannelData(0);
        const right = impulse.getChannelData(1);

        for (let i = 0; i < length; i++) {
            const n = i / length; // normalized
            // noise * decay
            left[i] = (Math.random() * 2 - 1) * Math.pow(1 - n, decay);
            right[i] = (Math.random() * 2 - 1) * Math.pow(1 - n, decay);
        }
        return impulse;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÇ‡∏ô‡πâ‡∏ï (Karplus-Strong-ish approach using Oscillators + Filters)
    function playNote(freq) {
        if (!audioCtx) return;
        if (audioCtx.state === 'suspended') audioCtx.resume(); // Ensure active

        const now = audioCtx.currentTime;

        // 1. Oscillator (‡∏ï‡πâ‡∏ô‡∏Å‡∏≥‡πÄ‡∏ô‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á)
        const osc = audioCtx.createOscillator();
        // Triangle wave ‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≤‡∏¢‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ Sine
        osc.type = 'triangle'; 
        osc.frequency.setValueAtTime(freq, now);

        // 2. Filter (‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏µ‡∏î)
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏î‡∏µ‡∏î ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏à‡∏∞‡∏™‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÜ ‡∏ó‡∏∂‡∏ö‡∏•‡∏á
        const filter = audioCtx.createBiquadFilter();
        filter.type = 'lowpass';
        filter.Q.value = 1;
        filter.frequency.setValueAtTime(3000, now);
        filter.frequency.exponentialRampToValueAtTime(freq, now + 1.5); // Filter ‡∏õ‡∏¥‡∏î‡∏•‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤

        // 3. Amplitude Envelope (‡∏Å‡∏≤‡∏£‡∏î‡∏±‡∏á-‡πÄ‡∏ö‡∏≤)
        const gainNode = audioCtx.createGain();
        gainNode.gain.setValueAtTime(0, now);
        gainNode.gain.linearRampToValueAtTime(0.6, now + 0.02); // Attack ‡πÄ‡∏£‡πá‡∏ß‡πÜ (‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡∏µ‡∏î)
        gainNode.gain.exponentialRampToValueAtTime(0.001, now + 3.0); // Decay ‡∏¢‡∏≤‡∏ß‡πÜ (‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Å‡∏±‡∏á‡∏ß‡∏≤‡∏ô)

        // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: Osc -> Filter -> Gain -> Master
        osc.connect(filter);
        filter.connect(gainNode);
        gainNode.connect(masterGain);

        osc.start(now);
        osc.stop(now + 3.1);

        // Cleanup
        setTimeout(() => {
            osc.disconnect();
            filter.disconnect();
            gainNode.disconnect();
        }, 3200);
    }


    // --- Canvas & Physics ---
    const canvas = document.getElementById('harpCanvas');
    const ctx = canvas.getContext('2d');
    let width, height;
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ü‡∏¥‡∏™‡∏¥‡∏Å‡∏™‡πå
    const strings = [];
    const particles = [];
    let showLabels = true;

    // Scale ‡∏Ç‡∏≠‡∏á Harp (C Major Scale 2 Octaves)
    // C4, D4, E4, ...
    const notes = [
        { note: 'C4', freq: 261.63, color: '#ff4d4d' }, // ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏Æ‡∏≤‡∏£‡πå‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏ô‡πâ‡∏ï C
        { note: 'D4', freq: 293.66, color: '#d4af37' },
        { note: 'E4', freq: 329.63, color: '#d4af37' },
        { note: 'F4', freq: 349.23, color: '#4d4dff' }, // ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô/‡∏î‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏ô‡πâ‡∏ï F
        { note: 'G4', freq: 392.00, color: '#d4af37' },
        { note: 'A4', freq: 440.00, color: '#d4af37' },
        { note: 'B4', freq: 493.88, color: '#d4af37' },
        { note: 'C5', freq: 523.25, color: '#ff4d4d' },
        { note: 'D5', freq: 587.33, color: '#d4af37' },
        { note: 'E5', freq: 659.25, color: '#d4af37' },
        { note: 'F5', freq: 698.46, color: '#4d4dff' },
        { note: 'G5', freq: 783.99, color: '#d4af37' },
        { note: 'A5', freq: 880.00, color: '#d4af37' },
        { note: 'B5', freq: 987.77, color: '#d4af37' },
        { note: 'C6', freq: 1046.50, color: '#ff4d4d' }
    ];

    class HarpString {
        constructor(x, yStart, yEnd, noteData) {
            this.x = x;
            this.yStart = yStart;
            this.yEnd = yEnd;
            this.baseX = x;
            this.noteData = noteData;
            
            // Physics
            this.amplitude = 0; // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏ô
            this.velocity = 0;
            this.frequency = 0.3; // ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏°‡∏≤ (visual only)
            this.damping = 0.92; // ‡πÅ‡∏£‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏î‡∏ó‡∏≤‡∏ô
            
            this.playing = false;
            this.cooldown = 0; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏µ‡∏î‡∏ã‡πâ‡∏≥‡∏£‡∏±‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
        }

        pluck(force = 15) {
            if (this.cooldown > 0) return;
            
            // ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á
            playNote(this.noteData.freq);
            
            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡πà‡∏ô
            this.velocity = force;
            this.playing = true;
            this.cooldown = 10; // frames

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Particle effect
            createParticles(this.x, (this.yStart + this.yEnd) / 2, this.noteData.color);
        }

        update() {
            // Physics simulation (Spring motion)
            // ‡πÅ‡∏£‡∏á‡∏î‡∏∂‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏≤‡∏à‡∏∏‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á
            const tension = (this.baseX - this.x) * 0.2;
            this.velocity += tension;
            this.velocity *= this.damping;
            this.x += this.velocity;

            // Cooldown ‡∏•‡∏î‡∏•‡∏á
            if (this.cooldown > 0) this.cooldown--;

            // ‡∏´‡∏¢‡∏∏‡∏î‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ñ‡πâ‡∏≤‡∏™‡∏±‡πà‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏°‡∏≤‡∏Å‡πÜ
            if (Math.abs(this.x - this.baseX) < 0.1 && Math.abs(this.velocity) < 0.1) {
                this.x = this.baseX;
                this.velocity = 0;
                this.playing = false;
            }
        }

        draw(ctx, time) {
            ctx.beginPath();
            
            // ‡∏™‡∏µ‡∏™‡∏≤‡∏¢
            ctx.strokeStyle = this.noteData.color;
            ctx.lineWidth = 2 + (Math.abs(this.x - this.baseX) / 2); // ‡∏™‡∏≤‡∏¢‡∏´‡∏ô‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡πà‡∏ô‡πÅ‡∏£‡∏á
            
            // ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏á Bezier ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡πà‡∏ô
            ctx.moveTo(this.baseX, this.yStart);
            
            // ‡∏à‡∏∏‡∏î‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏Ç‡∏¢‡∏±‡∏ö‡∏ï‡∏≤‡∏° physics
            const midY = (this.yStart + this.yEnd) / 2;
            ctx.quadraticCurveTo(this.x, midY, this.baseX, this.yEnd);
            
            // Glow effect
            if (this.playing) {
                ctx.shadowBlur = 15;
                ctx.shadowColor = this.noteData.color;
            } else {
                ctx.shadowBlur = 0;
            }

            ctx.stroke();
            ctx.shadowBlur = 0; // Reset

            // ‡∏ß‡∏≤‡∏î‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ô‡πâ‡∏ï
            if (showLabels) {
                ctx.fillStyle = '#fff';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(this.noteData.note, this.baseX, this.yEnd + 20);
            }
        }
    }

    class Particle {
        constructor(x, y, color) {
            this.x = x;
            this.y = y;
            this.color = color;
            this.size = Math.random() * 3 + 1;
            this.speedX = (Math.random() - 0.5) * 4;
            this.speedY = (Math.random() - 0.5) * 4;
            this.life = 1.0; // Opacity
        }
        update() {
            this.x += this.speedX;
            this.y += this.speedY;
            this.life -= 0.03;
        }
        draw(ctx) {
            ctx.globalAlpha = this.life;
            ctx.fillStyle = this.color;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fill();
            ctx.globalAlpha = 1.0;
        }
    }

    function createParticles(x, y, color) {
        for(let i=0; i<8; i++) {
            particles.push(new Particle(x, y, color));
        }
    }

    // --- Initialization & Loop ---

    function resize() {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;
        initStrings();
    }

    function initStrings() {
        strings.length = 0;
        const totalStrings = notes.length;
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á
        const marginX = width * 0.1;
        const spacing = (width - (marginX * 2)) / (totalStrings - 1);
        
        // ‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á‡∏Æ‡∏≤‡∏£‡πå‡∏õ (‡∏™‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô‡πÑ‡∏õ‡∏¢‡∏≤‡∏ß ‡∏´‡∏£‡∏∑‡∏≠ ‡∏¢‡∏≤‡∏ß‡πÑ‡∏õ‡∏™‡∏±‡πâ‡∏ô)
        // ‡∏Æ‡∏≤‡∏£‡πå‡∏õ‡∏à‡∏£‡∏¥‡∏á: ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡πà‡∏≥‡∏™‡∏≤‡∏¢‡∏¢‡∏≤‡∏ß ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏π‡∏á‡∏™‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô
        
        notes.forEach((note, index) => {
            const x = marginX + (index * spacing);
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏™‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° (Slope)
            const heightRatio = 0.6 + (0.3 * (1 - (index / totalStrings))); 
            const stringLen = height * heightRatio;
            const yStart = (height - stringLen) / 2 + 50;
            const yEnd = yStart + stringLen;
            
            strings.push(new HarpString(x, yStart, yEnd, note));
        });
    }

    function animate(time) {
        ctx.clearRect(0, 0, width, height);

        // ‡∏ß‡∏≤‡∏î‡πÑ‡∏°‡πâ‡∏Ñ‡∏≤‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÅ‡∏•‡∏∞‡∏•‡πà‡∏≤‡∏á (Visual Decoration)
        ctx.fillStyle = '#3e2723';
        // Top bar
        // ctx.fillRect(0, 50, width, 20); 

        // Update & Draw Strings
        strings.forEach(str => {
            str.update();
            str.draw(ctx, time);
        });

        // Update & Draw Particles
        for (let i = particles.length - 1; i >= 0; i--) {
            const p = particles[i];
            p.update();
            p.draw(ctx);
            if (p.life <= 0) {
                particles.splice(i, 1);
            }
        }

        requestAnimationFrame(animate);
    }

    // --- Interaction Logic ---

    let isTouching = false;
    let lastX = 0;
    let lastY = 0;

    function handleInput(x, y) {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏ô‡∏Å‡∏±‡∏ö‡∏™‡∏≤‡∏¢ (Collision Detection)
        // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û ‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏Ñ‡πà‡∏£‡∏∞‡∏¢‡∏∞ X ‡∏Å‡πá‡∏û‡∏≠ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏™‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á
        
        strings.forEach(str => {
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏°‡∏≤‡∏™‡πå/‡∏ô‡∏¥‡πâ‡∏ß ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
            // ‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏¢
            const distance = Math.abs(x - str.x);
            const inHeight = y >= str.yStart && y <= str.yEnd;
            
            // Logic: ‡∏ñ‡πâ‡∏≤‡∏•‡∏≤‡∏Å‡∏ú‡πà‡∏≤‡∏ô (Crossed)
            // ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡πÅ‡∏ï‡∏∞‡πÉ‡∏Å‡∏•‡πâ‡πÜ
            if (distance < 20 && inHeight) {
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏µ‡∏î‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏°‡∏≤‡∏™‡πå (‡∏á‡πà‡∏≤‡∏¢‡πÜ‡∏Ñ‡∏∑‡∏≠‡∏î‡∏π‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å base)
                const force = (x - str.baseX) > 0 ? 15 : -15;
                str.pluck(force);
            }
        });
    }

    // Mouse Events
    canvas.addEventListener('mousemove', (e) => {
        // ‡πÉ‡∏ä‡πâ logic ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏ï‡∏±‡∏î‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏™‡πâ‡∏ô X ‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏à‡∏∞‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏Å‡∏ß‡πà‡∏≤
        // ‡πÅ‡∏ï‡πà‡∏ß‡∏¥‡∏ò‡∏µ simple distance check ‡∏Å‡πá‡∏û‡∏≠‡πÑ‡∏´‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö UX ‡∏•‡∏∑‡πà‡∏ô‡πÜ
        if (e.buttons === 1 || isTouching) { // ‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ñ‡πâ‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô touch mode
             handleInput(e.clientX, e.clientY);
        }
    });

    canvas.addEventListener('mousedown', (e) => {
        isTouching = true;
        // Safety resume
        if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
        handleInput(e.clientX, e.clientY);
    });

    canvas.addEventListener('mouseup', () => {
        isTouching = false;
    });

    // Touch Events (Multi-touch support for Polyphony)
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        isTouching = true;
        
        // Safety resume for mobile
        if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();

        for (let i = 0; i < e.changedTouches.length; i++) {
            const t = e.changedTouches[i];
            handleInput(t.clientX, t.clientY);
        }
    }, { passive: false });

    canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        for (let i = 0; i < e.changedTouches.length; i++) {
            const t = e.changedTouches[i];
            handleInput(t.clientX, t.clientY);
        }
    }, { passive: false });

    canvas.addEventListener('touchend', (e) => {
        if(e.touches.length === 0) isTouching = false;
    });


    // --- Setup UI & Start ---
    const startBtn = document.getElementById('startBtn');
    const overlay = document.getElementById('overlay');
    const toggleBtn = document.getElementById('toggleLabels');
    const recordBtn = document.getElementById('recordBtn');

    startBtn.addEventListener('click', () => {
        initAudio();
        overlay.classList.add('hidden');
        // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å AudioContext ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
        if (audioCtx && audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
    });

    toggleBtn.addEventListener('click', () => {
        showLabels = !showLabels;
    });

    // Recording Logic
    recordBtn.addEventListener('click', () => {
        if (!audioCtx) initAudio();

        if (!isRecording) {
            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            audioChunks = [];
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á MediaRecorder ‡∏à‡∏≤‡∏Å Stream ‡∏Ç‡∏≠‡∏á Web Audio
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö browser support
            const mimeType = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/ogg';
            mediaRecorder = new MediaRecorder(dest.stream, { mimeType: mimeType });

            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) audioChunks.push(e.data);
            };

            mediaRecorder.onstop = () => {
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏¢‡∏∏‡∏î
                const blob = new Blob(audioChunks, { type: mimeType });
                const url = URL.createObjectURL(blob);
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                const timestamp = new Date().toISOString().slice(0,19).replace(/[-:]/g,"");
                a.download = `my-harp-song-${timestamp}.webm`; // ‡∏´‡∏£‡∏∑‡∏≠ .ogg
                document.body.appendChild(a);
                a.click();
                
                // Cleanup
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            };

            mediaRecorder.start();
            isRecording = true;
            recordBtn.textContent = "‚èπ ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å";
            recordBtn.style.background = "#ff4d4d";
            recordBtn.style.color = "white";
            recordBtn.style.borderColor = "#ff4d4d";
        } else {
            // ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            mediaRecorder.stop();
            isRecording = false;
            recordBtn.textContent = "üî¥ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á";
            recordBtn.style.background = ""; // Reset style
            recordBtn.style.color = "";
            recordBtn.style.borderColor = "";
        }
    });

    // Start everything
    window.addEventListener('resize', resize);
    resize();
    requestAnimationFrame(animate);

</script>
</body>
</html>