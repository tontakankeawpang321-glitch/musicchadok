<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏£‡∏∞‡∏Ü‡∏±‡∏á‡∏£‡∏≤‡∏ß‡∏à‡∏≥‡∏•‡∏≠‡∏á (Tubular Bells)</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --wood-color: #3e2723;
            --metal-light: #fffbd5;
            --metal-dark: #b8860b;
            --shadow: rgba(0, 0, 0, 0.6);
            --record-red: #ff4444;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        #start-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: white;
            text-align: center;
            cursor: pointer;
            transition: opacity 0.5s;
        }

        #start-overlay h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #ffd700;
            text-shadow: 0 0 10px #b8860b;
        }

        #start-overlay p {
            font-size: 1.2rem;
            color: #ddd;
        }

        /* ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å */
        .controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 50;
        }

        .record-btn {
            background: #333;
            color: white;
            border: 2px solid #555;
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            outline: none;
        }

        .record-btn:active {
            transform: scale(0.95);
        }

        .record-dot {
            width: 12px;
            height: 12px;
            background-color: var(--record-red);
            border-radius: 50%;
            transition: all 0.3s;
        }

        .record-btn.recording {
            background: rgba(50, 0, 0, 0.8);
            border-color: var(--record-red);
            color: var(--record-red);
        }

        .record-btn.recording .record-dot {
            animation: pulse 1.5s infinite;
            box-shadow: 0 0 10px var(--record-red);
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }

        .frame {
            position: relative;
            width: 95%;
            max-width: 1000px;
            height: 75vh; /* ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° */
            background: linear-gradient(90deg, #2a1a10, #5d4037, #2a1a10);
            border-radius: 15px;
            box-shadow: 0 10px 30px var(--shadow);
            border: 5px solid #1a1008;
            display: flex;
            justify-content: space-evenly;
            align-items: flex-start;
            padding: 20px 10px 0 10px;
            box-sizing: border-box;
            margin-top: 40px;
        }

        .frame::before {
            content: '';
            position: absolute;
            top: 10px;
            left: 0;
            width: 100%;
            height: 20px;
            background: linear-gradient(to bottom, #4e342e, #281b16);
            z-index: 0;
        }

        .bell-container {
            position: relative;
            height: 100%;
            width: 10%;
            display: flex;
            justify-content: center;
            z-index: 1;
            cursor: pointer;
        }

        .bell {
            width: 70%;
            background: linear-gradient(90deg, 
                #8a6e2f 0%, 
                #ffd700 40%, 
                #ffecb3 50%, 
                #ffd700 60%, 
                #8a6e2f 100%);
            border-radius: 0 0 10px 10px;
            box-shadow: 2px 5px 10px rgba(0,0,0,0.5);
            position: relative;
            transition: transform 0.1s ease-out, filter 0.1s;
            border-top: 5px solid #333;
        }

        .bell.active {
            filter: brightness(1.3) drop-shadow(0 0 15px gold);
            transform: scale(1.02) translateY(-2px);
        }

        .label {
            position: absolute;
            bottom: -40px;
            color: #888;
            font-weight: bold;
            font-size: 1.2rem;
            pointer-events: none;
        }

        @media (max-width: 600px) {
            .frame {
                width: 98%;
                height: 80vh;
                padding: 10px 5px 0 5px;
            }
            .label {
                font-size: 0.9rem;
                bottom: -30px;
            }
            .controls {
                top: 10px;
                right: 10px;
            }
            .record-btn {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>

    <div id="start-overlay">
        <h1>üéµ ‡∏£‡∏∞‡∏Ü‡∏±‡∏á‡∏£‡∏≤‡∏ß‡∏à‡∏≥‡∏•‡∏≠‡∏á</h1>
        <p>‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
        <p style="font-size: 0.9em; margin-top: 20px; color: #888;">(‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏à‡∏£‡∏¥‡∏á)</p>
    </div>

    <div class="controls">
        <button id="record-btn" class="record-btn">
            <span class="record-dot"></span>
            <span id="record-text">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á</span>
        </button>
    </div>

    <div class="frame" id="bell-frame">
        <!-- ‡∏£‡∏∞‡∏Ü‡∏±‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢ JS -->
    </div>

    <script>
        const notes = [
            { note: 'C', freq: 261.63, height: 95, label: '‡∏î' },
            { note: 'D', freq: 293.66, height: 90, label: '‡∏£' },
            { note: 'E', freq: 329.63, height: 85, label: '‡∏°' },
            { note: 'F', freq: 349.23, height: 80, label: '‡∏ü' },
            { note: 'G', freq: 392.00, height: 75, label: '‡∏ã' },
            { note: 'A', freq: 440.00, height: 70, label: '‡∏•' },
            { note: 'B', freq: 493.88, height: 65, label: '‡∏ó' },
            { note: 'C', freq: 523.25, height: 60, label: '‡∏î‡πç' }
        ];

        let audioCtx;
        let mixerNode; // ‡∏ï‡∏±‡∏ß‡∏£‡∏ß‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏™‡∏µ‡∏¢‡∏á
        let isAudioStarted = false;
        
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á
        let mediaRecorder;
        let recordedChunks = [];
        let isRecording = false;

        function initAudio() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á Mixer Node (‡∏ï‡∏±‡∏ß‡∏Å‡∏•‡∏≤‡∏á‡∏£‡∏ß‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏á)
                mixerNode = audioCtx.createGain();
                mixerNode.gain.value = 1.0;
                
                // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Mixer -> ‡∏•‡∏≥‡πÇ‡∏û‡∏á (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô)
                mixerNode.connect(audioCtx.destination);

                // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á (MediaStream)
                setupRecording();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            
            const overlay = document.getElementById('start-overlay');
            overlay.style.opacity = '0';
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 500);
            isAudioStarted = true;
        }

        function setupRecording() {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Destination ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ Stream ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà Recorder
            const dest = audioCtx.createMediaStreamDestination();
            
            // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Mixer -> Recorder (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Recorder ‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏•‡∏≥‡πÇ‡∏û‡∏á)
            mixerNode.connect(dest);

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á MediaRecorder
            try {
                mediaRecorder = new MediaRecorder(dest.stream);
            } catch (err) {
                console.error('Browser does not support MediaRecorder', err);
                document.getElementById('record-btn').style.display = 'none';
                return;
            }

            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) {
                    recordedChunks.push(e.data);
                }
            };

            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: 'audio/webm' });
                const url = URL.createObjectURL(blob);
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                // ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                const timestamp = new Date().toLocaleTimeString().replace(/:/g, '-');
                a.download = `tubular-bells-${timestamp}.webm`;
                document.body.appendChild(a);
                a.click();
                
                // Cleanup
                setTimeout(() => {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }, 100);
                
                recordedChunks = [];
            };
        }

        function toggleRecording() {
            if (!isAudioStarted) initAudio();

            const btn = document.getElementById('record-btn');
            const txt = document.getElementById('record-text');

            if (!isRecording) {
                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î
                recordedChunks = [];
                if (mediaRecorder && mediaRecorder.state === 'inactive') {
                    mediaRecorder.start();
                    isRecording = true;
                    btn.classList.add('recording');
                    txt.innerText = '‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
                }
            } else {
                // ‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏î
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                    isRecording = false;
                    btn.classList.remove('recording');
                    txt.innerText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á';
                }
            }
        }

        function playSound(freq) {
            if (!isAudioStarted) return;

            const t = audioCtx.currentTime;
            const masterGain = audioCtx.createGain();
            
            // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° note ‡πÑ‡∏õ‡∏ó‡∏µ‡πà mixerNode ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏õ destination ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
            masterGain.connect(mixerNode); 
            
            masterGain.gain.setValueAtTime(0.5, t);

            const partials = [
                { ratio: 0.5, amp: 0.3, decay: 2.5 },
                { ratio: 1.0, amp: 1.0, decay: 2.0 },
                { ratio: 1.5, amp: 0.6, decay: 1.5 },
                { ratio: 2.76, amp: 0.2, decay: 1.0 },
                { ratio: 3.8, amp: 0.1, decay: 0.8 },
                { ratio: 5.4, amp: 0.1, decay: 0.5 }
            ];

            partials.forEach(p => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();

                osc.type = 'sine';
                osc.frequency.value = freq * p.ratio;

                gain.gain.setValueAtTime(0, t);
                gain.gain.linearRampToValueAtTime(p.amp, t + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.001, t + p.decay);

                osc.connect(gain);
                gain.connect(masterGain);

                osc.start(t);
                osc.stop(t + p.decay + 0.1);
            });
        }

        function createBells() {
            const frame = document.getElementById('bell-frame');

            notes.forEach((n, index) => {
                const container = document.createElement('div');
                container.className = 'bell-container';
                container.dataset.index = index;

                const bell = document.createElement('div');
                bell.className = 'bell';
                bell.style.height = `${n.height}%`;
                bell.id = `bell-${index}`;

                const label = document.createElement('div');
                label.className = 'label';
                label.innerText = n.label;

                container.appendChild(bell);
                container.appendChild(label);
                frame.appendChild(container);

                const hit = () => {
                    triggerBell(index);
                };

                container.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    hit();
                });
                
                container.addEventListener('mouseenter', (e) => {
                    if(e.buttons === 1) {
                        hit();
                    }
                });
            });
        }

        function triggerBell(index) {
            if(index < 0 || index >= notes.length) return;
            
            const note = notes[index];
            const bell = document.getElementById(`bell-${index}`);

            playSound(note.freq);

            bell.classList.remove('active');
            void bell.offsetWidth;
            bell.classList.add('active');
            
            setTimeout(() => {
                bell.classList.remove('active');
            }, 150);
        }

        function setupTouchEvents() {
            const frame = document.getElementById('bell-frame');
            
            frame.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (!isAudioStarted) initAudio();

                for (let i = 0; i < e.changedTouches.length; i++) {
                    const touch = e.changedTouches[i];
                    const target = document.elementFromPoint(touch.clientX, touch.clientY);
                    
                    const container = target.closest('.bell-container');
                    if (container) {
                        const index = parseInt(container.dataset.index);
                        triggerBell(index);
                    }
                }
            }, { passive: false });
        }

        document.getElementById('start-overlay').addEventListener('click', initAudio);
        document.getElementById('start-overlay').addEventListener('touchstart', initAudio);
        document.getElementById('record-btn').addEventListener('click', toggleRecording);
        document.getElementById('record-btn').addEventListener('touchstart', (e) => {
            e.stopPropagation(); // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ trigger overlay ‡∏´‡∏£‡∏∑‡∏≠ note
        });

        createBells();
        setupTouchEvents();

    </script>
</body>
</html>