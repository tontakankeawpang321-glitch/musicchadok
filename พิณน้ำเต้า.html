<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>พิณน้ำเต้าจำลอง (Phin Namtao Simulator)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background: linear-gradient(to bottom, #1a0f00, #3e2708);
            color: white;
            overflow: hidden; /* ป้องกันการเลื่อน */
            touch-action: none; /* ป้องกันการซูมและเลื่อนบนมือถือ */
            user-select: none;
            -webkit-user-select: none;
            height: 100dvh; /* Dynamic viewport height */
            display: flex;
            flex-direction: column;
        }

        /* เอฟเฟกต์สายสั่น */
        @keyframes vibrate {
            0% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            50% { transform: translateX(2px); }
            75% { transform: translateX(-1px); }
            100% { transform: translateX(0); }
        }

        .string-vibrate {
            animation: vibrate 0.1s linear infinite;
        }

        /* โซนกดโน้ต */
        .fret-zone {
            transition: background-color 0.1s;
        }
        .fret-zone:active, .fret-zone.active {
            background-color: rgba(255, 215, 0, 0.2);
        }

        /* สไตล์ปุ่มอัดเสียง */
        .recording-pulse {
            animation: pulse-red 1.5s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* ลายไม้ */
        .wood-texture {
            background-color: #5c3a16;
            background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.1) 10px, rgba(0,0,0,0.1) 20px);
            box-shadow: inset 5px 5px 15px rgba(0,0,0,0.5);
        }

        .gourd-texture {
            background: radial-gradient(circle at 30% 30%, #cd853f, #8b4513, #3e1f08);
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body class="relative">

    <!-- Header -->
    <header class="h-14 flex items-center justify-between px-4 bg-black/30 backdrop-blur-sm z-50 border-b border-white/10">
        <h1 class="text-xl font-bold text-amber-400">พิณน้ำเต้า</h1>
        <div id="status-text" class="text-xs text-gray-300">พร้อมใช้งาน</div>
    </header>

    <!-- Main Instrument Area -->
    <main class="flex-1 relative flex justify-center items-center w-full h-full overflow-hidden">
        
        <!-- พื้นหลังลายไทยจางๆ -->
        <div class="absolute inset-0 opacity-10 pointer-events-none flex justify-center items-center">
            <svg width="300" height="300" viewBox="0 0 100 100" fill="none" stroke="white" stroke-width="1">
                <circle cx="50" cy="50" r="40" />
                <path d="M50 10 Q80 50 50 90 Q20 50 50 10" />
            </svg>
        </div>

        <!-- ตัวพิณ (Stick & Gourd) -->
        <div class="relative h-[95%] w-full max-w-md flex flex-col items-center">
            
            <!-- คันพิณ (The Stick) -->
            <div class="absolute top-0 bottom-0 w-8 wood-texture rounded-full z-10"></div>

            <!-- สายพิณ (The String) -->
            <div id="main-string" class="absolute top-0 bottom-0 w-1 bg-yellow-200 z-20 shadow-[0_0_5px_rgba(255,255,0,0.8)] ml-0.5"></div>

            <!-- กะโหลกน้ำเต้า (The Gourd Resonator) - อยู่ด้านหลัง -->
            <div class="absolute top-10 w-48 h-48 rounded-[50%_50%_45%_45%_/_60%_60%_40%_40%] gourd-texture z-0 transform rotate-12 border-4 border-[#2a1505]">
                <!-- รูเสียง -->
                <div class="absolute bottom-10 left-12 w-8 h-12 bg-[#1a0f00] rounded-full transform rotate-[-20deg] shadow-[inset_0_0_10px_black]"></div>
            </div>

            <!-- พื้นที่สัมผัส (Fretboard Zones) -->
            <div class="absolute top-0 bottom-0 w-full z-30 flex flex-col" id="fretboard">
                <!-- Zones will be generated by JS -->
            </div>

            <!-- ลูกบิด (Tuning Peg) -->
            <div class="absolute top-2 w-16 h-4 wood-texture rounded rotate-[-10deg] z-0 shadow-lg"></div>
        </div>
    </main>

    <!-- Controls Footer -->
    <footer class="h-auto pb-6 pt-4 px-4 bg-gradient-to-t from-black to-transparent z-50 flex flex-col gap-3">
        
        <!-- แถบควบคุมเสียง -->
        <div class="flex justify-center gap-4">
            <button id="record-btn" class="flex flex-col items-center gap-1 group">
                <div class="w-12 h-12 rounded-full bg-slate-700 flex items-center justify-center border-2 border-slate-500 group-active:scale-95 transition-all">
                    <div id="record-icon" class="w-4 h-4 rounded-full bg-red-500"></div>
                </div>
                <span class="text-xs">อัดเสียง</span>
            </button>

            <button id="play-btn" class="flex flex-col items-center gap-1 group disabled:opacity-50" disabled>
                <div class="w-12 h-12 rounded-full bg-slate-700 flex items-center justify-center border-2 border-slate-500 group-active:scale-95 transition-all">
                    <svg class="w-6 h-6 text-green-400 fill-current" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                </div>
                <span class="text-xs">เล่นเสียง</span>
            </button>

            <button id="download-btn" class="flex flex-col items-center gap-1 group disabled:opacity-50" disabled>
                <div class="w-12 h-12 rounded-full bg-slate-700 flex items-center justify-center border-2 border-slate-500 group-active:scale-95 transition-all">
                    <svg class="w-6 h-6 text-blue-400 fill-current" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                </div>
                <span class="text-xs">โหลด</span>
            </button>
        </div>

        <!-- Toggle Notes -->
        <button id="toggle-notes" class="mx-auto px-4 py-2 bg-amber-700/80 rounded-full text-sm border border-amber-500/50 shadow-lg active:bg-amber-800 transition-colors w-full max-w-xs">
            แสดงตำแหน่งโน้ต
        </button>
    </footer>

    <!-- Audio Logic Script -->
    <script>
        // --- การตั้งค่าเสียงและสเกล (Pentatonic Thai Style) ---
        // พิณน้ำเต้าจริงๆ มีเสียงจำกัด แต่นี่จำลองให้เล่นได้หลายโน้ต
        const notes = [
            { name: "ด", note: "C4", freq: 261.63, label: "โด" },
            { name: "ร", note: "D4", freq: 293.66, label: "เร" },
            { name: "ม", note: "E4", freq: 329.63, label: "มี" },
            { name: "ซ", note: "G4", freq: 392.00, label: "ซอล" },
            { name: "ล", note: "A4", freq: 440.00, label: "ลา" },
            { name: "ดํ", note: "C5", freq: 523.25, label: "โด (สูง)" },
            { name: "รํ", note: "D5", freq: 587.33, label: "เร (สูง)" }
        ].reverse(); // เรียงจากบนลงล่าง (เสียงสูงอยู่ล่างคอพิณ แต่นิยมเล่นจากบนลงล่างใน UI แนวตั้ง)

        // Web Audio Context
        let audioCtx;
        let masterGain;
        let dest; // For recording
        let mediaRecorder;
        let recordedChunks = [];
        let audioBlob;
        let audioUrl;
        
        // UI Elements
        const fretboard = document.getElementById('fretboard');
        const mainString = document.getElementById('main-string');
        const toggleNotesBtn = document.getElementById('toggle-notes');
        const statusText = document.getElementById('status-text');
        
        // Recording UI
        const recordBtn = document.getElementById('record-btn');
        const recordIcon = document.getElementById('record-icon');
        const playBtn = document.getElementById('play-btn');
        const downloadBtn = document.getElementById('download-btn');
        let isRecording = false;

        let showNotes = false;

        // --- 1. สร้าง Fretboard (โซนกด) ---
        function createFretboard() {
            fretboard.innerHTML = '';
            notes.forEach((note, index) => {
                const zone = document.createElement('div');
                zone.className = 'fret-zone flex-1 flex items-center justify-center border-b border-white/5 relative cursor-pointer';
                zone.dataset.freq = note.freq;
                zone.dataset.index = index;
                
                // ป้ายบอกโน้ต (ซ่อนอยู่)
                const label = document.createElement('span');
                label.className = `note-label text-amber-300 font-bold text-lg drop-shadow-md opacity-0 transition-opacity duration-300 pointer-events-none`;
                label.innerText = note.label;
                zone.appendChild(label);

                // Event Listeners for Touch/Click
                const playHandler = (e) => {
                    e.preventDefault(); // Prevent scrolling
                    playTone(note.freq);
                    visualizeString();
                    zone.classList.add('active');
                    setTimeout(() => zone.classList.remove('active'), 150);
                };

                zone.addEventListener('touchstart', playHandler, { passive: false });
                zone.addEventListener('mousedown', playHandler);

                fretboard.appendChild(zone);
            });
        }

        // --- 2. ระบบเสียง (Synthesizer) ---
        function initAudio() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
                
                // Master Gain (Volume)
                masterGain = audioCtx.createGain();
                masterGain.gain.value = 0.8;
                masterGain.connect(audioCtx.destination);

                // Setup Recording Stream
                dest = audioCtx.createMediaStreamDestination();
                masterGain.connect(dest);
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function playTone(freq) {
            initAudio();

            const t = audioCtx.currentTime;
            
            // Oscillator 1: Triangle (ตัวหลัก ให้เนื้อเสียง)
            const osc1 = audioCtx.createOscillator();
            osc1.type = 'triangle';
            osc1.frequency.value = freq;

            // Oscillator 2: Sawtooth (เพิ่มความแหลม/คมของสาย)
            const osc2 = audioCtx.createOscillator();
            osc2.type = 'sawtooth';
            osc2.frequency.value = freq;
            // Detune เล็กน้อยเพื่อความเป็นธรรมชาติ
            osc2.detune.value = 5; 

            // Gain Envelope (การดีดและหางเสียง)
            const gainNode = audioCtx.createGain();
            gainNode.gain.setValueAtTime(0, t);
            gainNode.gain.linearRampToValueAtTime(1, t + 0.02); // Attack เร็ว (เสียงดีด)
            gainNode.gain.exponentialRampToValueAtTime(0.001, t + 1.5); // Decay ยาวหน่อยแบบพิณ

            // Filter (Lowpass) จำลองความทึบของกะโหลกน้ำเต้า
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(3000, t);
            filter.frequency.exponentialRampToValueAtTime(500, t + 1); // เสียงค่อยๆ ทึบลงตอนหางเสียง

            // เชื่อมต่อ
            osc1.connect(filter);
            osc2.connect(filter); // ผสม 2 osc เข้า filter
            filter.connect(gainNode);
            gainNode.connect(masterGain);

            osc1.start(t);
            osc2.start(t);
            osc1.stop(t + 2);
            osc2.stop(t + 2);
            
            // Cleanup nodes after playing
            setTimeout(() => {
                osc1.disconnect();
                osc2.disconnect();
                gainNode.disconnect();
                filter.disconnect();
            }, 2000);
        }

        // --- 3. Visual & Interaction Logic ---
        function visualizeString() {
            // Remove class to reset animation
            mainString.classList.remove('string-vibrate');
            void mainString.offsetWidth; // Trigger reflow
            mainString.classList.add('string-vibrate');
            
            // Remove after animation ends
            setTimeout(() => {
                mainString.classList.remove('string-vibrate');
            }, 200);
        }

        toggleNotesBtn.addEventListener('click', () => {
            showNotes = !showNotes;
            const labels = document.querySelectorAll('.note-label');
            labels.forEach(l => {
                l.style.opacity = showNotes ? '1' : '0';
            });
            toggleNotesBtn.innerText = showNotes ? 'ซ่อนตำแหน่งโน้ต' : 'แสดงตำแหน่งโน้ต';
            toggleNotesBtn.classList.toggle('bg-amber-600');
        });

        // --- 4. Recording Logic ---
        recordBtn.addEventListener('click', () => {
            initAudio(); // Ensure context is ready
            
            if (!isRecording) {
                // Start Recording
                startRecording();
            } else {
                // Stop Recording
                stopRecording();
            }
        });

        function startRecording() {
            recordedChunks = [];
            
            // Check browser support for types
            const mimeType = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/mp4';
            
            try {
                mediaRecorder = new MediaRecorder(dest.stream, { mimeType: mimeType });
            } catch (e) {
                statusText.innerText = "ไม่รองรับการอัดเสียงบน Browser นี้";
                return;
            }

            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) recordedChunks.push(e.data);
            };

            mediaRecorder.onstop = () => {
                audioBlob = new Blob(recordedChunks, { type: mimeType });
                audioUrl = URL.createObjectURL(audioBlob);
                playBtn.disabled = false;
                downloadBtn.disabled = false;
                statusText.innerText = "บันทึกเสร็จสิ้น";
            };

            mediaRecorder.start();
            isRecording = true;
            
            // UI Updates
            recordIcon.classList.replace('bg-red-500', 'bg-white');
            recordIcon.classList.replace('rounded-full', 'rounded-sm'); // Square stop icon
            recordBtn.querySelector('div').classList.add('recording-pulse', 'border-red-500');
            statusText.innerText = "กำลังบันทึก...";
            
            // Disable play/download while recording
            playBtn.disabled = true;
            downloadBtn.disabled = true;
        }

        function stopRecording() {
            mediaRecorder.stop();
            isRecording = false;

            // UI Updates
            recordIcon.classList.replace('bg-white', 'bg-red-500');
            recordIcon.classList.replace('rounded-sm', 'rounded-full');
            recordBtn.querySelector('div').classList.remove('recording-pulse', 'border-red-500');
        }

        playBtn.addEventListener('click', () => {
            if (audioUrl) {
                const audio = new Audio(audioUrl);
                statusText.innerText = "กำลังเล่นเสียงที่อัด...";
                audio.play();
                audio.onended = () => statusText.innerText = "พร้อมใช้งาน";
            }
        });

        downloadBtn.addEventListener('click', () => {
            if (audioUrl) {
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = audioUrl;
                a.download = `phin-namtao-${new Date().getTime()}.webm`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                statusText.innerText = "ดาวน์โหลดแล้ว";
            }
        });

        // Initialize
        createFretboard();

        // Prevent Context Menu on long press
        window.oncontextmenu = function(event) {
            event.preventDefault();
            event.stopPropagation();
            return false;
        };

    </script>
</body>
</html>