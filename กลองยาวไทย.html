<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏Å‡∏•‡∏≠‡∏á‡∏¢‡∏≤‡∏ß‡∏à‡∏≥‡∏•‡∏≠‡∏á (Virtual Klong Yao)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #2d1b0e; /* Dark wood color */
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M20 20.5V18H0v-2h20v5.1L6 4.1 7.4 2.8 21.6 17l4.4-4.4L11.8.8 13.2-.6 27.5 13.7 34 7.3 35.4 8.7 29 15.1l8.1 8.1-1.4 1.4-8.1-8.1-5.3 5.3 14.2 14.2-1.4 1.4-14.2-14.2-4.4 4.4 14.2 14.2-1.4 1.4-14.2-14.2L2.6 37.4 1.2 36l14.2-14.2L0 20.5h20z' fill='%234a3018' fill-opacity='0.15' fill-rule='evenodd'/%3E%3C/svg%3E");
            touch-action: none; /* ‡∏´‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ã‡∏π‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÇ‡∏î‡∏¢‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î */
            overflow: hidden; 
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: none;
        }

        /* Drum Head Texture */
        .drum-head {
            background: radial-gradient(circle, #f3e5ab 0%, #e0c87e 50%, #d6c485 75%, #b69b4c 100%);
            box-shadow: 
                inset 0 0 30px rgba(0,0,0,0.3),
                0 10px 20px rgba(0,0,0,0.5),
                0 0 0 10px #5c3a21, /* Inner rim */
                0 0 0 20px #8b5a2b, /* Outer rim wood */
                0 15px 30px rgba(0,0,0,0.6); /* Drop shadow */
            position: relative;
            cursor: pointer;
            touch-action: none;
            will-change: transform;
            transform-origin: center center;
        }

        /* Texture overlay */
        .drum-texture {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            border-radius: 50%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.15'/%3E%3C/svg%3E");
            pointer-events: none;
        }

        /* "Rice Paste" Center */
        .khoon {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 45%; 
            height: 45%;
            background: radial-gradient(circle, #3e2723 0%, #5d4037 80%, transparent 100%);
            border-radius: 50%;
            opacity: 0.8;
            filter: blur(2px);
            pointer-events: none;
            border: 2px dashed rgba(255,255,255,0.1);
        }

        /* Hit animations */
        @keyframes ripple {
            0% { opacity: 0.8; transform: translate(-50%, -50%) scale(0.5); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); }
        }
        .hit-anim {
            position: fixed;
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            pointer-events: none;
            will-change: transform, opacity;
            z-index: 40;
            animation: ripple 0.15s ease-out forwards;
        }

        /* Note labels */
        .note-label {
            position: absolute;
            color: rgba(62, 39, 35, 0.8);
            font-weight: bold;
            pointer-events: none;
            text-shadow: 0 1px 1px rgba(255,255,255,0.5);
            display: none;
            text-align: center;
        }
        .show-notes .note-label {
            display: block;
        }

        /* Control Panel */
        .glass-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-control {
            transition: transform 0.1s;
        }
        .btn-control:active {
            transform: scale(0.95);
        }
        .recording-pulse {
            animation: pulse-red 1.5s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* Start Overlay */
        #start-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 50;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            text-align: center;
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col justify-between overflow-hidden">

    <!-- Start Overlay -->
    <div id="start-overlay">
        <div class="p-6 bg-white/10 backdrop-blur-md rounded-xl border border-white/20 animate-bounce cursor-pointer" onclick="initAudio()">
            <i class="fas fa-drum text-6xl mb-4 text-yellow-400"></i>
            <h1 class="text-2xl font-bold">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏µ‡∏Å‡∏•‡∏≠‡∏á‡∏¢‡∏≤‡∏ß</h1>
            <p class="text-sm mt-2 opacity-80">Tap to Start</p>
        </div>
    </div>

    <!-- Header -->
    <div class="flex justify-between items-center p-4 pt-6 z-10 pointer-events-none">
        <div>
            <h1 class="text-white text-xl font-bold drop-shadow-md"><i class="fas fa-music text-yellow-500 mr-2"></i>‡∏Å‡∏•‡∏≠‡∏á‡∏¢‡∏≤‡∏ß‡πÑ‡∏ó‡∏¢</h1>
            <p class="text-yellow-200/70 text-xs">Virtual Klong Yao Simulator</p>
        </div>
        <div id="status-indicator" class="text-xs text-green-400 font-mono hidden pointer-events-auto">
            <i class="fas fa-circle text-[8px] mr-1"></i>‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
        </div>
    </div>

    <!-- Main Instrument Area -->
    <div class="flex-1 flex justify-center items-center relative" id="drum-container">
        
        <!-- The Drum -->
        <div id="drum" class="drum-head w-[85vw] h-[85vw] max-w-[500px] max-h-[500px] rounded-full relative">
            
            <div class="drum-texture"></div>
            
            <!-- Center Target (Bom) -->
            <div class="khoon"></div>
            
            <!-- Note Labels (2 Zones Only) -->
            <div class="note-label text-4xl text-white drop-shadow-lg" style="top: 50%; left: 50%; transform: translate(-50%, -50%);">
                ‡∏ö‡πà‡∏≠‡∏°
            </div>
            
            <!-- Rim Labels -->
            <div class="note-label text-2xl" style="top: 10%; left: 50%; transform: translate(-50%, -50%);">‡πÄ‡∏õ‡∏¥‡∏á</div>
            <div class="note-label text-2xl" style="bottom: 10%; left: 50%; transform: translate(-50%, -50%);">‡πÄ‡∏õ‡∏¥‡∏á</div>
            <div class="note-label text-2xl" style="left: 10%; top: 50%; transform: translate(-50%, -50%);">‡πÄ‡∏õ‡∏¥‡∏á</div>
            <div class="note-label text-2xl" style="right: 10%; top: 50%; transform: translate(-50%, -50%);">‡πÄ‡∏õ‡∏¥‡∏á</div>
            
        </div>
    </div>

    <!-- Controls -->
    <div class="glass-panel pb-8 pt-4 px-4 w-full z-20 rounded-t-3xl">
        <div class="flex justify-between items-center gap-2 max-w-md mx-auto">
            
            <button id="btn-notes" class="btn-control flex flex-col items-center justify-center w-16 h-16 rounded-2xl bg-white/10 text-white border border-white/20" onclick="toggleNotes()">
                <i class="fas fa-eye text-xl mb-1"></i>
                <span class="text-[10px]">‡πÇ‡∏ô‡πâ‡∏ï</span>
            </button>

            <button id="btn-record" class="btn-control flex flex-col items-center justify-center w-20 h-20 rounded-full bg-red-600/80 text-white shadow-lg border-4 border-red-900/50" onclick="toggleRecord()">
                <i class="fas fa-microphone text-2xl mb-1"></i>
                <span class="text-[10px]">‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</span>
            </button>

            <div class="flex gap-2">
                <button id="btn-play" class="btn-control flex flex-col items-center justify-center w-16 h-16 rounded-2xl bg-blue-500/80 text-white disabled:opacity-30 disabled:grayscale" onclick="playRecording()" disabled>
                    <i class="fas fa-play text-xl mb-1"></i>
                    <span class="text-[10px]">‡∏ü‡∏±‡∏á</span>
                </button>

                <button id="btn-download" class="btn-control flex flex-col items-center justify-center w-16 h-16 rounded-2xl bg-green-500/80 text-white disabled:opacity-30 disabled:grayscale" onclick="downloadRecording()" disabled>
                    <i class="fas fa-download text-xl mb-1"></i>
                    <span class="text-[10px]">‡πÇ‡∏´‡∏•‡∏î</span>
                </button>
            </div>

        </div>
    </div>

    <script>
        // --- Configuration ---
        // ‚ö†Ô∏è ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ (Bom = ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ö‡πà‡∏≠‡∏°, Poeng = ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏õ‡∏¥‡∏á)
        const soundUrls = {
         bom: 'konglong/momlong.wav',    // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á "‡∏ö‡πà‡∏≠‡∏°" (‡∏Å‡∏•‡∏≤‡∏á)
            poeng: 'konglong/pengkob.wav'   // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á "‡πÄ‡∏õ‡∏¥‡∏á" (‡∏Ç‡∏≠‡∏ö)
        };

        // --- Global Variables ---
        let audioCtx;
        let masterGain;
        let compressor;
        let reverbNode; 
        let reverbGain; 
        let recorder;
        let recordedChunks = [];
        let audioBlob;
        let audioUrl;
        let isRecording = false;
        let destStream;

        let audioBuffers = { bom: null, poeng: null };

        // PRE-CALCULATED GEOMETRY
        const drum = document.getElementById('drum');
        let drumRect, drumRadius, drumCenterX, drumCenterY, drumRadiusSq;

        function updateDrumGeometry() {
            drumRect = drum.getBoundingClientRect();
            drumRadius = drumRect.width / 2;
            drumRadiusSq = drumRadius * drumRadius; 
            drumCenterX = drumRect.left + drumRadius;
            drumCenterY = drumRect.top + drumRadius;
        }
        window.addEventListener('resize', updateDrumGeometry);
        updateDrumGeometry();

        async function initAudio() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext({ latencyHint: 'interactive' });
                
                // Silent warm-up
                const buffer = audioCtx.createBuffer(1, 1, 22050);
                const source = audioCtx.createBufferSource();
                source.buffer = buffer;
                source.connect(audioCtx.destination);
                source.start();

                // 1. Compressor
                compressor = audioCtx.createDynamicsCompressor();
                compressor.threshold.value = -18; 
                compressor.knee.value = 30;
                compressor.ratio.value = 3; 
                compressor.attack.value = 0.001; 
                compressor.release.value = 0.05; 
                compressor.connect(audioCtx.destination);

                // 2. Master Gain
                masterGain = audioCtx.createGain();
                masterGain.gain.value = 1.0;
                masterGain.connect(compressor);

                // 3. Reverb
                await setupReverb();

                // 4. Load Files
                await loadSoundFiles();

                destStream = audioCtx.createMediaStreamDestination();
                compressor.connect(destStream);

                document.getElementById('start-overlay').style.display = 'none';
                document.getElementById('status-indicator').classList.remove('hidden');
            }
            
            if (audioCtx.state === 'suspended') {
                await audioCtx.resume();
            }
        }

        // --- Safe Trim Silence (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏ö‡∏™) ---
        function trimSilence(buffer) {
            // Threshold ‡∏ï‡πà‡∏≥‡∏°‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏ö‡∏™‡∏ó‡∏∏‡πâ‡∏°‡πÜ ‡πÑ‡∏î‡πâ
            const threshold = 0.0002; 
            let start = buffer.length;
            let end = 0;
            const numChannels = buffer.numberOfChannels;

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å Channel (‡∏ã‡πâ‡∏≤‡∏¢/‡∏Ç‡∏ß‡∏≤) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå
            for (let c = 0; c < numChannels; c++) {
                const data = buffer.getChannelData(c);
                for (let i = 0; i < data.length; i++) {
                    if (Math.abs(data[i]) > threshold) {
                        if (i < start) start = i;
                        break;
                    }
                }
                for (let i = data.length - 1; i >= 0; i--) {
                    if (Math.abs(data[i]) > threshold) {
                        if (i > end) end = i;
                        break;
                    }
                }
            }
            
            // Safety 1: ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÄ‡∏•‡∏¢ (Start ‡πÑ‡∏°‡πà‡∏Ç‡∏¢‡∏±‡∏ö) ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°
            if (start >= buffer.length || end === 0) return buffer;

            // Padding: ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏ß‡πâ‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Å‡∏±‡∏ô‡∏´‡∏±‡∏ß‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ç‡∏≤‡∏î
            start = Math.max(0, start - 100); 
            end = Math.min(buffer.length, end + 200);

            const length = end - start;
            
            // Safety 2: ‡∏ñ‡πâ‡∏≤‡∏ï‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏±‡πâ‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥) ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°
            if (length < 100) return buffer; 

            const newBuffer = audioCtx.createBuffer(numChannels, length, buffer.sampleRate);
            for (let c = 0; c < numChannels; c++) {
                 const oldData = buffer.getChannelData(c);
                 const newData = newBuffer.getChannelData(c);
                 for (let i = 0; i < length; i++) {
                     newData[i] = oldData[i + start];
                 }
            }
            return newBuffer;
        }

        async function loadSoundFiles() {
            let loadedCount = 0;
            const total = Object.values(soundUrls).filter(u => u).length;

            if (total === 0) {
                 document.getElementById('status-indicator').innerHTML = '<i class="fas fa-exclamation-triangle text-yellow-500 mr-1"></i>‡πÉ‡∏ä‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏±‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå';
                 return;
            }

            for (const [key, url] of Object.entries(soundUrls)) {
                if (!url) continue;
                try {
                    const statusDiv = document.getElementById('status-indicator');
                    statusDiv.innerHTML = `<i class="fas fa-spinner fa-spin mr-1"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î ${key}...`;
                    statusDiv.classList.remove('hidden');

                    const response = await fetch(url);
                    if (!response.ok) throw new Error("File not found");
                    
                    const arrayBuffer = await response.arrayBuffer();
                    const rawBuffer = await audioCtx.decodeAudioData(arrayBuffer);
                    
                    // ‡πÉ‡∏ä‡πâ Safe Trim
                    audioBuffers[key] = trimSilence(rawBuffer);
                    loadedCount++;
                } catch (e) {
                    console.warn(`Error loading ${key}`, e);
                }
            }
            document.getElementById('status-indicator').innerHTML = `<i class="fas fa-check-circle text-green-400 mr-1"></i>‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (${loadedCount}/${total})`;
        }

        async function setupReverb() {
            reverbNode = audioCtx.createConvolver();
            reverbGain = audioCtx.createGain();
            reverbGain.gain.value = 0.25; 

            const length = audioCtx.sampleRate * 1.2; 
            const impulse = audioCtx.createBuffer(2, length, audioCtx.sampleRate);
            const left = impulse.getChannelData(0);
            const right = impulse.getChannelData(1);

            for (let i = 0; i < length; i++) {
                const decay = Math.pow(1 - i / length, 3);
                left[i] = (Math.random() * 2 - 1) * decay;
                right[i] = (Math.random() * 2 - 1) * decay;
            }

            reverbNode.buffer = impulse;
            reverbNode.connect(masterGain); 
            reverbGain.connect(reverbNode); 
        }

        // --- PlaySound Logic (Revised) ---
        function playSound(type) {
            if (!audioCtx) return;
            const t = audioCtx.currentTime;

            /* === GAIN === */
            const gain = audioCtx.createGain();

            /* === SOURCE === */
            let source;
            if (audioBuffers[type]) {
                source = audioCtx.createBufferSource();
                source.buffer = audioBuffers[type];
            } else {
                source = audioCtx.createOscillator();
                if (type === 'bom') {
                    source.type = 'square';
                    source.frequency.value = 240;
                    source.frequency.exponentialRampToValueAtTime(120, t + 0.3);
                } else {
                    source.type = 'square';
                    source.frequency.value = 650;
                }
            }

            /* === ENVELOPE === */
            gain.gain.setValueAtTime(0, t);
            gain.gain.linearRampToValueAtTime(
                type === 'bom' ? 1.8 : 1.0,
                t + 0.02
            );
            gain.gain.exponentialRampToValueAtTime(
                0.001,
                t + (type === 'bom' ? 1.0 : 0.35)
            );

            source.connect(gain);

            /* === OUTPUT ROUTING (Bypass check) === */
            if (type === 'bom') {
                // üî• ‡∏ö‡πà‡∏≠‡∏°: ‡∏ï‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏•‡∏≥‡πÇ‡∏û‡∏á‡∏ï‡∏£‡∏á (Bypass Compressor)
                gain.connect(audioCtx.destination);
            } else {
                // ‡πÄ‡∏õ‡∏¥‡∏á: ‡∏ú‡πà‡∏≤‡∏ô compressor
                gain.connect(masterGain);
            }

            source.start(t);
            
            // Auto-stop for oscillator fallback
            if (!audioBuffers[type]) source.stop(t + 1.0);
            
            source.onended = () => {
                source.disconnect();
                gain.disconnect();
            }
        }

        // --- Visual Animation ---
        function triggerDrumAnimation() {
            drum.animate([
                { transform: 'scale(1)' },
                { transform: 'scale(0.97)' },
                { transform: 'scale(1)' }
            ], {
                duration: 60,
                easing: 'ease-out'
            });
        }

        // --- Optimized Touch Handler ---
        function handleHit(e) {
            if (e.cancelable) e.preventDefault();
            
            // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠ 1: ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ï‡∏µ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÄ‡∏á‡∏µ‡∏¢‡∏ö (Wait for init)
            if (!audioCtx) {
                initAudio().then(() => handleHit(e));
                return;
            }

            const touches = e.changedTouches;
            const len = touches.length;
            let visualTriggered = false;

            for (let i = 0; i < len; i++) {
                const t = touches[i];
                const dx = t.clientX - drumCenterX;
                const dy = t.clientY - drumCenterY;
                const distSq = dx*dx + dy*dy;
                const normalizedDistSq = distSq / drumRadiusSq;

                // Zone Logic: Center radius 45% = 0.45 * 0.45 = 0.2025
                if (normalizedDistSq < 0.2025) { 
                    playSound('bom');
                } else {
                    playSound('poeng');
                }
                
                requestAnimationFrame(() => createRipple(t.clientX, t.clientY));
                visualTriggered = true;
            }

            if (visualTriggered) {
                requestAnimationFrame(triggerDrumAnimation);
            }
        }

        function createRipple(x, y) {
            const el = document.createElement('div');
            el.className = 'hit-anim';
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            document.body.appendChild(el);
            setTimeout(() => {
                el.remove();
            }, 200);
        }

        // Event Listeners
        drum.addEventListener('touchstart', handleHit, { passive: false });
        drum.addEventListener('mousedown', handleHit); 
        document.body.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });

        // Controls
        function toggleNotes() {
            const drumEl = document.getElementById('drum');
            const btn = document.getElementById('btn-notes');
            drumEl.classList.toggle('show-notes');
            if (drumEl.classList.contains('show-notes')) {
                btn.classList.remove('bg-white/10');
                btn.classList.add('bg-yellow-500/80');
            } else {
                btn.classList.add('bg-white/10');
                btn.classList.remove('bg-yellow-500/80');
            }
        }

        function toggleRecord() {
            if (!isRecording) startRecording();
            else stopRecording();
        }

        function startRecording() {
            if (!audioCtx) initAudio();
            recordedChunks = [];
            const mimeType = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/ogg';
            recorder = new MediaRecorder(destStream.stream, { mimeType: mimeType });
            recorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
            recorder.onstop = () => {
                audioBlob = new Blob(recordedChunks, { type: 'audio/webm' });
                audioUrl = URL.createObjectURL(audioBlob);
                document.getElementById('btn-play').disabled = false;
                document.getElementById('btn-download').disabled = false;
            };
            recorder.start();
            isRecording = true;
            const recBtn = document.getElementById('btn-record');
            recBtn.classList.add('recording-pulse', 'bg-red-700');
            recBtn.innerHTML = '<i class="fas fa-stop text-2xl mb-1"></i><span class="text-[10px]">‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏î</span>';
            document.getElementById('btn-play').disabled = true;
            document.getElementById('btn-download').disabled = true;
        }

        function stopRecording() {
            recorder.stop();
            isRecording = false;
            const recBtn = document.getElementById('btn-record');
            recBtn.classList.remove('recording-pulse', 'bg-red-700');
            recBtn.classList.add('bg-red-600/80');
            recBtn.innerHTML = '<i class="fas fa-microphone text-2xl mb-1"></i><span class="text-[10px]">‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</span>';
        }

        function playRecording() {
            if (!audioUrl) return;
            const audio = new Audio(audioUrl);
            const playBtn = document.getElementById('btn-play');
            const originalHTML = playBtn.innerHTML;
            playBtn.innerHTML = '<i class="fas fa-spinner fa-spin text-xl mb-1"></i><span class="text-[10px]">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà</span>';
            playBtn.disabled = true;
            audio.onended = () => {
                playBtn.innerHTML = originalHTML;
                playBtn.disabled = false;
            };
            audio.play();
        }

        function downloadRecording() {
            if (!audioUrl) return;
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = audioUrl;
            const date = new Date();
            a.download = `klong-yao-recording-${date.getHours()}-${date.getMinutes()}.webm`;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => document.body.removeChild(a), 100);
        }

        window.oncontextmenu = (e) => { e.preventDefault(); return false; };

    </script>
</body>
</html>
