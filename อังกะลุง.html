<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏≠‡∏±‡∏á‡∏Å‡∏∞‡∏•‡∏∏‡∏á‡πÄ‡∏™‡∏°‡∏∑‡∏≠‡∏ô‡∏à‡∏£‡∏¥‡∏á (Virtual Angklung)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');

        :root {
            --bamboo-light: #e6cfa3;
            --bamboo-dark: #b89058;
            --bamboo-border: #8c6a3e;
            --bg-color: #fdf6e3;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            background-image: radial-gradient(#e4d6b6 1px, transparent 1px);
            background-size: 20px 20px;
            font-family: 'Sarabun', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            touch-action: none; /* Prevent zooming/scrolling on mobile */
        }

        header {
            background: linear-gradient(to right, #5d4037, #8d6e63);
            color: white;
            width: 100%;
            text-align: center;
            padding: 10px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
        }

        h1 {
            margin: 0;
            font-size: 1.5rem;
            text-shadow: 1px 1px 2px black;
        }

        .controls {
            display: flex;
            gap: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.8);
            border-radius: 0 0 15px 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        button.ctrl-btn {
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-family: 'Sarabun', sans-serif;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        #btn-record { background-color: #ff5252; color: white; }
        #btn-stop { background-color: #424242; color: white; display: none; }
        #btn-play { background-color: #4caf50; color: white; }
        #btn-download { background-color: #2196f3; color: white; display: none;}

        button.ctrl-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.ctrl-btn:active {
            transform: scale(0.95);
        }

        /* Angklung Rack Area */
        .angklung-rack {
            flex-grow: 1;
            width: 100%;
            max-width: 800px;
            display: flex;
            justify-content: center;
            align-items: flex-end; /* Align bottom */
            padding-bottom: 20px;
            gap: 2%;
            position: relative;
        }

        /* The Hanging Rail */
        .rail {
            position: absolute;
            top: 10%;
            left: 2%;
            right: 2%;
            height: 15px;
            background: linear-gradient(to bottom, #5d4037, #3e2723);
            border-radius: 10px;
            z-index: 0;
        }

        /* Individual Angklung Unit */
        .angklung-unit {
            position: relative;
            width: 11%; /* Responsive width based on 8 notes */
            height: 70%; /* Base height */
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            transition: transform 0.1s;
            touch-action: manipulation;
            z-index: 1;
            -webkit-tap-highlight-color: transparent;
        }

        .angklung-unit.shaking {
            animation: shake 0.2s infinite;
        }

        @keyframes shake {
            0% { transform: rotate(0deg) translateX(0); }
            25% { transform: rotate(3deg) translateX(2px); }
            50% { transform: rotate(0deg) translateX(0); }
            75% { transform: rotate(-3deg) translateX(-2px); }
            100% { transform: rotate(0deg) translateX(0); }
        }

        /* Bamboo Tubes Visuals */
        .tubes-container {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            justify-content: center;
        }

        /* Generic Bamboo Style */
        .bamboo {
            background: linear-gradient(90deg, 
                var(--bamboo-border) 0%, 
                var(--bamboo-dark) 10%, 
                var(--bamboo-light) 40%, 
                var(--bamboo-light) 60%, 
                var(--bamboo-dark) 90%, 
                var(--bamboo-border) 100%);
            border-radius: 0 0 5px 5px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            position: absolute;
            bottom: 0;
        }

        /* Bamboo Nodes (The rings on bamboo) */
        .node-ring {
            position: absolute;
            width: 100%;
            height: 2px;
            background-color: var(--bamboo-border);
            opacity: 0.7;
        }

        /* Specific Tubes */
        .tube-main {
            width: 45%;
            height: 100%; /* Will be adjusted by JS per note */
            left: 5%;
            z-index: 2;
        }
        
        .tube-octave {
            width: 35%;
            height: 60%; /* Will be adjusted by JS per note */
            right: 5%;
            z-index: 2;
        }

        .frame-top {
            width: 80%;
            height: 8px;
            top: -15px;
            position: absolute;
            background: #5d4037;
            z-index: 3;
        }

        /* String hanging */
        .string {
            width: 2px;
            height: 40px; /* Distance to rail */
            background: #aaa;
            position: absolute;
            top: -45px;
            left: 50%;
            z-index: 0;
        }

        .note-label {
            position: absolute;
            bottom: -35px;
            background: #5d4037;
            color: white;
            padding: 4px 8px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1rem;
            width: 100%;
            text-align: center;
            box-sizing: border-box;
            user-select: none;
        }

        .status-bar {
            position: fixed;
            bottom: 10px;
            font-size: 0.8rem;
            color: #666;
            background: rgba(255,255,255,0.7);
            padding: 2px 10px;
            border-radius: 10px;
        }

        /* Playback Audio Element hidden visually */
        audio { display: none; }

        /* Mobile specific adjustments */
        @media (max-height: 500px) {
            .angklung-unit { height: 60%; }
            .rail { top: 15%; }
        }
    </style>
</head>
<body>

    <header>
        <h1>‡∏≠‡∏±‡∏á‡∏Å‡∏∞‡∏•‡∏∏‡∏á‡πÄ‡∏™‡∏°‡∏∑‡∏≠‡∏ô‡∏à‡∏£‡∏¥‡∏á</h1>
    </header>

    <div class="controls">
        <button id="btn-record" class="ctrl-btn" onclick="toggleRecording()">üî¥ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button id="btn-stop" class="ctrl-btn" onclick="stopPlayback()">‚èπ ‡∏´‡∏¢‡∏∏‡∏î</button>
        <button id="btn-play" class="ctrl-btn" onclick="playRecording()" disabled>‚ñ∂ ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
        <button id="btn-download" class="ctrl-btn" onclick="downloadRecording()">‚¨á ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</button>
    </div>

    <div class="angklung-rack" id="rack">
        <div class="rail"></div>
        <!-- Notes will be generated by JS -->
    </div>

    <div class="status-bar" id="status-text">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô - ‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏∞‡∏ö‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</div>

    <script>
        // --- Configuration ---
        const NOTES = [
            { id: 'c', name: '‡πÇ‡∏î', freq: 261.63, height: 100 },
            { id: 'd', name: '‡πÄ‡∏£', freq: 293.66, height: 92 },
            { id: 'e', name: '‡∏°‡∏µ', freq: 329.63, height: 84 },
            { id: 'f', name: '‡∏ü‡∏≤', freq: 349.23, height: 78 },
            { id: 'g', name: '‡∏ã‡∏≠‡∏•', freq: 392.00, height: 70 },
            { id: 'a', name: '‡∏•‡∏≤', freq: 440.00, height: 62 },
            { id: 'b', name: '‡∏ó‡∏µ', freq: 493.88, height: 55 },
            { id: 'c2', name: '‡πÇ‡∏î‡πà', freq: 523.25, height: 50 }
        ];

        // --- Audio Context & Synthesis ---
        let audioCtx;
        let mainGain;
        let compressor;
        let dest; // MediaStreamDestination for recording
        let mediaRecorder;
        let recordedChunks = [];
        let audioUrl = null;
        let playbackAudio = new Audio();
        let isRecording = false;

        function initAudio() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
                
                // Master Compressor to prevent clipping
                compressor = audioCtx.createDynamicsCompressor();
                compressor.threshold.setValueAtTime(-24, audioCtx.currentTime);
                compressor.knee.setValueAtTime(40, audioCtx.currentTime);
                compressor.ratio.setValueAtTime(12, audioCtx.currentTime);
                compressor.attack.setValueAtTime(0, audioCtx.currentTime);
                compressor.release.setValueAtTime(0.25, audioCtx.currentTime);
                
                mainGain = audioCtx.createGain();
                mainGain.gain.value = 0.8;

                // Routing
                compressor.connect(mainGain);
                mainGain.connect(audioCtx.destination);

                // Setup Recording Destination
                dest = audioCtx.createMediaStreamDestination();
                mainGain.connect(dest);
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        // --- Sound Generation (Physical Modeling Approximation) ---
        function playAngklungSound(freq) {
            initAudio();
            const t = audioCtx.currentTime;
            
            // 1. Bamboo Resonance (Tonal Part)
            // Create two oscillators: Fundamental and Octave (Angklung tubes are usually tuned in octaves)
            const osc1 = audioCtx.createOscillator();
            const osc2 = audioCtx.createOscillator();
            const toneGain = audioCtx.createGain();

            osc1.type = 'sine'; // Smooth tone
            osc2.type = 'triangle'; // Slightly richer tone for the octave

            osc1.frequency.value = freq;
            osc2.frequency.value = freq * 2; // Octave up

            // Envelope for Tone (Woody decay)
            toneGain.gain.setValueAtTime(0, t);
            toneGain.gain.linearRampToValueAtTime(0.6, t + 0.05); // Attack
            toneGain.gain.exponentialRampToValueAtTime(0.01, t + 0.6); // Decay

            osc1.connect(toneGain);
            osc2.connect(toneGain);
            toneGain.connect(compressor);

            osc1.start(t);
            osc2.start(t);
            osc1.stop(t + 0.7);
            osc2.stop(t + 0.7);

            // 2. The "Rattle" (Noise Part) - Simulating the bamboo shaking collision
            const bufferSize = audioCtx.sampleRate * 0.5; // 0.5 seconds
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            
            // Create noise
            for (let i = 0; i < bufferSize; i++) {
                data[i] = Math.random() * 2 - 1;
            }

            const noiseNode = audioCtx.createBufferSource();
            noiseNode.buffer = buffer;

            // Filter the noise to match the wood timbre
            const noiseFilter = audioCtx.createBiquadFilter();
            noiseFilter.type = 'bandpass';
            noiseFilter.frequency.value = freq * 1.5; // Resonate around the note
            noiseFilter.Q.value = 5;

            const noiseGain = audioCtx.createGain();
            
            // Envelope for Rattle (Multiple rapid hits simulation)
            // We simulate a "shake" which is a burst of impacts
            noiseGain.gain.setValueAtTime(0, t);
            noiseGain.gain.linearRampToValueAtTime(0.8, t + 0.02);
            noiseGain.gain.linearRampToValueAtTime(0.4, t + 0.08); // First shake
            noiseGain.gain.linearRampToValueAtTime(0.7, t + 0.15); // Second shake echo
            noiseGain.gain.exponentialRampToValueAtTime(0.001, t + 0.4);

            noiseNode.connect(noiseFilter);
            noiseFilter.connect(noiseGain);
            noiseGain.connect(compressor);

            noiseNode.start(t);
        }

        // --- UI Generation ---
        const rack = document.getElementById('rack');

        NOTES.forEach((note, index) => {
            const unit = document.createElement('div');
            unit.className = 'angklung-unit';
            unit.dataset.note = note.name;
            unit.dataset.freq = note.freq;

            // Visual scaling logic
            const scale = 0.6 + (note.height / 100) * 0.4; 
            
            unit.innerHTML = `
                <div class="string"></div>
                <div class="frame-top"></div>
                <div class="tubes-container">
                    <div class="bamboo tube-main" style="height: ${note.height}%;">
                        <div class="node-ring" style="top: 30%"></div>
                        <div class="node-ring" style="bottom: 10%"></div>
                    </div>
                    <div class="bamboo tube-octave" style="height: ${note.height * 0.6}%;">
                        <div class="node-ring" style="top: 40%"></div>
                    </div>
                </div>
                <div class="note-label">${note.name}</div>
            `;

            // Interaction Handlers
            const triggerSound = (e) => {
                e.preventDefault();
                playAngklungSound(note.freq);
                
                // Visual shake
                unit.classList.remove('shaking');
                void unit.offsetWidth; // Trigger reflow
                unit.classList.add('shaking');
                setTimeout(() => unit.classList.remove('shaking'), 300);
            };

            // Touch and Click support
            unit.addEventListener('touchstart', triggerSound, {passive: false});
            unit.addEventListener('mousedown', triggerSound);

            rack.appendChild(unit);
        });

        // --- Recording Logic ---
        const btnRecord = document.getElementById('btn-record');
        const btnStop = document.getElementById('btn-stop');
        const btnPlay = document.getElementById('btn-play');
        const btnDownload = document.getElementById('btn-download');
        const statusText = document.getElementById('status-text');

        function toggleRecording() {
            initAudio();
            if (!isRecording) {
                // Start Recording
                recordedChunks = [];
                // Prefer opus for better compression, fallback to default
                const options = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') 
                    ? { mimeType: 'audio/webm;codecs=opus' } 
                    : {};
                
                mediaRecorder = new MediaRecorder(dest.stream, options);

                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) recordedChunks.push(e.data);
                };

                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { 'type' : 'audio/webm' });
                    if (audioUrl) URL.revokeObjectURL(audioUrl);
                    audioUrl = URL.createObjectURL(blob);
                    
                    playbackAudio.src = audioUrl;
                    
                    btnPlay.disabled = false;
                    btnDownload.style.display = 'inline-flex';
                    btnStop.style.display = 'none';
                    btnRecord.style.display = 'inline-flex';
                    statusText.textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ü‡∏±‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î";
                };

                mediaRecorder.start();
                isRecording = true;
                
                // UI Update
                btnRecord.style.display = 'none';
                btnStop.style.display = 'inline-flex';
                btnPlay.disabled = true;
                btnDownload.style.display = 'none';
                statusText.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á... (‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏á‡∏Å‡∏∞‡∏•‡∏∏‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô)";
                document.body.style.backgroundColor = "#ffebee"; // Visual cue
            }
        }

        function stopPlayback() {
            if (isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                document.body.style.backgroundColor = "var(--bg-color)";
            } else {
                playbackAudio.pause();
                playbackAudio.currentTime = 0;
                statusText.textContent = "‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß";
            }
        }

        function playRecording() {
            if (audioUrl) {
                statusText.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ...";
                playbackAudio.play();
                playbackAudio.onended = () => {
                    statusText.textContent = "‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß";
                };
            }
        }

        function downloadRecording() {
            if (audioUrl) {
                const a = document.createElement('a');
                const date = new Date();
                const timestamp = `${date.getHours()}-${date.getMinutes()}-${date.getSeconds()}`;
                a.href = audioUrl;
                a.download = `Angklung-Recording-${timestamp}.webm`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        }

        // Prevent context menu on right click to make it feel more like an app
        document.addEventListener('contextmenu', event => event.preventDefault());

    </script>
</body>
</html>