<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bassoon Simulator</title>
    <style>
        /* รีเซ็ตและตั้งค่าพื้นฐาน */
        * {
            box-sizing: border-box;
            touch-action: none; /* ป้องกันการซูมและเลื่อน */
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            background-color: #1a1a1a;
            font-family: 'Sarabun', sans-serif;
            overflow: hidden; /* ป้องกันขอบล้น */
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* ส่วนหัวและปุ่มควบคุม */
        .controls-bar {
            width: 100%;
            height: 60px;
            background: #2d1b15;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-bottom: 2px solid #5d4037;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .control-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: none;
            font-size: 14px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: transform 0.1s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-record { background: #d32f2f; }
        .btn-stop { background: #f57c00; display: none; }
        /* เปลี่ยนสีและสไตล์ปุ่มดาวน์โหลด */
        .btn-download { background: #0288d1; display: none; }
        
        .control-btn:active { transform: scale(0.95); }
        .status-light {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #555;
            margin-right: 5px;
        }
        .status-light.recording { background: #ff0000; box-shadow: 0 0 10px #ff0000; animation: blink 1s infinite; }

        @keyframes blink { 50% { opacity: 0.5; } }

        /* ตัวเครื่องบาสซูน */
        .instrument-body {
            flex: 1;
            width: 100%;
            max-width: 600px;
            background: linear-gradient(90deg, #3e2723 0%, #5d4037 40%, #8d6e63 50%, #5d4037 60%, #3e2723 100%);
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-evenly;
            align-items: center;
            padding: 20px 0;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
        }

        /* ลวดลายไม้ */
        .instrument-body::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.5' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.1'/%3E%3C/svg%3E");
            opacity: 0.4;
            pointer-events: none;
        }

        /* กลุ่มปุ่มกด */
        .keys-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            width: 100%;
            padding: 0 20px;
            z-index: 5;
        }

        /* ดีไซน์ปุ่มกด */
        .key {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #e0e0e0, #9e9e9e, #424242);
            border: 4px solid #b0bec5;
            box-shadow: 0 5px 15px rgba(0,0,0,0.6), inset 0 0 10px rgba(255,255,255,0.2);
            position: relative;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            font-weight: bold;
            color: #333;
            text-shadow: 0 1px 0 rgba(255,255,255,0.5);
            transition: transform 0.05s, box-shadow 0.05s;
        }

        /* ปุ่มสีทองสำหรับโน้ตสำคัญ */
        .key.gold {
            background: radial-gradient(circle at 30% 30%, #fff9c4, #fbc02d, #f57f17);
            border-color: #ffd54f;
        }

        /* เอฟเฟกต์ตอนกด */
        .key.active {
            transform: scale(0.92) translateY(2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.5), inset 0 0 15px rgba(0,0,0,0.8);
            background: radial-gradient(circle at 30% 30%, #bdbdbd, #616161);
        }
        .key.gold.active {
            background: radial-gradient(circle at 30% 30%, #fdd835, #f57f17);
        }

        /* ชื่อโน้ต */
        .note-label {
            pointer-events: none;
        }

        /* ส่วนโลหะตกแต่ง (Rod system) */
        .rod {
            position: absolute;
            width: 6px;
            height: 90%;
            background: linear-gradient(90deg, #9e9e9e, #f5f5f5, #616161);
            left: 50%;
            transform: translateX(-50%);
            z-index: 1;
            border-radius: 3px;
        }
        
        /* ขาตั้งปุ่ม */
        .key-mount {
            position: absolute;
            width: 20px;
            height: 100%;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            z-index: 0;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
        }
        .mount-point {
            width: 100%;
            height: 4px;
            background: #757575;
        }

        /* ข้อความแจ้งเตือน */
        .toast {
            position: absolute;
            bottom: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 20;
        }

    </style>
</head>
<body>

    <div class="controls-bar">
        <button id="btnRecord" class="control-btn btn-record">
            <div id="recLight" class="status-light"></div> บันทึก
        </button>
        <button id="btnStop" class="control-btn btn-stop">หยุด</button>
        <!-- เปลี่ยนจากปุ่มเล่น เป็นปุ่มดาวน์โหลด -->
        <a id="btnDownload" class="control-btn btn-download" download="bassoon_recording.webm">ดาวน์โหลด</a>
    </div>

    <div class="instrument-body">
        <div class="rod"></div>
        
        <!-- แถวบน: มือซ้าย -->
        <div class="keys-container">
            <div class="key" data-note="F2">F2</div>
            <div class="key" data-note="G2">G2</div>
            <div class="key" data-note="A2">A2</div>
            <div class="key gold" data-note="Bb2">Bb2</div>
        </div>

        <!-- แถวล่าง: มือขวา -->
        <div class="keys-container">
            <div class="key" data-note="C3">C3</div>
            <div class="key" data-note="D3">D3</div>
            <div class="key" data-note="E3">E3</div>
            <div class="key gold" data-note="F3">F3</div>
        </div>
        
        <!-- แถวพิเศษ -->
        <div class="keys-container">
            <div class="key" data-note="G3">G3</div>
            <div class="key" data-note="A3">A3</div>
        </div>
    </div>

    <div id="toast" class="toast">เริ่มบันทึกเสียง...</div>

    <script>
        // --- Audio Engine (Web Audio API) ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;
        let destNode; // โหนดปลายทางสำหรับอัดเสียง
        let mediaRecorder; // ตัวอัดเสียง
        let audioChunks = []; // เก็บข้อมูลเสียงที่อัด
        
        // ความถี่โน้ต (Bassoon Range - Bass Clef)
        const noteFreqs = {
            'F2': 87.31,
            'G2': 98.00,
            'A2': 110.00,
            'Bb2': 116.54,
            'C3': 130.81,
            'D3': 146.83,
            'E3': 164.81,
            'F3': 174.61,
            'G3': 196.00,
            'A3': 220.00
        };

        // เก็บ Oscillators ที่กำลังเล่นอยู่
        const activeNotes = {};

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new AudioContext();
                // สร้าง Destination สำหรับส่งสัญญาณเสียงไปที่ Recorder
                destNode = audioCtx.createMediaStreamDestination();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        // สร้างเสียงบาสซูนสังเคราะห์
        function playTone(note) {
            if (!audioCtx) initAudio();
            if (activeNotes[note]) return; // เล่นอยู่แล้วไม่ต้องเล่นซ้ำ

            const t = audioCtx.currentTime;
            const freq = noteFreqs[note];

            // 1. Main Oscillator (Sawtooth)
            const osc1 = audioCtx.createOscillator();
            osc1.type = 'sawtooth';
            osc1.frequency.value = freq;

            // 2. Sub Oscillator (Square)
            const osc2 = audioCtx.createOscillator();
            osc2.type = 'square';
            osc2.frequency.value = freq;
            osc2.detune.value = -5; 

            // 3. Filter (Lowpass)
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(600, t); 
            filter.Q.value = 1;

            // 4. Envelope (Gain)
            const gainNode = audioCtx.createGain();
            gainNode.gain.setValueAtTime(0, t);
            gainNode.gain.linearRampToValueAtTime(0.6, t + 0.05);
            gainNode.gain.exponentialRampToValueAtTime(0.4, t + 0.2);

            // การเชื่อมต่อ: Osc -> Filter -> Gain -> Outputs
            osc1.connect(filter);
            osc2.connect(filter);
            filter.connect(gainNode);
            
            // **สำคัญ**: เชื่อมต่อออกลำโพง (เพื่อให้เราได้ยินขณะเล่น)
            gainNode.connect(audioCtx.destination);
            // **สำคัญ**: เชื่อมต่อเข้าตัวอัดเสียง (ถ้ามี)
            if (destNode) {
                gainNode.connect(destNode);
            }

            osc1.start(t);
            osc2.start(t);

            activeNotes[note] = { osc1, osc2, gainNode, filter };
        }

        function stopTone(note) {
            if (!activeNotes[note]) return;

            const { osc1, osc2, gainNode } = activeNotes[note];
            const t = audioCtx.currentTime;

            // Release phase
            gainNode.gain.cancelScheduledValues(t);
            gainNode.gain.setValueAtTime(gainNode.gain.value, t);
            gainNode.gain.exponentialRampToValueAtTime(0.001, t + 0.15); 

            osc1.stop(t + 0.15);
            osc2.stop(t + 0.15);

            delete activeNotes[note];
        }

        // --- User Interface & Interaction ---
        const keys = document.querySelectorAll('.key');

        keys.forEach(key => {
            const note = key.dataset.note;

            const start = (e) => {
                e.preventDefault();
                key.classList.add('active');
                playTone(note);
            };

            const end = (e) => {
                e.preventDefault();
                key.classList.remove('active');
                stopTone(note);
            };

            key.addEventListener('touchstart', start, { passive: false });
            key.addEventListener('touchend', end, { passive: false });
            key.addEventListener('touchcancel', end, { passive: false });

            key.addEventListener('mousedown', start);
            key.addEventListener('mouseup', end);
            key.addEventListener('mouseleave', end);
        });

        // --- Recording System (MediaRecorder) ---
        let isRecording = false;
        
        const btnRecord = document.getElementById('btnRecord');
        const btnStop = document.getElementById('btnStop');
        const btnDownload = document.getElementById('btnDownload'); // ปุ่มใหม่
        const recLight = document.getElementById('recLight');
        const toast = document.getElementById('toast');

        function showToast(msg) {
            toast.textContent = msg;
            toast.style.opacity = 1;
            setTimeout(() => toast.style.opacity = 0, 2000);
        }

        btnRecord.addEventListener('click', () => {
            initAudio();
            audioChunks = []; // เคลียร์ข้อมูลเก่า
            
            // ตั้งค่า MediaRecorder
            const options = { mimeType: 'audio/webm' };
            // ถ้า Browser ไม่รองรับ webm ให้ลอง mp4 หรือ default
            if (!MediaRecorder.isTypeSupported('audio/webm')) {
                 // ปล่อยให้ Browser เลือก default
                 mediaRecorder = new MediaRecorder(destNode.stream);
            } else {
                 mediaRecorder = new MediaRecorder(destNode.stream, options);
            }

            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) {
                    audioChunks.push(e.data);
                }
            };

            mediaRecorder.onstop = () => {
                // สร้าง Blob ไฟล์เสียง
                const blob = new Blob(audioChunks, { type: 'audio/webm' });
                const url = URL.createObjectURL(blob);
                
                // ตั้งค่าปุ่มดาวน์โหลด
                btnDownload.href = url;
                // ตั้งชื่อไฟล์ตามเวลา
                const date = new Date();
                const timestamp = `${date.getHours()}-${date.getMinutes()}-${date.getSeconds()}`;
                btnDownload.download = `bassoon_rec_${timestamp}.webm`;
                
                btnDownload.style.display = 'flex'; // แสดงปุ่มดาวน์โหลด
                showToast('พร้อมดาวน์โหลด');
            };

            mediaRecorder.start();
            isRecording = true;
            
            btnRecord.style.display = 'none';
            btnDownload.style.display = 'none'; // ซ่อนปุ่มโหลดเก่าถ้ามี
            btnStop.style.display = 'flex';
            recLight.classList.add('recording');
            showToast('เริ่มบันทึก...');
        });

        btnStop.addEventListener('click', () => {
            if (isRecording && mediaRecorder) {
                mediaRecorder.stop();
                isRecording = false;
            }

            btnStop.style.display = 'none';
            btnRecord.style.display = 'flex';
            recLight.classList.remove('recording');
        });

    </script>
</body>
</html>