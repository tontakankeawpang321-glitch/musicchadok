<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Oboe Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ป้องกันการเลือกข้อความและการซูม */
        body {
            overscroll-behavior: none;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            font-family: 'Sarabun', sans-serif;
            background-color: #1a1a1a;
            overflow: hidden;
        }

        /* ลวดลายไม้สีดำ (Blackwood Texture) */
        .oboe-body {
            background: linear-gradient(90deg, #0f0f0f 0%, #2b1d12 40%, #1a120b 60%, #050505 100%);
            box-shadow: inset 0 0 20px #000;
            position: relative;
        }

        /* ปุ่มคีย์เงิน (Silver Keys) */
        .key-btn {
            background: radial-gradient(circle at 30% 30%, #ffffff, #d1d5db, #6b7280, #374151);
            border: 2px solid #9ca3af;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5), inset 0 -2px 4px rgba(0,0,0,0.3);
            transition: transform 0.05s, box-shadow 0.05s;
            position: relative;
            touch-action: none; /* สำคัญมากสำหรับมือถือ */
            /* ทำให้ปุ่มคงรูปวงกลมเสมอ */
            aspect-ratio: 1 / 1; 
        }

        .key-btn:active, .key-btn.active {
            transform: scale(0.95) translateY(2px);
            background: radial-gradient(circle at 30% 30%, #d1d5db, #9ca3af, #4b5563, #1f2937);
            box-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        /* รูกลางปุ่ม (เพื่อให้เหมือนคีย์โอโบจริงบางรุ่น) */
        .key-hole {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40%;
            height: 40%;
            background-color: #1a120b;
            border-radius: 50%;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.8);
            border: 1px solid #4b5563;
        }

        /* ไฟสถานะอัดเสียง */
        .rec-dot {
            width: 12px;
            height: 12px;
            background-color: red;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            50% { opacity: 0; }
        }

        /* เอฟเฟกต์ Glow เมื่อกด */
        .glow-effect {
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
        }
    </style>
</head>
<body class="h-[100dvh] w-screen flex flex-col items-center justify-between text-white">

    <!-- Header & Controls -->
    <div class="w-full bg-gray-900 p-3 flex justify-between items-center z-10 shadow-lg border-b border-gray-700 flex-shrink-0">
        <div>
            <h1 class="text-lg font-bold text-amber-500 tracking-wider">OBOE PRO</h1>
            <p class="text-[10px] text-gray-400">เครื่องจำลองเสียงโอโบ</p>
        </div>
        
        <div class="flex gap-2">
            <button id="recordBtn" class="bg-red-700 hover:bg-red-600 text-white px-3 py-1.5 rounded-lg font-bold text-xs shadow flex items-center transition">
                <span class="material-icons">REC</span>
            </button>
            <button id="stopRecBtn" class="hidden bg-gray-700 hover:bg-gray-600 text-white px-3 py-1.5 rounded-lg font-bold text-xs shadow transition">
                STOP
            </button>
            <button id="playBtn" class="hidden bg-green-600 hover:bg-green-500 text-white px-3 py-1.5 rounded-lg font-bold text-xs shadow transition">
                PLAY/SAVE
            </button>
        </div>
    </div>

    <!-- Instrument Body -->
    <div class="oboe-body flex-grow w-full max-w-md flex flex-col items-center py-2 relative overflow-hidden">
        <!-- Decoration: Gold Rings -->
        <div class="absolute top-0 w-full h-2 bg-gradient-to-r from-yellow-600 via-yellow-300 to-yellow-600 z-0"></div>
        <div class="absolute bottom-0 w-full h-4 bg-gradient-to-r from-yellow-600 via-yellow-300 to-yellow-600 z-0"></div>

        <!-- Keys Container -->
        <div class="flex flex-col w-full items-center justify-evenly h-full px-4 py-2 z-10" id="keys-container">
            <!-- Keys will be generated by JS -->
        </div>
    </div>

    <!-- Hidden Audio Player for playback -->
    <audio id="audioPlayer" controls class="hidden"></audio>

    <script>
        // --- Configuration ---
        const NOTES = [
            { note: 'C5', freq: 523.25, label: 'โด' },
            { note: 'B4', freq: 493.88, label: 'ที' },
            { note: 'A4', freq: 440.00, label: 'ลา' },
            { note: 'G4', freq: 392.00, label: 'ซอล' },
            { note: 'F4', freq: 349.23, label: 'ฟา' },
            { note: 'E4', freq: 329.63, label: 'มี' },
            { note: 'D4', freq: 293.66, label: 'เร' },
            { note: 'C4', freq: 261.63, label: 'โด' }
        ];

        // --- Global Variables ---
        let audioCtx;
        let masterGain;
        let compressor;
        let activeOscillators = {}; // Map to track playing notes
        
        // Recording variables
        let mediaRecorder;
        let audioChunks = [];
        let dest; // MediaStreamDestination
        let isRecording = false;

        // --- Initialization ---
        function initAudio() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
                
                // Master Volume
                masterGain = audioCtx.createGain();
                masterGain.gain.value = 0.5;

                // Compressor (to prevent clipping when many keys pressed)
                compressor = audioCtx.createDynamicsCompressor();
                compressor.threshold.value = -24;
                compressor.knee.value = 30;
                compressor.ratio.value = 12;
                compressor.attack.value = 0.003;
                compressor.release.value = 0.25;

                // Routing
                masterGain.connect(compressor);
                compressor.connect(audioCtx.destination);

                // Setup Recording Destination
                dest = audioCtx.createMediaStreamDestination();
                compressor.connect(dest);
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        // --- Sound Engine (Oboe Synthesis) ---
        function playNote(freq, id) {
            initAudio(); // Ensure context is ready

            if (activeOscillators[id]) return; // Prevent double trigger

            const t = audioCtx.currentTime;

            // 1. Create Oscillator (Sawtooth is good for reeds)
            const osc = audioCtx.createOscillator();
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(freq, t);

            // 2. Filter (Lowpass to dampen the harsh sawtooth)
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.Q.value = 2; // Resonance
            filter.frequency.setValueAtTime(1200, t); // Oboe format range

            // 3. Gain Envelope (ADSR)
            const gainNode = audioCtx.createGain();
            gainNode.gain.setValueAtTime(0, t);
            gainNode.gain.linearRampToValueAtTime(0.8, t + 0.05); // Attack
            gainNode.gain.exponentialRampToValueAtTime(0.6, t + 0.2); // Decay

            // 4. Vibrato (LFO) - Crucial for Oboe realism
            const lfo = audioCtx.createOscillator();
            lfo.type = 'sine';
            lfo.frequency.value = 5.5; // Vibrato speed (Hz)
            const lfoGain = audioCtx.createGain();
            lfoGain.gain.value = 3; // Vibrato depth
            
            lfo.connect(lfoGain);
            lfoGain.connect(osc.frequency);
            lfo.start(t);

            // Connect graph
            osc.connect(filter);
            filter.connect(gainNode);
            gainNode.connect(masterGain);

            osc.start(t);

            // Store nodes to stop later
            activeOscillators[id] = { osc, gainNode, lfo, filter };
        }

        function stopNote(id) {
            if (!activeOscillators[id]) return;

            const { osc, gainNode, lfo } = activeOscillators[id];
            const t = audioCtx.currentTime;

            // Release phase
            gainNode.gain.cancelScheduledValues(t);
            gainNode.gain.setValueAtTime(gainNode.gain.value, t);
            gainNode.gain.exponentialRampToValueAtTime(0.001, t + 0.1); // Quick release

            osc.stop(t + 0.15);
            lfo.stop(t + 0.15);
            
            // Cleanup after sound stops
            setTimeout(() => {
                if (activeOscillators[id] === activeOscillators[id]) { // Check if not replaced
                   delete activeOscillators[id];
                }
            }, 150);
        }

        // --- UI Construction ---
        const keysContainer = document.getElementById('keys-container');

        NOTES.forEach((n, index) => {
            const btn = document.createElement('div');
            // Responsive sizing logic (Fitscreen)
            // ใช้ความสูงหน้าจอ (vh) เป็นเกณฑ์: 
            // 8 ปุ่ม * 9vh = 72% ของจอ (เหลือที่ให้ Header/Padding)
            // กำหนด max/min เพื่อไม่ให้ใหญ่/เล็กเกินไป
            btn.className = `key-btn h-[9.5vh] w-[9.5vh] max-h-[85px] max-w-[85px] min-h-[50px] min-w-[50px] rounded-full flex items-center justify-center cursor-pointer select-none relative`;
            btn.dataset.note = n.note;
            btn.dataset.freq = n.freq;
            btn.id = `key-${index}`;

            // Inner styling
            btn.innerHTML = `
                <div class="key-hole pointer-events-none"></div>
                <span class="pointer-events-none text-gray-900 font-bold text-lg drop-shadow-md absolute -right-[4.5rem] bg-black/50 text-white px-2 py-0.5 rounded text-sm">${n.label}</span>
                <span class="pointer-events-none text-[10px] text-gray-600 font-mono absolute bottom-1 opacity-70">${n.note}</span>
            `;

            // Event Listeners (Universal for Touch & Mouse)
            const startHandler = (e) => {
                e.preventDefault();
                playNote(n.freq, index);
                btn.classList.add('active', 'glow-effect');
            };

            const endHandler = (e) => {
                e.preventDefault();
                stopNote(index);
                btn.classList.remove('active', 'glow-effect');
            };

            // Touch events
            btn.addEventListener('touchstart', startHandler, { passive: false });
            btn.addEventListener('touchend', endHandler);
            btn.addEventListener('touchcancel', endHandler);

            // Mouse events
            btn.addEventListener('mousedown', startHandler);
            btn.addEventListener('mouseup', endHandler);
            btn.addEventListener('mouseleave', endHandler);

            keysContainer.appendChild(btn);
        });

        // --- Recording Logic ---
        const recordBtn = document.getElementById('recordBtn');
        const stopRecBtn = document.getElementById('stopRecBtn');
        const playBtn = document.getElementById('playBtn');

        recordBtn.addEventListener('click', () => {
            initAudio();
            audioChunks = [];
            
            // Use the destination stream
            const stream = dest.stream;
            mediaRecorder = new MediaRecorder(stream);

            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const audioUrl = URL.createObjectURL(audioBlob);
                const audioPlayer = document.getElementById('audioPlayer');
                audioPlayer.src = audioUrl;
                
                // Allow download
                playBtn.onclick = () => {
                    const a = document.createElement('a');
                    a.href = audioUrl;
                    a.download = 'my-oboe-solo.webm';
                    a.click();
                    audioPlayer.play();
                };
            };

            mediaRecorder.start();
            isRecording = true;
            
            // UI Update
            recordBtn.innerHTML = '<span class="rec-dot"></span>กำลังบันทึก';
            recordBtn.classList.remove('bg-red-700');
            recordBtn.classList.add('bg-gray-800', 'border', 'border-red-500');
            stopRecBtn.classList.remove('hidden');
            playBtn.classList.add('hidden');
        });

        stopRecBtn.addEventListener('click', () => {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;

                // UI Update
                recordBtn.innerHTML = '<span class="material-icons">REC</span>';
                recordBtn.classList.add('bg-red-700');
                recordBtn.classList.remove('bg-gray-800', 'border', 'border-red-500');
                stopRecBtn.classList.add('hidden');
                playBtn.classList.remove('hidden');
            }
        });

    </script>
</body>
</html>