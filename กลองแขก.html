<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏Å‡∏•‡∏≠‡∏á‡πÅ‡∏Ç‡∏Å‡πÄ‡∏™‡∏°‡∏∑‡∏≠‡∏ô‡∏à‡∏£‡∏¥‡∏á (Glong Khaek)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #2c1e12; /* Dark wood base */
            background-image: repeating-linear-gradient(45deg, #3d2b1f 25%, transparent 25%, transparent 75%, #3d2b1f 75%, #3d2b1f), repeating-linear-gradient(45deg, #3d2b1f 25%, #2c1e12 25%, #2c1e12 75%, #3d2b1f 75%, #3d2b1f);
            background-position: 0 0, 10px 10px;
            background-size: 20px 20px;
            overflow: hidden; /* Prevent scrolling */
            touch-action: none; /* Disable browser handling of gestures */
            user-select: none;
            -webkit-user-select: none;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
        }

        /* Drum Skin Texture */
        .drum-head {
            background: radial-gradient(circle at 30% 30%, #e6d5b8, #cfb893, #a68b64);
            box-shadow: 
                inset 0 0 20px rgba(0,0,0,0.6),
                0 10px 20px rgba(0,0,0,0.5),
                0 0 0 8px #5c4033, /* Wood rim */
                0 0 0 12px #2a1d12; /* Dark outer rim */
            position: relative;
            border-radius: 50%;
            transition: transform 0.05s, filter 0.05s;
            cursor: pointer;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.1);
        }

        /* Interaction feedback */
        .drum-head:active, .drum-head.active {
            transform: scale(0.96);
            filter: brightness(0.9);
        }

        /* Center spot (Target) */
        .drum-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 35%;
            height: 35%;
            background: radial-gradient(circle, rgba(0,0,0,0.1), transparent 70%);
            border-radius: 50%;
            pointer-events: none; /* Let clicks pass through to parent logic */
            border: 1px dashed rgba(139, 69, 19, 0.3);
        }

        /* Rope Texture decoration */
        .rope {
            position: absolute;
            background: #d4a76a;
            width: 4px;
            height: 20px;
            z-index: -1;
            box-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .control-panel {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            border-top: 2px solid #8b4513;
            width: 100%;
            padding: 10px 5px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 10;
        }

        .btn {
            background: linear-gradient(to bottom, #8b5a2b, #5c3a1e);
            border: 1px solid #a67c52;
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.4);
            transition: all 0.2s;
            text-shadow: 1px 1px 2px black;
            min-width: 60px;
            text-align: center;
        }

        .btn:active {
            transform: translateY(2px);
            box-shadow: 0 1px 2px rgba(0,0,0,0.4);
        }

        .btn.recording {
            background: linear-gradient(to bottom, #ff4444, #cc0000);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0); }
        }

        /* Start Overlay */
        #start-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: white;
            text-align: center;
        }

        .tap-zone-label {
            position: absolute;
            font-size: 0.8rem;
            color: rgba(92, 64, 51, 0.7);
            font-weight: bold;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <!-- Header -->
    <div class="w-full text-center py-2 z-10 pointer-events-none">
        <h1 class="text-xl text-[#e6d5b8] font-bold drop-shadow-md tracking-wider">ü•Å ‡∏Å‡∏•‡∏≠‡∏á‡πÅ‡∏Ç‡∏Å (Virtual)</h1>
        <p class="text-xs text-[#a68b64]">‡πÅ‡∏ï‡∏∞‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á "‡∏ó‡∏∏‡πâ‡∏°" / ‡πÅ‡∏ï‡∏∞‡∏Ç‡∏≠‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á "‡πÅ‡∏´‡∏•‡∏°"</p>
    </div>

    <!-- Drum Area -->
    <div class="flex-grow flex flex-col justify-center items-center w-full max-w-lg relative gap-6 p-4">
        
        <!-- Drum 1: ‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ (Male) - Lower Pitch -->
        <div class="relative w-full aspect-square max-h-[35vh] flex justify-center items-center">
            <div id="drum-low" class="drum-head w-full h-full" data-drum="male">
                <div class="drum-center"></div>
                <span class="tap-zone-label top-4 left-1/2 transform -translate-x-1/2">‡∏Ç‡∏≠‡∏ö (‡∏ï‡∏¥‡∏á)</span>
                <span class="tap-zone-label top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-black/40">‡∏Å‡∏•‡∏≤‡∏á (‡πÇ‡∏à‡πä‡∏∞)</span>
            </div>
            <!-- Decorative Ropes -->
            <div class="rope" style="top: -15px; left: 20%; transform: rotate(-10deg);"></div>
            <div class="rope" style="top: -15px; right: 20%; transform: rotate(10deg);"></div>
            <div class="rope" style="bottom: -15px; left: 20%; transform: rotate(10deg);"></div>
            <div class="rope" style="bottom: -15px; right: 20%; transform: rotate(-10deg);"></div>
            <div class="absolute -bottom-6 text-[#e6d5b8] text-sm font-bold opacity-80">‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ (Male)</div>
        </div>

        <!-- Drum 2: ‡∏ï‡∏±‡∏ß‡πÄ‡∏°‡∏µ‡∏¢ (Female) - Higher Pitch -->
        <div class="relative w-full aspect-square max-h-[35vh] flex justify-center items-center">
            <div id="drum-high" class="drum-head w-full h-full" data-drum="female">
                <div class="drum-center"></div>
                <span class="tap-zone-label top-4 left-1/2 transform -translate-x-1/2">‡∏Ç‡∏≠‡∏ö (‡∏à‡πä‡∏∞)</span>
                <span class="tap-zone-label top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-black/40">‡∏Å‡∏•‡∏≤‡∏á (‡∏ï‡πâ‡∏°)</span>
            </div>
            <div class="absolute -bottom-6 text-[#e6d5b8] text-sm font-bold opacity-80">‡∏ï‡∏±‡∏ß‡πÄ‡∏°‡∏µ‡∏¢ (Female)</div>
        </div>

    </div>

    <!-- Controls -->
    <div class="control-panel pb-6 pt-3 safe-area-bottom">
        <button id="btn-record" class="btn" onclick="toggleRecording()">
            <span id="record-text">‚ö™ ‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</span>
        </button>
        <button id="btn-play" class="btn bg-gray-600" onclick="playRecording()" disabled>
            ‚ñ∂Ô∏è ‡πÄ‡∏•‡πà‡∏ô
        </button>
        <button id="btn-download" class="btn bg-gray-600" onclick="downloadRecording()" disabled>
            ‚¨áÔ∏è ‡πÇ‡∏´‡∏•‡∏î
        </button>
    </div>

    <!-- Start Overlay -->
    <div id="start-overlay" onclick="startApp()">
        <div class="text-6xl mb-4">ü•Å</div>
        <h2 class="text-2xl font-bold mb-2">‡∏Å‡∏•‡∏≠‡∏á‡πÅ‡∏Ç‡∏Å‡∏à‡∏≥‡∏•‡∏≠‡∏á</h2>
        <p class="mb-6 opacity-80">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á)</p>
        <div class="animate-bounce bg-[#e6d5b8] text-[#2c1e12] px-6 py-2 rounded-full font-bold shadow-lg cursor-pointer">
            ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏¢
        </div>
    </div>

    <script>
        // --- 1. Sound Configuration (‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ) ---
        const soundUrls = {
            male: {
                center: "kongkang/joman.wav", // ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á "‡πÇ‡∏à‡πä‡∏∞" (‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ-‡∏Å‡∏•‡∏≤‡∏á) ‡πÄ‡∏ä‡πà‡∏ô 'sounds/jo.mp3'
                rim: "kongkang/thingman.wav"     // ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á "‡∏ï‡∏¥‡∏á" (‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ-‡∏Ç‡∏≠‡∏ö)
            },
            female: {
                center: "kongkang/thingwo.wav", // ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á "‡∏ï‡πâ‡∏°" (‡∏ï‡∏±‡∏ß‡πÄ‡∏°‡∏µ‡∏¢-‡∏Å‡∏•‡∏≤‡∏á)
                rim: "kongkang/jowo.wav"     // ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á "‡∏à‡πä‡∏∞" (‡∏ï‡∏±‡∏ß‡πÄ‡∏°‡∏µ‡∏¢-‡∏Ç‡∏≠‡∏ö)
            }
        };

        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß
        const audioBuffers = {
            male: { center: null, rim: null },
            female: { center: null, rim: null }
        };

        // --- Audio Engine Setup ---
        let audioCtx;
        let masterGain;
        let compressor;
        let dest; 
        let mediaRecorder;
        let recordedChunks = [];
        let audioBlob;
        let audioUrl;
        
        async function initAudio() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
                
                // Dynamics Compressor (Limiter)
                compressor = audioCtx.createDynamicsCompressor();
                compressor.threshold.value = -10;
                compressor.knee.value = 0;
                compressor.ratio.value = 20;
                compressor.attack.value = 0.001;
                compressor.release.value = 0.1;

                // Master Gain
                masterGain = audioCtx.createGain();
                masterGain.gain.value = 1.8;

                masterGain.connect(compressor);
                compressor.connect(audioCtx.destination);

                // Setup Recording
                dest = audioCtx.createMediaStreamDestination();
                compressor.connect(dest);

                // Load custom sounds if URLs provided
                await loadAllCustomSounds();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        // --- Custom Sound Loader & Processing ---
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡∏´‡∏±‡∏ß‡πÑ‡∏ü‡∏•‡πå (Trim Silence)
        function trimSilence(buffer) {
            const rawData = buffer.getChannelData(0); // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å Channel ‡∏ã‡πâ‡∏≤‡∏¢
            const len = rawData.length;
            const threshold = 0.005; // ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö

            // ‡∏´‡∏≤‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á (Start Offset)
            let start = 0;
            for(let i = 0; i < len; i++){
                if(Math.abs(rawData[i]) > threshold){
                    start = i;
                    break;
                }
            }

            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏á‡∏µ‡∏¢‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡∏ó‡∏±‡πâ‡∏á‡πÑ‡∏ü‡∏•‡πå ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
            if(start === 0 || start === len) return buffer;

            // ‡∏ï‡∏±‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏°‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á Buffer ‡πÉ‡∏´‡∏°‡πà
            const newLen = len - start;
            const newBuffer = audioCtx.createBuffer(buffer.numberOfChannels, newLen, buffer.sampleRate);
            
            for(let ch = 0; ch < buffer.numberOfChannels; ch++){
                const oldData = buffer.getChannelData(ch);
                const newData = newBuffer.getChannelData(ch);
                // Copy ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö Manual (‡πÉ‡∏ä‡πâ loop ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î)
                for(let i = 0; i < newLen; i++){
                    newData[i] = oldData[i + start];
                }
            }
            return newBuffer;
        }

        async function loadSound(url) {
            if (!url) return null;
            try {
                // 1. Fetch File
                const response = await fetch(url);
                const arrayBuffer = await response.arrayBuffer();
                
                // 2. Decode Audio Data to Buffer
                let audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
                
                // 3. Trim Silence (Pre-process)
                audioBuffer = trimSilence(audioBuffer);
                
                console.log(`Loaded and trimmed: ${url}`);
                return audioBuffer;
            } catch (e) {
                console.warn("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ:", url, e);
                return null;
            }
        }

        async function loadAllCustomSounds() {
            // ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ö‡∏ö Parallel ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß
            const promises = [];
            if(soundUrls.male.center) promises.push(loadSound(soundUrls.male.center).then(b => audioBuffers.male.center = b));
            if(soundUrls.male.rim)    promises.push(loadSound(soundUrls.male.rim).then(b => audioBuffers.male.rim = b));
            if(soundUrls.female.center) promises.push(loadSound(soundUrls.female.center).then(b => audioBuffers.female.center = b));
            if(soundUrls.female.rim)    promises.push(loadSound(soundUrls.female.rim).then(b => audioBuffers.female.rim = b));
            await Promise.all(promises);
        }

        // --- Play Sound Logic (File Only) ---
        function playSound(zone, drumType) {
            if (!audioCtx) initAudio();
            const t = audioCtx.currentTime;

            // Check if file is loaded
            const customBuffer = audioBuffers[drumType]?.[zone];
            if (customBuffer) {
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á Node
                const source = audioCtx.createBufferSource();
                const gainNode = audioCtx.createGain(); // ‡πÄ‡∏û‡∏¥‡πà‡∏° Gain Node ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Fade
                
                source.buffer = customBuffer;
                
                // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: Source -> Gain -> Master
                source.connect(gainNode);
                gainNode.connect(masterGain);

                // --- Envelope: Fade In/Out (‡∏£‡∏∞‡∏î‡∏±‡∏ö ms) ---
                // Fade In 2ms (‡πÅ‡∏Å‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°)
                gainNode.gain.setValueAtTime(0, t);
                gainNode.gain.linearRampToValueAtTime(1, t + 0.002);

                // Fade Out ‡∏ï‡∏≠‡∏ô‡∏à‡∏ö‡πÑ‡∏ü‡∏•‡πå (‡πÅ‡∏Å‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ï‡∏≠‡∏ô‡∏à‡∏ö)
                const duration = customBuffer.duration;
                if (duration > 0.01) {
                    gainNode.gain.setValueAtTime(1, t + duration - 0.005); // ‡∏Ñ‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏á‡πÑ‡∏ß‡πâ‡∏à‡∏ô‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡∏à‡∏ö
                    gainNode.gain.linearRampToValueAtTime(0, t + duration); // Fade out 5ms ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
                }

                source.start(t);
            } else {
                // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á
                console.warn(`‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö: ${drumType} (${zone}) - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏ô soundUrls`);
            }
        }

        // --- Interaction Logic ---
        
        function handleHit(element, e) {
            e.preventDefault(); 
            initAudio();

            const rect = element.getBoundingClientRect();
            if (e.changedTouches) {
                for (let i = 0; i < e.changedTouches.length; i++) {
                    processTouch(element, e.changedTouches[i].clientX, e.changedTouches[i].clientY, rect);
                }
            } else {
                processTouch(element, e.clientX, e.clientY, rect);
            }
        }

        function processTouch(element, x, y, rect) {
            element.classList.add('active');
            setTimeout(() => element.classList.remove('active'), 80);

            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            const touchX = x - rect.left;
            const touchY = y - rect.top;
            const dist = Math.sqrt(Math.pow(touchX - centerX, 2) + Math.pow(touchY - centerY, 2));
            const centerZoneRadius = (rect.width / 2) * 0.45;

            const drumType = element.dataset.drum; // 'male' or 'female'

            if (dist < centerZoneRadius) {
                // Center Hit
                playSound('center', drumType);
            } else {
                // Rim Hit
                playSound('rim', drumType);
            }
        }

        // Bind Events
        const drums = document.querySelectorAll('.drum-head');
        drums.forEach(drum => {
            drum.addEventListener('touchstart', (e) => handleHit(drum, e), { passive: false });
            drum.addEventListener('mousedown', (e) => handleHit(drum, e));
        });

        // --- Recording Logic ---

        let isRecording = false;

        function toggleRecording() {
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        }

        function startRecording() {
            initAudio();
            recordedChunks = [];
            const options = MediaRecorder.isTypeSupported('audio/webm') ? { mimeType: 'audio/webm' } : {};
            
            try {
                mediaRecorder = new MediaRecorder(dest.stream, options);
            } catch (e) {
                alert("Browser recording not fully supported.");
                return;
            }

            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) recordedChunks.push(e.data);
            };

            mediaRecorder.onstop = () => {
                audioBlob = new Blob(recordedChunks, { type: 'audio/webm' });
                audioUrl = URL.createObjectURL(audioBlob);
                
                document.getElementById('btn-play').disabled = false;
                document.getElementById('btn-play').classList.remove('bg-gray-600');
                document.getElementById('btn-play').classList.add('bg-green-600');
                
                document.getElementById('btn-download').disabled = false;
                document.getElementById('btn-download').classList.remove('bg-gray-600');
                document.getElementById('btn-download').classList.add('bg-blue-600');
            };

            mediaRecorder.start();
            isRecording = true;
            
            const btn = document.getElementById('btn-record');
            btn.classList.add('recording');
            document.getElementById('record-text').innerText = "‚èπ ‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏î";
        }

        function stopRecording() {
            mediaRecorder.stop();
            isRecording = false;
            
            const btn = document.getElementById('btn-record');
            btn.classList.remove('recording');
            document.getElementById('record-text').innerText = "üî¥ ‡∏≠‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà";
        }

        function playRecording() {
            if (!audioUrl) return;
            const audio = new Audio(audioUrl);
            audio.play();
        }

        function downloadRecording() {
            if (!audioUrl) return;
            const a = document.createElement('a');
            a.href = audioUrl;
            a.download = `glong-khaek-${new Date().getTime()}.webm`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // --- App Start ---
        function startApp() {
            initAudio();
            // createNoiseBuffer(); // ‡∏•‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏±‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏≠‡∏Å
            document.getElementById('start-overlay').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('start-overlay').style.display = 'none';
            }, 500);
        }

        window.oncontextmenu = function(event) {
            event.preventDefault();
            event.stopPropagation();
            return false;
        };

    </script>
</body>
</html>
