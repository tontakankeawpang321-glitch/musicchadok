<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>‡∏Å‡∏•‡∏≠‡∏á‡∏¢‡∏≤‡∏ß‡∏à‡∏≥‡∏•‡∏≠‡∏á (Virtual Klong Yao)</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

<style>
@import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
body{
    font-family:'Sarabun',sans-serif;
    background:#2d1b0e;
    overflow:hidden;
    touch-action:none;
    user-select:none;
}
.drum-head{
    background:radial-gradient(circle,#f3e5ab 0%,#e0c87e 55%,#b69b4c 100%);
    box-shadow:
        inset 0 0 30px rgba(0,0,0,.3),
        0 0 0 12px #5c3a21,
        0 0 0 24px #8b5a2b,
        0 18px 30px rgba(0,0,0,.6);
    cursor:pointer;
}
.khoon{
    position:absolute;
    inset:28%;
    border-radius:50%;
    background:radial-gradient(circle,#3e2723 0%,#5d4037 70%,transparent 100%);
}
.hit-anim{
    position:fixed;
    width:20px;height:20px;
    background:rgba(255,255,255,.6);
    border-radius:50%;
    animation:ripple .15s ease-out forwards;
    pointer-events:none;
}
@keyframes ripple{
    from{transform:scale(.5);opacity:.8}
    to{transform:scale(1.5);opacity:0}
}
</style>
</head>

<body class="h-screen flex flex-col justify-between">

<!-- START -->
<div id="start-overlay" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50">
    <div onclick="initAudio()" class="cursor-pointer text-center text-white">
        <i class="fas fa-drum text-6xl text-yellow-400 mb-4"></i>
        <div class="text-2xl font-bold">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏µ‡∏Å‡∏•‡∏≠‡∏á</div>
    </div>
</div>

<!-- DRUM -->
<div class="flex-1 flex items-center justify-center">
    <div id="drum" class="drum-head w-[80vw] h-[80vw] max-w-[480px] max-h-[480px] rounded-full relative">
        <div class="khoon"></div>
    </div>
</div>

<!-- CONTROLS -->
<div class="bg-black/40 backdrop-blur-md p-4 flex justify-center gap-3">
    <button id="recBtn" onclick="toggleRecord()" class="w-16 h-16 rounded-full bg-red-600 text-white">
        <i class="fas fa-microphone"></i>
    </button>
    <button id="playBtn" onclick="playRecording()" disabled class="w-16 h-16 rounded-xl bg-blue-600 text-white opacity-40">
        <i class="fas fa-play"></i>
    </button>
    <button id="downBtn" onclick="downloadRecording()" disabled class="w-16 h-16 rounded-xl bg-green-600 text-white opacity-40">
        <i class="fas fa-download"></i>
    </button>
</div>

<script>
/* =======================
   CONFIG
======================= */
const soundUrls = {
    bom: 'konglong/momlong.wav',
    pa: 'konglong/paklong.wav',
    poeng: 'konglong/pengkob.wav'
};

let audioCtx, masterGain, compressor, reverbNode, reverbGain;
let audioBuffers = {};
let destStream, recorder, recordedChunks=[], audioUrl;
let isRecording=false;

/* =======================
   INIT AUDIO
======================= */
async function initAudio(){
    if(audioCtx) return;
    audioCtx = new (window.AudioContext||window.webkitAudioContext)({latencyHint:'interactive'});

    compressor = audioCtx.createDynamicsCompressor();
    compressor.threshold.value = -22;
    compressor.knee.value = 24;
    compressor.ratio.value = 3.2;
    compressor.attack.value = 0.02;
    compressor.release.value = 0.22;

    masterGain = audioCtx.createGain();
    masterGain.gain.value = 1.6; // üî• ‡∏î‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö

    compressor.connect(audioCtx.destination);
    masterGain.connect(compressor);

    destStream = audioCtx.createMediaStreamDestination();
    compressor.connect(destStream);

    await setupReverb();
    await loadSoundFiles();

    document.getElementById('start-overlay').style.display='none';
}

/* =======================
   REVERB
======================= */
async function setupReverb(){
    reverbNode = audioCtx.createConvolver();
    reverbGain = audioCtx.createGain();
    reverbGain.gain.value = 0.25;

    const len = audioCtx.sampleRate * .8;
    const impulse = audioCtx.createBuffer(2,len,audioCtx.sampleRate);
    for(let c=0;c<2;c++){
        const d = impulse.getChannelData(c);
        for(let i=0;i<len;i++){
            d[i]=(Math.random()*2-1)*Math.pow(1-i/len,3);
        }
    }
    reverbNode.buffer = impulse;
    reverbGain.connect(reverbNode);
    reverbNode.connect(masterGain);
}

/* =======================
   LOAD FILES (NO TRIM)
======================= */
async function loadSoundFiles(){
    for(const k in soundUrls){
        const res = await fetch(soundUrls[k]);
        audioBuffers[k] = await audioCtx.decodeAudioData(await res.arrayBuffer());
    }
}

/* =======================
   PLAY SOUND
======================= */
function playSound(type){
    if(!audioCtx) return;
    const t = audioCtx.currentTime;

    const src = audioCtx.createBufferSource();
    src.buffer = audioBuffers[type];

    const filter = audioCtx.createBiquadFilter();
    filter.type='lowpass';
    if(type==='bom'){
        filter.frequency.value = 6500; // üî• ‡πÄ‡∏õ‡∏¥‡∏î harmonic ‡πÄ‡∏ï‡πá‡∏°
        filter.Q.value = 0.9;
    }else{
        filter.frequency.value = 2200;
        filter.Q.value = 0.8;
    }

    const gain = audioCtx.createGain();
    gain.gain.setValueAtTime(0,t);

    const peak = type==='bom'?6.5:1.1;   // üî• ‡∏ö‡πà‡∏≠‡∏°‡∏î‡∏±‡∏á‡∏™‡∏∏‡∏î
    const decay = type==='bom'?1.0:0.4;

    gain.gain.linearRampToValueAtTime(peak,t+.01);
    gain.gain.exponentialRampToValueAtTime(.001,t+decay);

    src.connect(filter);
    filter.connect(gain);
    gain.connect(masterGain);
    gain.connect(reverbGain);

    /* SUB HARMONIC ‚Äì ‡∏™‡∏±‡πà‡∏ô‡∏•‡∏≥‡πÇ‡∏û‡∏á‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
    if(type==='bom'){
        const sub = audioCtx.createOscillator();
        const subGain = audioCtx.createGain();
        sub.type='sine';
        sub.frequency.value=55;
        subGain.gain.setValueAtTime(1.4,t);
        subGain.gain.exponentialRampToValueAtTime(.001,t+.6);
        sub.connect(subGain);
        subGain.connect(masterGain);
        sub.start(t);
        sub.stop(t+.6);
    }

    src.start(t);
}

/* =======================
   HIT
======================= */
const drum=document.getElementById('drum');
drum.addEventListener('mousedown',e=>{
    const r=drum.getBoundingClientRect();
    const dx=e.clientX-(r.left+r.width/2);
    const dy=e.clientY-(r.top+r.height/2);
    const d=Math.sqrt(dx*dx+dy*dy)/(r.width/2);

    if(d<.35) playSound('bom');
    else if(d>.75) playSound('poeng');
    else playSound('pa');

    const h=document.createElement('div');
    h.className='hit-anim';
    h.style.left=e.clientX+'px';
    h.style.top=e.clientY+'px';
    document.body.appendChild(h);
    setTimeout(()=>h.remove(),200);
});

/* =======================
   RECORD
======================= */
function toggleRecord(){
    if(!isRecording){
        recordedChunks=[];
        recorder=new MediaRecorder(destStream.stream);
        recorder.ondataavailable=e=>recordedChunks.push(e.data);
        recorder.onstop=()=>{
            audioUrl=URL.createObjectURL(new Blob(recordedChunks,{type:'audio/webm'}));
            playBtn.disabled=false;
            downBtn.disabled=false;
            playBtn.classList.remove('opacity-40');
            downBtn.classList.remove('opacity-40');
        };
        recorder.start();
        isRecording=true;
        recBtn.innerHTML='<i class="fas fa-stop"></i>';
    }else{
        recorder.stop();
        isRecording=false;
        recBtn.innerHTML='<i class="fas fa-microphone"></i>';
    }
}

function playRecording(){
    if(audioUrl) new Audio(audioUrl).play();
}
function downloadRecording(){
    const a=document.createElement('a');
    a.href=audioUrl;
    a.download='klong-yao-recording.webm';
    a.click();
}
</script>
</body>
</html>
