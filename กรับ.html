<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏Å‡∏£‡∏±‡∏ö‡πÑ‡∏ó‡∏¢ - Thai Krap Simulator</title>
    <meta name="description" content="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏ô‡∏ï‡∏£‡∏µ‡πÑ‡∏ó‡∏¢‡∏à‡∏≥‡∏•‡∏≠‡∏á ‡∏Å‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏†‡∏≤ ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏°‡∏à‡∏£‡∏¥‡∏á ‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ">
    <style>
        /* ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô */
            background-color: #1a1a1a;
            font-family: 'Sarabun', sans-serif;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            touch-action: none; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô gesture ‡∏Ç‡∏≠‡∏á browser */
        }

        /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏•‡∏≤‡∏¢‡πÑ‡∏°‡πâ‡∏à‡∏≤‡∏á‡πÜ */
        .bg-pattern {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: repeating-linear-gradient(45deg, #2b2b2b 25%, transparent 25%, transparent 75%, #2b2b2b 75%, #2b2b2b), repeating-linear-gradient(45deg, #2b2b2b 25%, #1a1a1a 25%, #1a1a1a 75%, #2b2b2b 75%, #2b2b2b);
            background-position: 0 0, 10px 10px;
            background-size: 20px 20px;
            opacity: 0.1;
            z-index: -1;
        }

        /* ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß */
        header {
            padding: 15px;
            text-align: center;
            z-index: 10;
            width: 100%;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        }

        h1 {
            margin: 0;
            font-size: 1.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            color: #ffd700; /* ‡∏™‡∏µ‡∏ó‡∏≠‡∏á */
        }

        /* ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏±‡∏ö (Main Stage) */
        .stage {
            flex-grow: 1;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            perspective: 800px;
            cursor: pointer;
        }

        /* ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏±‡∏ö (Krap) */
        .krap-container {
            position: relative;
            width: 220px;
            height: 220px;
            transition: transform 0.1s;
        }

        .krap-stick {
            position: absolute;
            width: 60px;
            height: 200px;
            background: #4e342e; /* ‡∏™‡∏µ‡πÑ‡∏°‡πâ‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô (‡πÑ‡∏°‡πâ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÅ‡∏Ç‡πá‡∏á) */
            border-radius: 8px;
            box-shadow: 
                inset 5px 0 10px rgba(0,0,0,0.6),
                inset -2px 0 5px rgba(255,255,255,0.05),
                8px 8px 20px rgba(0,0,0,0.6);
            /* ‡∏õ‡∏£‡∏±‡∏ö‡∏•‡∏≤‡∏¢‡πÑ‡∏°‡πâ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏™‡∏°‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏∂‡πâ‡∏ô */
            background-image: 
                linear-gradient(90deg, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0) 15%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0) 85%),
                repeating-linear-gradient(178deg, transparent, transparent 10px, rgba(0,0,0,0.08) 12px, transparent 15px);
        }

        .krap-left {
            left: 40px;
            top: 10px;
            transform: rotate(-10deg);
            z-index: 1;
            transition: transform 0.08s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-origin: bottom center;
        }

        .krap-right {
            right: 40px;
            top: 10px;
            transform: rotate(10deg);
            z-index: 2;
            transition: transform 0.08s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-origin: bottom center;
        }

        /* Animation ‡∏ï‡∏≠‡∏ô‡∏ï‡∏µ */
        .krap-container.active .krap-left {
            transform: rotate(2deg) translateX(12px);
        }
        
        .krap-container.active .krap-right {
            transform: rotate(-2deg) translateX(-12px);
        }

        /* Visual Effect (Note/Spark) */
        .visual-hit {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 2px solid #ffd700;
            opacity: 0;
            pointer-events: none;
            z-index: 5;
        }

        .visual-hit.animate {
            animation: ripple 0.3s ease-out;
        }

        @keyframes ripple {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0.8; border-width: 4px; }
            100% { transform: translate(-50%, -50%) scale(1.8); opacity: 0; border-width: 0px; }
        }

        /* ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° */
        .controls {
            width: 100%;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px 10px;
            border-top: 1px solid #444;
            display: flex;
            justify-content: center;
            gap: 15px;
            z-index: 20;
            flex-wrap: wrap;
        }

        .btn {
            background: #333;
            color: white;
            border: 1px solid #555;
            padding: 10px 15px;
            border-radius: 50px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            outline: none;
            min-width: 100px;
            justify-content: center;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn.recording {
            background: #d32f2f;
            border-color: #ff5252;
            animation: pulse 1.5s infinite;
        }

        .btn.playing {
            background: #2e7d32;
            border-color: #69f0ae;
        }

        .btn-icon {
            font-size: 1.2rem;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(211, 47, 47, 0); }
            100% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0); }
        }

        /* ‡∏ï‡∏±‡∏ß‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */
        .status-bar {
            position: absolute;
            top: 60px;
            background: rgba(0,0,0,0.6);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            color: #aaa;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .status-bar.show {
            opacity: 1;
        }

        /* Overlay ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Audio Context ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô */
        #start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }
        
        #start-btn {
            margin-top: 20px;
            padding: 15px 40px;
            font-size: 1.2rem;
            background: #ffd700;
            color: black;
            border: none;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* ‡∏ã‡πà‡∏≠‡∏ô Audio Player ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô */
        audio {
            display: none;
        }

    </style>
</head>
<body>

    <div class="bg-pattern"></div>

    <header>
        <h1>‡∏Å‡∏£‡∏±‡∏ö‡πÑ‡∏ó‡∏¢ (Thai Krap)</h1>
    </header>

    <div id="status-display" class="status-bar">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>

    <div class="stage" id="touch-area">
        <div class="visual-hit" id="visual-hit"></div>
        <div class="krap-container" id="krap-model">
            <div class="krap-stick krap-left"></div>
            <div class="krap-stick krap-right"></div>
        </div>
    </div>

    <div class="controls">
        <button class="btn" id="btn-record">
            <span class="btn-icon">‚óè</span> ‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á
        </button>
        <button class="btn" id="btn-play" disabled>
            <span class="btn-icon">‚ñ∂</span> ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á
        </button>
        <button class="btn" id="btn-download" disabled>
            <span class="btn-icon">‚¨á</span> ‡πÇ‡∏´‡∏•‡∏î
        </button>
        <button class="btn" id="btn-visual" style="background: #444;">
            <span class="btn-icon">üëÅ</span> ‡πÇ‡∏ô‡πâ‡∏ï
        </button>
    </div>

    <!-- Hidden Audio Element for Playback -->
    <audio id="playback-audio"></audio>

    <!-- Start Overlay -->
    <div id="start-overlay">
        <div style="font-size: 4rem; margin-bottom: 20px;">ü™µ</div>
        <h2>‡∏Å‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏†‡∏≤‡∏à‡∏≥‡∏•‡∏≠‡∏á</h2>
        <p>‡πÅ‡∏ï‡∏∞‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
        <button id="start-btn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button>
    </div>

    <script>
        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á URL ‡πÄ‡∏™‡∏µ‡∏¢‡∏á (Sound Configuration) ---
        // ‚ö†Ô∏è ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏´‡∏£‡∏∑‡∏≠ Base64 String ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏≠‡∏Å‡∏°‡∏≤ (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ï‡∏±‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏±‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß)
        const CUSTOM_SOUND_URL = "krub/krub.wav"; 

        // --- Configuration & State ---
        const state = {
            audioContext: null,
            isRecording: false,
            recorder: null,
            audioChunks: [],
            audioBlob: null,
            destination: null, 
            visualsEnabled: true,
            canPlay: false,
            krapBuffer: null, // Preloaded AudioBuffer
            compressor: null 
        };

        const dom = {
            krapModel: document.getElementById('krap-model'),
            touchArea: document.getElementById('touch-area'),
            visualHit: document.getElementById('visual-hit'),
            btnRecord: document.getElementById('btn-record'),
            btnPlay: document.getElementById('btn-play'),
            btnDownload: document.getElementById('btn-download'),
            btnVisual: document.getElementById('btn-visual'),
            status: document.getElementById('status-display'),
            overlay: document.getElementById('start-overlay'),
            startBtn: document.getElementById('start-btn'),
            audioPlayer: document.getElementById('playback-audio')
        };

        // --- Advance Audio Processing ---

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡∏´‡∏±‡∏ß-‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á (Trim Silence)
        function trimSilence(buffer) {
            const channelData = buffer.getChannelData(0); // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å Channel ‡∏ã‡πâ‡∏≤‡∏¢
            let start = 0;
            let end = channelData.length;
            const threshold = 0.005; // ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏á‡∏µ‡∏¢‡∏ö (-46dB)

            // ‡∏´‡∏≤‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á
            for (let i = 0; i < channelData.length; i++) {
                if (Math.abs(channelData[i]) > threshold) {
                    start = i;
                    break;
                }
            }

            // ‡∏´‡∏≤‡∏à‡∏∏‡∏î‡∏à‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á
            for (let i = channelData.length - 1; i >= 0; i--) {
                if (Math.abs(channelData[i]) > threshold) {
                    end = i + 1;
                    break;
                }
            }

            if (end <= start) return buffer; // ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡∏™‡∏ô‡∏¥‡∏ó ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Buffer ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á
            const newLength = end - start;
            const newBuffer = state.audioContext.createBuffer(buffer.numberOfChannels, newLength, buffer.sampleRate);

            for (let channel = 0; channel < buffer.numberOfChannels; channel++) {
                const oldData = buffer.getChannelData(channel);
                const newData = newBuffer.getChannelData(channel);
                for (let i = 0; i < newLength; i++) {
                    newData[i] = oldData[i + start];
                }
            }
            console.log(`Trimmed silence: start=${start}, length=${newLength}`);
            return newBuffer;
        }

        // --- Audio Engine ---
        async function initAudio() {
            if (!state.audioContext) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                state.audioContext = new AudioContext();
                
                // 1. Dynamics Compressor (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏ï‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏£‡∏±‡∏ß)
                state.compressor = state.audioContext.createDynamicsCompressor();
                state.compressor.threshold.setValueAtTime(-10, state.audioContext.currentTime);
                state.compressor.knee.setValueAtTime(40, state.audioContext.currentTime);
                state.compressor.ratio.setValueAtTime(12, state.audioContext.currentTime);
                state.compressor.attack.setValueAtTime(0, state.audioContext.currentTime);
                state.compressor.release.setValueAtTime(0.25, state.audioContext.currentTime);

                state.destination = state.audioContext.createMediaStreamDestination();

                // Chain: Compressor -> Speaker & Recorder
                state.compressor.connect(state.audioContext.destination);
                state.compressor.connect(state.destination);

                // 2. Preload & Decode Sound (Real File Only)
                if (CUSTOM_SOUND_URL && CUSTOM_SOUND_URL.length > 0) {
                    try {
                        const response = await fetch(CUSTOM_SOUND_URL);
                        const arrayBuffer = await response.arrayBuffer();
                        const rawBuffer = await state.audioContext.decodeAudioData(arrayBuffer);
                        // ‡∏ï‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                        state.krapBuffer = trimSilence(rawBuffer);
                        showStatus("‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                    } catch (e) {
                        console.error("Load sound failed", e);
                        showStatus("‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                    }
                } else {
                    showStatus("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà URL ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î");
                }
            }
            
            if (state.audioContext.state === 'suspended') {
                state.audioContext.resume();
            }
        }

        function playKrapSound() {
            if (!state.audioContext || !state.krapBuffer) return;

            const t = state.audioContext.currentTime;

            // 1. Source (AudioBufferSourceNode) - ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
            const source = state.audioContext.createBufferSource();
            source.buffer = state.krapBuffer;
            
            // Randomize Pitch ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (Humanize)
            source.detune.value = (Math.random() * 100) - 50;

            // 2. Envelope Gain (Micro-fades)
            // ‡πÉ‡∏ä‡πâ GainNode ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥ Fade in/out ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á "‡∏Ñ‡∏•‡∏¥‡∏Å" (Pop/Click) ‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏ß‡πÅ‡∏•‡∏∞‡∏ó‡πâ‡∏≤‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á
            const envelope = state.audioContext.createGain();
            
            // Fade In: 2ms (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á Click ‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ñ‡πâ‡∏≤ waveform ‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà 0)
            envelope.gain.setValueAtTime(0, t);
            envelope.gain.linearRampToValueAtTime(1, t + 0.002);

            // Fade Out: 5ms ‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏ö‡πÑ‡∏ü‡∏•‡πå (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á Click ‡∏ï‡∏≠‡∏ô‡∏à‡∏ö)
            const duration = state.krapBuffer.duration;
            envelope.gain.setValueAtTime(1, t + duration - 0.005);
            envelope.gain.linearRampToValueAtTime(0, t + duration);

            // Connect Graph
            source.connect(envelope);
            envelope.connect(state.compressor);
            
            source.start(t);
        }

        // --- Visual Logic ---
        function triggerVisuals() {
            dom.krapModel.style.animation = 'none';
            dom.krapModel.offsetHeight; /* trigger reflow */
            dom.krapModel.style.animation = null; 
            
            dom.krapModel.classList.add('active');
            
            setTimeout(() => {
                dom.krapModel.classList.remove('active');
            }, 80);

            if (state.visualsEnabled) {
                const ripple = dom.visualHit.cloneNode(true);
                dom.touchArea.appendChild(ripple);
                ripple.style.display = 'block';
                ripple.classList.add('animate');
                
                setTimeout(() => {
                    ripple.remove();
                }, 400);
            }
        }

        function handleTap(e) {
            if(e && e.cancelable) e.preventDefault();
            if (!state.canPlay) return;

            playKrapSound();
            triggerVisuals();
        }

        // --- Recording Logic ---
        function toggleRecording() {
            if (state.isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            if (!state.audioContext) initAudio();
            
            state.audioChunks = [];
            
            try {
                let options = { mimeType: 'audio/webm' };
                if (!MediaRecorder.isTypeSupported('audio/webm')) {
                    options = { mimeType: 'audio/mp4' };
                    if (!MediaRecorder.isTypeSupported('audio/mp4')) {
                        options = undefined;
                    }
                }

                state.recorder = new MediaRecorder(state.destination.stream, options);
                
                state.recorder.ondataavailable = (e) => {
                    if (e.data.size > 0) state.audioChunks.push(e.data);
                };

                state.recorder.onstop = () => {
                    state.audioBlob = new Blob(state.audioChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(state.audioBlob);
                    dom.audioPlayer.src = audioUrl;
                    
                    dom.btnPlay.disabled = false;
                    dom.btnDownload.disabled = false;
                    showStatus("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô");
                    dom.btnRecord.innerHTML = '<span class="btn-icon">‚óè</span> ‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á';
                    dom.btnRecord.classList.remove('recording');
                };

                state.recorder.start();
                state.isRecording = true;
                
                dom.btnRecord.innerHTML = '<span class="btn-icon">‚ñ†</span> ‡∏´‡∏¢‡∏∏‡∏î';
                dom.btnRecord.classList.add('recording');
                showStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á...");
                
                dom.btnPlay.disabled = true;
                dom.btnDownload.disabled = true;

            } catch (err) {
                console.error("Recording error:", err);
                showStatus("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á");
            }
        }

        function stopRecording() {
            if (state.recorder && state.isRecording) {
                state.recorder.stop();
                state.isRecording = false;
            }
        }

        function playRecording() {
            if (!state.audioBlob) return;
            
            dom.audioPlayer.play();
            dom.btnPlay.innerHTML = '<span class="btn-icon">‚ùö‚ùö</span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô';
            dom.btnPlay.classList.add('playing');
            
            dom.audioPlayer.onended = () => {
                dom.btnPlay.innerHTML = '<span class="btn-icon">‚ñ∂</span> ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á';
                dom.btnPlay.classList.remove('playing');
            };
        }

        function downloadRecording() {
            if (!state.audioBlob) return;
            
            const url = URL.createObjectURL(state.audioBlob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'thai_krap_recording.webm';
            document.body.appendChild(a);
            a.click();
            
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 100);
            
            showStatus("‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß");
        }

        // --- Helper ---
        function showStatus(text) {
            dom.status.textContent = text;
            dom.status.classList.add('show');
            setTimeout(() => {
                dom.status.classList.remove('show');
            }, 2000);
        }

        // --- Initialization & Event Listeners ---
        
        dom.startBtn.addEventListener('click', () => {
            initAudio();
            dom.overlay.style.opacity = '0';
            setTimeout(() => {
                dom.overlay.style.display = 'none';
            }, 500);
            state.canPlay = true;
        });

        dom.touchArea.addEventListener('touchstart', handleTap, { passive: false });
        dom.touchArea.addEventListener('mousedown', handleTap); 

        dom.btnRecord.addEventListener('click', toggleRecording);
        dom.btnPlay.addEventListener('click', playRecording);
        dom.btnDownload.addEventListener('click', downloadRecording);
        dom.btnVisual.addEventListener('click', () => {
            state.visualsEnabled = !state.visualsEnabled;
            dom.btnVisual.style.opacity = state.visualsEnabled ? '1' : '0.5';
            showStatus(state.visualsEnabled ? "‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏ô‡πâ‡∏ï" : "‡∏õ‡∏¥‡∏î‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏ô‡πâ‡∏ï");
        });

        document.addEventListener('touchmove', function(event) {
            if (event.scale !== 1) { event.preventDefault(); }
        }, { passive: false });

    </script>
</body>
</html>
