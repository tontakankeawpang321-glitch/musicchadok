<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏õ‡∏µ‡πà‡∏ä‡∏ß‡∏≤‡∏à‡∏≥‡∏•‡∏≠‡∏á (Virtual Pi Java)</title>
    <style>
        /* --- ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô --- */
        :root {
            --wood-dark: #3e2723;
            --wood-light: #5d4037;
            --gold: #ffc107;
            --bg-color: #1a1a1a;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: white;
            font-family: 'Sarabun', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ */
            touch-action: none; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô default touch actions ‡∏Ç‡∏≠‡∏á browser */
            user-select: none;
            -webkit-user-select: none;
        }

        /* --- ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° (‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô) --- */
        .control-panel {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            gap: 10px;
            z-index: 100;
            backdrop-filter: blur(5px);
        }

        .btn-control {
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-record { background-color: #e53935; color: white; }
        .btn-stop { background-color: #757575; color: white; display: none; }
        .btn-play { background-color: #43a047; color: white; }
        .btn-download { background-color: #1e88e5; color: white; }
        
        .btn-control:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-control:active { transform: scale(0.95); }

        .status-text {
            position: absolute;
            top: 60px;
            font-size: 0.8rem;
            color: var(--gold);
            text-shadow: 1px 1px 2px black;
        }

        /* --- ‡∏ï‡∏±‡∏ß‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏ô‡∏ï‡∏£‡∏µ (‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á) --- */
        .instrument-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            width: 100%;
            padding-top: 20px;
            padding-bottom: 20px;
            touch-action: none; 
        }

        /* ‡∏™‡πà‡∏ß‡∏ô‡∏¢‡∏≠‡∏î (‡∏Å‡∏≥‡∏û‡∏ß‡∏î/‡∏•‡∏¥‡πâ‡∏ô) */
        .pi-top {
            width: 20px;
            height: 40px;
            background: linear-gradient(90deg, #d4af37, #fff8e1, #d4af37);
            border-radius: 5px 5px 0 0;
            margin-bottom: -5px;
            z-index: 2;
        }

        /* ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏õ‡∏µ‡πà (‡πÄ‡∏•‡∏≤‡∏õ‡∏µ‡πà) */
        .pi-body {
            width: 60px;
            flex-grow: 1; /* ‡∏¢‡∏∑‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏à‡∏≠ */
            max-height: 70vh;
            background: linear-gradient(90deg, var(--wood-dark), var(--wood-light), var(--wood-dark));
            border-radius: 30px;
            position: relative;
            box-shadow: 5px 0 15px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            justify-content: space-evenly; /* ‡∏à‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏π‡∏ô‡∏¥‡πâ‡∏ß */
            align-items: center;
            padding: 20px 0;
            border: 2px solid #2d1b18;
        }

        /* ‡∏•‡∏ß‡∏î‡∏•‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠ */
        .pi-ring {
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #b8860b, #ffd700, #b8860b);
            position: absolute;
        }
        .ring-top { top: 10px; }
        .ring-bottom { bottom: 10px; }

        /* ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏≥‡πÇ‡∏û‡∏á (‡∏ö‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á) */
        .pi-bell {
            width: 0;
            height: 0;
            border-left: 50px solid transparent;
            border-right: 50px solid transparent;
            border-top: 80px solid var(--wood-dark);
            margin-top: -10px;
            position: relative;
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.5));
        }
        
        .pi-bell::after {
            content: '';
            position: absolute;
            top: -80px;
            left: -40px;
            width: 80px;
            height: 20px;
            background: linear-gradient(90deg, var(--wood-dark), var(--wood-light), var(--wood-dark));
            opacity: 0.5;
        }

        /* --- ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡πÇ‡∏ô‡πâ‡∏ï (‡∏£‡∏π‡∏ô‡∏¥‡πâ‡∏ß) --- */
        .note-hole {
            width: 45px;
            height: 45px;
            background: radial-gradient(circle at 30% 30%, #5d4037, #261612);
            border-radius: 50%;
            border: 3px solid #8d6e63;
            box-shadow: inset 2px 2px 5px black;
            cursor: pointer;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.05s, background 0.05s; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡πÑ‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô */
        }

        /* ‡∏™‡∏£‡πâ‡∏≤‡∏á Hitbox ‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏ö‡∏ö‡∏°‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏•‡∏≤‡∏Å‡∏ï‡πà‡∏≠‡∏ô‡∏¥‡πâ‡∏ß‡∏á‡πà‡∏≤‡∏¢ */
        .note-hole::before {
            content: '';
            position: absolute;
            top: -15px;
            bottom: -15px;
            left: -15px;
            right: -15px;
            border-radius: 50%;
            z-index: 10;
        }

        .note-hole::after {
            content: attr(data-note);
            font-size: 12px;
            color: rgba(255,255,255,0.7);
            pointer-events: none;
        }

        /* ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏ï‡∏≠‡∏ô‡∏Å‡∏î (Active State) */
        .note-hole.active {
            background: radial-gradient(circle at 30% 30%, #ffd700, #b8860b);
            border-color: #fff;
            transform: scale(0.90); /* ‡∏¢‡∏∏‡∏ö‡∏•‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
            box-shadow: 0 0 15px var(--gold);
        }
        
        .note-hole.active::after {
            color: #000;
            font-weight: bold;
        }

    </style>
</head>
<body>

    <!-- ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° -->
    <div class="control-panel">
        <button id="btnRecord" class="btn-control btn-record">
            <span>üî¥</span> ‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á
        </button>
        <button id="btnStop" class="btn-control btn-stop">
            <span>‚èπ</span> ‡∏´‡∏¢‡∏∏‡∏î
        </button>
        <button id="btnPlayRecord" class="btn-control btn-play" disabled>
            <span>‚ñ∂</span> ‡∏ü‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏î
        </button>
        <button id="btnDownload" class="btn-control btn-download" disabled>
            <span>‚¨á</span> ‡πÇ‡∏´‡∏•‡∏î
        </button>
    </div>

    <div id="status" class="status-text">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î)</div>

    <!-- ‡∏ï‡∏±‡∏ß‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏ô‡∏ï‡∏£‡∏µ -->
    <div class="instrument-container">
        <div class="pi-top"></div>
        
        <div class="pi-body">
            <div class="pi-ring ring-top"></div>
            
            <!-- ‡∏£‡∏π‡∏ô‡∏¥‡πâ‡∏ß ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏ö‡∏ô‡∏•‡∏á‡∏•‡πà‡∏≤‡∏á -->
            <div class="note-hole" data-note="High" data-index="7"></div>
            <div class="note-hole" data-note="Ti" data-index="6"></div>
            <div class="note-hole" data-note="La" data-index="5"></div>
            <div class="note-hole" data-note="Sol" data-index="4"></div>
            <div class="note-hole" data-note="Fa" data-index="3"></div>
            <div class="note-hole" data-note="Mi" data-index="2"></div>
            <div class="note-hole" data-note="Re" data-index="1"></div>
            <div class="note-hole" data-note="Do" data-index="0"></div>

            <div class="pi-ring ring-bottom"></div>
        </div>

        <div class="pi-bell"></div>
    </div>

    <script>
        // ==========================================
        // --- ‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á (USER CONFIG) ---
        // ==========================================
        const audioConfig = [
            "", // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà 1 (‡πÇ‡∏î / Low)
            "", // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà 2 (‡πÄ‡∏£)
            "", // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà 3 (‡∏°‡∏µ)
            "", // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà 4 (‡∏ü‡∏≤)
            "", // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà 5 (‡∏ã‡∏≠‡∏•)
            "", // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà 6 (‡∏•‡∏≤)
            "", // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà 7 (‡∏ó‡∏µ)
            ""  // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà 8 (‡πÇ‡∏î ‡∏™‡∏π‡∏á / High)
        ];

        // ==========================================
        // --- ‡∏£‡∏∞‡∏ö‡∏ö Audio Engine ---
        // ==========================================
        let audioContext;
        let audioBuffers = [];
        let mediaStreamDestination;
        let mediaRecorder;
        let audioChunks = [];
        let recordedBlob;
        let isRecording = false;
        const statusEl = document.getElementById('status');

        async function initAudio() {
            if (!audioContext) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioContext = new AudioContext();
                mediaStreamDestination = audioContext.createMediaStreamDestination();
                await loadSounds();
            }
            if (audioContext.state === 'suspended') {
                await audioContext.resume();
            }
        }

        async function loadSounds() {
            statusEl.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á...";
            const loadPromises = audioConfig.map(async (url, index) => {
                if (!url) return null;
                try {
                    const response = await fetch(url);
                    const arrayBuffer = await response.arrayBuffer();
                    return await audioContext.decodeAudioData(arrayBuffer);
                } catch (error) {
                    console.error(`Error loading sound ${index}:`, error);
                    return null;
                }
            });

            audioBuffers = await Promise.all(loadPromises);
            const loadedCount = audioBuffers.filter(b => b !== null).length;
            if (loadedCount === 0) {
                statusEl.innerText = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏≤‡∏ü‡∏¥‡∏Å)";
            } else {
                statusEl.innerText = `‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô (${loadedCount}/${audioConfig.length})`;
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏û)
        function playSound(index) {
            initAudio(); 

            if (audioContext && audioBuffers[index]) {
                const source = audioContext.createBufferSource();
                source.buffer = audioBuffers[index];
                source.connect(audioContext.destination);
                
                if (mediaStreamDestination) {
                    source.connect(mediaStreamDestination);
                }
                source.start(0);
            }
        }

        // ==========================================
        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™ (Robust Touch System) ---
        // ==========================================
        
        // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏ô‡∏¥‡πâ‡∏ß‡πÑ‡∏´‡∏ô (Touch ID) ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏î‡πÇ‡∏ô‡πâ‡∏ï‡πÑ‡∏´‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ã‡πâ‡∏≥‡∏ñ‡πâ‡∏≤‡∏ô‡∏¥‡πâ‡∏ß‡∏¢‡∏±‡∏á‡πÅ‡∏ä‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ñ‡πâ‡∏≤‡∏¢‡πâ‡∏≤‡∏¢‡∏£‡∏π
        const activeTouches = {}; 

        function handleTouch(e) {
            e.preventDefault(); // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏π‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏à‡∏≠

            // ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏π‡πÇ‡∏ô‡πâ‡∏ï‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Å‡∏î‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏£‡∏≤‡∏ü‡∏¥‡∏Å)
            const currentTouchedIndices = new Set();

            // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡∏ô‡∏¥‡πâ‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏à‡∏≠
            for (let i = 0; i < e.touches.length; i++) {
                const touch = e.touches[i];
                const element = document.elementFromPoint(touch.clientX, touch.clientY);

                if (element && element.classList.contains('note-hole')) {
                    const index = parseInt(element.getAttribute('data-index'));
                    
                    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏ô‡πâ‡∏ï‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡∏Å‡∏î" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏ü
                    currentTouchedIndices.add(index);

                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Logic ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á:
                    // ‡∏ñ‡πâ‡∏≤‡∏ô‡∏¥‡πâ‡∏ß‡∏ô‡∏µ‡πâ (ID ‡∏ô‡∏µ‡πâ) ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô (‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏°‡∏≤‡πÇ‡∏î‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏Å‡∏î‡∏•‡∏á‡πÑ‡∏õ)
                    if (activeTouches[touch.identifier] !== index) {
                        playSound(index);
                        activeTouches[touch.identifier] = index; // ‡∏à‡∏≥‡πÑ‡∏ß‡πâ‡∏ß‡πà‡∏≤‡∏ô‡∏¥‡πâ‡∏ß‡∏ô‡∏µ‡πâ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß
                    }
                } else {
                    // ‡∏ñ‡πâ‡∏≤‡∏ô‡∏¥‡πâ‡∏ß‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏£‡∏π‡πÇ‡∏ô‡πâ‡∏ï (‡∏•‡∏≤‡∏Å‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á)
                    // ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÇ‡∏î‡∏ô‡∏£‡∏π‡πÉ‡∏´‡∏°‡πà ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å
                    delete activeTouches[touch.identifier];
                }
            }

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (Visual Update)
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏ñ‡πâ‡∏≤‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏´‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Å‡∏î ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü, ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü
            document.querySelectorAll('.note-hole').forEach(hole => {
                const index = parseInt(hole.getAttribute('data-index'));
                if (currentTouchedIndices.has(index)) {
                    hole.classList.add('active');
                } else {
                    hole.classList.remove('active');
                }
            });
        }

        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏Å‡∏ô‡∏¥‡πâ‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        function handleTouchEnd(e) {
            e.preventDefault();
            
            // ‡∏•‡∏ö Touch ID ‡∏ó‡∏µ‡πà‡∏¢‡∏Å‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥
            // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡πâ‡∏≤‡∏á (Memory cleanup)
            const currentTouchIds = new Set();
            for (let i = 0; i < e.touches.length; i++) {
                currentTouchIds.add(e.touches[i].identifier);
            }

            for (const id in activeTouches) {
                if (!currentTouchIds.has(parseInt(id))) {
                    delete activeTouches[id];
                }
            }

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å handleTouch ‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÑ‡∏ü‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏¥‡πâ‡∏ß‡∏¢‡∏Å‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
            handleTouch(e); 
        }

        const instrumentContainer = document.querySelector('.instrument-container');
        
        // ‡πÉ‡∏ä‡πâ Touch Events ‡πÅ‡∏ö‡∏ö Full-Screen Container ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏´‡∏•
        instrumentContainer.addEventListener('touchstart', handleTouch, { passive: false });
        instrumentContainer.addEventListener('touchmove', handleTouch, { passive: false }); // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å (Glissando)
        instrumentContainer.addEventListener('touchend', handleTouchEnd);
        instrumentContainer.addEventListener('touchcancel', handleTouchEnd);

        // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Mouse ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ö‡∏ô‡∏Ñ‡∏≠‡∏° (‡∏Ñ‡∏•‡∏¥‡∏Å+‡∏•‡∏≤‡∏Å)
        let isMouseDown = false;
        instrumentContainer.addEventListener('mousedown', (e) => {
            isMouseDown = true;
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Mock Touch Object
            const mockEvent = {
                preventDefault: () => {},
                touches: [{ identifier: 999, clientX: e.clientX, clientY: e.clientY }]
            };
            handleTouch(mockEvent);
        });
        
        window.addEventListener('mousemove', (e) => {
            if (!isMouseDown) return;
            const mockEvent = {
                preventDefault: () => {},
                touches: [{ identifier: 999, clientX: e.clientX, clientY: e.clientY }]
            };
            handleTouch(mockEvent);
        });

        window.addEventListener('mouseup', (e) => {
            isMouseDown = false;
             const mockEvent = {
                preventDefault: () => {},
                touches: []
            };
            handleTouchEnd(mockEvent);
        });


        // ==========================================
        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á ---
        // ==========================================
        const btnRecord = document.getElementById('btnRecord');
        const btnStop = document.getElementById('btnStop');
        const btnPlayRecord = document.getElementById('btnPlayRecord');
        const btnDownload = document.getElementById('btnDownload');

        btnRecord.addEventListener('click', async () => {
            await initAudio();
            audioChunks = [];
            
            if (!mediaStreamDestination) {
                statusEl.innerText = "Error: Audio Context not ready";
                return;
            }

            try {
                const options = MediaRecorder.isTypeSupported('audio/webm') ? { mimeType: 'audio/webm' } : undefined;
                mediaRecorder = new MediaRecorder(mediaStreamDestination.stream, options);

                mediaRecorder.ondataavailable = (event) => audioChunks.push(event.data);
                mediaRecorder.onstop = () => {
                    recordedBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    btnPlayRecord.disabled = false;
                    btnDownload.disabled = false;
                    statusEl.innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô";
                };

                mediaRecorder.start();
                isRecording = true;
                btnRecord.style.display = 'none';
                btnStop.style.display = 'flex';
                statusEl.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å... üî¥";
                btnPlayRecord.disabled = true;
                btnDownload.disabled = true;

            } catch (e) {
                statusEl.innerText = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ";
            }
        });

        btnStop.addEventListener('click', () => {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                btnRecord.style.display = 'flex';
                btnStop.style.display = 'none';
            }
        });

        btnPlayRecord.addEventListener('click', () => {
            if (recordedBlob) {
                const audioUrl = URL.createObjectURL(recordedBlob);
                const playbackAudio = new Audio(audioUrl);
                playbackAudio.play();
                statusEl.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏î... ‚ñ∂";
            }
        });

        btnDownload.addEventListener('click', () => {
            if (recordedBlob) {
                const url = URL.createObjectURL(recordedBlob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'my_pi_java_song.webm';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            }
        });

    </script>
</body>
</html>