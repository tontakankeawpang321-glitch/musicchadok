<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡πÑ‡∏ó‡∏¢‡∏à‡∏≥‡∏•‡∏≠‡∏á (Virtual Jakhe)</title>
    <style>
        :root {
            --wood-dark: #3e2723;
            --wood-light: #8d6e63;
            --wood-red: #5d4037;
            --string-nylon: #fff9c4; /* ‡∏™‡∏µ‡∏™‡∏≤‡∏¢‡πÄ‡∏≠‡πá‡∏ô */
            --string-brass: #ffd700; /* ‡∏™‡∏µ‡∏™‡∏≤‡∏¢‡∏•‡∏ß‡∏î */
            --fret-color: #d7ccc8;
            --gold: #ffb300;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background-color: #1a1a1a;
            font-family: 'Sarabun', sans-serif;
            display: flex;
            flex-direction: column;
            color: white;
            touch-action: none; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ */
        }

        /* --- Header / Controls --- */
        header {
            height: 60px;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            flex-shrink: 0;
        }

        h1 {
            font-size: 1.2rem;
            margin: 0;
            color: var(--gold);
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        .btn {
            border: 1px solid var(--gold);
            background: transparent;
            color: var(--gold);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn:active {
            background: var(--gold);
            color: #000;
            transform: scale(0.95);
        }

        .btn.recording {
            background: #d32f2f;
            border-color: #d32f2f;
            color: white;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        /* --- Main Jakhe Body --- */
        #jakhe-board {
            flex-grow: 1;
            position: relative;
            background: linear-gradient(90deg, #3e2723 0%, #5d4037 20%, #8d6e63 50%, #5d4037 80%, #3e2723 100%);
            display: flex;
            flex-direction: column;
            /* box-shadow: inset 0 0 50px rgba(0,0,0,0.8); */
            overflow: hidden;
        }

        /* Wood Texture Overlay */
        #jakhe-board::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.5' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.1'/%3E%3C/svg%3E");
            opacity: 0.4;
            pointer-events: none;
        }

        /* --- Fret Layout (Nom) --- */
        .fret-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column-reverse; /* Note Low to High (Bottom to Top) */
            padding-bottom: 20px; /* Space for bridge/open strings */
            padding-top: 10px;
        }

        .fret-row {
            position: relative;
            flex-grow: 1;
            border-top: 6px solid transparent; /* The Nom (Fret) visual handled by pseudo */
            display: flex;
            align-items: center;
        }

        /* The Nom (Raised Fret) Visual */
        .fret-row::after {
            content: "";
            position: absolute;
            top: -5px; /* Adjust based on border/height */
            left: 15%; /* Only covers melody strings */
            width: 70%;
            height: 8px;
            background: linear-gradient(to bottom, #d7ccc8, #8d6e63);
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            z-index: 1;
            pointer-events: none;
        }
        
        /* The "Bridge" area at the bottom for Open Strings */
        .bridge-area {
            height: 12vh;
            background: #281813;
            border-top: 4px solid #1a1a1a;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.6);
            z-index: 5;
        }
        
        .bridge-wood {
            width: 80%;
            height: 20px;
            background: #d7ccc8;
            border-radius: 10px;
            position: absolute;
        }

        /* --- Strings --- */
        .strings-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Clicks pass through to touch areas */
            z-index: 10;
        }

        .string {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 4px; /* Thickness */
            box-shadow: 2px 0 5px rgba(0,0,0,0.6);
        }

        /* Sai Lo (Drone) - Left */
        .string.sai-lo {
            left: 20%;
            background: linear-gradient(90deg, #b8860b, var(--string-brass), #b8860b);
            width: 5px; /* Thicker */
        }

        /* Sai Thum (Middle) */
        .string.sai-thum {
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(90deg, #ddd, var(--string-nylon), #ddd);
        }

        /* Sai Ek (High) - Right */
        .string.sai-ek {
            right: 20%;
            background: linear-gradient(90deg, #ddd, var(--string-nylon), #ddd);
            width: 3px; /* Thinner */
        }

        /* String Vibration Animation */
        @keyframes vibrate {
            0% { transform: translateX(0); }
            20% { transform: translateX(-2px); }
            40% { transform: translateX(2px); }
            60% { transform: translateX(-1px); }
            80% { transform: translateX(1px); }
            100% { transform: translateX(0); }
        }
        
        @keyframes vibrate-center {
             0% { transform: translateX(-50%) translateX(0); }
            20% { transform: translateX(-50%) translateX(-2px); }
            40% { transform: translateX(-50%) translateX(2px); }
            100% { transform: translateX(-50%) translateX(0); }
        }

        .vibrating {
            animation: vibrate 0.15s linear infinite;
        }
        .vibrating.sai-thum {
            animation: vibrate-center 0.15s linear infinite;
        }

        /* --- Touch Zones --- */
        .touch-grid {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            z-index: 20;
        }

        .string-column {
            flex: 1;
            display: flex;
            flex-direction: column-reverse; /* Match visual fret layout */
            height: 100%;
        }
        
        /* Specific column widths to match visual strings */
        .col-lo { flex: 1; } /* Left */
        .col-thum { flex: 1; } /* Center */
        .col-ek { flex: 1; } /* Right */

        .note-zone {
            flex-grow: 1; /* Distribute height equally */
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0); /* Hidden by default */
            font-weight: bold;
            text-shadow: 0 0 3px black;
        }
        
        .note-zone.open-string {
            height: 12vh; /* Match bridge area */
            flex-grow: 0;
            border-top: 1px solid rgba(255,215,0,0.3);
            background: rgba(0,0,0,0.1);
        }

        /* Show Notes Mode */
        body.show-notes .note-zone {
            color: rgba(255, 255, 255, 0.9);
        }
        
        /* Note names for Sai Lo (Drone) are usually not fret-based, so hide upper zones or make them same sound */
        .col-lo .note-zone:not(.open-string) {
            pointer-events: none; /* Only play open string for drone for simplicity */
        }
        
        /* Visual feedback on touch */
        .note-zone:active, .note-zone.active-touch {
            background: rgba(255, 215, 0, 0.2);
        }

        /* Label on fretboard */
        .fret-number {
            position: absolute;
            right: 5px;
            font-size: 0.7rem;
            color: rgba(255,255,255,0.3);
            pointer-events: none;
        }

        /* Modal/Overlay */
        #start-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 999;
            text-align: center;
            color: var(--gold);
        }
        
        .big-btn {
            padding: 15px 40px;
            font-size: 1.5rem;
            background: var(--gold);
            color: #3e2723;
            border: none;
            border-radius: 50px;
            margin-top: 20px;
            font-weight: bold;
            box-shadow: 0 0 20px rgba(255, 179, 0, 0.4);
            cursor: pointer;
        }

    </style>
</head>
<body>

    <!-- Start Overlay (Required for AudioContext) -->
    <div id="start-overlay">
        <h1>‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏à‡∏≥‡∏•‡∏≠‡∏á</h1>
        <p>Virtual Jakhe</p>
        <button class="big-btn" id="start-btn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô (Start)</button>
        <p style="font-size: 0.8rem; margin-top: 20px; opacity: 0.7;">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡∏ï‡∏≤‡∏°‡∏ñ‡∏ô‡∏±‡∏î<br>‡πÉ‡∏™‡πà‡∏´‡∏π‡∏ü‡∏±‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p>
    </div>

    <header>
        <h1><span style="font-size:1.5rem;">üéº</span> ‡∏à‡∏∞‡πÄ‡∏Ç‡πâ</h1>
        <div class="controls">
            <button class="btn" id="toggle-notes">‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏ô‡πâ‡∏ï</button>
            <button class="btn" id="record-btn">‚óè ‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
            <button class="btn" id="play-btn" style="display:none;">‚ñ∂ ‡πÄ‡∏•‡πà‡∏ô</button>
            <button class="btn" id="download-btn" style="display:none;">‚¨á</button>
        </div>
    </header>

    <div id="jakhe-board">
        <!-- Visual Layer for Frets -->
        <div class="fret-container" id="visual-frets">
            <!-- Frets will be generated by JS -->
        </div>

        <!-- The Strings Visuals -->
        <div class="strings-layer">
            <div class="string sai-lo" id="str-lo"></div>
            <div class="string sai-thum" id="str-thum"></div>
            <div class="string sai-ek" id="str-ek"></div>
        </div>

        <!-- Bridge Area (Visual) -->
        <div class="bridge-area">
            <div class="bridge-wood"></div>
        </div>

        <!-- Touch Interaction Layer -->
        <div class="touch-grid">
            <!-- Left: Sai Lo (Drone) -->
            <div class="string-column col-lo" id="col-lo">
                <!-- Zones generated by JS -->
            </div>
            
            <!-- Center: Sai Thum (Mid) -->
            <div class="string-column col-thum" id="col-thum"></div>
            
            <!-- Right: Sai Ek (High) -->
            <div class="string-column col-ek" id="col-ek"></div>
        </div>
    </div>

    <script>
        // --- Audio Context & Variables ---
        let audioCtx;
        let masterGain;
        let dest; // For recording
        let mediaRecorder;
        let audioChunks = [];
        let audioBlob;
        let audioUrl;
        let playbackAudio = new Audio();

        // Thai Scale Frequencies (Approximate C Major for simplicity relative to Jakhe)
        // Jakhe Standard Tuning:
        // Sai Lo (Drone): C3
        // Sai Thum (Mid): G3
        // Sai Ek (High): C4
        
        // Fret mapping (Nom 1 to 11 approx):
        // Note: Thai scales are equidistant 7-tone. Here we map to closest Western Chromatic/Diatonic for web compatibility.
        // Scale: C, D, E, F, G, A, B, C...
        
        const tuning = {
            lo: 130.81, // C3
            thum: 196.00, // G3
            ek: 261.63  // C4
        };

        // Note map for frets (Semitone steps from open string, adjusted for Diatonic feel)
        // 0 = Open, 1 = Fret 1, etc.
        // Simplified Diatonic C Major map for playability:
        // Fret: 1(D), 2(E), 3(F), 4(G), 5(A), 6(B), 7(C), 8(D), 9(E), 10(F), 11(G)
        
        const scaleSteps = [0, 2, 4, 5, 7, 9, 11, 12, 14, 16, 17, 19]; // Semitones from root
        const noteNamesC = ["C", "D", "E", "F", "G", "A", "B", "C", "D", "E", "F", "G"];
        const noteNamesG = ["G", "A", "B", "C", "D", "E", "F#", "G", "A", "B", "C", "D"];
        const noteNamesDrone = ["C (L)"];

        const totalFrets = 11;

        // --- Init Function ---
        function initAudio() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
                
                // Master Gain (Volume)
                masterGain = audioCtx.createGain();
                masterGain.gain.value = 0.8;
                masterGain.connect(audioCtx.destination);

                // Recording Destination
                dest = audioCtx.createMediaStreamDestination();
                masterGain.connect(dest);
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        // --- Sound Synthesis ---
        function playNote(freq, type = 'nylon') {
            if (!audioCtx) return;

            const osc = audioCtx.createOscillator();
            const osc2 = audioCtx.createOscillator(); // Harmonics
            const gainNode = audioCtx.createGain();
            const filter = audioCtx.createBiquadFilter();

            // Configure oscillators
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            osc2.frequency.setValueAtTime(freq * 2, audioCtx.currentTime); // Octave up for brightness
            
            if (type === 'brass') {
                // Sai Lo (Brass/Metal string) - Richer, buzzier
                osc.type = 'sawtooth';
                osc2.type = 'triangle';
                filter.frequency.setValueAtTime(2000, audioCtx.currentTime);
                filter.Q.value = 5;
            } else {
                // Sai Ek/Thum (Nylon/Silk) - Warmer, plucky
                osc.type = 'triangle';
                osc2.type = 'sine';
                filter.frequency.setValueAtTime(3000, audioCtx.currentTime);
                filter.Q.value = 1; 
            }

            // Envelope (Pluck effect)
            // Start silent
            gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
            // Attack (Immediate)
            gainNode.gain.linearRampToValueAtTime(type === 'brass' ? 0.6 : 0.5, audioCtx.currentTime + 0.01);
            // Decay (Exponential fade out)
            const duration = type === 'brass' ? 2.5 : 1.5; // Drone lasts longer
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);

            // Filter Envelope (The "Twang")
            filter.type = 'lowpass';
            filter.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + (duration * 0.8));

            // Connections
            osc.connect(filter);
            osc2.connect(filter);
            filter.connect(gainNode);
            gainNode.connect(masterGain);

            // Start & Stop
            osc.start();
            osc2.start();
            osc.stop(audioCtx.currentTime + duration);
            osc2.stop(audioCtx.currentTime + duration);
            
            // Cleanup
            setTimeout(() => {
                osc.disconnect();
                osc2.disconnect();
                gainNode.disconnect();
                filter.disconnect();
            }, duration * 1000 + 100);
        }

        function getFrequency(rootFreq, semitones) {
            return rootFreq * Math.pow(2, semitones / 12);
        }

        // --- UI Generation ---
        function generateBoard() {
            const visualContainer = document.getElementById('visual-frets');
            const colLo = document.getElementById('col-lo');
            const colThum = document.getElementById('col-thum');
            const colEk = document.getElementById('col-ek');

            // Create Visual Frets (Nom)
            for (let i = totalFrets; i >= 1; i--) {
                const fretRow = document.createElement('div');
                fretRow.className = 'fret-row';
                
                const label = document.createElement('div');
                label.className = 'fret-number';
                label.innerText = i;
                fretRow.appendChild(label);
                
                visualContainer.appendChild(fretRow);
            }

            // Create Touch Zones (Open string at bottom, then frets going up)
            // Loop 0 to totalFrets (0 is open)
            for (let i = 0; i <= totalFrets; i++) {
                
                // Sai Lo (Drone)
                const zoneLo = createZone(i, 'lo', tuning.lo, noteNamesC[0]); // Usually just C
                if (i === 0) {
                     colLo.appendChild(zoneLo); // Only Open string for Lo
                } else {
                     const spacer = document.createElement('div');
                     spacer.className = 'note-zone'; // Empty invisible filler
                     colLo.appendChild(spacer);
                }

                // Sai Thum (Middle)
                const freqThum = getFrequency(tuning.thum, scaleSteps[i]);
                const noteThum = noteNamesG[i % 12];
                colThum.appendChild(createZone(i, 'thum', freqThum, noteThum));

                // Sai Ek (High)
                const freqEk = getFrequency(tuning.ek, scaleSteps[i]);
                const noteEk = noteNamesC[i % 12];
                colEk.appendChild(createZone(i, 'ek', freqEk, noteEk));
            }
        }

        function createZone(index, stringType, freq, noteName) {
            const el = document.createElement('div');
            el.className = 'note-zone';
            if (index === 0) el.classList.add('open-string');
            el.dataset.freq = freq;
            el.dataset.type = stringType;
            el.innerText = noteName;

            // Touch Event
            const trigger = (e) => {
                if(e.cancelable) e.preventDefault(); // Stop scroll
                
                // Visual feedback on string
                const visualString = document.getElementById(`str-${stringType}`);
                visualString.classList.remove('vibrating');
                void visualString.offsetWidth; // trigger reflow
                visualString.classList.add('vibrating');
                
                // Visual feedback on zone
                el.classList.add('active-touch');
                setTimeout(() => el.classList.remove('active-touch'), 150);

                // Sound
                const soundType = stringType === 'lo' ? 'brass' : 'nylon';
                playNote(freq, soundType);
            };

            el.addEventListener('touchstart', trigger, {passive: false});
            el.addEventListener('mousedown', trigger);

            return el;
        }

        // --- Recorder Logic ---
        const recBtn = document.getElementById('record-btn');
        const playBtn = document.getElementById('play-btn');
        const dlBtn = document.getElementById('download-btn');

        recBtn.addEventListener('click', () => {
            if (recBtn.classList.contains('recording')) {
                // Stop Recording
                mediaRecorder.stop();
                recBtn.classList.remove('recording');
                recBtn.innerText = '‚óè ‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á';
            } else {
                // Start Recording
                initAudio();
                audioChunks = [];
                mediaRecorder = new MediaRecorder(dest.stream);
                
                mediaRecorder.ondataavailable = (e) => {
                    audioChunks.push(e.data);
                };
                
                mediaRecorder.onstop = () => {
                    audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    audioUrl = URL.createObjectURL(audioBlob);
                    playbackAudio.src = audioUrl;
                    playBtn.style.display = 'inline-flex';
                    dlBtn.style.display = 'inline-flex';
                };

                mediaRecorder.start();
                recBtn.classList.add('recording');
                recBtn.innerText = '‚ñ† ‡∏´‡∏¢‡∏∏‡∏î';
                playBtn.style.display = 'none';
                dlBtn.style.display = 'none';
            }
        });

        playBtn.addEventListener('click', () => {
            playbackAudio.play();
        });

        dlBtn.addEventListener('click', () => {
            const a = document.createElement('a');
            a.href = audioUrl;
            a.download = 'my_jakhe_solo.wav';
            a.click();
        });

        // --- Other UI Controls ---
        document.getElementById('start-btn').addEventListener('click', () => {
            initAudio();
            document.getElementById('start-overlay').style.display = 'none';
        });

        document.getElementById('toggle-notes').addEventListener('click', () => {
            document.body.classList.toggle('show-notes');
            const btn = document.getElementById('toggle-notes');
            btn.style.background = document.body.classList.contains('show-notes') ? 'var(--gold)' : 'transparent';
            btn.style.color = document.body.classList.contains('show-notes') ? 'black' : 'var(--gold)';
        });

        // Initialize Board
        generateBoard();

    </script>
</body>
</html>