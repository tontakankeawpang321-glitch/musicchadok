<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>‡∏£‡∏∞‡∏ô‡∏≤‡∏î‡πÄ‡∏≠‡∏Å Pro (Thai Ranat Ek)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');

        :root {
            --wood-dark: #3e2723;
            --wood-light: #8d6e63;
            --gold: #ffd700;
            --string-color: #f5f5f5;
            --bg-color: #1a1a1a;
        }

        * {
            box-sizing: border-box;
            touch-action: none; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏π‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh; /* Fallback */
            height: 100dvh; /* Dynamic height for mobile browsers */
            background-color: var(--bg-color);
            font-family: 'Sarabun', sans-serif;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* ‡∏•‡πá‡∏≠‡∏Ñ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô */
            background: radial-gradient(circle at center, #2c1e1e 0%, #000000 100%);
            padding-bottom: env(safe-area-inset-bottom); /* For iPhone notch/bar */
        }

        /* Control Panel */
        #controls {
            height: 50px; /* Fixed compact height */
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            border-bottom: 1px solid var(--gold);
            z-index: 100;
            gap: 8px;
            padding: 0 10px;
            flex-shrink: 0;
        }

        .btn {
            background: linear-gradient(145deg, #5d4037, #3e2723);
            color: var(--gold);
            border: 1px solid var(--gold);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .btn:active {
            transform: scale(0.95);
            background: #3e2723;
        }

        .btn.recording {
            background: #b71c1c;
            color: white;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
        }

        /* Stage area for Ranat */
        #stage {
            flex-grow: 1;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            padding: 10px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏° Padding ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ä‡∏ô‡∏Ç‡∏≠‡∏ö */
            perspective: 1000px;
            overflow: hidden;
        }

        /* The Instrument Body (Rang Ranat) */
        #ranat-container {
            width: 92%; /* ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏•‡∏á‡∏à‡∏≤‡∏Å 98% ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ç‡∏≠‡∏ö‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô */
            max-width: 1000px; /* ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
            height: 55%; /* ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏•‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡πÑ‡∏°‡πà‡∏¢‡∏∑‡∏î‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ */
            position: relative;
            display: flex;
            justify-content: center;
            align-items: flex-end; /* Curve simulation */
            margin-bottom: 20px;
        }

        /* The Base/Boat shape simulation */
        .rang-base {
            position: absolute;
            bottom: -25px;
            width: 100%;
            height: 80px; /* ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏≠‡∏á‡∏ê‡∏≤‡∏ô‡∏•‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiPjxkZWZzPjxsaW5lYXJHcmFkaWVudCBpZD0iZ3JhZCIgeDE9IjAlIiB5MT0iMCUiIHgyPSIwJSIgeTI9IjEwMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiM1ZDQwMzc7c3RvcC1vcGFjaXR5OjEiIC8+PHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojM2UyNzIzO3N0b3Atb3BhY2l0eToxIiAvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjZ3JhZCkiIC8+PC9zdmc+');
            background-size: cover;
            border-bottom-left-radius: 50% 100%;
            border-bottom-right-radius: 50% 100%;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            border: 2px solid var(--gold);
            z-index: 1;
        }

        /* Keys Container */
        #keys-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: flex-end; /* This aligns keys to form curve based on height */
            width: 98%; /* ‡∏•‡∏î‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏´‡∏•‡∏∏‡∏î‡∏Ç‡∏≠‡∏ö‡∏ê‡∏≤‡∏ô */
            height: 140%; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
            z-index: 10;
            padding-bottom: 20px;
            position: relative;
        }

        /* String (Roi Chueak) */
        .string-line {
            position: absolute;
            bottom: 42%;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--string-color);
            border-radius: 50%;
            z-index: 5;
            box-shadow: 0 2px 2px rgba(0,0,0,0.3);
            pointer-events: none;
        }

        /* Individual Key (Luk Ranat) */
        .key {
            position: relative;
            background: linear-gradient(90deg, #5d4037 0%, #a1887f 20%, #8d6e63 50%, #a1887f 80%, #5d4037 100%);
            border-radius: 4px; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏°‡∏∏‡∏°‡∏°‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ */
            cursor: pointer;
            box-shadow: 2px 4px 6px rgba(0,0,0,0.4);
            transition: transform 0.05s;
            display: flex;
            justify-content: center;
            align-items: center;
            color: rgba(255, 255, 255, 0.9);
            font-weight: bold;
            font-size: 0.8rem; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ */
            text-shadow: 1px 1px 2px black;
            border-top: 1px solid rgba(255,255,255,0.3);
            border-bottom: 1px solid rgba(0,0,0,0.6);
            /* Flex properties for sizing */
            flex: 1; 
            margin: 0 2px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏¢‡∏Å‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô */
            height: 100%; 
        }

        .key::after {
            /* Simulate the node/mounting point */
            content: '';
            position: absolute;
            top: 25%;
            width: 70%;
            height: 50%;
            background: radial-gradient(rgba(255,255,255,0.15), transparent);
            border-radius: 50%;
            pointer-events: none;
        }

        .key:active, .key.active {
            transform: translateY(6px) scale(0.95);
            background: linear-gradient(90deg, #4e342e 0%, #8d6e63 50%, #4e342e 100%);
        }

        .note-label {
            position: absolute;
            bottom: 10px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            font-size: 1em;
        }

        .show-notes .note-label {
            opacity: 1;
        }

        /* Mallet Animation Indicator (Visual Feedback) */
        .hit-effect {
            position: absolute;
            width: 35px;
            height: 35px;
            background: radial-gradient(circle, rgba(255,215,0,0.8) 0%, rgba(255,215,0,0) 70%);
            border-radius: 50%;
            pointer-events: none;
            animation: hitFade 0.3s ease-out forwards;
            z-index: 20;
        }

        @keyframes hitFade {
            0% { transform: scale(0.5); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }

        /* Status Text */
        #status-msg {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            display: none;
            z-index: 200;
            font-size: 1.2rem;
            white-space: nowrap;
        }

        /* Mobile Landscape Optimization */
        @media (orientation: portrait) {
            #stage {
                /* ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö‡∏¢‡∏¥‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô */
                position: absolute;
                top: 48%;
                left: 50%;
                /* ‡πÉ‡∏ä‡πâ 90vh ‡πÅ‡∏ó‡∏ô 100vh ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ç‡∏≠‡∏ö‡∏´‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢ */
                width: 88vh; 
                /* ‡πÉ‡∏ä‡πâ 88vw ‡πÅ‡∏ó‡∏ô 100vw ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ç‡∏≠‡∏ö‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏ß‡∏≤ */
                height: 88vw; 
                transform: translate(-50%, -50%) rotate(90deg);
                transform-origin: center center;
                padding: 0;
            }
            
            #ranat-container {
                height: 60%; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
                width: 100%;
            }

            #controls {
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 60px;
                z-index: 101;
                border-top: 1px solid var(--gold);
                border-bottom: none;
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
    </style>
</head>
<body>

    <div id="controls">
        <button class="btn" onclick="toggleNotes()">
            <span id="note-btn-text">üëÅÔ∏è ‡πÇ‡∏ô‡πâ‡∏ï</span>
        </button>
        <button class="btn" id="recordBtn" onclick="toggleRecord()">
            ‚è∫Ô∏è ‡∏≠‡∏±‡∏î
        </button>
        <button class="btn" id="playBtn" onclick="playRecording()" disabled>
            ‚ñ∂Ô∏è ‡πÄ‡∏•‡πà‡∏ô
        </button>
        <button class="btn" id="dlBtn" onclick="downloadRecording()" disabled>
            ‚¨áÔ∏è ‡πÇ‡∏´‡∏•‡∏î
        </button>
    </div>

    <div id="stage">
        <div id="ranat-container">
            <div class="rang-base"></div>
            <div class="string-line"></div>
            <div id="keys-wrapper">
                <!-- Keys will be generated by JS -->
            </div>
        </div>
    </div>

    <div id="status-msg"></div>

    <script>
        // --- Configuration ---
        const totalKeys = 21; // Standard Ranat Ek usually has 21-22 keys
        // Thai Scale Logic: Equidistant 7-tone scale.
        // Formula: Freq = Base * 2^(index/7)
        // Starting roughly around Low So (Sol) ~ 240Hz for mobile speakers clarity
        const baseFreq = 240; 
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        // State
        let isRecording = false;
        let recordedChunks = [];
        let mediaRecorder;
        let audioDest;
        let recordedBlob;
        let recordedAudio = new Audio();
        let showNotes = false;

        // Thai Solfege (Sound names)
        const thaiNotes = ['‡∏ã', '‡∏•', '‡∏ó', '‡∏î', '‡∏£', '‡∏°', '‡∏ü']; // Sol, La, Ti, Do, Re, Mi, Fa

        // --- Initialization ---
        function init() {
            const keysWrapper = document.getElementById('keys-wrapper');
            
            for (let i = 0; i < totalKeys; i++) {
                const key = document.createElement('div');
                key.className = 'key';
                key.dataset.index = i;
                
                // Calculate Thai Frequency
                // i=0 -> So (Low)
                const freq = baseFreq * Math.pow(2, i / 7);
                key.dataset.freq = freq;

                // Label
                const noteName = thaiNotes[i % 7];
                const label = document.createElement('span');
                label.className = 'note-label';
                label.innerText = noteName;
                key.appendChild(label);

                // Visual Styling: Curve Simulation
                // Middle keys are shorter/lower, End keys are longer/higher visually (but in Ranat, middle is thickest)
                // Actually, Ranat keys (Luk) length: Low pitch = Long/Big, High pitch = Short/Small
                // Let's adjust Height based on pitch (Standard Xylophone physics)
                // Longest (Left) -> Shortest (Right)
                const heightPercent = 100 - (i * 2.5); 
                key.style.height = `${Math.max(45, heightPercent)}%`; // Increased min height
                
                // Add Touch Event
                key.addEventListener('touchstart', (e) => {
                    e.preventDefault(); // Stop scrolling
                    playNote(freq, key);
                }, { passive: false });

                // Add Mouse Event for Desktop testing
                key.addEventListener('mousedown', (e) => {
                    playNote(freq, key);
                });

                keysWrapper.appendChild(key);
            }

            // Init Recorder Destination
            audioDest = audioCtx.createMediaStreamDestination();
        }

        // --- Audio Engine ---
        function playNote(freq, element) {
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }

            const t = audioCtx.currentTime;

            // 1. Oscillator (The Sound)
            const osc = audioCtx.createOscillator();
            // Thai Ranat has a woody sound. Sine is too pure. Triangle is too harsh.
            // Let's use Sine but add a tiny bit of Triangle for "hit" texture or just Shape Envelope.
            osc.type = 'sine'; 
            osc.frequency.setValueAtTime(freq, t);

            // 2. Gain Node (The Volume Envelope)
            const gain = audioCtx.createGain();
            
            // "Wood" Envelope: Very fast attack, fast decay
            gain.gain.setValueAtTime(0, t);
            gain.gain.linearRampToValueAtTime(0.8, t + 0.01); // Attack (Hit)
            gain.gain.exponentialRampToValueAtTime(0.01, t + 0.4); // Decay (Short sustain)

            // Connect graph
            osc.connect(gain);
            gain.connect(audioCtx.destination); // Speaker
            gain.connect(audioDest); // Recorder input

            // Start/Stop
            osc.start(t);
            osc.stop(t + 0.5);

            // Visual Feedback
            element.classList.add('active');
            createHitEffect(element);
            setTimeout(() => element.classList.remove('active'), 100);
        }

        // --- Visual Effects ---
        function createHitEffect(element) {
            const effect = document.createElement('div');
            effect.className = 'hit-effect';
            // Center effect on key
            const rect = element.getBoundingClientRect();
            // We need to account for stage rotation in portrait mode?
            // Simple approach: append to element so coordinates are relative
            element.appendChild(effect); 
            effect.style.left = '50%';
            effect.style.top = '50%';
            effect.style.transform = 'translate(-50%, -50%)';
            
            setTimeout(() => effect.remove(), 350);
        }

        function toggleNotes() {
            showNotes = !showNotes;
            const wrapper = document.getElementById('keys-wrapper');
            const btnText = document.getElementById('note-btn-text');
            
            if (showNotes) {
                wrapper.classList.add('show-notes');
                btnText.innerText = "üëÅÔ∏è ‡∏ã‡πà‡∏≠‡∏ô";
            } else {
                wrapper.classList.remove('show-notes');
                btnText.innerText = "üëÅÔ∏è ‡πÇ‡∏ô‡πâ‡∏ï";
            }
        }

        // --- Recording Logic ---
        function toggleRecord() {
            const btn = document.getElementById('recordBtn');
            const playBtn = document.getElementById('playBtn');
            const dlBtn = document.getElementById('dlBtn');

            if (!isRecording) {
                // Start Recording
                recordedChunks = [];
                mediaRecorder = new MediaRecorder(audioDest.stream);
                
                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) recordedChunks.push(e.data);
                };

                mediaRecorder.onstop = () => {
                    recordedBlob = new Blob(recordedChunks, { type: 'audio/webm' });
                    const audioURL = URL.createObjectURL(recordedBlob);
                    recordedAudio.src = audioURL;
                    playBtn.disabled = false;
                    dlBtn.disabled = false;
                    showStatus("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô");
                };

                mediaRecorder.start();
                isRecording = true;
                btn.classList.add('recording');
                btn.innerHTML = "‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î";
                playBtn.disabled = true;
                dlBtn.disabled = true;
                
                // Ensure AudioCtx is running
                if (audioCtx.state === 'suspended') audioCtx.resume();
                showStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...");

            } else {
                // Stop Recording
                mediaRecorder.stop();
                isRecording = false;
                btn.classList.remove('recording');
                btn.innerHTML = "‚è∫Ô∏è ‡∏≠‡∏±‡∏î";
            }
        }

        function playRecording() {
            if (!recordedAudio.src) return;
            recordedAudio.play();
            showStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏î‡πÑ‡∏ß‡πâ...");
        }

        function downloadRecording() {
            if (!recordedBlob) return;
            const url = URL.createObjectURL(recordedBlob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'ranat_sound_' + new Date().getTime() + '.webm';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            showStatus("‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        }

        function showStatus(msg) {
            const el = document.getElementById('status-msg');
            el.innerText = msg;
            el.style.display = 'block';
            setTimeout(() => {
                el.style.display = 'none';
            }, 2000);
        }

        // Run
        window.onload = init;

    </script>
</body>
</html>