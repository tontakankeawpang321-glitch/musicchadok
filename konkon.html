<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>‡∏Å‡∏•‡∏≠‡∏á‡∏¢‡∏≤‡∏ß‡∏à‡∏≥‡∏•‡∏≠‡∏á (Virtual Klong Yao)</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

<style>
@import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
body{
    font-family:'Sarabun',sans-serif;
    background:#2d1b0e;
    overflow:hidden;
    touch-action:none;
    user-select:none;
}
.drum-head{
    background:radial-gradient(circle,#f3e5ab 0%,#e0c87e 55%,#b69b4c 100%);
    box-shadow:
        inset 0 0 30px rgba(0,0,0,.3),
        0 0 0 12px #5c3a21,
        0 0 0 24px #8b5a2b,
        0 18px 30px rgba(0,0,0,.6);
    cursor:pointer;
}
.khoon{
    position:absolute;
    inset:28%;
    border-radius:50%;
    background:radial-gradient(circle,#3e2723 0%,#5d4037 70%,transparent 100%);
}
.hit-anim{
    position:fixed;
    width:20px;height:20px;
    background:rgba(255,255,255,.6);
    border-radius:50%;
    animation:ripple .15s ease-out forwards;
    pointer-events:none;
}
@keyframes ripple{
    from{transform:scale(.5);opacity:.8}
    to{transform:scale(1.5);opacity:0}
}
</style>
</head>

<body class="h-screen flex flex-col justify-between">

<!-- START -->
<div id="start-overlay" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50">
    <div onclick="initAudio()" class="cursor-pointer text-center text-white">
        <i class="fas fa-drum text-6xl text-yellow-400 mb-4"></i>
        <div class="text-2xl font-bold">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏µ‡∏Å‡∏•‡∏≠‡∏á</div>
    </div>
</div>

<!-- DRUM -->
<div class="flex-1 flex items-center justify-center">
    <div id="drum" class="drum-head w-[80vw] h-[80vw] max-w-[480px] max-h-[480px] rounded-full relative">
        <div class="khoon"></div>
    </div>
</div>

<!-- CONTROLS -->
<div class="bg-black/40 backdrop-blur-md p-4 flex justify-center gap-3">
    <button id="recBtn" onclick="toggleRecord()" class="w-16 h-16 rounded-full bg-red-600 text-white">
        <i class="fas fa-microphone"></i>
    </button>
    <button id="playBtn" onclick="playRecording()" disabled class="w-16 h-16 rounded-xl bg-blue-600 text-white opacity-40">
        <i class="fas fa-play"></i>
    </button>
    <button id="downBtn" onclick="downloadRecording()" disabled class="w-16 h-16 rounded-xl bg-green-600 text-white opacity-40">
        <i class="fas fa-download"></i>
    </button>
</div>

<script>
/* =======================
   CONFIG
======================= */
const soundUrls = {
    bom: 'konglong/momlong.wav',
    pa: 'konglong/paklong.wav',
    poeng: 'konglong/pengkob.wav'
};

let audioCtx, masterGain, compressor;
let audioBuffers = {};
let destStream, recorder, recordedChunks=[], audioUrl;
let isRecording=false;

/* =======================
   INIT AUDIO
======================= */
async function initAudio(){
    if(audioCtx) return;

    audioCtx = new (window.AudioContext||window.webkitAudioContext)({
        latencyHint:'interactive'
    });

    // compressor: ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏´‡∏±‡∏ß‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ö‡πà‡∏≠‡∏°
    compressor = audioCtx.createDynamicsCompressor();
    compressor.threshold.value = -18;
    compressor.knee.value = 20;
    compressor.ratio.value = 3;
    compressor.attack.value = 0.02;
    compressor.release.value = 0.25;

    masterGain = audioCtx.createGain();
    masterGain.gain.value = 1.7; // üî• ‡∏î‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö (‡πÑ‡∏ü‡∏•‡πå‡∏•‡πâ‡∏ß‡∏ô)

    masterGain.connect(compressor);
    compressor.connect(audioCtx.destination);

    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á
    destStream = audioCtx.createMediaStreamDestination();
    compressor.connect(destStream);

    await loadSoundFiles();
    document.getElementById('start-overlay').style.display='none';
}

/* =======================
   LOAD FILES (RAW 100%)
======================= */
async function loadSoundFiles(){
    for(const k in soundUrls){
        const res = await fetch(soundUrls[k]);
        const buf = await audioCtx.decodeAudioData(await res.arrayBuffer());
        audioBuffers[k] = buf; // ‚ùå ‡πÑ‡∏°‡πà trim ‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞
    }
}

/* =======================
   PLAY SOUND (FILE ONLY)
======================= */
function playSound(type){
    if(!audioCtx) return;
    const t = audioCtx.currentTime;

    const src = audioCtx.createBufferSource();
    src.buffer = audioBuffers[type];

    const filter = audioCtx.createBiquadFilter();
    filter.type = 'lowpass';

    if(type==='bom'){
        filter.frequency.value = 7000; // ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏ï‡πá‡∏°
        filter.Q.value = 0.7;
    }else{
        filter.frequency.value = 2500;
        filter.Q.value = 0.9;
    }

    const gain = audioCtx.createGain();
    gain.gain.setValueAtTime(0, t);

    const peak = type==='bom' ? 7.0 : 1.2; // üî• ‡∏ö‡πà‡∏≠‡∏°‡∏î‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå
    const decay = type==='bom' ? 1.1 : 0.4;

    gain.gain.linearRampToValueAtTime(peak, t + 0.008);
    gain.gain.exponentialRampToValueAtTime(0.001, t + decay);

    src.connect(filter);
    filter.connect(gain);
    gain.connect(masterGain);

    src.start(t);
}

/* =======================
   HIT DETECTION
======================= */
const drum=document.getElementById('drum');
drum.addEventListener('mousedown',e=>{
    const r=drum.getBoundingClientRect();
    const dx=e.clientX-(r.left+r.width/2);
    const dy=e.clientY-(r.top+r.height/2);
    const d=Math.sqrt(dx*dx+dy*dy)/(r.width/2);

    if(d<.35) playSound('bom');
    else if(d>.75) playSound('poeng');
    else playSound('pa');

    const h=document.createElement('div');
    h.className='hit-anim';
    h.style.left=e.clientX+'px';
    h.style.top=e.clientY+'px';
    document.body.appendChild(h);
    setTimeout(()=>h.remove(),200);
});

/* =======================
   RECORD
======================= */
function toggleRecord(){
    if(!isRecording){
        recordedChunks=[];
        recorder=new MediaRecorder(destStream.stream);
        recorder.ondataavailable=e=>recordedChunks.push(e.data);
        recorder.onstop=()=>{
            audioUrl=URL.createObjectURL(new Blob(recordedChunks,{type:'audio/webm'}));
            playBtn.disabled=false;
            downBtn.disabled=false;
            playBtn.classList.remove('opacity-40');
            downBtn.classList.remove('opacity-40');
        };
        recorder.start();
        isRecording=true;
        recBtn.innerHTML='<i class="fas fa-stop"></i>';
    }else{
        recorder.stop();
        isRecording=false;
        recBtn.innerHTML='<i class="fas fa-microphone"></i>';
    }
}

function playRecording(){
    if(audioUrl) new Audio(audioUrl).play();
}
function downloadRecording(){
    const a=document.createElement('a');
    a.href=audioUrl;
    a.download='klong-yao-file100.webm';
    a.click();
}
</script>
</body>
</html>
