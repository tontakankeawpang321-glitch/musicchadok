<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>กลองบองโกจำลอง (Bongo Drums)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ป้องกันการเลือกข้อความและการลากบนมือถือ */
        body {
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
            overflow: hidden;
            background: #2c1e12; /* สีพื้นหลังไม้เข้ม */
        }

        /* การตกแต่งตัวกลอง */
        .drum-container {
            position: relative;
            border-radius: 50%;
            background: linear-gradient(135deg, #d4a373 0%, #a97142 100%);
            box-shadow: 
                0 15px 35px rgba(0,0,0,0.6),
                inset 0 -5px 15px rgba(0,0,0,0.3);
            border: 8px solid #5d4037;
            transition: transform 0.05s cubic-bezier(0.1, 0.7, 1.0, 0.1);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* หน้ากลอง (หนังกลอง) */
        .drum-head {
            width: 90%;
            height: 90%;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fef3c7, #eaddcf, #d4c5b0);
            box-shadow: inset 0 0 20px rgba(0,0,0,0.3);
            position: relative;
        }

        /* เอฟเฟกต์ตอนตี */
        .drum-container.active {
            transform: scale(0.92) translateY(5px);
        }
        .drum-container.active .drum-head {
            background: radial-gradient(circle at 30% 30%, #fffbf0, #f5eadd, #e0d0b8);
        }

        /* ลายไม้พื้นหลัง */
        .wood-bg {
            background-color: #3e2723;
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0h20v20H0V0zm10 17a7 7 0 1 0 0-14 7 7 0 0 0 0 14zm20 0a7 7 0 1 0 0-14 7 7 0 0 0 0 14zM10 37a7 7 0 1 0 0-14 7 7 0 0 0 0 14zm10-17h20v20H20V20zm10 17a7 7 0 1 0 0-14 7 7 0 0 0 0 14z' fill='%234e342e' fill-opacity='0.4' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        /* วงแหวนเหล็กขอบกลอง */
        .rim {
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 50%;
            border: 4px solid #9e9e9e;
            box-shadow: 
                0 4px 8px rgba(0,0,0,0.6),
                inset 0 2px 2px rgba(255,255,255,0.5);
            pointer-events: none;
            z-index: 10;
        }

        /* ตัวยึดตรงกลาง */
        .connector {
            background: #5d4037;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
        }
        
        /* แอนิเมชันสำหรับคำแนะนำ */
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        .instruction {
            animation: pulse 2s infinite;
        }

        /* ปุ่มบันทึกเสียง */
        .btn-record {
            background: #e53935;
            color: white;
            padding: 8px 24px;
            border-radius: 9999px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: all 0.2s;
            border: 2px solid #b71c1c;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .btn-record:active {
            transform: scale(0.95);
        }
        .btn-record.recording {
            background: #f44336;
            animation: pulse-red 1.5s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(229, 57, 53, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(229, 57, 53, 0); }
            100% { box-shadow: 0 0 0 0 rgba(229, 57, 53, 0); }
        }
    </style>
</head>
<body class="wood-bg h-screen w-screen flex flex-col items-center justify-between py-4">

    <!-- Header -->
    <header class="text-center z-10 flex flex-col items-center">
        <h1 class="text-3xl font-bold text-[#f3e5f5] drop-shadow-md tracking-wider">BONGO PRO</h1>
        
        <!-- Controls Area -->
        <div class="mt-4 z-20">
            <button id="record-btn" class="btn-record" onclick="toggleRecording()">
                <span id="record-icon">●</span>
                <span id="record-text">บันทึกเสียง</span>
            </button>
        </div>
    </header>

    <!-- Drum Set Area -->
    <main class="flex-grow flex items-center justify-center w-full max-w-4xl relative">
        
        <!-- ตัวเชื่อมกลอง (Connector) -->
        <div class="connector absolute w-16 h-8 md:w-24 md:h-12 rounded-lg z-0"></div>

        <div class="flex gap-4 md:gap-12 items-center justify-center z-10 w-full px-4">
            
            <!-- กลองใบใหญ่ (Hembra) - เสียงทุ้ม -->
            <div id="drum-low" class="drum-container w-40 h-40 md:w-64 md:h-64" data-key="a">
                <div class="rim"></div>
                <div class="drum-head"></div>
            </div>

            <!-- กลองใบเล็ก (Macho) - เสียงแหลม -->
            <div id="drum-high" class="drum-container w-32 h-32 md:w-52 md:h-52" data-key="d">
                <div class="rim"></div>
                <div class="drum-head"></div>
            </div>

        </div>
    </main>

    <!-- Footer / Controls -->
    <footer class="mb-4 text-[#a1887f] text-xs text-center">
        <p class="instruction">แตะหน้าจอเพื่อเล่น | เสียงทุ้มและกังวาลสมจริง</p>
        <p class="mt-2 opacity-50">Keyboard: กด 'A' (ใบใหญ่) และ 'D' (ใบเล็ก)</p>
    </footer>

    <script>
        // --- Web Audio API Setup ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;
        let masterGain; 
        let reverbNode; // เพิ่ม Reverb (Convolver)
        
        // Recording Variables
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        
        // สร้าง Impulse Response สำหรับ Reverb (จำลองเสียงห้อง)
        function createReverbBuffer() {
            const sampleRate = audioCtx.sampleRate;
            const length = sampleRate * 1.5; // 1.5 วินาที reverb tail
            const impulse = audioCtx.createBuffer(2, length, sampleRate);
            const impulseL = impulse.getChannelData(0);
            const impulseR = impulse.getChannelData(1);

            for (let i = 0; i < length; i++) {
                const n = i;
                // สร้าง noise ที่ค่อยๆ เบาลง (Exponential decay)
                let decay = Math.pow(1 - n / length, 2);
                impulseL[i] = (Math.random() * 2 - 1) * decay;
                impulseR[i] = (Math.random() * 2 - 1) * decay;
            }
            return impulse;
        }

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new AudioContext();
                
                // Master Gain
                masterGain = audioCtx.createGain();
                masterGain.gain.value = 0.8; // ลด Volume หลักลงนิดหน่อยกันแตก

                // Setup Reverb
                reverbNode = audioCtx.createConvolver();
                reverbNode.buffer = createReverbBuffer();
                
                // Dry/Wet Mix (เสียงสด vs เสียงก้อง)
                const dryGain = audioCtx.createGain(); // เสียงสด
                dryGain.gain.value = 1.0;
                
                const wetGain = audioCtx.createGain(); // เสียงก้อง
                wetGain.gain.value = 0.3; // ปรับความกังวาลตรงนี้ (0.3 = ปานกลาง)

                // Routing Graph
                // Sound -> [Dry] -> Master
                // Sound -> [Reverb] -> [Wet] -> Master
                // Note: We will connect individual drum sounds to a temporary 'source bus' in playBongoSound
                
                // เชื่อม Master ไปยัง Destination
                masterGain.connect(audioCtx.destination);

                // Setup Recorder
                const dest = audioCtx.createMediaStreamDestination();
                masterGain.connect(dest);

                try {
                    mediaRecorder = new MediaRecorder(dest.stream);
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) audioChunks.push(event.data);
                    };
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(audioChunks, { type: 'audio/webm' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        const timestamp = new Date().toLocaleTimeString('th-TH').replace(/:/g, '-');
                        a.download = `bongo-pro-${timestamp}.webm`;
                        document.body.appendChild(a);
                        a.click();
                        setTimeout(() => { document.body.removeChild(a); window.URL.revokeObjectURL(url); }, 100);
                        audioChunks = [];
                    };
                } catch (e) {
                    console.error("Recording not supported", e);
                }

                // Global routing helper
                audioCtx.dryDest = dryGain;
                audioCtx.wetDest = reverbNode;
                
                // Connect Mixer
                dryGain.connect(masterGain);
                reverbNode.connect(wetGain);
                wetGain.connect(masterGain);

            } else if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function toggleRecording() {
            initAudio();
            const btn = document.getElementById('record-btn');
            const icon = document.getElementById('record-icon');
            const text = document.getElementById('record-text');

            if (!isRecording) {
                if (mediaRecorder && mediaRecorder.state === "inactive") {
                    mediaRecorder.start();
                    isRecording = true;
                    btn.classList.add('recording');
                    icon.textContent = '⬛';
                    text.textContent = 'หยุดบันทึก';
                }
            } else {
                if (mediaRecorder && mediaRecorder.state === "recording") {
                    mediaRecorder.stop();
                    isRecording = false;
                    btn.classList.remove('recording');
                    icon.textContent = '●';
                    text.textContent = 'บันทึกเสียง';
                }
            }
        }

        function playBongoSound(type) {
            if (!audioCtx) initAudio();
            const t = audioCtx.currentTime;

            // -- Parameter Tuning --
            // Low (Hembra): ทุ้มลึก, High (Macho): ใส, คม
            const fundFreq = type === 'high' ? 420 : 180; 
            const dropFreq = type === 'high' ? 120 : 60;  // Pitch drop amount
            const decayTime = type === 'high' ? 0.25 : 0.45; // หางเสียง (Low ยาวกว่า)
            const volume = type === 'high' ? 0.8 : 1.0;

            // 1. Fundamental Oscillator (เสียงหลัก - Sine Wave)
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.frequency.setValueAtTime(fundFreq, t);
            osc.frequency.exponentialRampToValueAtTime(fundFreq - dropFreq, t + 0.15); // Pitch drop
            
            gain.gain.setValueAtTime(0, t);
            gain.gain.linearRampToValueAtTime(volume, t + 0.005); // Attack
            gain.gain.exponentialRampToValueAtTime(0.001, t + decayTime); // Decay

            osc.connect(gain);
            
            // 2. Overtone Oscillator (เสียงรอง - เพื่อความสมจริงของไม้/หนัง)
            const osc2 = audioCtx.createOscillator();
            const gain2 = audioCtx.createGain();
            
            // Harmonic ที่ 1.5 หรือ 2 เท่า
            osc2.frequency.setValueAtTime(fundFreq * 1.6, t); 
            osc2.type = 'triangle'; // Triangle ให้เสียงที่มี texture มากกว่า Sine
            
            gain2.gain.setValueAtTime(0, t);
            gain2.gain.linearRampToValueAtTime(volume * 0.2, t + 0.005);
            gain2.gain.exponentialRampToValueAtTime(0.001, t + (decayTime * 0.6)); // หางเสียงสั้นกว่าตัวหลัก

            osc2.connect(gain2);

            // 3. Routing
            // ส่งเข้าทั้ง Dry (เสียงสด) และ Wet (เสียงก้อง Reverb)
            gain.connect(audioCtx.dryDest);
            gain.connect(audioCtx.wetDest); // ส่งเข้า Reverb
            
            gain2.connect(audioCtx.dryDest);

            // Start
            osc.start(t);
            osc.stop(t + decayTime + 0.1);
            osc2.start(t);
            osc2.stop(t + decayTime + 0.1);

            // 4. Slap Noise (เสียงกระทบหนัง - ปรับให้แน่นขึ้น)
            createSlapNoise(t, type);
        }

        function createSlapNoise(t, type) {
            const bufferSize = audioCtx.sampleRate * 0.025; // สั้นลงเพื่อให้คม (25ms)
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                data[i] = (Math.random() * 2 - 1);
            }

            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;
            
            const noiseFilter = audioCtx.createBiquadFilter();
            noiseFilter.type = 'lowpass';
            noiseFilter.frequency.value = type === 'high' ? 3000 : 1200; // Low drum เสียงตบจะทุ้มกว่า
            
            const noiseGain = audioCtx.createGain();
            noiseGain.gain.setValueAtTime(type === 'high' ? 0.6 : 0.4, t);
            noiseGain.gain.exponentialRampToValueAtTime(0.01, t + 0.02);

            noise.connect(noiseFilter);
            noiseFilter.connect(noiseGain);
            noiseGain.connect(audioCtx.dryDest); // เสียงตบไม่ส่งเข้า reverb มากนัก เพื่อความชัด
            
            noise.start(t);
        }

        // --- Interaction Logic (Original) ---
        const drumLow = document.getElementById('drum-low');
        const drumHigh = document.getElementById('drum-high');

        function triggerDrum(element, type) {
            playBongoSound(type);
            element.classList.remove('active');
            void element.offsetWidth; // Trigger reflow
            element.classList.add('active');
            setTimeout(() => {
                element.classList.remove('active');
            }, 100);
        }

        function handleTouch(e) {
            e.preventDefault();
            initAudio();
            for (let i = 0; i < e.changedTouches.length; i++) {
                const touch = e.changedTouches[i];
                const target = document.elementFromPoint(touch.clientX, touch.clientY);
                if (target) {
                    const drumContainer = target.closest('.drum-container');
                    const recordBtn = target.closest('#record-btn');
                    if (drumContainer) {
                        if (drumContainer.id === 'drum-low') triggerDrum(drumLow, 'low');
                        if (drumContainer.id === 'drum-high') triggerDrum(drumHigh, 'high');
                    }
                    if (recordBtn) recordBtn.click();
                }
            }
        }

        document.addEventListener('touchstart', handleTouch, { passive: false });
        drumLow.addEventListener('mousedown', () => triggerDrum(drumLow, 'low'));
        drumHigh.addEventListener('mousedown', () => triggerDrum(drumHigh, 'high'));
        document.addEventListener('keydown', (e) => {
            if (e.repeat) return;
            const key = e.key.toLowerCase();
            if (key === 'a') triggerDrum(drumLow, 'low');
            if (key === 'd' || key === 'l') triggerDrum(drumHigh, 'high'); 
            if (key === ' ' || key === 'r') toggleRecording();
        });

        document.body.addEventListener('click', initAudio, { once: true });
        document.body.addEventListener('touchstart', initAudio, { once: true });
    </script>
</body>
</html>
