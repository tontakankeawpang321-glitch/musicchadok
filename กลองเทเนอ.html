<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>กลองเทเนอร์จำลอง (Sample Playback)</title>

<style>
:root {
    --bg-color:#1a1a1a;
    --drum-rim:#e0e0e0;
    --drum-head:#ffffff;
    --drum-shell:#263238;
    --highlight:#00bcd4;
    --record-color:#ff5252;
}

body{
    margin:0;
    background:var(--bg-color);
    height:100vh;
    overflow:hidden;
    display:flex;
    justify-content:center;
    align-items:center;
    font-family:'Sarabun',sans-serif;
    user-select:none;
    touch-action:none;
}

#start-overlay{
    position:absolute;
    inset:0;
    background:rgba(0,0,0,.9);
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    z-index:100;
    color:#fff;
    transition:.4s;
}

.btn-start{
    padding:15px 32px;
    font-size:1.5rem;
    background:var(--highlight);
    border:none;
    border-radius:50px;
    color:#fff;
    cursor:pointer;
    font-weight:bold;
    box-shadow:0 0 20px rgba(0,188,212,.6);
}

#loading-text{
    margin-top:12px;
    color:#aaa;
    font-size:.9rem;
}

.controls{
    position:absolute;
    top:15px;
    display:flex;
    gap:12px;
    z-index:20;
}

.btn-control{
    padding:8px 16px;
    border-radius:20px;
    background:rgba(255,255,255,.1);
    border:1px solid rgba(255,255,255,.2);
    color:#fff;
    cursor:pointer;
}

.btn-record.recording{
    background:var(--record-color);
    border-color:var(--record-color);
    animation:pulse 1.4s infinite;
}

@keyframes pulse{
    0%{box-shadow:0 0 0 0 rgba(255,82,82,.7)}
    70%{box-shadow:0 0 0 12px rgba(255,82,82,0)}
    100%{box-shadow:0 0 0 0 rgba(255,82,82,0)}
}

.status-text{
    color:var(--record-color);
    font-weight:bold;
    display:none;
}

.drum-container{
    position:relative;
    width:95vw;
    height:60vh;
    max-width:800px;
}

.drum{
    position:absolute;
    border-radius:50%;
    background:radial-gradient(circle at 30% 30%,#fff,#eceff1);
    border:8px solid var(--drum-shell);
    box-shadow:
        0 0 0 4px var(--drum-rim),
        0 15px 25px rgba(0,0,0,.6),
        inset 0 0 20px rgba(0,0,0,.1);
    display:flex;
    justify-content:center;
    align-items:center;
    font-weight:bold;
    font-size:1.4rem;
    cursor:pointer;
}

.drum.hit{
    transform:scale(.96);
    border-color:var(--highlight);
}

#drum-1{width:18vmin;height:18vmin;right:32%;top:15%}
#drum-2{width:20vmin;height:20vmin;left:30%;top:15%}
#drum-3{width:24vmin;height:24vmin;right:5%;top:25%}
#drum-4{width:26vmin;height:26vmin;left:2%;top:25%}

#drum-spock{
    width:14vmin;height:14vmin;
    left:50%;top:5%;
    transform:translateX(-50%);
    background:radial-gradient(circle at 30% 30%,#455a64,#263238);
    border-color:#000;
    color:#ccc;
}
</style>
</head>

<body>

<div id="start-overlay">
    <h1>กลองเทเนอร์จำลอง</h1>
    <button id="btn-start-init" class="btn-start">▶ เริ่มใช้งาน</button>
    <div id="loading-text"></div>
</div>

<div class="controls">
    <button id="btn-record" class="btn-control btn-record" onclick="toggleRecord()">● บันทึก</button>
    <button id="btn-stop" class="btn-control" onclick="stopRecord()" disabled>■ หยุด & โหลด</button>
    <span id="record-status" class="status-text">กำลังบันทึก...</span>
</div>

<div class="drum-container">
    <div id="drum-spock" class="drum" data-note="spock">S</div>
    <div id="drum-2" class="drum" data-note="2">2</div>
    <div id="drum-1" class="drum" data-note="1">1</div>
    <div id="drum-4" class="drum" data-note="4">4</div>
    <div id="drum-3" class="drum" data-note="3">3</div>
</div>

<script>
const soundFiles={
    spock:'tenors/stenor.mp3',
    1:'tenors/1tenor.mp3',
    2:'tenors/tenors.mp3',
    3:'tenors/tenors.mp3',
    4:'tenors/4tenors.mp3'
};

let audioCtx,masterGain,destNode;
let audioBuffers={};
let mediaRecorder,audioChunks=[],isRecording=false;

async function initAudio(){
    const btn=document.getElementById('btn-start-init');
    btn.disabled=true;
    btn.innerText='กำลังโหลด...';

    audioCtx=new (window.AudioContext||window.webkitAudioContext)();

    masterGain=audioCtx.createGain();
    masterGain.connect(audioCtx.destination);

    destNode=audioCtx.createMediaStreamDestination();
    masterGain.connect(destNode);

    setupRecorder();

    await Promise.all(
        Object.keys(soundFiles).map(n=>loadSound(n,soundFiles[n]))
    );

    document.getElementById('start-overlay').style.opacity=0;
    setTimeout(()=>startOverlay.remove(),400);
}

async function loadSound(note,url){
    try{
        const r=await fetch(url);
        const b=await r.arrayBuffer();
        audioBuffers[note]=await audioCtx.decodeAudioData(b);
    }catch(e){
        console.warn('โหลดเสียงไม่ได้',url);
    }
}

function playDrumSound(note){
    if(audioBuffers[note]){
        const s=audioCtx.createBufferSource();
        s.buffer=audioBuffers[note];
        s.connect(masterGain);
        s.start();
    }else{
        const o=audioCtx.createOscillator();
        const g=audioCtx.createGain();
        o.frequency.value=440;
        g.gain.value=.1;
        o.connect(g);
        g.connect(masterGain);
        o.start();
        o.stop(audioCtx.currentTime+.1);
    }
}

function setupRecorder(){
    mediaRecorder=new MediaRecorder(destNode.stream);
    mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);
    mediaRecorder.onstop=()=>{
        const blob=new Blob(audioChunks,{type:'audio/webm'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url;
        a.download='tenor_recording.webm';
        a.click();
        audioChunks=[];
    };
}

function toggleRecord(){
    if(!isRecording){
        audioChunks=[];
        mediaRecorder.start();
        isRecording=true;
        btnRecord.classList.add('recording');
        recordStatus.style.display='inline';
        btnStop.disabled=false;
    }
}

function stopRecord(){
    if(isRecording){
        mediaRecorder.stop();
        isRecording=false;
        btnRecord.classList.remove('recording');
        recordStatus.style.display='none';
        btnStop.disabled=true;
    }
}

document.querySelectorAll('.drum').forEach(d=>{
    const note=d.dataset.note;
    const hit=e=>{
        e.preventDefault();
        d.classList.add('hit');
        setTimeout(()=>d.classList.remove('hit'),80);
        playDrumSound(note);
    };
    d.addEventListener('touchstart',hit,{passive:false});
    d.addEventListener('mousedown',hit);
});

document.getElementById('btn-start-init').addEventListener('click',initAudio);
</script>

</body>
</html>
