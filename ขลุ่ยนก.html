<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ขลุ่ยนกกาเหว่า (Asian Koel Flute)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            overflow: hidden;
            background-color: #050505;
            /* บรรยากาศป่าดิบชื้นตอนเช้ามืด */
            background-image: 
                radial-gradient(circle at 50% 0%, #1a2e1a 0%, #050505 60%),
                linear-gradient(0deg, rgba(0,0,0,0.8), transparent);
        }

        /* Bamboo Body: ปรับสีให้เหมือนไม้ไผ่จริง (Golden Bamboo) */
        .bamboo-body {
            /* ไล่สีจากขอบเข้มเข้าหากลางสว่าง (สีเหลืองทอง/น้ำตาลไหม้) */
            background: linear-gradient(90deg, 
                #3e2723 0%, 
                #8d6e63 15%, 
                #deb887 40%, 
                #e6ceaa 50%, 
                #deb887 60%, 
                #8d6e63 85%, 
                #3e2723 100%
            );
            box-shadow: 
                10px 10px 30px rgba(0,0,0,0.8), 
                inset 2px 0 5px rgba(255,255,255,0.2), /* เพิ่มความมันวาว */
                inset -5px 0 15px rgba(0,0,0,0.6);
            border-radius: 20px;
            position: relative;
            /* Texture ลายเสี้ยนไม้ไผ่ */
            background-image: 
                linear-gradient(90deg, 
                    #3e2723 0%, 
                    #8d6e63 15%, 
                    #deb887 40%, 
                    #e6ceaa 50%, 
                    #deb887 60%, 
                    #8d6e63 85%, 
                    #3e2723 100%
                ),
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(62, 39, 35, 0.1) 3px);
            background-blend-mode: multiply;
        }

        /* ลายกระบนไม้ไผ่ (Bamboo Speckles) */
        .bamboo-body::after {
            content: '';
            position: absolute;
            inset: 0;
            background-image: radial-gradient(rgba(62, 39, 35, 0.2) 1px, transparent 1px);
            background-size: 10px 20px;
            opacity: 0.5;
            pointer-events: none;
            border-radius: 20px;
        }

        /* ข้อไม้ไผ่ (Joints) */
        .joint {
            position: absolute;
            left: -2px; right: -2px;
            height: 6px;
            background: #5d4037; /* สีข้อเข้มกว่าเนื้อไม้นิดหน่อย */
            border-top: 1px solid rgba(255,255,255,0.4);
            border-bottom: 1px solid rgba(0,0,0,0.5);
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            z-index: 5;
        }

        /* รูเสียง 3 รู */
        .hole-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            /* สีดำสนิทไล่เฟด เพื่อให้ดูลึก */
            background: radial-gradient(circle at 40% 40%, #3e2723 10%, #000 70%);
            box-shadow: 
                inset 2px 2px 6px rgba(0,0,0,0.9),
                0 1px 1px rgba(255,255,255,0.3); /* ขอบรูสะท้อนแสง */
            border: 2px solid rgba(141, 110, 99, 0.6);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.4);
            font-weight: bold;
            font-size: 1.2rem;
            transition: all 0.08s;
            -webkit-tap-highlight-color: transparent;
            z-index: 10;
        }

        .hole-btn:active, .hole-btn.active {
            transform: scale(0.92);
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3), inset 0 0 15px #000;
            background: radial-gradient(circle at 40% 40%, #5d4037 10%, #1a1008 80%);
        }

        /* เชือกแดงผูกขลุ่ย */
        .rope {
            position: absolute;
            top: 40px;
            left: -3px;
            right: -3px;
            height: 12px;
            background: repeating-linear-gradient(45deg, #b71c1c, #b71c1c 3px, #7f0000 4px, #7f0000 5px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.6);
            z-index: 6;
            border-radius: 2px;
        }

        /* Control Buttons */
        .control-btn {
            transition: all 0.2s;
            backdrop-filter: blur(8px);
        }
        .control-btn:active { transform: scale(0.95); }

        /* Recording Animation */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(2); opacity: 0; }
        }
        .recording-ring::before {
            content: '';
            position: absolute;
            width: 100%; height: 100%;
            border-radius: 50%;
            border: 2px solid #ef4444;
            animation: pulse-ring 1.5s infinite;
        }

    </style>
</head>
<body class="h-screen w-screen flex flex-col items-center justify-between py-6 text-white overflow-hidden">

    <!-- Header -->
    <header class="text-center z-10">
        <h1 class="text-4xl font-bold text-amber-50 drop-shadow-xl tracking-wider" style="font-family: 'Sarabun', serif;">ขลุ่ยนกกาเหว่า</h1>
        <p class="text-amber-200/40 text-sm mt-1">Asian Koel Simulator</p>
    </header>

    <!-- Instrument Area -->
    <main class="flex-grow flex items-center justify-center w-full px-4 relative">
        
        <!-- ตัวขลุ่ย -->
        <div class="bamboo-body w-28 md:w-36 h-[60vh] max-h-[500px] flex flex-col items-center justify-evenly py-10 relative">
            
            <!-- ข้อไม้ไผ่บนและล่าง -->
            <div class="joint" style="top: 15px;"></div>
            <div class="rope"></div> <!-- เชือกแดง -->
            <div class="joint" style="bottom: 15px;"></div>

            <!-- ปากเป่า (Mouthpiece) -->
            <div class="absolute -top-6 w-14 h-8 bg-[#3e2723] rounded-t-lg shadow-2xl border-b border-white/10"></div>

            <!-- 3 รูเสียง (Tuned for Koel Call) -->
            
            <button class="hole-btn" data-note="HIGH" 
                ontouchstart="startNote(event, 'HIGH', this)" ontouchend="endNote(event, 'HIGH', this)" 
                onmousedown="startNote(event, 'HIGH', this)" onmouseup="endNote(event, 'HIGH', this)" onmouseleave="endNote(event, 'HIGH', this)">
                <span>๓</span>
            </button>

            <button class="hole-btn" data-note="MID" 
                ontouchstart="startNote(event, 'MID', this)" ontouchend="endNote(event, 'MID', this)" 
                onmousedown="startNote(event, 'MID', this)" onmouseup="endNote(event, 'MID', this)" onmouseleave="endNote(event, 'MID', this)">
                <span>๒</span>
            </button>

            <button class="hole-btn" data-note="LOW" 
                ontouchstart="startNote(event, 'LOW', this)" ontouchend="endNote(event, 'LOW', this)" 
                onmousedown="startNote(event, 'LOW', this)" onmouseup="endNote(event, 'LOW', this)" onmouseleave="endNote(event, 'LOW', this)">
                <span>๑</span>
            </button>

            <!-- Text Hint -->
            <div class="absolute -right-16 top-1/2 -translate-y-1/2 text-xs text-white/20 rotate-90 hidden md:block">
                กา - เห - ว่า
            </div>

        </div>
    </main>

    <!-- Controls -->
    <footer class="w-full max-w-sm px-6 pb-8 z-20">
        <div class="bg-[#1a1a1a]/80 backdrop-blur-xl rounded-3xl p-3 border border-white/5 shadow-2xl">
            <!-- Status -->
            <div id="statusText" class="text-center text-[10px] text-amber-100/40 mb-3 h-4 tracking-wide">กดปุ่ม ๑ แล้ว ๓ เพื่อเล่นเสียง "กา-เหว่า"</div>
            
            <div class="flex gap-3">
                <!-- Record -->
                <button id="recBtn" onclick="toggleRecord()" class="control-btn relative flex-1 bg-[#2a2a2a] hover:bg-[#333] h-14 rounded-2xl flex items-center justify-center gap-2 border border-white/5 shadow-lg group">
                    <div id="recDot" class="w-3 h-3 rounded-full bg-red-600 shadow-[0_0_10px_rgba(220,38,38,0.5)] transition-colors"></div>
                    <span id="recLabel" class="text-sm font-medium text-gray-300">อัดเสียง</span>
                </button>

                <!-- Playback Tools (Hidden initially) -->
                <div id="playbackTools" class="hidden flex-1 gap-2 flex">
                    <button onclick="playRecord()" class="control-btn flex-1 bg-emerald-900/80 hover:bg-emerald-800 h-14 rounded-2xl flex items-center justify-center text-emerald-100 border border-white/5">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/></svg>
                    </button>
                    <button onclick="downloadRecord()" class="control-btn w-14 bg-sky-900/80 hover:bg-sky-800 h-14 rounded-2xl flex items-center justify-center text-sky-100 border border-white/5">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    </button>
                    <button onclick="resetRecord()" class="control-btn w-14 bg-neutral-800 h-14 rounded-2xl flex items-center justify-center text-gray-400 border border-white/5">
                        ✕
                    </button>
                </div>
            </div>
        </div>
    </footer>

    <!-- Koel Audio Engine -->
    <script>
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let ctx;
        let master, compressor, reverb;
        let dest, recorder;
        let audioChunks = [];
        let audioBlob, audioUrl;
        let playbackAudio = new Audio();
        let isRecording = false;
        let recordStartTime;
        let recordInterval;

        // Frequencies tuned for Asian Koel (E scale roughly)
        // Koel calls typically rise in pitch significantly
        const notes = {
            'LOW': 784.00,  // G5 (เสียง "กา")
            'MID': 987.77,  // B5 (เสียงเชื่อม)
            'HIGH': 1174.66 // D6 (เสียง "เหว่า" สูงแหลม)
        };

        const activeOscillators = {};

        function initAudio() {
            if (ctx) return;
            ctx = new AudioContext();
            
            // 1. Compressor (Limiter)
            compressor = ctx.createDynamicsCompressor();
            compressor.threshold.value = -10;
            compressor.ratio.value = 20;

            // 2. Reverb (Forest Ambience) - Very Wet for Koel
            reverb = ctx.createConvolver();
            reverb.buffer = createImpulseResponse(2.0, 2.0); // ยาว 2 วิ
            const reverbGain = ctx.createGain();
            reverbGain.gain.value = 0.5; // เสียงก้องมากหน่อย เพื่อความเหมือนจริงในป่า

            // 3. Master Gain
            master = ctx.createGain();
            master.gain.value = 0.8;

            // 4. Recorder Dest
            dest = ctx.createMediaStreamDestination();

            // Routing
            compressor.connect(master);
            
            // Parallel processing for reverb
            const dryGain = ctx.createGain();
            dryGain.gain.value = 0.7;
            
            compressor.connect(dryGain);
            dryGain.connect(master);
            
            const wetGain = ctx.createGain();
            wetGain.gain.value = 0.4;
            compressor.connect(reverb);
            reverb.connect(wetGain);
            wetGain.connect(master);

            master.connect(ctx.destination);
            master.connect(dest);
        }

        // Create algorithmic reverb
        function createImpulseResponse(duration, decay) {
            const length = ctx.sampleRate * duration;
            const impulse = ctx.createBuffer(2, length, ctx.sampleRate);
            const L = impulse.getChannelData(0);
            const R = impulse.getChannelData(1);
            for (let i = 0; i < length; i++) {
                const n = i;
                const e = Math.pow(1 - n / length, decay);
                L[i] = (Math.random() * 2 - 1) * e;
                R[i] = (Math.random() * 2 - 1) * e;
            }
            return impulse;
        }

        // Koel Synthesis Logic
        function playSound(freq) {
            const t = ctx.currentTime;

            // Koel sound is very pure, almost sine but piercing
            const osc = ctx.createOscillator();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(freq, t);

            // Breath/Air noise (subtle)
            const noise = ctx.createOscillator();
            noise.type = 'triangle';
            noise.frequency.setValueAtTime(freq * 2, t); // Harmonic
            const noiseGain = ctx.createGain();
            noiseGain.gain.value = 0.05;

            // Envelope (ADSR) - Koel specific
            // Attack: Not instant, swells in slightly (0.1s)
            // Decay: Very slow sustain
            const env = ctx.createGain();
            env.gain.setValueAtTime(0, t);
            env.gain.linearRampToValueAtTime(0.8, t + 0.1); // Swell attack
            env.gain.exponentialRampToValueAtTime(0.6, t + 0.5); // Sustain level

            // Vibrato (ลูกคอ) - Koel has a slow, wide vibrato at the end of the call
            const lfo = ctx.createOscillator();
            lfo.frequency.value = 5.5; 
            const lfoGain = ctx.createGain();
            lfoGain.gain.value = 0; // Start with no vibrato
            // Vibrato delayed entry
            lfoGain.gain.setTargetAtTime(freq * 0.02, t + 0.3, 0.5); 
            
            lfo.connect(lfoGain);
            lfoGain.connect(osc.frequency);
            lfo.start(t);

            // Wiring
            osc.connect(env);
            noise.connect(noiseGain);
            noiseGain.connect(env);
            env.connect(compressor);

            osc.start(t);
            noise.start(t);

            return { osc, noise, lfo, env, noiseGain };
        }

        function startNote(e, note, btn) {
            if(e.type === 'touchstart') e.preventDefault();
            initAudio();
            if (ctx.state === 'suspended') ctx.resume();
            
            if (activeOscillators[note]) return;

            btn.classList.add('active');
            activeOscillators[note] = playSound(notes[note]);
        }

        function endNote(e, note, btn) {
            if(e.type === 'touchend') e.preventDefault();
            if (!activeOscillators[note]) return;

            btn.classList.remove('active');
            
            const { osc, noise, lfo, env, noiseGain } = activeOscillators[note];
            const t = ctx.currentTime;
            
            // Release - Koel sound lingers slightly in the forest
            const release = 0.3;
            env.gain.cancelScheduledValues(t);
            env.gain.setValueAtTime(env.gain.value, t);
            env.gain.linearRampToValueAtTime(0, t + release);

            osc.stop(t + release + 0.1);
            noise.stop(t + release + 0.1);
            lfo.stop(t + release + 0.1);

            delete activeOscillators[note];
        }

        // --- Recording Logic ---
        function toggleRecord() {
            initAudio();
            const btn = document.getElementById('recBtn');
            const dot = document.getElementById('recDot');
            const label = document.getElementById('recLabel');
            const status = document.getElementById('statusText');

            if (!isRecording) {
                // Start
                audioChunks = [];
                const options = MediaRecorder.isTypeSupported('audio/webm') ? {mimeType: 'audio/webm'} : {mimeType: 'audio/mp4'};
                
                try {
                    recorder = new MediaRecorder(dest.stream, options);
                } catch(e) { alert("ไม่รองรับการอัดเสียง"); return; }

                recorder.ondataavailable = e => audioChunks.push(e.data);
                recorder.onstop = finishRecord;
                recorder.start();

                isRecording = true;
                btn.classList.add('recording-ring'); // Add pulsing ring
                dot.classList.remove('bg-red-600');
                dot.classList.add('bg-white');
                status.innerText = "กำลังบันทึก... (กดหยุดเพื่อฟัง)";
                
                recordStartTime = Date.now();
                recordInterval = setInterval(() => {
                    const ms = Date.now() - recordStartTime;
                    const secs = Math.floor(ms / 1000);
                    const mins = Math.floor(secs / 60);
                    label.innerText = `${mins}:${(secs%60).toString().padStart(2,'0')}`;
                }, 1000);

            } else {
                // Stop
                recorder.stop();
                isRecording = false;
                clearInterval(recordInterval);
                btn.classList.remove('recording-ring');
            }
        }

        function finishRecord() {
            audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            audioUrl = URL.createObjectURL(audioBlob);
            playbackAudio.src = audioUrl;

            // Swap UI
            document.getElementById('recBtn').classList.add('hidden');
            document.getElementById('playbackTools').classList.remove('hidden');
            document.getElementById('statusText').innerText = "บันทึกเสร็จสิ้น";
        }

        function playRecord() {
            if(!audioUrl) return;
            document.getElementById('statusText').innerText = "กำลังเล่นเสียงที่บันทึก...";
            playbackAudio.play();
            playbackAudio.onended = () => document.getElementById('statusText').innerText = "จบการเล่น";
        }

        function downloadRecord() {
            if(!audioUrl) return;
            const a = document.createElement('a');
            a.href = audioUrl;
            a.download = `Kawao-${Date.now()}.webm`;
            a.click();
        }

        function resetRecord() {
            audioUrl = null;
            document.getElementById('playbackTools').classList.add('hidden');
            document.getElementById('recBtn').classList.remove('hidden');
            
            // Reset Record Button Look
            document.getElementById('recDot').classList.add('bg-red-600');
            document.getElementById('recDot').classList.remove('bg-white');
            document.getElementById('recLabel').innerText = "อัดเสียง";
            document.getElementById('statusText').innerText = "พร้อมบรรเลง";
        }

        window.oncontextmenu = (e) => { e.preventDefault(); return false; }

    </script>
</body>
</html>