<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏Ç‡∏•‡∏∏‡πà‡∏¢‡∏à‡∏≥‡∏•‡∏≠‡∏á (Virtual Flute)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ã‡∏π‡∏°‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        body {
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            overflow: hidden;
            font-family: 'Sarabun', sans-serif;
            background: #1a1a1a;
        }

        /* ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡πÅ‡∏™‡∏á‡πÄ‡∏á‡∏≤‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏•‡∏´‡∏∞/‡πÑ‡∏°‡πâ */
        .flute-body {
            background: linear-gradient(90deg, #4a4a4a, #8c8c8c, #4a4a4a);
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }

        /* ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î (‡∏£‡∏π‡∏Ç‡∏•‡∏∏‡πà‡∏¢) */
        .flute-hole {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #333, #000);
            border: 4px solid #555;
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.8), 0 2px 5px rgba(255,255,255,0.1);
            transition: transform 0.05s, background 0.1s;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° */
        .flute-hole.active {
            transform: scale(0.92);
            background: radial-gradient(circle at 30% 30%, #50e3c2, #006b5f); /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏£‡∏Å‡∏ï‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡πÅ‡∏™‡∏á */
            border-color: #88ffd8;
            box-shadow: 0 0 15px #50e3c2;
        }

        /* ‡∏ï‡∏±‡∏ß‡πÇ‡∏ô‡πâ‡∏ï‡∏ö‡∏ô‡∏õ‡∏∏‡πà‡∏° */
        .note-label {
            color: rgba(255,255,255,0.3);
            font-weight: bold;
            font-size: 1.2rem;
            pointer-events: none;
        }
        .flute-hole.active .note-label {
            color: #fff;
            text-shadow: 0 0 5px #000;
        }

        /* ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• */
        .display-screen {
            background: #000;
            border: 2px solid #333;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 5px #00ff00;
        }

        /* ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° */
        .control-btn {
            transition: all 0.2s;
        }
        .control-btn:active {
            transform: scale(0.95);
        }
        
        /* Animation ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
        }
        .recording-indicator {
            animation: pulse-red 1.5s infinite;
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col items-center justify-between py-4 bg-gray-900 text-white">

    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß: ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á -->
    <div class="w-full px-4 flex flex-col gap-3 shrink-0 z-10">
        <!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏ô‡πâ‡∏ï -->
        <div class="display-screen rounded-lg p-3 text-center h-16 flex items-center justify-center relative">
            <span id="status-text" class="text-xs absolute top-1 left-2 text-gray-500">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
            <div id="current-note" class="text-3xl font-bold">--</div>
            <div id="viz-bar" class="absolute bottom-0 left-0 h-1 bg-green-500 transition-all duration-75" style="width: 0%"></div>
        </div>

        <!-- ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° -->
        <div class="flex justify-between items-center bg-gray-800 p-2 rounded-lg border border-gray-700 gap-2">
            <button id="btn-record" class="control-btn flex items-center gap-2 bg-red-900 hover:bg-red-700 text-white px-2 py-2 rounded-md text-sm font-bold flex-1 justify-center min-w-[80px]">
                <span id="rec-icon">‚óè</span> <span id="rec-text">‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</span>
            </button>
            
            <button id="btn-stop-rec" class="control-btn hidden bg-gray-600 text-white px-2 py-2 rounded-md text-sm font-bold flex-1 min-w-[80px]">
                ‡∏´‡∏¢‡∏∏‡∏î
            </button>

            <button id="btn-play" class="control-btn bg-green-800 hover:bg-green-600 disabled:opacity-30 disabled:cursor-not-allowed text-white px-2 py-2 rounded-md text-sm font-bold flex-1 flex items-center justify-center gap-1 min-w-[80px]" disabled>
                <span>‚ñ∂</span> ‡∏ü‡∏±‡∏á
            </button>

            <a id="btn-download" class="control-btn hidden bg-blue-600 hover:bg-blue-500 text-white px-2 py-2 rounded-md text-sm font-bold flex-1 items-center justify-center gap-1 min-w-[80px]" download="flute_song.webm">
                <span>‚¨á</span> ‡πÇ‡∏´‡∏•‡∏î
            </a>
        </div>
    </div>

    <!-- ‡∏ï‡∏±‡∏ß‡∏Ç‡∏•‡∏∏‡πà‡∏¢ (Scrollable Container) -->
    <div class="flute-body flex-1 w-24 sm:w-32 rounded-full my-4 flex flex-col items-center justify-start py-8 gap-4 overflow-y-auto relative border-x-4 border-gray-600 no-scrollbar" style="-ms-overflow-style: none; scrollbar-width: none;">
        
        <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î (Note Keys) -->
        <!-- ‡πÑ‡∏•‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏™‡∏π‡∏á‡∏•‡∏á‡∏ï‡πà‡∏≥ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ï‡πà‡∏≥‡∏Ç‡∏∂‡πâ‡∏ô‡∏™‡∏π‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏ô‡∏±‡∏î (‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ç‡∏•‡∏∏‡πà‡∏¢‡∏£‡∏π‡∏ö‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏π‡∏á ‡∏£‡∏π‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡πà‡∏≥ ‡πÅ‡∏ï‡πà‡πÉ‡∏ô UI ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏°‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏á C4 -> C5) -->
        <!-- ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏õ‡∏µ‡∏¢‡πÇ‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á (‡∏•‡πà‡∏≤‡∏á‡∏ï‡πà‡∏≥ ‡∏ö‡∏ô‡∏™‡∏π‡∏á) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢ -->
        
        <!-- C5 (Do ‡∏™‡∏π‡∏á) -->
        <div class="flute-hole" data-note="C5" data-freq="523.25">
            <span class="note-label">C5</span>
        </div>
        
        <!-- B4 (Si) -->
        <div class="flute-hole" data-note="B4" data-freq="493.88">
            <span class="note-label">B</span>
        </div>
        
        <!-- A4 (La) -->
        <div class="flute-hole" data-note="A4" data-freq="440.00">
            <span class="note-label">A</span>
        </div>
        
        <!-- G4 (Sol) -->
        <div class="flute-hole" data-note="G4" data-freq="392.00">
            <span class="note-label">G</span>
        </div>
        
        <!-- F4 (Fa) -->
        <div class="flute-hole" data-note="F4" data-freq="349.23">
            <span class="note-label">F</span>
        </div>
        
        <!-- E4 (Mi) -->
        <div class="flute-hole" data-note="E4" data-freq="329.63">
            <span class="note-label">E</span>
        </div>
        
        <!-- D4 (Re) -->
        <div class="flute-hole" data-note="D4" data-freq="293.66">
            <span class="note-label">D</span>
        </div>
        
        <!-- C4 (Do) -->
        <div class="flute-hole" data-note="C4" data-freq="261.63">
            <span class="note-label">C</span>
        </div>

    </div>

    <div class="text-xs text-gray-500 pb-2">‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πà‡∏≤ ‚Ä¢ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Multi-touch</div>

    <!-- Audio Element ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏î -->
    <audio id="audio-playback" class="hidden"></audio>

    <script>
        // --- Web Audio API Engine ---
        let audioCtx;
        const activeOscillators = {}; // ‡πÄ‡∏Å‡πá‡∏ö Oscillator ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏¢‡∏∏‡∏î‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡∏ß
        let masterGain;
        let recordingStreamDestination;
        let mediaRecorder;
        let recordedChunks = [];
        let isRecording = false;
        let recordingMimeType = 'audio/webm'; // Default
        let recordingExtension = 'webm';

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Audio Context (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å User Interaction)
        function initAudio() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á Master Gain ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏á‡∏£‡∏ß‡∏°
                masterGain = audioCtx.createGain();
                masterGain.gain.value = 0.5; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢
                masterGain.connect(audioCtx.destination);

                // Setup Recording Destination
                recordingStreamDestination = audioCtx.createMediaStreamDestination();
                masterGain.connect(recordingStreamDestination);
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ç‡∏•‡∏∏‡πà‡∏¢ (Synthesizer)
        function playTone(freq, noteName) {
            initAudio();

            // ‡∏ñ‡πâ‡∏≤‡πÇ‡∏ô‡πâ‡∏ï‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ã‡πâ‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö Phase cancel)
            if (activeOscillators[noteName]) {
                stopTone(noteName);
            }

            const t = audioCtx.currentTime;

            // 1. Oscillator ‡∏´‡∏•‡∏±‡∏Å (Sine Wave) - ‡∏ï‡∏±‡∏ß‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á
            const osc = audioCtx.createOscillator();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(freq, t);

            // 2. Harmonics (Triangle Wave) - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡∏°‡∏à‡∏£‡∏¥‡∏á
            const harmonicOsc = audioCtx.createOscillator();
            harmonicOsc.type = 'triangle';
            harmonicOsc.frequency.setValueAtTime(freq, t);

            // 3. Breath Noise (Optional but simple logic)
            // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏ô‡πâ‡∏ô Synth ‡∏ö‡∏£‡∏¥‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏ï‡πà‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•

            // 4. Envelope (Gain Node) - ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° Attack, Sustain, Release
            const gainNode = audioCtx.createGain();
            const harmonicGain = audioCtx.createGain();

            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Attack (‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ñ‡πà‡∏≠‡∏¢‡πÜ ‡∏î‡∏±‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏•‡∏°‡πÄ‡∏õ‡πà‡∏≤)
            gainNode.gain.setValueAtTime(0, t);
            gainNode.gain.linearRampToValueAtTime(1.0, t + 0.05); // Attack 50ms
            
            harmonicGain.gain.setValueAtTime(0, t);
            harmonicGain.gain.linearRampToValueAtTime(0.2, t + 0.05); // Triangle ‡πÄ‡∏ö‡∏≤‡∏Å‡∏ß‡πà‡∏≤ Sine

            // 5. Vibrato (LFO) - ‡∏•‡∏π‡∏Å‡∏Ñ‡∏≠
            const lfo = audioCtx.createOscillator();
            lfo.frequency.value = 5; // 5Hz vibrato
            const lfoGain = audioCtx.createGain();
            lfoGain.gain.value = 2; // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏ô
            lfo.connect(lfoGain);
            lfoGain.connect(osc.frequency); // ‡∏ï‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏´‡∏•‡∏±‡∏Å
            lfo.start(t);

            // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≤‡∏¢‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì
            osc.connect(gainNode);
            harmonicOsc.connect(harmonicGain);
            harmonicGain.connect(gainNode); // ‡∏£‡∏ß‡∏° Harmonics ‡πÄ‡∏Ç‡πâ‡∏≤ Gain ‡∏´‡∏•‡∏±‡∏Å
            gainNode.connect(masterGain);

            osc.start(t);
            harmonicOsc.start(t);

            // ‡πÄ‡∏Å‡πá‡∏ö Reference ‡πÑ‡∏ß‡πâ‡∏™‡∏±‡πà‡∏á‡∏´‡∏¢‡∏∏‡∏î
            activeOscillators[noteName] = {
                osc: osc,
                harmonicOsc: harmonicOsc,
                lfo: lfo,
                gain: gainNode,
                startTime: t
            };

            // UI Update
            updateDisplay(noteName, true);
        }

        function stopTone(noteName) {
            if (!activeOscillators[noteName]) return;

            const voice = activeOscillators[noteName];
            const t = audioCtx.currentTime;

            // Release Phase (‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ñ‡πà‡∏≠‡∏¢‡πÜ ‡πÄ‡∏ö‡∏≤‡∏•‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏õ‡∏∏‡πà‡∏°)
            // ‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ setTargetAtTime ‡∏´‡∏£‡∏∑‡∏≠ linearRamp ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•
            voice.gain.gain.cancelScheduledValues(t);
            voice.gain.gain.setValueAtTime(voice.gain.gain.value, t);
            voice.gain.gain.exponentialRampToValueAtTime(0.001, t + 0.15); // Release 150ms

            // ‡∏´‡∏¢‡∏∏‡∏î Oscillator ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏á‡∏µ‡∏¢‡∏ö
            voice.osc.stop(t + 0.2);
            voice.harmonicOsc.stop(t + 0.2);
            voice.lfo.stop(t + 0.2);

            // ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            delete activeOscillators[noteName];

            // UI Update
            updateDisplay(noteName, false);
        }

        // --- UI & Interaction Logic ---
        const holes = document.querySelectorAll('.flute-hole');
        const displayNote = document.getElementById('current-note');
        const vizBar = document.getElementById('viz-bar');

        function updateDisplay(note, isActive) {
            const btn = document.querySelector(`.flute-hole[data-note="${note}"]`);
            if (isActive) {
                if(btn) btn.classList.add('active');
                displayNote.textContent = note;
                displayNote.style.color = "#50e3c2";
                vizBar.style.width = '100%';
            } else {
                if(btn) btn.classList.remove('active');
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÇ‡∏ô‡πâ‡∏ï‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏° ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏à‡∏≠
                if (Object.keys(activeOscillators).length === 0) {
                    displayNote.textContent = "--";
                    displayNote.style.color = "#00ff00";
                    vizBar.style.width = '0%';
                }
            }
        }

        // Event Listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Touch/Mouse
        holes.forEach(hole => {
            const note = hole.dataset.note;
            const freq = parseFloat(hole.dataset.freq);

            // Touch Events (‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠)
            hole.addEventListener('touchstart', (e) => {
                e.preventDefault(); // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Scroll/Zoom
                playTone(freq, note);
            }, { passive: false });

            hole.addEventListener('touchend', (e) => {
                e.preventDefault();
                stopTone(note);
            });
            
            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏•‡∏≤‡∏Å‡∏ô‡∏¥‡πâ‡∏ß‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°
            hole.addEventListener('touchcancel', (e) => stopTone(note));

            // Mouse Events (PC/Testing)
            hole.addEventListener('mousedown', (e) => {
                playTone(freq, note);
            });
            hole.addEventListener('mouseup', () => stopTone(note));
            hole.addEventListener('mouseleave', () => stopTone(note));
        });

        // --- Recording Logic ---
        const btnRecord = document.getElementById('btn-record');
        const btnStopRec = document.getElementById('btn-stop-rec');
        const btnPlay = document.getElementById('btn-play');
        const btnDownload = document.getElementById('btn-download');
        const statusText = document.getElementById('status-text');
        const audioPlayback = document.getElementById('audio-playback');
        const recIcon = document.getElementById('rec-icon');

        btnRecord.addEventListener('click', () => {
            initAudio();
            startRecording();
        });

        btnStopRec.addEventListener('click', () => {
            stopRecording();
        });

        btnPlay.addEventListener('click', () => {
            if (audioPlayback.src) {
                // Ensure audio context doesn't block HTML5 audio
                if (audioCtx && audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }
                
                audioPlayback.play().catch(e => {
                    console.error("Playback failed:", e);
                    alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î");
                });

                statusText.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏î...";
                btnPlay.innerHTML = "<span>üîä</span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô...";
                audioPlayback.onended = () => {
                    statusText.textContent = "‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
                    btnPlay.innerHTML = "<span>‚ñ∂</span> ‡∏ü‡∏±‡∏á";
                };
            }
        });

        function startRecording() {
            recordedChunks = [];
            // ‡πÉ‡∏ä‡πâ Stream ‡∏à‡∏≤‡∏Å Node ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ
            const stream = recordingStreamDestination.stream;
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Browser Support ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å MimeType ‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
            if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
                recordingMimeType = 'audio/webm;codecs=opus';
                recordingExtension = 'webm';
            } else if (MediaRecorder.isTypeSupported('audio/webm')) {
                recordingMimeType = 'audio/webm';
                recordingExtension = 'webm';
            } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
                recordingMimeType = 'audio/mp4'; // Safari ‡∏°‡∏±‡∏Å‡∏ä‡∏≠‡∏ö‡∏≠‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                recordingExtension = 'mp4';
            } else {
                alert("Browser ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á");
                return;
            }

            try {
                mediaRecorder = new MediaRecorder(stream, { mimeType: recordingMimeType });
            } catch (e) {
                console.error(e);
                // Fallback ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ mimeType
                try {
                    mediaRecorder = new MediaRecorder(stream);
                } catch (err) {
                    alert("‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ú‡πà‡∏≤‡∏ô Web Audio");
                    return;
                }
            }

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = () => {
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á Blob ‡∏ï‡∏≤‡∏° MimeType ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á
                const blob = new Blob(recordedChunks, { type: recordingMimeType });
                const url = URL.createObjectURL(blob);
                
                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Audio Element
                audioPlayback.src = url;
                
                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏° Play
                btnPlay.disabled = false;
                
                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏° Download
                const timestamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
                btnDownload.href = url;
                btnDownload.download = `Flute_${timestamp}.${recordingExtension}`;
                btnDownload.classList.remove('hidden');
                btnDownload.classList.add('flex');

                statusText.textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô";
            };

            mediaRecorder.start();
            isRecording = true;

            // UI Changes
            btnRecord.classList.add('hidden');
            btnStopRec.classList.remove('hidden');
            btnDownload.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà
            btnDownload.classList.remove('flex');
            
            btnRecord.classList.add('recording-indicator'); 
            statusText.textContent = "‚Ä¢ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á...";
            statusText.style.color = "red";
            btnPlay.disabled = true;
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;

                // UI Changes
                btnRecord.classList.remove('hidden');
                btnStopRec.classList.add('hidden');
                btnRecord.classList.remove('recording-indicator');
                statusText.textContent = "‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...";
                statusText.style.color = "gray";
            }
        }

    </script>
</body>
</html>