<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Salo - Lanna Instrument Simulator (Stable)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #1a1510;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%232c241b' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            touch-action: none; /* ป้องกันการซูมและเลื่อนหน้าจอขณะเล่น */
            -webkit-user-select: none; /* Safari */
            user-select: none;
        }

        .wood-texture {
            background: #5d4037;
            background: linear-gradient(135deg, #5d4037 0%, #3e2723 100%);
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8), 0 10px 20px rgba(0,0,0,0.5);
            border: 4px solid #8d6e63;
        }

        .string {
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            transition: transform 0.05s, background 0.1s;
        }
        
        .string.active {
            transform: scale(0.95) translateY(2px);
            background: linear-gradient(to bottom, #d4af37, #aa8c2c);
            box-shadow: 0 0 15px #ffd700;
        }

        /* Thai Gold Gradient */
        .gold-text {
            background: linear-gradient(to bottom, #cfc09f 22%, #634f2c 24%, #cfc09f 26%, #cfc09f 27%, #ffecb3 40%, #3a2c0f 78%); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            color: #fff; 
        }

        .pattern-border {
            border: 2px solid #bcaaa4;
            position: relative;
        }
        
        .pattern-border::before {
            content: '';
            position: absolute;
            top: 4px; left: 4px; right: 4px; bottom: 4px;
            border: 1px dashed #bcaaa4;
            pointer-events: none;
        }

        .key-hint {
            opacity: 0.6;
            font-size: 0.8rem;
        }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-center overflow-hidden select-none">

    <!-- Header -->
    <div class="text-center mb-4 md:mb-8 relative z-10 pointer-events-none">
        <h1 class="text-4xl md:text-5xl font-bold gold-text mb-2 drop-shadow-lg">สะล้อ</h1>
        <p class="text-amber-200 opacity-80 text-lg">Lanna Salo Simulator</p>
        <p class="text-amber-100/50 text-xs md:text-sm mt-2">รองรับ Multi-touch กดพร้อมกันได้หลายเสียง</p>
    </div>

    <!-- Main Instrument Body -->
    <div class="wood-texture p-4 md:p-8 rounded-3xl w-full max-w-4xl mx-2 relative">
        
        <!-- Decorative Top -->
        <div class="absolute -top-6 left-1/2 transform -translate-x-1/2 w-32 h-12 bg-[#3e2723] rounded-t-full border-t-4 border-[#8d6e63] flex justify-center items-center pointer-events-none">
            <div class="w-20 h-2 bg-amber-900 rounded-full"></div>
        </div>

        <!-- Start Button (Overlay) -->
        <div id="start-overlay" class="absolute inset-0 z-50 bg-black/80 rounded-3xl flex flex-col items-center justify-center backdrop-blur-sm transition-opacity duration-500">
            <button id="start-btn" class="px-8 py-4 bg-amber-700 hover:bg-amber-600 text-white rounded-full text-xl font-bold shadow-lg transform transition hover:scale-105 border-2 border-amber-400">
                แตะเพื่อเริ่มบรรเลง
            </button>
        </div>

        <!-- Keys Container -->
        <div class="flex justify-center gap-1 md:gap-4 overflow-hidden py-4 touch-none" id="touch-area">
            
            <!-- Keys generated by JS -->
            <div id="keys-container" class="flex gap-1 md:gap-3 w-full justify-center">
                <!-- Keys will be injected here -->
            </div>

        </div>

        <!-- Decorative Bottom / Sound Hole illusion -->
        <div class="mt-4 md:mt-6 flex justify-center pointer-events-none">
            <div class="w-16 h-16 rounded-full bg-black/60 shadow-inner border border-white/10 flex items-center justify-center">
                <div class="w-2 h-2 bg-amber-500/50 rounded-full animate-pulse" id="sound-indicator"></div>
            </div>
        </div>
        
    </div>

    <!-- Volume Control -->
    <div class="mt-6 md:mt-8 flex items-center gap-4 bg-[#2c241b] px-6 py-3 rounded-full border border-amber-900/50 z-20">
        <span class="text-amber-200">ความดัง</span>
        <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="0.6" class="accent-amber-600 w-32 cursor-pointer">
    </div>

    <script>
        // Audio Context Setup
        let audioCtx;
        let masterGain;
        let isAudioStarted = false;

        // Note Data
        const notes = [
            { note: 'ซฺ', freq: 196.00, key: 'a', thai: 'ซฺ (Low)', color: 'bg-amber-900' },
            { note: 'ลฺ', freq: 220.00, key: 's', thai: 'ลฺ (Low)', color: 'bg-amber-800' },
            { note: 'ทฺ', freq: 246.94, key: 'd', thai: 'ทฺ (Low)', color: 'bg-amber-800' },
            { note: 'ด', freq: 261.63, key: 'f', thai: 'ด (Mid)', color: 'bg-amber-700' },
            { note: 'ร', freq: 293.66, key: 'g', thai: 'ร (Mid)', color: 'bg-amber-700' },
            { note: 'ม', freq: 329.63, key: 'h', thai: 'ม (Mid)', color: 'bg-amber-600' },
            { note: 'ฟ', freq: 349.23, key: 'j', thai: 'ฟ (Mid)', color: 'bg-amber-600' },
            { note: 'ซ', freq: 392.00, key: 'k', thai: 'ซ (Mid)', color: 'bg-amber-500' },
            { note: 'ล', freq: 440.00, key: 'l', thai: 'ล (Mid)', color: 'bg-amber-500' },
            { note: 'ดํ', freq: 523.25, key: ';', thai: 'ดํ (High)', color: 'bg-amber-400' }
        ];

        // Active Oscillators Tracker
        const activeNotes = {};

        function initAudio() {
            if (isAudioStarted && audioCtx.state === 'running') return;
            
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!audioCtx) {
                audioCtx = new AudioContext();
            } else if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            
            // Re-create master gain if needed
            if(!masterGain) {
                masterGain = audioCtx.createGain();
                masterGain.connect(audioCtx.destination);
                updateVolume();
            }

            isAudioStarted = true;
            document.getElementById('start-overlay').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('start-overlay').style.display = 'none';
            }, 500);
        }

        function updateVolume() {
            if(masterGain) {
                const vol = document.getElementById('volume-slider').value;
                // Use exponential ramp for smooth volume change
                masterGain.gain.setTargetAtTime(vol, audioCtx.currentTime, 0.1);
            }
        }

        document.getElementById('volume-slider').addEventListener('input', updateVolume);

        // Salo Sound Synthesis Engine
        function playSound(freq, id) {
            if (!isAudioStarted) initAudio();
            if (audioCtx.state === 'suspended') audioCtx.resume();

            // If note is already playing, do nothing (or restart envelop if needed, but for stability allow sustain)
            if (activeNotes[id]) return; 

            const t = audioCtx.currentTime;

            // 1. Oscillator 1: Sawtooth (Body)
            const osc1 = audioCtx.createOscillator();
            osc1.type = 'sawtooth';
            osc1.frequency.value = freq;

            // 2. Oscillator 2: Triangle (Fundamental)
            const osc2 = audioCtx.createOscillator();
            osc2.type = 'triangle'; 
            osc2.frequency.value = freq;

            // 3. Vibrato (LFO)
            const lfo = audioCtx.createOscillator();
            lfo.type = 'sine';
            lfo.frequency.value = 5.5; 
            const lfoGain = audioCtx.createGain();
            lfoGain.gain.value = 3.0; 
            lfo.connect(lfoGain);
            lfoGain.connect(osc1.frequency);
            lfoGain.connect(osc2.frequency);
            lfo.start();

            // 4. Filter
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = 2500;
            filter.Q.value = 0.5;

            // 5. Envelope
            const gainNode = audioCtx.createGain();
            
            // Graph Connections
            osc1.connect(filter);
            osc2.connect(filter);
            filter.connect(gainNode);
            gainNode.connect(masterGain);

            // ADSR - Slightly faster attack for responsiveness
            gainNode.gain.setValueAtTime(0, t);
            gainNode.gain.linearRampToValueAtTime(0.7, t + 0.05); // Faster Attack
            gainNode.gain.setValueAtTime(0.7, t + 0.05); // Sustain

            osc1.start(t);
            osc2.start(t);

            // Visual
            const keyEl = document.getElementById(`key-${id}`);
            if(keyEl) keyEl.classList.add('active');
            
            const indicator = document.getElementById('sound-indicator');
            indicator.style.backgroundColor = '#ffd700';
            indicator.style.boxShadow = '0 0 20px #ffd700';

            // Store with explicit reference for cleanup
            activeNotes[id] = { osc1, osc2, lfo, lfoGain, gainNode, filter, id };
        }

        function stopSound(id) {
            if (!activeNotes[id]) return;

            const voice = activeNotes[id];
            // Remove from registry immediately to allow re-trigger
            delete activeNotes[id];

            const t = audioCtx.currentTime;
            const releaseTime = 0.2; // Short release to prevent mud

            // Release Envelope
            voice.gainNode.gain.cancelScheduledValues(t);
            voice.gainNode.gain.setValueAtTime(voice.gainNode.gain.value, t);
            voice.gainNode.gain.exponentialRampToValueAtTime(0.001, t + releaseTime);

            voice.osc1.stop(t + releaseTime);
            voice.osc2.stop(t + releaseTime);
            voice.lfo.stop(t + releaseTime);

            // CRITICAL: Memory Cleanup
            // Disconnect nodes after sound finishes to free memory and prevent "hanging"
            setTimeout(() => {
                voice.osc1.disconnect();
                voice.osc2.disconnect();
                voice.lfo.disconnect();
                voice.lfoGain.disconnect();
                voice.filter.disconnect();
                voice.gainNode.disconnect();
            }, (releaseTime * 1000) + 100);

            // Visual Cleanup
            const keyEl = document.getElementById(`key-${id}`);
            if(keyEl) keyEl.classList.remove('active');
            
            if (Object.keys(activeNotes).length === 0) {
                const indicator = document.getElementById('sound-indicator');
                indicator.style.backgroundColor = 'rgba(245, 158, 11, 0.5)';
                indicator.style.boxShadow = 'none';
            }
        }

        // Generate UI
        const container = document.getElementById('keys-container');
        notes.forEach((n) => {
            const btn = document.createElement('div');
            btn.id = `key-${n.key}`;
            // Added touch-action: none to prevent scrolling on keys
            btn.className = `string flex-1 min-w-[30px] md:min-w-[60px] h-48 md:h-64 rounded-b-xl rounded-t-sm flex flex-col justify-end items-center pb-4 cursor-pointer relative pattern-border bg-gradient-to-b from-[#2c241b] to-[#4e342e] text-amber-100 hover:to-[#5d4037]`;
            btn.dataset.noteId = n.key;
            btn.dataset.freq = n.freq;

            const stringLine = document.createElement('div');
            stringLine.className = "absolute top-0 bottom-0 w-0.5 bg-amber-200/50 left-1/2 transform -translate-x-1/2 pointer-events-none";
            btn.appendChild(stringLine);

            const label = document.createElement('span');
            label.className = "text-lg md:text-2xl font-bold z-10 mb-1 drop-shadow-md pointer-events-none";
            label.innerText = n.note;
            btn.appendChild(label);

            const hint = document.createElement('span');
            hint.className = "key-hint text-amber-400/50 uppercase pointer-events-none hidden md:block";
            hint.innerText = n.key;
            btn.appendChild(hint);

            container.appendChild(btn);
        });

        // --- Improved Input Handling (Multi-touch & Mouse) ---
        
        // 1. Mouse Events
        container.addEventListener('mousedown', (e) => {
            if(e.target.dataset.noteId) {
                e.preventDefault();
                playSound(parseFloat(e.target.dataset.freq), e.target.dataset.noteId);
            }
        });

        // Global mouseup to catch releases outside keys
        window.addEventListener('mouseup', () => {
            Object.keys(activeNotes).forEach(id => stopSound(id));
        });

        // 2. Touch Events (Multi-touch support)
        // We use 'touchstart' and 'touchend' on the container to manage multiple fingers
        container.addEventListener('touchstart', (e) => {
            e.preventDefault(); // Stop scrolling/zooming
            for (let i = 0; i < e.changedTouches.length; i++) {
                const touch = e.changedTouches[i];
                // Use elementFromPoint if target is tricky, but event.target usually works for start
                // We use document.elementFromPoint to be sure in case of overlapping
                const target = document.elementFromPoint(touch.clientX, touch.clientY);
                const btn = target.closest('.string');
                if (btn && btn.dataset.noteId) {
                    playSound(parseFloat(btn.dataset.freq), btn.dataset.noteId);
                }
            }
        }, { passive: false });

        container.addEventListener('touchend', (e) => {
            e.preventDefault();
            for (let i = 0; i < e.changedTouches.length; i++) {
                const touch = e.changedTouches[i];
                // Check which note this touch started on or is currently on
                const target = document.elementFromPoint(touch.clientX, touch.clientY);
                // Simple strategy: Stop ALL notes associated with released touches isn't perfect if sliding
                // Better strategy: Find which key is under this release? 
                // Or simply: Iterate keys, if no touch is on them, stop them.
                
                // Let's use the Robust Strategy:
                // Check which keys are physically being touched right now
                checkActiveTouches(e.touches);
            }
        }, { passive: false });
        
        container.addEventListener('touchcancel', (e) => {
            e.preventDefault();
            checkActiveTouches(e.touches);
        });

        // Helper to sync sound with currently held touches
        function checkActiveTouches(touches) {
            // Get list of Note IDs currently being touched
            const currentlyTouchedIds = new Set();
            for (let i = 0; i < touches.length; i++) {
                const touch = touches[i];
                const element = document.elementFromPoint(touch.clientX, touch.clientY);
                if (element) {
                    const btn = element.closest('.string');
                    if (btn && btn.dataset.noteId) {
                        currentlyTouchedIds.add(btn.dataset.noteId);
                    }
                }
            }

            // Stop notes that are NO LONGER touched
            Object.keys(activeNotes).forEach(id => {
                if (!currentlyTouchedIds.has(id)) {
                    stopSound(id);
                }
            });
            
            // (Optional) Play notes that ARE touched but not playing? 
            // Usually playSound handles 'touchstart', but for 'glissando' (sliding) we might want this later.
            // For now, let's keep it simple: Start on TouchStart, Stop when not touched.
        }

        // 3. Keyboard Events
        document.addEventListener('keydown', (e) => {
            if (e.repeat) return;
            const k = e.key.toLowerCase();
            const noteData = notes.find(n => n.key === k);
            if (noteData) {
                playSound(noteData.freq, k);
            }
        });

        document.addEventListener('keyup', (e) => {
            const k = e.key.toLowerCase();
            const noteData = notes.find(n => n.key === k);
            if (noteData) {
                stopSound(k);
            }
        });

        document.getElementById('start-btn').addEventListener('click', initAudio);

    </script>
</body>
</html>