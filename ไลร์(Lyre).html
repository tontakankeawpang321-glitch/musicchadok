<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>เครื่องเล่นไลร์จำลอง (Virtual Lyre)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #1a1a1a;
            touch-action: none; /* ป้องกันการซูมและการเลื่อนหน้าจอ */
            overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* เอฟเฟกต์สายสั่น */
        @keyframes vibrate {
            0% { transform: translateX(0); }
            20% { transform: translateX(-2px); }
            40% { transform: translateX(2px); }
            60% { transform: translateX(-1px); }
            80% { transform: translateX(1px); }
            100% { transform: translateX(0); }
        }

        .string-vibrating {
            animation: vibrate 0.15s linear infinite;
        }

        .string-container {
            position: relative;
            height: 100%;
            cursor: pointer;
            transition: background-color 0.05s;
        }

        /* Active state visual */
        .string-container.active .string-line {
            background-color: #ffd700;
            box-shadow: 0 0 15px #ffd700, 0 0 30px #ffaa00;
            transform: scaleX(1.5);
        }

        /* แสงวิบวับที่พื้นหลัง */
        .sparkle {
            position: absolute;
            background: white;
            border-radius: 50%;
            pointer-events: none;
            animation: sparkle-anim 0.6s ease-out forwards;
        }

        @keyframes sparkle-anim {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }

        /* สไตล์ลายไม้ */
        .wood-texture {
            background-color: #5d4037;
            background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.05) 0px, rgba(255,255,255,0.05) 2px, transparent 2px, transparent 4px),
                              linear-gradient(to bottom, #3e2723, #5d4037, #3e2723);
            box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
        }

        /* Animation ปุ่มอัดเสียง */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .recording-active {
            animation: pulse-red 1.5s infinite;
            background-color: #ef4444 !important; /* Red-500 */
            color: white !important;
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col items-center justify-center text-white">

    <!-- Start Overlay (จำเป็นสำหรับ Web Audio API) -->
    <div id="start-overlay" class="fixed inset-0 z-50 bg-black/90 flex flex-col items-center justify-center transition-opacity duration-500">
        <h1 class="text-4xl md:text-6xl font-bold mb-4 text-yellow-500">Lyre Harp</h1>
        <p class="text-gray-300 mb-8 text-center px-4">เครื่องดนตรีไลร์จำลอง<br>พร้อมระบบบันทึกเสียง</p>
        <button id="start-btn" class="px-8 py-3 bg-yellow-600 hover:bg-yellow-500 text-black font-bold rounded-full text-xl shadow-lg transform transition hover:scale-105">
            แตะเพื่อเริ่มเล่น
        </button>
    </div>

    <!-- Recording Controls (Top Right) -->
    <div class="absolute top-4 right-4 z-40 flex items-center gap-2">
        <div id="recording-status" class="text-red-400 text-sm font-bold opacity-0 transition-opacity">REC ●</div>
        <button id="record-btn" class="bg-gray-800 hover:bg-gray-700 text-white p-3 rounded-full shadow-lg border border-gray-600 transition-all flex items-center justify-center" title="บันทึกเสียง">
            <!-- Icon Mic -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
            </svg>
        </button>
    </div>

    <!-- Main Instrument Area -->
    <div class="relative w-full max-w-2xl h-[90vh] flex flex-col items-center">
        
        <!-- Header / Decoration -->
        <div class="absolute top-0 w-full flex justify-center z-10 pointer-events-none">
            <div class="wood-texture w-full md:w-3/4 h-16 rounded-b-3xl border-b-4 border-yellow-800 shadow-xl flex items-center justify-center">
                <div class="text-yellow-200 opacity-50 tracking-[0.5em] text-sm md:text-base">ANCIENT LYRE</div>
            </div>
        </div>

        <!-- Strings Area -->
        <div id="harp-body" class="relative w-full h-full flex justify-center items-stretch pt-20 pb-10 px-4 md:px-12">
            
            <!-- SVG Frame (โครงสร้างพิณ) -->
            <svg class="absolute inset-0 w-full h-full pointer-events-none z-0" viewBox="0 0 400 600" preserveAspectRatio="none">
                <!-- Left Arm -->
                <path d="M20,600 Q10,300 60,100 Q80,50 100,50" fill="none" stroke="#3e2723" stroke-width="15" stroke-linecap="round"/>
                <!-- Right Arm -->
                <path d="M380,600 Q390,300 340,100 Q320,50 300,50" fill="none" stroke="#3e2723" stroke-width="15" stroke-linecap="round"/>
                <!-- Top Bar -->
                <line x1="60" y1="80" x2="340" y2="80" stroke="#5d4037" stroke-width="20" stroke-linecap="round" />
                <!-- Bottom Soundbox (Abstract) -->
                <path d="M50,550 Q200,650 350,550 L320,450 Q200,500 80,450 Z" fill="#3e2723" stroke="#271c19" stroke-width="5"/>
            </svg>

            <!-- Strings Container -->
            <div class="z-10 w-full max-w-lg flex justify-between h-full relative" id="strings-wrapper">
                <!-- String Elements will be generated by JS -->
            </div>
        </div>
        
        <!-- Controls / Info -->
        <div class="absolute bottom-4 text-xs text-gray-500 select-none pointer-events-none text-center">
            รองรับการกดพร้อมกันและการรูดสาย (Multi-touch)<br>
            กดรูปไมโครโฟนเพื่ออัดเสียง
        </div>
    </div>

    <script>
        // --- Audio Engine (Optimized & Recorder Ready) ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;
        let masterGain; // Main output node for routing
        
        // Recording Variables
        let mediaRecorder;
        let recordedChunks = [];
        let isRecording = false;
        let recordingDest;

        const notes = [
            { note: 'C4', freq: 261.63, key: '1', label: 'โด' },
            { note: 'D4', freq: 293.66, key: '2', label: 'เร' },
            { note: 'E4', freq: 329.63, key: '3', label: 'มี' },
            { note: 'F4', freq: 349.23, key: '4', label: 'ฟา' },
            { note: 'G4', freq: 392.00, key: '5', label: 'ซอล' },
            { note: 'A4', freq: 440.00, key: '6', label: 'ลา' },
            { note: 'B4', freq: 493.88, key: '7', label: 'ที' },
            { note: 'C5', freq: 523.25, key: '8', label: 'โด(สูง)' }
        ];

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new AudioContext({ latencyHint: 'interactive' });
                // Create a Master Gain to route all sounds through
                masterGain = audioCtx.createGain();
                masterGain.gain.value = 1.0;
                masterGain.connect(audioCtx.destination);
            } else if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function playTone(freq) {
            if (!audioCtx) return;

            const t = audioCtx.currentTime;

            // Oscillators
            const osc = audioCtx.createOscillator();
            osc.type = 'triangle';
            osc.frequency.value = freq;

            const harmonic = audioCtx.createOscillator();
            harmonic.type = 'sine';
            harmonic.frequency.value = freq;

            // Gain Node (Volume Envelope)
            const gainNode = audioCtx.createGain();
            
            // Connect to Master Gain instead of direct destination
            // This allows us to capture the audio from Master Gain later
            osc.connect(gainNode);
            harmonic.connect(gainNode);
            gainNode.connect(masterGain); 

            // Envelope: Crisp Attack, Long Release
            gainNode.gain.setValueAtTime(0, t);
            gainNode.gain.linearRampToValueAtTime(0.4, t + 0.01); 
            gainNode.gain.exponentialRampToValueAtTime(0.001, t + 2.0); 

            // Start
            osc.start(t);
            harmonic.start(t);
            
            // Stop & Cleanup
            const duration = 2.0;
            osc.stop(t + duration);
            harmonic.stop(t + duration);

            setTimeout(() => {
                osc.disconnect();
                harmonic.disconnect();
                gainNode.disconnect();
            }, duration * 1000 + 100);
        }

        // --- Recording Logic ---
        const recordBtn = document.getElementById('record-btn');
        const recordingStatus = document.getElementById('recording-status');

        recordBtn.addEventListener('click', toggleRecording);

        function toggleRecording() {
            initAudio(); // Ensure audio context is ready

            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        }

        function startRecording() {
            try {
                // 1. Create a destination for recording stream
                recordingDest = audioCtx.createMediaStreamDestination();
                
                // 2. Connect Master Gain to Recording Destination
                // Now Master Gain goes to BOTH Speakers (already connected) AND Recorder
                masterGain.connect(recordingDest);

                // 3. Setup MediaRecorder
                mediaRecorder = new MediaRecorder(recordingDest.stream);
                recordedChunks = [];

                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        recordedChunks.push(e.data);
                    }
                };

                mediaRecorder.onstop = saveRecording;

                // 4. Start
                mediaRecorder.start();
                isRecording = true;
                
                // UI Updates
                recordBtn.classList.add('recording-active');
                // Change icon to Stop (Square)
                recordBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" /></svg>`;
                recordingStatus.style.opacity = '1';

            } catch (err) {
                console.error("Recording setup failed:", err);
                alert("ไม่สามารถเริ่มการบันทึกเสียงได้");
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                isRecording = false;

                // Disconnect recording destination to free resources
                // (Master Gain stays connected to Speakers)
                masterGain.disconnect(recordingDest);

                // UI Updates
                recordBtn.classList.remove('recording-active');
                // Change icon back to Mic
                recordBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>`;
                recordingStatus.style.opacity = '0';
            }
        }

        function saveRecording() {
            const blob = new Blob(recordedChunks, { type: 'audio/webm' });
            const url = URL.createObjectURL(blob);
            
            // Create download link
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            const timestamp = new Date().toISOString().slice(0,19).replace(/[-T:]/g,"");
            a.download = `lyre-recording-${timestamp}.webm`;
            document.body.appendChild(a);
            a.click();
            
            // Cleanup
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 100);
        }

        // --- UI Generation ---
        const stringsWrapper = document.getElementById('strings-wrapper');
        const startOverlay = document.getElementById('start-overlay');
        const startBtn = document.getElementById('start-btn');
        const stringElements = [];

        notes.forEach((n, index) => {
            const stringContainer = document.createElement('div');
            stringContainer.className = 'string-container flex-1 flex flex-col items-center group relative';
            stringContainer.style.touchAction = 'none'; 

            // String Line
            const line = document.createElement('div');
            const thickness = Math.max(1, 4 - (index * 0.3)); 
            line.className = 'string-line w-full h-full bg-yellow-100 opacity-60 rounded-full transition-all duration-75 origin-center';
            line.style.width = `${thickness}px`;
            
            // Note Label
            const label = document.createElement('div');
            label.className = 'absolute bottom-20 md:bottom-24 text-center opacity-60 pointer-events-none transition-opacity duration-300';
            label.innerHTML = `<span class="block font-bold text-yellow-500 text-lg shadow-black drop-shadow-md">${n.note}</span>`;

            stringContainer.appendChild(line);
            stringContainer.appendChild(label);
            stringsWrapper.appendChild(stringContainer);
            stringElements.push(stringContainer);
        });

        // --- Optimized Interaction Logic ---

        function triggerString(index) {
            if (index < 0 || index >= notes.length) return;
            
            // Audio
            initAudio(); 
            playTone(notes[index].freq);

            // Visuals
            const el = stringElements[index];
            const line = el.querySelector('.string-line');
            
            // Reset Animation
            line.classList.remove('string-vibrating');
            void line.offsetWidth; // Force Reflow
            line.classList.add('string-vibrating');

            // Active State
            el.classList.add('active');
            
            // Remove active state quickly
            setTimeout(() => el.classList.remove('active'), 150); 
            setTimeout(() => line.classList.remove('string-vibrating'), 400);

            // Lightweight Sparkle
            createSparkle(el);
        }

        function createSparkle(element) {
            const sparkle = document.createElement('div');
            sparkle.className = 'sparkle';
            const rect = element.getBoundingClientRect();
            const randomY = Math.random() * (rect.height * 0.6) + (rect.height * 0.2); 
            
            sparkle.style.left = '50%';
            sparkle.style.top = `${randomY}px`;
            sparkle.style.width = '15px';
            sparkle.style.height = '15px';
            
            element.appendChild(sparkle);
            setTimeout(() => sparkle.remove(), 600);
        }

        // --- High Performance Input Handling ---

        function getIndexFromX(x) {
            const rect = stringsWrapper.getBoundingClientRect();
            if (x < rect.left || x > rect.right) return -1;
            
            const relativeX = x - rect.left;
            const widthPerString = rect.width / notes.length;
            const index = Math.floor(relativeX / widthPerString);
            return Math.max(0, Math.min(index, notes.length - 1));
        }

        // 1. Touch Events
        stringsWrapper.addEventListener('touchstart', (e) => {
            e.preventDefault(); 
            for (let i = 0; i < e.changedTouches.length; i++) {
                const t = e.changedTouches[i];
                const index = getIndexFromX(t.clientX);
                if (index !== -1) triggerString(index);
            }
        }, { passive: false });

        stringsWrapper.addEventListener('touchmove', (e) => {
            e.preventDefault();
            for (let i = 0; i < e.changedTouches.length; i++) {
                const t = e.changedTouches[i];
                const index = getIndexFromX(t.clientX);
                
                if (index !== -1) {
                    const el = stringElements[index];
                    if (!el.classList.contains('active')) {
                        triggerString(index);
                    }
                }
            }
        }, { passive: false });

        // 2. Mouse Events
        let isMouseDown = false;
        
        stringsWrapper.addEventListener('mousedown', (e) => {
            isMouseDown = true;
            const index = getIndexFromX(e.clientX);
            if (index !== -1) triggerString(index);
        });

        window.addEventListener('mouseup', () => isMouseDown = false);
        window.addEventListener('mouseleave', () => isMouseDown = false);

        stringsWrapper.addEventListener('mousemove', (e) => {
            if (!isMouseDown) return;
            const index = getIndexFromX(e.clientX);
            if (index !== -1) {
                const el = stringElements[index];
                if (!el.classList.contains('active')) {
                    triggerString(index);
                }
            }
        });

        // 3. Keyboard
        window.addEventListener('keydown', (e) => {
            if (e.repeat) return; 
            if (e.key >= '1' && e.key <= '8') {
                triggerString(parseInt(e.key) - 1);
            }
            const keyMap = { 'a': 0, 's': 1, 'd': 2, 'f': 3, 'j': 4, 'k': 5, 'l': 6, ';': 7 };
            if (keyMap.hasOwnProperty(e.key.toLowerCase())) {
                triggerString(keyMap[e.key.toLowerCase()]);
            }
        });

        // Start Button
        startBtn.addEventListener('click', () => {
            initAudio();
            startOverlay.style.opacity = '0';
            setTimeout(() => startOverlay.style.display = 'none', 500);
        });

    </script>
</body>
</html>