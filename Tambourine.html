<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡πÅ‡∏ó‡∏°‡∏ö‡∏π‡∏£‡∏µ‡∏ô 3D Metal Morph</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            /* ‡∏™‡∏µ‡πÑ‡∏°‡πâ‡πÄ‡∏î‡∏¥‡∏° */
            --wood-dark: #3e2723;
            --wood-light: #5d4037;
            
            /* ‡∏™‡∏µ‡πÇ‡∏•‡∏´‡∏∞‡πÉ‡∏´‡∏°‡πà */
            --metal-surface: linear-gradient(135deg, #e0e0e0 0%, #909090 50%, #404040 100%);
            --metal-rim: #263238;
            --metal-glow: 0 0 30px rgba(192, 192, 192, 0.4);

            --metal-gold: #f1c40f;
            --metal-dark: #9a7d0a;
            --highlight: #e67e22; 
            --record-color: #ff5252;
            --text-color: #ffe0b2;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            height: 100vh; width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Sarabun', sans-serif;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            color: var(--text-color);
            perspective: 1000px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏¥‡∏ï‡∏¥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∂‡∏Å 3D */
        }

        /* --- Container ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å Animation ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏¢‡πà‡∏≤ --- */
        #shaker-wrapper {
            width: 75vmin;
            height: 75vmin;
            max-width: 400px;
            max-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            /* Animation ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏¢‡πà‡∏≤‡∏à‡∏∞‡∏ó‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡πÅ‡∏ó‡∏ô */
        }

        /* --- ‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏°‡∏ö‡∏π‡∏£‡∏µ‡∏ô --- */
        #tambourine {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 
                0 20px 40px rgba(0,0,0,0.6),
                inset 0 0 30px rgba(0,0,0,0.5);
            -webkit-tap-highlight-color: transparent;
            
            /* ‡∏û‡∏∑‡πâ‡∏ô‡∏ú‡∏¥‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡πÑ‡∏°‡πâ) */
            background: repeating-linear-gradient(45deg, var(--wood-light), var(--wood-light) 10px, var(--wood-dark) 10px, var(--wood-dark) 20px);
            border: 12px solid #2d1e1a;
            
            /* ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */
            transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275), 
                        background 0.2s, 
                        border-color 0.2s,
                        box-shadow 0.2s;
            transform-style: preserve-3d; /* ‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡πÜ ‡∏°‡∏µ‡∏°‡∏¥‡∏ï‡∏¥‡∏î‡πâ‡∏ß‡∏¢ */
        }

        /* --- ‡πÇ‡∏´‡∏°‡∏î‡πÇ‡∏•‡∏´‡∏∞ (Metal Mode) --- */
        #tambourine.metal-morph {
            /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏•‡∏≤‡∏¢‡πÑ‡∏°‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏•‡∏´‡∏∞‡πÄ‡∏á‡∏≤‡πÜ */
            background: radial-gradient(circle at 30% 30%, #cfd8dc, #b0bec5, #546e7a, #37474f);
            border-color: #cfd8dc; /* ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏á‡∏¥‡∏ô */
            border-width: 12px;
            box-shadow: 
                0 25px 50px rgba(0,0,0,0.7),
                inset 0 0 50px rgba(255, 255, 255, 0.3),
                var(--metal-glow); /* ‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡πÅ‡∏™‡∏á‡∏ô‡∏¥‡∏î‡πÜ */
        }

        /* ‡∏´‡∏ô‡∏±‡∏á‡∏Å‡∏•‡∏≠‡∏á */
        .skin {
            width: 85%;
            height: 85%;
            border-radius: 50%;
            position: relative;
            z-index: 2;
            background: radial-gradient(circle, #fff8e1 30%, #ffecb3 100%);
            box-shadow: inset 0 0 30px rgba(0,0,0,0.2);
            transition: background 0.2s;
        }

        /* ‡∏´‡∏ô‡∏±‡∏á‡∏Å‡∏•‡∏≠‡∏á‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÇ‡∏•‡∏´‡∏∞ */
        #tambourine.metal-morph .skin {
            background: radial-gradient(circle, #eceff1 20%, #b0bec5 100%); /* ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏±‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡πÄ‡∏á‡∏¥‡∏ô */
            opacity: 0.95;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }

        /* ‡∏à‡∏≤‡∏ô‡πÇ‡∏•‡∏´‡∏∞ (Jingles) */
        .zils-container {
            position: absolute;
            width: 100%; height: 100%;
            border-radius: 50%;
            pointer-events: none;
            /* ‡πÄ‡∏≠‡∏≤ animation spin ‡∏≠‡∏≠‡∏Å‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà‡∏Å‡∏•‡∏±‡∏ö‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ */
            /* animation: spin 60s linear infinite; */
            transform: translateZ(20px); /* ‡∏•‡∏≠‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‡πÉ‡∏ô‡πÅ‡∏Å‡∏ô Z */
        }

        .zil {
            position: absolute;
            width: 14%; height: 14%;
            border-radius: 50%;
            top: 50%; left: 50%;
            transform-origin: 0 0;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.4);
            background: radial-gradient(circle, var(--metal-gold) 10%, #d4ac0d 60%, var(--metal-dark) 100%);
        }
        
        .zil::after {
            content: ''; position: absolute; top: 25%; left: 25%; width: 50%; height: 50%;
            border-radius: 50%; border: 1px solid rgba(0,0,0,0.3);
        }

        /* Animation ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏¢‡πà‡∏≤ (‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö Wrapper ‡πÅ‡∏ó‡∏ô) */
        .shake-anim { animation: shake 0.3s ease-in-out; }
        @keyframes shake {
            0% { transform: rotate(0deg) translate(0, 0); }
            20% { transform: rotate(10deg) translate(10px, 0); }
            40% { transform: rotate(-10deg) translate(-10px, 0); }
            60% { transform: rotate(5deg) translate(5px, 0); }
            80% { transform: rotate(-5deg) translate(-5px, 0); }
            100% { transform: rotate(0deg) translate(0, 0); }
        }

        /* --- UI Elements --- */
        #start-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 100;
            color: white; text-align: center; transition: opacity 0.5s;
        }
        .btn-start {
            padding: 15px 30px; font-size: 1.5rem; background: var(--highlight);
            border: none; color: white; border-radius: 50px; cursor: pointer;
            margin-top: 20px; box-shadow: 0 0 20px rgba(230, 126, 34, 0.5); font-weight: bold;
        }
        #loading-text { margin-top: 15px; font-size: 0.9rem; color: #aaa; }

        .controls {
            position: absolute; top: 20px; display: flex; gap: 15px; z-index: 50;
            background: rgba(0,0,0,0.5); padding: 10px 20px; border-radius: 30px;
            backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1);
        }
        .btn-control {
            padding: 8px 16px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1); color: white; cursor: pointer;
            font-size: 1rem; display: flex; align-items: center; gap: 5px;
        }
        .btn-control:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-record.recording { background-color: var(--record-color); border-color: var(--record-color); animation: pulse 1.5s infinite; }
        .status-text { color: var(--record-color); font-weight: bold; display: none; align-items: center; margin-left: 10px; font-size: 0.9rem; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { opacity: 0.5; } 100% { transform: scale(1); } }
        .footer { position: absolute; bottom: 20px; color: #666; font-size: 0.8rem; }
    </style>
</head>
<body>

    <div id="start-overlay">
        <h1>‡πÅ‡∏ó‡∏°‡∏ö‡∏π‡∏£‡∏µ‡∏ô 3D Metal</h1>
        <p>‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏•‡∏´‡∏∞‡πÅ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ô‡∏¥‡πâ‡∏ß</p>
        <button id="btn-start-init" class="btn-start" onclick="initAudio()" ontouchstart="initAudio()">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°</button>
        <div id="loading-text">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å URL ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏</div>
    </div>

    <div class="controls">
        <button id="btn-record" class="btn-control btn-record" onclick="toggleRecord()">
            <span class="icon">‚óè</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        </button>
        <button id="btn-stop" class="btn-control" onclick="stopRecord()" disabled>
            <span class="icon">‚ñ†</span> ‡∏´‡∏¢‡∏∏‡∏î & ‡πÇ‡∏´‡∏•‡∏î
        </button>
        <span id="record-status" class="status-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...</span>
    </div>

    <!-- Wrapper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡∏¢‡πà‡∏≤ -->
    <div id="shaker-wrapper">
        <!-- ‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏°‡∏ö‡∏π‡∏£‡∏µ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ -->
        <div id="tambourine">
            <div class="zils-container" id="zils-layer"></div>
            <div class="skin"></div>
        </div>
    </div>

    <div class="footer">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ AI (Gemini)</div>

    <script>
        // ==========================================
        // üõ†Ô∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        // ==========================================
        const soundUrls = {
           'hit': 'tamburin/toburi01.mp3',
           'shake': 'tamburin/toburi02t.mp3'  
        };

        // Audio & Logic Variables
        let audioCtx;
        let masterGain;
        let audioBuffers = { hit: null, shake: null };

        // Recording Variables
        let mediaRecorder;
        let audioChunks = [];
        let destNode; 
        let isRecording = false;

        // Motion Variables
        let lastX=0, lastY=0, lastZ=0, lastTime=0, lastShakeTime=0;
        const SHAKE_THRESHOLD = 300;

        function createZils() {
            const container = document.getElementById('zils-layer');
            const numberOfZils = 6; 
            container.innerHTML = '';
            for (let i = 0; i < numberOfZils; i++) {
                const zil = document.createElement('div');
                zil.className = 'zil';
                const angle = (i / numberOfZils) * 360;
                // ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏¢‡∏∞ zils ‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
                zil.style.transform = `rotate(${angle}deg) translate(280%, 0)`; 
                container.appendChild(zil);
            }
        }

        async function loadSound(key, url) {
            try {
                if (url.includes('INSERT_YOUR')) throw new Error("URL ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤");
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
                audioBuffers[key] = audioBuffer;
            } catch (error) {
                console.warn(`Load failed for ${key}, creating backup.`);
            }
        }

        async function initAudio() {
            if (audioCtx) return;
            const btnStart = document.getElementById('btn-start-init');
            btnStart.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";
            btnStart.disabled = true;
            
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
            if (audioCtx.state === 'suspended') await audioCtx.resume();

            masterGain = audioCtx.createGain();
            masterGain.connect(audioCtx.destination);
            destNode = audioCtx.createMediaStreamDestination();
            masterGain.connect(destNode);

            setupRecorder();
            createZils();
            startMotionSensor();

            // Setup interaction events (Mouse & Touch)
            setupInteractions();

            try {
                await Promise.all([
                    loadSound('hit', soundUrls.hit),
                    loadSound('shake', soundUrls.shake)
                ]);
            } catch (err) { console.error(err); }

            const overlay = document.getElementById('start-overlay');
            overlay.style.opacity = '0';
            setTimeout(() => overlay.remove(), 500);
        }

        function playBackupBeep(type) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            if (type === 'hit') {
                osc.frequency.setValueAtTime(200, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);
            } else {
                osc.frequency.setValueAtTime(800, audioCtx.currentTime);
                osc.type = 'triangle';
            }
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
            osc.connect(gain);
            gain.connect(masterGain);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }

        function playSound(type) {
            if (!audioCtx) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();

            if (audioBuffers[type]) {
                const source = audioCtx.createBufferSource();
                source.buffer = audioBuffers[type];
                source.connect(masterGain);
                source.start(0);
            } else {
                playBackupBeep(type);
            }
        }

        // --- New Interaction & 3D Logic ---

        function setupInteractions() {
            const tambourine = document.getElementById('tambourine');
            
            // Mouse Events
            document.body.addEventListener('mousedown', (e) => handleStart(e, e.clientX, e.clientY));
            document.body.addEventListener('mousemove', (e) => handleMove(e, e.clientX, e.clientY));
            document.body.addEventListener('mouseup', handleEnd);
            
            // Touch Events
            document.body.addEventListener('touchstart', (e) => {
                if (e.target.closest('.controls')) return;
                e.preventDefault(); // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô scroll
                const touch = e.changedTouches[0];
                handleStart(e, touch.clientX, touch.clientY);
            }, { passive: false });

            document.body.addEventListener('touchmove', (e) => {
                 if (e.target.closest('.controls')) return;
                 e.preventDefault();
                 const touch = e.changedTouches[0];
                 handleMove(e, touch.clientX, touch.clientY);
            }, { passive: false });

            document.body.addEventListener('touchend', handleEnd);
        }

        let isPressed = false;

        function handleStart(e, x, y) {
            if (e.target.closest('.controls')) return;
            
            isPressed = true;
            playSound('hit');

            // 1. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏•‡∏´‡∏∞ (Add Class)
            const tambourine = document.getElementById('tambourine');
            tambourine.classList.add('metal-morph');

            // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏µ‡∏¢‡∏á 3D
            calculateTilt(x, y);
        }

        function handleMove(e, x, y) {
            if (!isPressed) return;
            // ‡∏Ç‡∏¢‡∏±‡∏ö‡∏ô‡∏¥‡πâ‡∏ß‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á ‡∏Å‡πá‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ô‡∏¥‡πâ‡∏ß
            calculateTilt(x, y);
        }

        function handleEnd() {
            isPressed = false;
            const tambourine = document.getElementById('tambourine');
            
            // ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏°‡πâ
            tambourine.classList.remove('metal-morph');
            
            // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á 3D ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á
            tambourine.style.transform = 'perspective(1000px) rotateX(0deg) rotateY(0deg) scale(1)';
        }

        function calculateTilt(clientX, clientY) {
            const tambourine = document.getElementById('tambourine');
            const rect = tambourine.getBoundingClientRect();
            
            // ‡∏´‡∏≤‡∏à‡∏∏‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏ó‡∏°‡∏ö‡∏π‡∏£‡∏µ‡∏ô
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏Å‡∏î‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á (-1 ‡∏ñ‡∏∂‡∏á 1)
            const percentX = (clientX - centerX) / (rect.width / 2);
            const percentY = (clientY - centerY) / (rect.height / 2);

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏∏‡∏°‡πÄ‡∏≠‡∏µ‡∏¢‡∏á (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 20 ‡∏≠‡∏á‡∏®‡∏≤)
            // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏î‡∏Ç‡∏ß‡∏≤ (X ‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏ß‡∏Å) ‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏°‡∏∏‡∏ô‡πÅ‡∏Å‡∏ô Y ‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏ß‡∏Å
            // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏î‡∏•‡πà‡∏≤‡∏á (Y ‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏ß‡∏Å) ‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏°‡∏∏‡∏ô‡πÅ‡∏Å‡∏ô X ‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏ö (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏î‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô)
            const maxTilt = 20; 
            const rotateY = percentX * maxTilt;
            const rotateX = -percentY * maxTilt;

            // ‡∏Å‡∏î‡∏•‡∏á‡πÑ‡∏õ‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ (scaleDown)
            tambourine.style.transform = `
                perspective(1000px) 
                rotateX(${rotateX}deg) 
                rotateY(${rotateY}deg) 
                scale(0.95)
            `;
        }

        // --- Motion Sensor (Shake) ---
        function startMotionSensor() {
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') window.addEventListener('devicemotion', handleMotion);
                    })
                    .catch(console.error);
            } else {
                window.addEventListener('devicemotion', handleMotion);
            }
        }

        function handleMotion(event) {
            const acc = event.accelerationIncludingGravity;
            if (!acc) return;
            const now = Date.now();
            if ((now - lastTime) > 20) {
                const deltaX = acc.x - lastX;
                const deltaY = acc.y - lastY;
                const deltaZ = acc.z - lastZ;
                const speed = Math.sqrt(deltaX**2 + deltaY**2 + deltaZ**2) / (now - lastTime) * 1000;

                if (speed > SHAKE_THRESHOLD && (now - lastShakeTime > 150)) {
                    playSound('shake');
                    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡πÉ‡∏ä‡πâ wrapper ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏¢‡πà‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏µ‡∏Å‡∏±‡∏ö transform 3D ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏•‡∏≠‡∏á
                    const wrapper = document.getElementById('shaker-wrapper');
                    wrapper.classList.remove('shake-anim');
                    void wrapper.offsetWidth;
                    wrapper.classList.add('shake-anim');
                    lastShakeTime = now;
                }
                lastX=acc.x; lastY=acc.y; lastZ=acc.z; lastTime=now;
            }
        }

        // --- Recorder Logic ---
        function setupRecorder() {
            try {
                mediaRecorder = new MediaRecorder(destNode.stream);
                mediaRecorder.ondataavailable = (event) => audioChunks.push(event.data);
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const a = document.createElement('a');
                    a.style.display = 'none'; a.href = audioUrl;
                    a.download = `tambourine_${Date.now()}.webm`; 
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => { document.body.removeChild(a); window.URL.revokeObjectURL(audioUrl); }, 100);
                    audioChunks = [];
                    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
                };
            } catch (e) { console.error(e); }
        }

        function toggleRecord() {
            if (!audioCtx) { alert('‡πÅ‡∏ï‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô'); return; }
            if (audioCtx.state === 'suspended') audioCtx.resume();
            if (!isRecording) {
                audioChunks = []; mediaRecorder.start(); isRecording = true;
                document.getElementById('btn-record').classList.add('recording');
                document.getElementById('btn-stop').disabled = false;
                document.getElementById('record-status').style.display = 'flex';
            }
        }

        function stopRecord() {
            if (isRecording) {
                mediaRecorder.stop(); isRecording = false;
                document.getElementById('btn-record').classList.remove('recording');
                document.getElementById('btn-stop').disabled = true;
                document.getElementById('record-status').style.display = 'none';
            }
        }
    </script>
</body>
</html>
