<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>‡∏£‡∏∞‡∏ô‡∏≤‡∏î‡πÄ‡∏≠‡∏Å Pro (Thai Ranat Ek)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');

        :root {
            --wood-dark: #3e2723;
            --wood-light: #8d6e63;
            --gold: #ffd700;
            --string-color: #f5f5f5;
            --bg-color: #1a1a1a;
        }

        * {
            box-sizing: border-box;
            touch-action: none; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏π‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡∏ï‡∏µ */
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            background-color: var(--bg-color);
            font-family: 'Sarabun', sans-serif;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: radial-gradient(circle at center, #2c1e1e 0%, #000000 100%);
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Control Panel */
        #controls {
            height: 50px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            border-bottom: 1px solid var(--gold);
            z-index: 100;
            gap: 8px;
            padding: 0 10px;
            flex-shrink: 0;
        }

        .btn {
            background: linear-gradient(145deg, #5d4037, #3e2723);
            color: var(--gold);
            border: 1px solid var(--gold);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .btn:active {
            transform: scale(0.95);
            background: #3e2723;
        }

        .btn.recording {
            background: #b71c1c;
            color: white;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
        }

        /* Stage area for Ranat */
        #stage {
            flex-grow: 1;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            padding: 0;
            perspective: 1000px;
            overflow: hidden;
        }

        /* The Instrument Body (Rang Ranat) */
        #ranat-container {
            width: 98%;
            max-width: none;
            height: 65%;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            margin-bottom: 10px;
        }

        /* The Base/Boat shape simulation */
        .rang-base {
            position: absolute;
            bottom: -20px;
            width: 100%;
            height: 70px; 
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiPjxkZWZzPjxsaW5lYXJHcmFkaWVudCBpZD0iZ3JhZCIgeDE9IjAlIiB5MT0iMCUiIHgyPSIwJSIgeTI9IjEwMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiM1ZDQwMzc7c3RvcC1vcGFjaXR5OjEiIC8+PHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojM2UyNzIzO3N0b3Atb3BhY2l0eToxIiAvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjZ3JhZCkiIC8+PC9zdmc+');
            background-size: cover;
            border-bottom-left-radius: 50% 100%;
            border-bottom-right-radius: 50% 100%;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            border: 2px solid var(--gold);
            z-index: 1;
        }

        /* Keys Container */
        #keys-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            width: 99%;
            height: 140%; 
            z-index: 10;
            padding-bottom: 15px;
            position: relative;
            /* ‡πÄ‡∏û‡∏¥‡πà‡∏° cursor ‡πÅ‡∏ö‡∏ö‡∏°‡∏∑‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÑ‡∏õ‡∏ß‡∏≤‡∏á */
            cursor: pointer;
        }

        /* String (Roi Chueak) */
        .string-line {
            position: absolute;
            bottom: 42%;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--string-color);
            border-radius: 50%;
            z-index: 5;
            box-shadow: 0 2px 2px rgba(0,0,0,0.3);
            pointer-events: none;
        }

        /* Individual Key (Luk Ranat) */
        .key {
            position: relative;
            background: linear-gradient(90deg, #5d4037 0%, #a1887f 20%, #8d6e63 50%, #a1887f 80%, #5d4037 100%);
            border-radius: 4px; 
            /* ‡∏•‡∏ö cursor: pointer ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡∏•‡∏π‡∏Å ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà wrapper ‡πÅ‡∏•‡πâ‡∏ß */
            box-shadow: 2px 4px 6px rgba(0,0,0,0.4);
            transition: transform 0.05s, background 0.05s;
            display: flex;
            justify-content: center;
            align-items: center;
            color: rgba(255, 255, 255, 0.9);
            font-weight: bold;
            font-size: 0.9rem;
            text-shadow: 1px 1px 2px black;
            border-top: 1px solid rgba(255,255,255,0.3);
            border-bottom: 1px solid rgba(0,0,0,0.6);
            flex: 1; 
            margin: 0 1px;
            height: 100%; 
        }

        .key::after {
            content: '';
            position: absolute;
            top: 25%;
            width: 70%;
            height: 50%;
            background: radial-gradient(rgba(255,255,255,0.15), transparent);
            border-radius: 50%;
            pointer-events: none; /* ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å: ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ elementFromPoint ‡∏°‡∏≠‡∏á‡∏ó‡∏∞‡∏•‡∏∏‡πÑ‡∏õ‡∏´‡∏≤‡∏ï‡∏±‡∏ß key */
        }

        /* Active state controlled by JS now */
        .key.active {
            transform: translateY(6px) scale(0.95);
            background: linear-gradient(90deg, #4e342e 0%, #8d6e63 50%, #4e342e 100%);
        }

        .note-label {
            position: absolute;
            bottom: 10px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none; /* ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç */
            font-size: 1.1em;
        }

        .show-notes .note-label {
            opacity: 1;
        }

        .hit-effect {
            position: absolute;
            width: 40px;
            height: 40px;
            background: radial-gradient(circle, rgba(255,215,0,0.8) 0%, rgba(255,215,0,0) 70%);
            border-radius: 50%;
            pointer-events: none; /* ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç */
            animation: hitFade 0.2s ease-out forwards; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡∏£‡∏±‡∏ß */
            z-index: 20;
        }

        @keyframes hitFade {
            0% { transform: scale(0.5); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }

        /* Status Text */
        #status-msg {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            display: none;
            z-index: 200;
            font-size: 1.2rem;
            white-space: nowrap;
        }

        @media (orientation: portrait) {
            #stage {
                position: absolute;
                top: 50%;
                left: 50%;
                width: 98vh; 
                height: 98vw; 
                transform: translate(-50%, -50%) rotate(90deg);
                transform-origin: center center;
                padding: 0;
            }
            #ranat-container {
                height: 65%; 
                width: 98%;
            }
            #controls {
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 60px;
                z-index: 101;
                border-top: 1px solid var(--gold);
                border-bottom: none;
                padding-bottom: env(safe-area-inset-bottom);
                background: rgba(0, 0, 0, 0.85);
            }
        }
    </style>
</head>
<body>

    <div id="controls">
        <button class="btn" onclick="toggleNotes()">
            <span id="note-btn-text">üëÅÔ∏è ‡πÇ‡∏ô‡πâ‡∏ï</span>
        </button>
        <button class="btn" id="recordBtn" onclick="toggleRecord()">
            ‚è∫Ô∏è ‡∏≠‡∏±‡∏î
        </button>
        <button class="btn" id="playBtn" onclick="playRecording()" disabled>
            ‚ñ∂Ô∏è ‡πÄ‡∏•‡πà‡∏ô
        </button>
        <button class="btn" id="dlBtn" onclick="downloadRecording()" disabled>
            ‚¨áÔ∏è ‡πÇ‡∏´‡∏•‡∏î
        </button>
    </div>

    <div id="stage">
        <div id="ranat-container">
            <div class="rang-base"></div>
            <div class="string-line"></div>
            <div id="keys-wrapper">
                <!-- Keys will be generated by JS -->
            </div>
        </div>
    </div>

    <div id="status-msg"></div>

    <script>
        // --- Configuration ---
        const totalKeys = 21; 
        const baseFreq = 240; 
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        // State
        let isRecording = false;
        let recordedChunks = [];
        let mediaRecorder;
        let audioDest;
        let recordedBlob;
        let recordedAudio = new Audio();
        let showNotes = false;

        // State for Multi-touch & Glissando
        // ‡πÉ‡∏ä‡πâ Map ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏ô‡∏¥‡πâ‡∏ß‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ô‡∏¥‡πâ‡∏ß (Key: Touch ID, Value: Index ‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏¥‡πâ‡∏ß‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏•‡πà‡∏ô)
        const activeTouches = new Map(); 
        let isMouseDown = false;
        let lastMouseKeyIndex = -1;

        const thaiNotes = ['‡∏ã', '‡∏•', '‡∏ó', '‡∏î', '‡∏£', '‡∏°', '‡∏ü']; 

        // --- Initialization ---
        function init() {
            const keysWrapper = document.getElementById('keys-wrapper');
            
            for (let i = 0; i < totalKeys; i++) {
                const key = document.createElement('div');
                key.className = 'key';
                key.dataset.index = i;
                
                // Calculate Thai Frequency
                const freq = baseFreq * Math.pow(2, i / 7);
                key.dataset.freq = freq;

                // Label
                const noteName = thaiNotes[i % 7];
                const label = document.createElement('span');
                label.className = 'note-label';
                label.innerText = noteName;
                key.appendChild(label);

                // Visual Styling
                const heightPercent = 100 - (i * 2.5); 
                key.style.height = `${Math.max(45, heightPercent)}%`; 
                
                // Note: ‡πÄ‡∏£‡∏≤‡∏•‡∏ö event listener ‡∏£‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏≠‡∏≠‡∏Å ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö Global Handler ‡πÅ‡∏ó‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
                
                keysWrapper.appendChild(key);
            }

            // Init Recorder Destination
            audioDest = audioCtx.createMediaStreamDestination();

            // --- ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á (Multitouch + Drag/Slide) ---
            setupInputHandlers(keysWrapper);
        }

        function setupInputHandlers(container) {
            // Touch Events (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ - ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß + ‡∏•‡∏≤‡∏Å)
            container.addEventListener('touchstart', handleTouch, { passive: false });
            container.addEventListener('touchmove', handleTouch, { passive: false });
            container.addEventListener('touchend', handleTouchEnd);
            container.addEventListener('touchcancel', handleTouchEnd);

            // Mouse Events (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PC - ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ñ‡∏•‡∏¥‡∏Å + ‡∏•‡∏≤‡∏Å)
            container.addEventListener('mousedown', (e) => {
                isMouseDown = true;
                handleMouse(e);
            });
            // ‡πÉ‡∏ä‡πâ window event ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö mousemove/up ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏∏‡∏î‡∏Ç‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ
            window.addEventListener('mousemove', (e) => {
                if(isMouseDown) handleMouse(e);
            });
            window.addEventListener('mouseup', () => {
                isMouseDown = false;
                lastMouseKeyIndex = -1;
            });
        }

        function handleTouch(e) {
            e.preventDefault(); // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
            
            // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡∏ô‡∏¥‡πâ‡∏ß‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡∏∞‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏¢‡∏±‡∏ö
            for (let i = 0; i < e.changedTouches.length; i++) {
                const touch = e.changedTouches[i];
                // ‡∏´‡∏≤ element ‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏¥‡πâ‡∏ß‡∏ô‡∏±‡πâ‡∏ô‡πÜ
                const target = document.elementFromPoint(touch.clientX, touch.clientY);
                const key = target ? target.closest('.key') : null;

                if (key) {
                    const index = key.dataset.index;
                    // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á:
                    // 1. ‡∏ñ‡πâ‡∏≤‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å (touchstart) -> ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏•‡∏¢
                    // 2. ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ñ‡πâ‡∏≤‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å (touchmove) ‡πÅ‡∏•‡∏∞‡∏ô‡∏¥‡πâ‡∏ß‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà (‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏°) -> ‡πÄ‡∏•‡πà‡∏ô
                    if (e.type === 'touchstart' || activeTouches.get(touch.identifier) !== index) {
                        playNote(parseFloat(key.dataset.freq), key);
                        activeTouches.set(touch.identifier, index); // ‡∏à‡∏≥‡∏ß‡πà‡∏≤‡∏ô‡∏¥‡πâ‡∏ß‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
                    }
                }
            }
        }

        function handleTouchEnd(e) {
            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏Å‡∏ô‡∏¥‡πâ‡∏ß‡∏≠‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏¥‡πâ‡∏ß‡∏ô‡∏±‡πâ‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
            for (let i = 0; i < e.changedTouches.length; i++) {
                activeTouches.delete(e.changedTouches[i].identifier);
            }
        }

        function handleMouse(e) {
            // ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏°‡∏≤‡∏™‡πå (‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
            const target = document.elementFromPoint(e.clientX, e.clientY);
            const key = target ? target.closest('.key') : null;
            
            if (key) {
                const index = key.dataset.index;
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á
                if (lastMouseKeyIndex !== index) {
                    playNote(parseFloat(key.dataset.freq), key);
                    lastMouseKeyIndex = index;
                }
            }
        }

        // --- Audio Engine ---
        function playNote(freq, element) {
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }

            const t = audioCtx.currentTime;

            // 1. Oscillator
            const osc = audioCtx.createOscillator();
            osc.type = 'sine'; 
            osc.frequency.setValueAtTime(freq, t);

            // 2. Gain Node (Envelope)
            const gain = audioCtx.createGain();
            gain.gain.setValueAtTime(0, t);
            gain.gain.linearRampToValueAtTime(0.8, t + 0.01); // Attack
            gain.gain.exponentialRampToValueAtTime(0.01, t + 0.4); // Decay

            // Connect
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            gain.connect(audioDest);

            // Start/Stop
            osc.start(t);
            osc.stop(t + 0.5);

            // Visual Feedback
            // ‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ remove/add class ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ animation ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏£‡∏±‡∏ß‡πÜ
            element.classList.remove('active');
            void element.offsetWidth; // Trigger Reflow
            element.classList.add('active');
            
            createHitEffect(element);
            
            setTimeout(() => {
                element.classList.remove('active');
            }, 150);
        }

        function createHitEffect(element) {
            const effect = document.createElement('div');
            effect.className = 'hit-effect';
            element.appendChild(effect); 
            effect.style.left = '50%';
            effect.style.top = '50%';
            effect.style.transform = 'translate(-50%, -50%)';
            
            setTimeout(() => effect.remove(), 200);
        }

        function toggleNotes() {
            showNotes = !showNotes;
            const wrapper = document.getElementById('keys-wrapper');
            const btnText = document.getElementById('note-btn-text');
            
            if (showNotes) {
                wrapper.classList.add('show-notes');
                btnText.innerText = "üëÅÔ∏è ‡∏ã‡πà‡∏≠‡∏ô";
            } else {
                wrapper.classList.remove('show-notes');
                btnText.innerText = "üëÅÔ∏è ‡πÇ‡∏ô‡πâ‡∏ï";
            }
        }

        // --- Recording Logic ---
        function toggleRecord() {
            const btn = document.getElementById('recordBtn');
            const playBtn = document.getElementById('playBtn');
            const dlBtn = document.getElementById('dlBtn');

            if (!isRecording) {
                recordedChunks = [];
                mediaRecorder = new MediaRecorder(audioDest.stream);
                
                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) recordedChunks.push(e.data);
                };

                mediaRecorder.onstop = () => {
                    recordedBlob = new Blob(recordedChunks, { type: 'audio/webm' });
                    const audioURL = URL.createObjectURL(recordedBlob);
                    recordedAudio.src = audioURL;
                    playBtn.disabled = false;
                    dlBtn.disabled = false;
                    showStatus("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô");
                };

                mediaRecorder.start();
                isRecording = true;
                btn.classList.add('recording');
                btn.innerHTML = "‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î";
                playBtn.disabled = true;
                dlBtn.disabled = true;
                
                if (audioCtx.state === 'suspended') audioCtx.resume();
                showStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...");

            } else {
                mediaRecorder.stop();
                isRecording = false;
                btn.classList.remove('recording');
                btn.innerHTML = "‚è∫Ô∏è ‡∏≠‡∏±‡∏î";
            }
        }

        function playRecording() {
            if (!recordedAudio.src) return;
            recordedAudio.play();
            showStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏î‡πÑ‡∏ß‡πâ...");
        }

        function downloadRecording() {
            if (!recordedBlob) return;
            const url = URL.createObjectURL(recordedBlob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'ranat_sound_' + new Date().getTime() + '.webm';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            showStatus("‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        }

        function showStatus(msg) {
            const el = document.getElementById('status-msg');
            el.innerText = msg;
            el.style.display = 'block';
            setTimeout(() => {
                el.style.display = 'none';
            }, 2000);
        }

        window.onload = init;

    </script>
</body>
</html>
