<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Harmonica Pro (เมาท์ออแกนมือถือ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
        
        body {
            font-family: 'Sarabun', sans-serif;
            touch-action: none; /* ป้องกันการซูมและเลื่อนหน้าจอ */
            background-color: #1a202c;
            color: white;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        .harmonica-body {
            background: linear-gradient(180deg, #b0c4de 0%, #778899 15%, #dbeafe 50%, #778899 85%, #b0c4de 100%);
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5), inset 0 0 10px rgba(255,255,255,0.3);
            border: 2px solid #4a5568;
        }

        .hole {
            background: linear-gradient(to bottom, #2d3748, #000000);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.8);
            transition: transform 0.1s, background 0.1s;
            position: relative;
            overflow: hidden;
        }

        .hole::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,215,0, 0.0);
            transition: background 0.1s;
        }

        .hole.active {
            transform: scale(0.95);
        }
        
        .hole.active::after {
            background: rgba(255,215,0, 0.3); /* แสงสีทองเมื่อกด */
        }

        /* ปุ่มสลับโหมด */
        .mode-toggle {
            transition: all 0.3s ease;
        }
        .mode-blow {
            background-color: #38a169; /* Green */
            box-shadow: 0 4px 0 #2f855a;
        }
        .mode-draw {
            background-color: #3182ce; /* Blue */
            box-shadow: 0 4px 0 #2c5282;
        }
        .mode-active {
            transform: translateY(4px);
            box-shadow: none !important;
        }

        /* Visualizer */
        canvas {
            width: 100%;
            height: 60px;
            background: #000;
            border-radius: 8px;
            border: 1px solid #4a5568;
        }

        .record-btn {
            background-color: #e53e3e;
            animation: pulse-red 2s infinite;
        }
        
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(229, 62, 62, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(229, 62, 62, 0); }
            100% { box-shadow: 0 0 0 0 rgba(229, 62, 62, 0); }
        }

        /* เพิ่มสไตล์สำหรับปุ่มดาวน์โหลด */
        .control-area {
            min-height: 4rem;
        }
    </style>
</head>
<body class="h-screen flex flex-col justify-between p-4">

    <!-- Header & Visualizer -->
    <div class="flex flex-col items-center gap-2 w-full max-w-2xl mx-auto">
        <h1 class="text-xl font-bold text-gray-300 tracking-wider">HARMONICA PRO</h1>
        <canvas id="visualizer"></canvas>
    </div>

    <!-- Main Instrument Area -->
    <div class="flex-grow flex items-center justify-center w-full max-w-4xl mx-auto">
        <div class="harmonica-body w-full p-2 md:p-4">
            <!-- Numbers -->
            <div class="flex justify-between px-2 mb-1 text-xs text-gray-800 font-bold">
                <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span>
                <span>6</span><span>7</span><span>8</span><span>9</span><span>10</span>
            </div>
            
            <!-- Holes Container -->
            <div class="grid grid-cols-10 gap-1 md:gap-2 h-48 md:h-64">
                <!-- Holes will be generated by JS -->
                <button class="hole rounded-md flex flex-col items-center justify-center text-white" data-hole="0">
                    <span class="note-name text-lg md:text-2xl font-bold text-yellow-400">C4</span>
                </button>
                <button class="hole rounded-md flex flex-col items-center justify-center text-white" data-hole="1">
                    <span class="note-name text-lg md:text-2xl font-bold text-yellow-400">E4</span>
                </button>
                <button class="hole rounded-md flex flex-col items-center justify-center text-white" data-hole="2">
                    <span class="note-name text-lg md:text-2xl font-bold text-yellow-400">G4</span>
                </button>
                <button class="hole rounded-md flex flex-col items-center justify-center text-white" data-hole="3">
                    <span class="note-name text-lg md:text-2xl font-bold text-yellow-400">C5</span>
                </button>
                <button class="hole rounded-md flex flex-col items-center justify-center text-white" data-hole="4">
                    <span class="note-name text-lg md:text-2xl font-bold text-yellow-400">E5</span>
                </button>
                <button class="hole rounded-md flex flex-col items-center justify-center text-white" data-hole="5">
                    <span class="note-name text-lg md:text-2xl font-bold text-yellow-400">G5</span>
                </button>
                <button class="hole rounded-md flex flex-col items-center justify-center text-white" data-hole="6">
                    <span class="note-name text-lg md:text-2xl font-bold text-yellow-400">C6</span>
                </button>
                <button class="hole rounded-md flex flex-col items-center justify-center text-white" data-hole="7">
                    <span class="note-name text-lg md:text-2xl font-bold text-yellow-400">E6</span>
                </button>
                <button class="hole rounded-md flex flex-col items-center justify-center text-white" data-hole="8">
                    <span class="note-name text-lg md:text-2xl font-bold text-yellow-400">G6</span>
                </button>
                <button class="hole rounded-md flex flex-col items-center justify-center text-white" data-hole="9">
                    <span class="note-name text-lg md:text-2xl font-bold text-yellow-400">C7</span>
                </button>
            </div>
            
            <div class="text-center mt-2 text-gray-700 text-sm font-semibold">KEY: C Major</div>
        </div>
    </div>

    <!-- Controls -->
    <div class="w-full max-w-2xl mx-auto flex flex-col gap-3 pb-2">
        
        <!-- Blow/Draw Switch -->
        <div class="flex gap-4">
            <button id="modeBtn" class="mode-toggle mode-blow flex-1 py-4 rounded-xl text-xl font-bold text-white shadow-lg active:translate-y-1 active:shadow-none">
                สถานะ: เป่า (Blow)
            </button>
        </div>

        <!-- Recording Controls -->
        <div class="bg-gray-800 rounded-xl p-2 flex items-center justify-between gap-2 border border-gray-700 control-area">
            <!-- ปุ่มเริ่มอัด -->
            <button id="recordBtn" class="bg-gray-600 hover:bg-gray-500 text-white rounded-lg p-3 w-12 h-12 flex items-center justify-center transition flex-shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                </svg>
            </button>
            
            <!-- ปุ่มหยุด -->
            <button id="stopBtn" class="bg-gray-600 text-white rounded-lg p-3 w-12 h-12 flex items-center justify-center hidden flex-shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                    <rect x="6" y="6" width="12" height="12" rx="2" />
                </svg>
            </button>
            
            <!-- สถานะและตัวจับเวลา -->
            <div id="recordingStatus" class="text-gray-400 text-sm hidden flex-grow text-center">กำลังอัด... <span id="timer" class="font-mono text-white">00:00</span></div>
            
            <!-- ส่วนเล่นเสียงและดาวน์โหลด (แสดงเมื่ออัดเสร็จ) -->
            <div id="playbackContainer" class="hidden flex items-center gap-2 flex-grow justify-end">
                <audio id="audioPlayback" controls class="h-10 w-32 md:w-48"></audio>
                
                <a id="downloadBtn" class="bg-green-600 hover:bg-green-500 text-white rounded-lg p-2 h-10 w-10 flex items-center justify-center shadow-md cursor-pointer" download="harmonica_solo.webm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                </a>
                
                <button id="discardBtn" class="bg-red-900/50 hover:bg-red-800 text-red-200 rounded-lg p-2 h-10 w-10 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Audio Engine & Logic -->
    <script>
        // --- Configuration ---
        const context = new (window.AudioContext || window.webkitAudioContext)();
        let masterGain = context.createGain();
        masterGain.gain.value = 0.5;
        masterGain.connect(context.destination);

        // Recording Stream Setup
        const destStream = context.createMediaStreamDestination();
        masterGain.connect(destStream);
        
        let mediaRecorder;
        let chunks = [];
        let isRecording = false;
        let recordingStartTime = 0;
        let recordingTimerInterval;

        // Frequencies (C Major Diatonic Harmonica)
        // Holes 1-10
        const frequencies = {
            blow: [261.63, 329.63, 392.00, 523.25, 659.25, 783.99, 1046.50, 1318.51, 1567.98, 2093.00], // C4, E4, G4, C5, E5, G5, C6, E6, G6, C7
            draw: [293.66, 392.00, 493.88, 587.33, 698.46, 880.00, 1174.66, 1396.91, 1760.00, 2349.32]  // D4, G4, B4, D5, F5, A5, D6, F6, A6, D7
        };

        const noteNames = {
            blow: ['C4', 'E4', 'G4', 'C5', 'E5', 'G5', 'C6', 'E6', 'G6', 'C7'],
            draw: ['D4', 'G4', 'B4', 'D5', 'F5', 'A5', 'D6', 'F6', 'A6', 'D7']
        };

        // State
        let currentMode = 'blow'; // 'blow' or 'draw'
        let activeOscillators = {}; // Store active notes { holeIndex: {osc1, osc2, gain} }

        // --- UI Elements ---
        const holeButtons = document.querySelectorAll('.hole');
        const modeBtn = document.getElementById('modeBtn');
        const recordBtn = document.getElementById('recordBtn');
        const stopBtn = document.getElementById('stopBtn');
        const audioPlayback = document.getElementById('audioPlayback');
        const recordingStatus = document.getElementById('recordingStatus');
        const timerDisplay = document.getElementById('timer');
        const playbackContainer = document.getElementById('playbackContainer');
        const downloadBtn = document.getElementById('downloadBtn');
        const discardBtn = document.getElementById('discardBtn');

        // --- Audio Synthesis (Harmonica Sound) ---
        function playTone(holeIndex) {
            if (context.state === 'suspended') context.resume();
            if (activeOscillators[holeIndex]) return; // Already playing

            const freq = frequencies[currentMode][holeIndex];
            const now = context.currentTime;

            // Oscillator 1: Sawtooth (Richness)
            const osc1 = context.createOscillator();
            osc1.type = 'sawtooth';
            osc1.frequency.value = freq;

            // Oscillator 2: Square (Hollowness)
            const osc2 = context.createOscillator();
            osc2.type = 'square';
            osc2.frequency.value = freq; // Slightly detuned could be nice, but keeping clean for stability

            // Lowpass Filter (Muffle harshness)
            const filter = context.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = 2500;
            filter.Q.value = 1;

            // Gain Envelope (ADSR)
            const noteGain = context.createGain();
            noteGain.gain.setValueAtTime(0, now);
            noteGain.gain.linearRampToValueAtTime(0.4, now + 0.05); // Attack
            
            // Connect Graph
            osc1.connect(filter);
            osc2.connect(filter);
            filter.connect(noteGain);
            noteGain.connect(masterGain);

            osc1.start(now);
            osc2.start(now);

            activeOscillators[holeIndex] = { osc1, osc2, noteGain };
            
            // UI Feedback
            holeButtons[holeIndex].classList.add('active');
        }

        function stopTone(holeIndex) {
            if (!activeOscillators[holeIndex]) return;

            const { osc1, osc2, noteGain } = activeOscillators[holeIndex];
            const now = context.currentTime;

            // Release
            noteGain.gain.cancelScheduledValues(now);
            noteGain.gain.setValueAtTime(noteGain.gain.value, now);
            noteGain.gain.exponentialRampToValueAtTime(0.001, now + 0.15);

            osc1.stop(now + 0.15);
            osc2.stop(now + 0.15);

            // Cleanup
            setTimeout(() => {
                // Ensure nodes are disconnected to prevent memory leaks
                osc1.disconnect();
                osc2.disconnect();
                noteGain.disconnect();
            }, 200);

            delete activeOscillators[holeIndex];
            
            // UI Feedback
            holeButtons[holeIndex].classList.remove('active');
        }

        function updateLabels() {
            holeButtons.forEach((btn, index) => {
                const note = noteNames[currentMode][index];
                btn.querySelector('.note-name').innerText = note;
                
                // Color hint
                if(currentMode === 'blow') {
                    btn.querySelector('.note-name').classList.remove('text-blue-300');
                    btn.querySelector('.note-name').classList.add('text-yellow-400');
                } else {
                    btn.querySelector('.note-name').classList.remove('text-yellow-400');
                    btn.querySelector('.note-name').classList.add('text-blue-300');
                }
            });
        }

        // --- Mode Switching ---
        function toggleMode() {
            // Stop all current sounds when switching
            Object.keys(activeOscillators).forEach(key => stopTone(parseInt(key)));

            if (currentMode === 'blow') {
                currentMode = 'draw';
                modeBtn.innerText = "สถานะ: ดูด (Draw)";
                modeBtn.classList.remove('mode-blow');
                modeBtn.classList.add('mode-draw');
            } else {
                currentMode = 'blow';
                modeBtn.innerText = "สถานะ: เป่า (Blow)";
                modeBtn.classList.remove('mode-draw');
                modeBtn.classList.add('mode-blow');
            }
            updateLabels();
        }

        // Mode Button Interaction (Toggle Click)
        modeBtn.addEventListener('mousedown', (e) => {
            e.preventDefault();
            toggleMode();
        });
        modeBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            toggleMode();
        });

        // --- Touch Interaction Logic for Holes ---
        // Using pointer events for better multi-touch support across devices
        
        holeButtons.forEach((btn, index) => {
            const handleStart = (e) => {
                e.preventDefault(); // Prevent scrolling
                playTone(index);
            };

            const handleEnd = (e) => {
                e.preventDefault();
                stopTone(index);
            };

            btn.addEventListener('touchstart', handleStart, {passive: false});
            btn.addEventListener('touchend', handleEnd, {passive: false});
            btn.addEventListener('touchcancel', handleEnd, {passive: false});
            
            // Mouse support for desktop testing
            btn.addEventListener('mousedown', handleStart);
            btn.addEventListener('mouseup', handleEnd);
            btn.addEventListener('mouseleave', handleEnd);
        });

        // --- Recorder Logic ---
        recordBtn.addEventListener('click', () => {
            if (context.state === 'suspended') context.resume();
            
            chunks = [];
            
            // ตรวจสอบและเลือก MimeType ที่ดีที่สุดสำหรับอุปกรณ์
            const types = [
                "audio/mp4",
                "audio/webm;codecs=opus",
                "audio/webm", 
                "audio/ogg;codecs=opus",
                "audio/aac"
            ];
            
            let options = undefined;
            for (let type of types) {
                if (MediaRecorder.isTypeSupported(type)) {
                    options = { mimeType: type };
                    console.log("Using mimeType:", type);
                    break;
                }
            }

            try {
                if (options) {
                    mediaRecorder = new MediaRecorder(destStream.stream, options);
                } else {
                    mediaRecorder = new MediaRecorder(destStream.stream); // ให้เบราว์เซอร์เลือกเอง
                }
            } catch (err) {
                alert("เบราว์เซอร์นี้ไม่รองรับการอัดเสียง หรือเกิดข้อผิดพลาด: " + err.message);
                return;
            }

            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) {
                    chunks.push(e.data);
                }
            };

            mediaRecorder.onstop = () => {
                // สร้าง Blob ตาม mimeType ที่ใช้จริง
                const blob = new Blob(chunks, { 'type' : mediaRecorder.mimeType || 'audio/webm' });
                const audioURL = window.URL.createObjectURL(blob);
                
                audioPlayback.src = audioURL;
                
                // ตั้งค่าปุ่มดาวน์โหลด
                downloadBtn.href = audioURL;
                
                // ตั้งนามสกุลไฟล์ให้ถูกต้อง
                let ext = 'webm';
                if (mediaRecorder.mimeType.includes('mp4')) ext = 'mp4';
                else if (mediaRecorder.mimeType.includes('ogg')) ext = 'ogg';
                else if (mediaRecorder.mimeType.includes('wav')) ext = 'wav';
                else if (mediaRecorder.mimeType.includes('aac')) ext = 'aac';
                
                downloadBtn.download = `harmonica_solo_${new Date().getTime()}.${ext}`;

                // แสดงผล UI
                recordBtn.classList.add('hidden');
                stopBtn.classList.add('hidden');
                recordingStatus.classList.add('hidden');
                playbackContainer.classList.remove('hidden');
                
                clearInterval(recordingTimerInterval);
            };

            mediaRecorder.start();
            isRecording = true;
            recordingStartTime = Date.now();
            
            // UI Updates
            recordBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');
            playbackContainer.classList.add('hidden');
            recordingStatus.classList.remove('hidden');
            recordBtn.classList.add('record-btn');

            // Timer
            recordingTimerInterval = setInterval(() => {
                const diff = Math.floor((Date.now() - recordingStartTime) / 1000);
                const m = Math.floor(diff / 60).toString().padStart(2, '0');
                const s = (diff % 60).toString().padStart(2, '0');
                timerDisplay.innerText = `${m}:${s}`;
            }, 1000);
        });

        stopBtn.addEventListener('click', () => {
            if(mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                isRecording = false;
            }
        });
        
        // ปุ่มลบทิ้ง/อัดใหม่
        discardBtn.addEventListener('click', () => {
            playbackContainer.classList.add('hidden');
            recordBtn.classList.remove('hidden');
            audioPlayback.src = '';
            chunks = [];
        });

        // --- Visualizer ---
        const canvas = document.getElementById('visualizer');
        const canvasCtx = canvas.getContext('2d');
        const analyser = context.createAnalyser();
        masterGain.connect(analyser);
        analyser.fftSize = 256;
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);

        function resizeCanvas() {
            canvas.width = canvas.parentElement.offsetWidth;
            canvas.height = 60;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function drawVisualizer() {
            requestAnimationFrame(drawVisualizer);
            analyser.getByteFrequencyData(dataArray);

            canvasCtx.fillStyle = 'rgb(20, 20, 20)';
            canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

            const barWidth = (canvas.width / bufferLength) * 2.5;
            let barHeight;
            let x = 0;

            for(let i = 0; i < bufferLength; i++) {
                barHeight = dataArray[i] / 2; // Scale down

                const r = barHeight + 25 * (i/bufferLength);
                const g = 250 * (i/bufferLength);
                const b = 50;

                canvasCtx.fillStyle = `rgb(${r},${g},${b})`;
                canvasCtx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);

                x += barWidth + 1;
            }
        }
        drawVisualizer();

    </script>
</body>
</html>