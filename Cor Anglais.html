<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cor Anglais Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ป้องกันการเลือกข้อความและการลากบนมือถือ */
        body {
            overscroll-behavior: none;
            touch-action: none; /* เปลี่ยนเป็น none เพื่อปิด Gesture ทั้งหมดของ Browser ในพื้นที่นี้ */
            -webkit-user-select: none;
            user-select: none;
            background-color: #1a1a1a;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden; /* ห้ามเลื่อนหน้าจอ */
        }

        /* เอฟเฟกต์ปุ่มกด */
        .key-btn {
            transition: transform 0.05s ease, box-shadow 0.05s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5), inset 0 2px 4px rgba(255,255,255,0.2);
            /* ใช้ vh เพื่อให้ขนาดปุ่มยืดหดตามความสูงหน้าจอ */
            width: 14vw; 
            height: 14vw;
            max-width: 70px;
            max-height: 70px;
            min-width: 40px;
            min-height: 40px;
        }
        /* ปรับขนาดปุ่มสำหรับหน้าจอแนวนอนหรือจอใหญ่ */
        @media (min-aspect-ratio: 1/1) {
             .key-btn {
                width: 7vh;
                height: 7vh;
             }
        }

        .key-btn:active, .key-btn.active {
            transform: scale(0.95);
            box-shadow: 0 1px 2px rgba(0,0,0,0.5), inset 0 -2px 4px rgba(0,0,0,0.3);
            background: radial-gradient(circle at 30% 30%, #ffd700, #b8860b);
            border-color: #ffd700;
        }

        /* สไตล์ของเครื่องดนตรี (SVG) */
        .wood-texture {
            fill: #2c1a0e; /* สีไม้เข้ม */
            stroke: #1a0f08;
            stroke-width: 2;
        }
        .silver-key {
            fill: #c0c0c0;
            stroke: #808080;
            stroke-width: 1;
            filter: drop-shadow(0px 2px 2px rgba(0,0,0,0.5));
        }

        /* Animation สำหรับการอัดเสียง */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
        }
        .recording-active {
            animation: pulse-red 1.5s infinite;
            background-color: #ef4444 !important;
            color: white !important;
        }

        /* จัดการ Layout แนวตั้ง/แนวนอน */
        #instrument-container {
            /* ใช้ dvh (Dynamic Viewport Height) เพื่อแก้ปัญหาแถบ URL ในมือถือบัง */
            height: 100dvh; 
            width: 100vw;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }
    </style>
</head>
<body class="bg-stone-900 text-white h-screen w-screen overflow-hidden">

    <!-- หน้าจอเริ่ม (เพื่อ Activate AudioContext) -->
    <div id="start-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-black/90 backdrop-blur-sm transition-opacity duration-500">
        <div class="text-center p-6 rounded-xl border border-amber-600/30 bg-stone-800 shadow-2xl">
            <h1 class="text-3xl font-bold text-amber-500 mb-2">Cor Anglais</h1>
            <p class="text-stone-400 mb-6 text-sm">จำลองเสียงเครื่องดนตรีคอร์ แองเกลส์</p>
            <button id="start-btn" class="px-8 py-3 bg-amber-600 hover:bg-amber-500 text-white rounded-full font-bold text-lg shadow-lg transform transition active:scale-95">
                แตะเพื่อเริ่มเล่น
            </button>
        </div>
    </div>

    <div id="instrument-container">
        
        <!-- แผงควบคุมด้านบน -->
        <div class="absolute top-0 left-0 w-full p-4 flex justify-between items-start z-20 pointer-events-none">
            <div class="flex gap-2 pointer-events-auto">
                <button id="toggle-notes" class="bg-stone-700/80 backdrop-blur text-white px-3 py-2 rounded-lg text-xs border border-stone-600 active:bg-stone-600">
                    แสดงโน้ต
                </button>
            </div>
            
            <div class="flex gap-2 pointer-events-auto">
                <button id="record-btn" class="bg-stone-700/80 backdrop-blur text-white px-3 py-2 rounded-lg text-xs border border-stone-600 flex items-center gap-1">
                    <span class="w-2 h-2 rounded-full bg-red-500 inline-block"></span> อัดเสียง
                </button>
                <button id="play-btn" class="bg-stone-700/80 backdrop-blur text-white px-3 py-2 rounded-lg text-xs border border-stone-600 disabled:opacity-50 hidden">
                    ▶ เล่นซ้ำ
                </button>
            </div>
        </div>

        <!-- ตัวเครื่องดนตรี (SVG Background) -->
        <div class="relative h-full w-full max-w-lg flex justify-center items-center py-2">
            <!-- ภาพกราฟิก Cor Anglais -->
            <svg viewBox="0 0 200 800" class="h-full w-auto drop-shadow-2xl opacity-90" preserveAspectRatio="xMidYMid meet">
                <!-- Bulb Bell (ปากลำโพงรูปกระเปาะ - เอกลักษณ์ของ Cor Anglais) -->
                <path d="M70,700 Q60,740 40,750 Q20,760 50,790 L150,790 Q180,760 160,750 Q140,740 130,700 Z" class="wood-texture" fill="url(#woodGradient)" />
                
                <!-- Main Body (ตัวเครื่อง) -->
                <path d="M80,100 L70,700 L130,700 L120,100 Z" class="wood-texture" />
                
                <!-- Bocal (ท่อลมโค้งด้านบน) -->
                <path d="M95,100 L95,60 Q95,20 60,20 L40,30" fill="none" stroke="#d4af37" stroke-width="4" stroke-linecap="round" />
                <path d="M35,28 L45,32 L42,45 L32,41 Z" fill="#d4cfa3" /> <!-- Reed -->

                <!-- Gradient Definition -->
                <defs>
                    <linearGradient id="woodGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:#1a0f08;stop-opacity:1" />
                        <stop offset="50%" style="stop-color:#3e2716;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#1a0f08;stop-opacity:1" />
                    </linearGradient>
                    <linearGradient id="silverGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#e0e0e0;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#909090;stop-opacity:1" />
                    </linearGradient>
                </defs>

                <!-- Key Rods (ก้านคีย์) -->
                <rect x="98" y="120" width="4" height="550" fill="#808080" />
            </svg>

            <!-- ปุ่มกด (Keys) - วางทับบน SVG -->
            <!-- ใช้ flex-col และ justify-center เพื่อให้ปุ่มเรียงกลางจอเสมอ และใช้ gap แบบ vh -->
            <div id="keys-container" class="absolute inset-0 flex flex-col justify-center items-center pointer-events-none" style="gap: 1.5vh; padding-top: 5vh;">
                <!-- Keys will be generated by JS -->
            </div>
        </div>

        <!-- Status Bar -->
        <div class="absolute bottom-4 text-center w-full pointer-events-none z-30">
            <p id="status-text" class="text-amber-500/80 text-sm font-mono tracking-wider opacity-0 transition-opacity">Playing...</p>
        </div>
    </div>

    <script>
        // --- การตั้งค่าเสียง (Audio Config) ---
        const NOTES = [
            { note: 'F3', freq: 174.61, label: 'Low F' },
            { note: 'G3', freq: 196.00, label: 'G' },
            { note: 'A3', freq: 220.00, label: 'A' },
            { note: 'B3', freq: 246.94, label: 'B' },
            { note: 'C4', freq: 261.63, label: 'C' },
            { note: 'D4', freq: 293.66, label: 'D' },
            { note: 'E4', freq: 329.63, label: 'E' },
            { note: 'F4', freq: 349.23, label: 'F' },
            { note: 'G4', freq: 392.00, label: 'High G' },
            { note: 'A4', freq: 440.00, label: 'High A' }
        ];

        let audioCtx;
        let masterGain;
        let activeOscillators = {};
        let isShowNotes = false;

        // --- ระบบอัดเสียง (Recording System) ---
        let isRecording = false;
        let recordedEvents = []; // { note, action: 'on'/'off', time }
        let recordingStartTime = 0;
        let isPlayingBack = false;

        // --- เริ่มต้น AudioContext ---
        function initAudio() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
                
                // Master Gain (Volume Control)
                masterGain = audioCtx.createGain();
                masterGain.gain.value = 0.4; // ลดความดังรวม
                
                // Compressor เพื่อป้องกันเสียงแตก
                const compressor = audioCtx.createDynamicsCompressor();
                compressor.threshold.value = -10;
                compressor.knee.value = 40;
                compressor.ratio.value = 12;
                compressor.attack.value = 0;
                compressor.release.value = 0.25;

                masterGain.connect(compressor);
                compressor.connect(audioCtx.destination);
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        // --- สร้างเสียง Cor Anglais (Synthesis) ---
        function playTone(freq, noteName) {
            if (!audioCtx) initAudio();
            if (activeOscillators[noteName]) return; // ป้องกันเสียงซ้อน

            const t = audioCtx.currentTime;

            // 1. Oscillator หลัก (Sawtooth - ให้เสียงแหลมแบบเครื่องเป่า)
            const osc = audioCtx.createOscillator();
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(freq, t);

            // 2. Filter (Lowpass - กรองเสียงแหลมให้ทุ้มลงเป็นไม้)
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(800, t); // ความถี่ Cutoff เริ่มต้น
            filter.Q.value = 1; 
            // Envelope สำหรับ Filter (ให้เสียง "วาว" ตอนเริ่มเป่า)
            filter.frequency.linearRampToValueAtTime(1500, t + 0.1);
            filter.frequency.linearRampToValueAtTime(1000, t + 0.3);

            // 3. Vibrato (LFO - สั่นพริ้ว)
            const lfo = audioCtx.createOscillator();
            lfo.type = 'sine';
            lfo.frequency.value = 5; // ความเร็วการสั่น 5Hz
            const lfoGain = audioCtx.createGain();
            lfoGain.gain.value = 2; // ความกว้างการสั่น (Pitch depth)
            lfo.connect(lfoGain);
            lfoGain.connect(osc.frequency);
            lfo.start(t);

            // 4. Note Envelope (Gain) - ควบคุมความดัง
            const noteGain = audioCtx.createGain();
            noteGain.gain.setValueAtTime(0, t);
            noteGain.gain.linearRampToValueAtTime(1, t + 0.05); // Attack (ไม่ดังทันที)
            noteGain.gain.linearRampToValueAtTime(0.8, t + 0.2); // Decay

            // เชื่อมต่อ: LFO -> Osc -> Filter -> Gain -> Master
            osc.connect(filter);
            filter.connect(noteGain);
            noteGain.connect(masterGain);

            osc.start(t);

            // เก็บออบเจกต์ไว้เพื่อหยุดเสียงทีหลัง
            activeOscillators[noteName] = { osc, noteGain, lfo, stop: function() {
                const stopTime = audioCtx.currentTime;
                // Release (ค่อยๆ เบาลงเมื่อปล่อยปุ่ม)
                this.noteGain.gain.cancelScheduledValues(stopTime);
                this.noteGain.gain.setValueAtTime(this.noteGain.gain.value, stopTime);
                this.noteGain.gain.exponentialRampToValueAtTime(0.001, stopTime + 0.1);
                
                this.osc.stop(stopTime + 0.1);
                this.lfo.stop(stopTime + 0.1);
                delete activeOscillators[noteName];
            }};

            // UI Feedback
            updateStatus(`Playing: ${noteName}`);
            
            // Record Event
            if (isRecording) {
                recordedEvents.push({
                    note: noteName,
                    action: 'on',
                    time: Date.now() - recordingStartTime,
                    freq: freq
                });
            }
        }

        function stopTone(noteName) {
            if (activeOscillators[noteName]) {
                activeOscillators[noteName].stop();
                updateStatus('');
                
                // Record Event
                if (isRecording) {
                    recordedEvents.push({
                        note: noteName,
                        action: 'off',
                        time: Date.now() - recordingStartTime
                    });
                }
            }
        }

        function stopAllTones() {
            Object.keys(activeOscillators).forEach(key => stopTone(key));
        }

        // --- สร้างปุ่ม (UI Generation) ---
        function createKeys() {
            const container = document.getElementById('keys-container');
            
            const reversedNotes = [...NOTES].reverse(); // เอาเสียงสูงไว้บน

            reversedNotes.forEach((n, index) => {
                const btn = document.createElement('div');
                // เพิ่ม pointer-events-auto เพราะ container หลักมี pointer-events-none เพื่อให้กดทะลุพื้นที่ว่างได้
                btn.className = `key-btn rounded-full bg-gradient-to-br from-stone-200 to-stone-400 border-4 border-stone-500 flex items-center justify-center relative cursor-pointer select-none pointer-events-auto`;
                btn.dataset.note = n.note;
                btn.dataset.freq = n.freq;
                
                // รูปลักษณ์ปุ่มแบบโลหะ
                const innerRing = document.createElement('div');
                innerRing.className = 'w-[70%] h-[70%] rounded-full border border-stone-300 bg-gradient-to-br from-stone-300 to-stone-100 opacity-80 pointer-events-none';
                btn.appendChild(innerRing);

                // ป้ายชื่อโน้ต (ซ่อนอยู่)
                const label = document.createElement('span');
                label.className = 'note-label absolute text-stone-800 font-bold text-sm lg:text-lg opacity-0 pointer-events-none transition-opacity duration-300';
                label.innerText = n.label;
                btn.appendChild(label);

                // Event Listeners (Mouse & Touch)
                const startHandler = (e) => {
                    e.preventDefault(); // ป้องกันการซูม/เลื่อน
                    btn.classList.add('active');
                    playTone(n.freq, n.note);
                };

                const endHandler = (e) => {
                    e.preventDefault();
                    btn.classList.remove('active');
                    stopTone(n.note);
                };

                btn.addEventListener('mousedown', startHandler);
                btn.addEventListener('touchstart', startHandler, {passive: false});
                
                btn.addEventListener('mouseup', endHandler);
                btn.addEventListener('mouseleave', endHandler);
                btn.addEventListener('touchend', endHandler);
                btn.addEventListener('touchcancel', endHandler);

                container.appendChild(btn);
            });
        }

        function updateStatus(text) {
            const el = document.getElementById('status-text');
            el.innerText = text;
            el.style.opacity = text ? '1' : '0';
        }

        // --- ระบบควบคุม UI ---
        document.getElementById('start-btn').addEventListener('click', () => {
            initAudio();
            document.getElementById('start-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('start-screen').style.display = 'none';
            }, 500);
        });

        document.getElementById('toggle-notes').addEventListener('click', (e) => {
            isShowNotes = !isShowNotes;
            const labels = document.querySelectorAll('.note-label');
            labels.forEach(l => l.style.opacity = isShowNotes ? '1' : '0');
            e.target.classList.toggle('bg-amber-600');
            e.target.classList.toggle('text-white');
        });

        // --- Logic การอัดเสียง ---
        const recordBtn = document.getElementById('record-btn');
        const playBtn = document.getElementById('play-btn');

        recordBtn.addEventListener('click', () => {
            if (isPlayingBack) return;

            if (!isRecording) {
                // เริ่มอัด
                isRecording = true;
                recordedEvents = [];
                recordingStartTime = Date.now();
                recordBtn.innerHTML = '<span class="w-2 h-2 rounded-full bg-white animate-pulse inline-block"></span> หยุด';
                recordBtn.classList.add('recording-active');
                playBtn.classList.add('hidden');
            } else {
                // หยุดอัด
                isRecording = false;
                recordBtn.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500 inline-block"></span> อัดเสียงใหม่';
                recordBtn.classList.remove('recording-active');
                if (recordedEvents.length > 0) {
                    playBtn.classList.remove('hidden');
                    playBtn.disabled = false;
                }
            }
        });

        playBtn.addEventListener('click', () => {
            if (recordedEvents.length === 0 || isRecording || isPlayingBack) return;

            isPlayingBack = true;
            playBtn.innerText = 'กำลังเล่น...';
            playBtn.disabled = true;
            recordBtn.disabled = true;

            // เล่น Playback
            recordedEvents.forEach((evt, index) => {
                setTimeout(() => {
                    // Highlight UI Button
                    const btn = document.querySelector(`div[data-note="${evt.note}"]`);
                    
                    if (evt.action === 'on') {
                        playTone(evt.freq, evt.note);
                        if(btn) btn.classList.add('active');
                    } else {
                        stopTone(evt.note);
                        if(btn) btn.classList.remove('active');
                    }

                    // จบการเล่น
                    if (index === recordedEvents.length - 1) {
                        setTimeout(() => {
                            isPlayingBack = false;
                            playBtn.innerText = '▶ เล่นซ้ำ';
                            playBtn.disabled = false;
                            recordBtn.disabled = false;
                            stopAllTones(); // Safety clear
                        }, 500);
                    }
                }, evt.time);
            });
        });

        // Initialize
        createKeys();
        
        // ป้องกันการลากนิ้วไปโดนปุ่มอื่นแล้วไม่ติด (Touch Slide Support)
        // ฟีเจอร์นี้ทำให้ลากนิ้วผ่านปุ่มแล้วเสียงเปลี่ยนเหมือน glissando
        const instrumentContainer = document.getElementById('instrument-container');
        let currentTouchNote = null;

        instrumentContainer.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const element = document.elementFromPoint(touch.clientX, touch.clientY);
            
            if (element && element.classList.contains('key-btn')) {
                const note = element.dataset.note;
                const freq = parseFloat(element.dataset.freq);
                
                if (currentTouchNote !== note) {
                    // Stop previous if exists (สำหรับการเล่นแบบ Monophonic ถ้าต้องการ)
                    // แต่ในที่นี้เราปล่อยให้ Polyphonic ได้เล็กน้อยเพื่อความสมูท
                    // หรือจะ stop ตัวเก่า: if(currentTouchNote) stopTone(currentTouchNote);
                    
                    if (currentTouchNote) {
                         const prevBtn = document.querySelector(`div[data-note="${currentTouchNote}"]`);
                         if(prevBtn) prevBtn.classList.remove('active');
                         stopTone(currentTouchNote);
                    }

                    playTone(freq, note);
                    element.classList.add('active');
                    currentTouchNote = note;
                }
            } else {
                if (currentTouchNote) {
                    stopTone(currentTouchNote);
                    const prevBtn = document.querySelector(`div[data-note="${currentTouchNote}"]`);
                    if(prevBtn) prevBtn.classList.remove('active');
                    currentTouchNote = null;
                }
            }
        }, {passive: false});

        instrumentContainer.addEventListener('touchend', () => {
             if (currentTouchNote) {
                stopTone(currentTouchNote);
                const prevBtn = document.querySelector(`div[data-note="${currentTouchNote}"]`);
                if(prevBtn) prevBtn.classList.remove('active');
                currentTouchNote = null;
            }
        });

    </script>
</body>
</html>