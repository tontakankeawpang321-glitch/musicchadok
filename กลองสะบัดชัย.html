<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Virtual Sabat Chai Drum</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            touch-action: manipulation; /* Prevent double-tap zoom */
            user-select: none;
            -webkit-user-select: none;
            background-color: #1a1510;
            background-image: radial-gradient(circle at center, #2c241b 0%, #0f0c09 100%);
            overflow: hidden;
        }

        /* Drum Skin Texture */
        .drum-skin {
            background: radial-gradient(circle at 30% 30%, #e6ccb3, #d9b38c, #bf8040);
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5), 0 10px 20px rgba(0,0,0,0.5);
            position: relative;
            overflow: hidden;
        }
        
        /* Realistic Leather Texture Pattern */
        .drum-skin::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.6' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.15'/%3E%3C/svg%3E");
            opacity: 0.6;
            pointer-events: none;
        }

        .drum-rim {
            background: linear-gradient(145deg, #5c4033, #3e2b22);
            border: 4px solid #2b1d16;
        }

        .gong {
            background: radial-gradient(circle at 30% 30%, #ffd700, #b8860b, #8b6508);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }

        /* Animation Classes */
        .hit-anim {
            animation: drumHit 0.1s ease-out;
        }
        
        .hit-anim-rim {
            animation: rimHit 0.1s ease-out;
        }

        @keyframes drumHit {
            0% { transform: scale(1); filter: brightness(1.2); }
            50% { transform: scale(0.96); }
            100% { transform: scale(1); filter: brightness(1); }
        }

        @keyframes rimHit {
            0% { transform: scale(1); filter: brightness(1.5); }
            50% { transform: scale(0.98); }
            100% { transform: scale(1); filter: brightness(1); }
        }

        .visual-ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0);
            pointer-events: none;
        }
        
        .ripple-anim {
            animation: rippleEffect 0.4s linear;
        }

        @keyframes rippleEffect {
            to { transform: scale(2.5); opacity: 0; }
        }

        /* Wood Texture for UI */
        .wood-panel {
            background: #4a3728;
            background-image: repeating-linear-gradient(45deg, rgba(0,0,0,0.1) 0px, rgba(0,0,0,0.1) 2px, transparent 2px, transparent 4px);
            border-top: 2px solid #6b5340;
        }
        
        /* Custom Scrollbar for list */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #2c241b; }
        ::-webkit-scrollbar-thumb { background: #8b6508; border-radius: 2px; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col text-white">

    <!-- Header -->
    <header class="h-16 flex items-center justify-between px-4 bg-black/30 backdrop-blur-md z-10 border-b border-white/10">
        <div class="flex items-center gap-2">
            <div class="w-2 h-8 bg-yellow-600 rounded"></div>
            <h1 class="text-xl font-bold text-yellow-500 tracking-wider">กลองสะบัดชัย</h1>
        </div>
        <div id="status-indicator" class="text-xs text-gray-400 font-mono">พร้อมใช้งาน</div>
    </header>

    <!-- Main Instrument Area -->
    <main class="flex-1 relative flex flex-col items-center justify-center p-4 gap-6">
        
        <!-- Center Drum (The big one) -->
        <div class="relative w-full max-w-[340px] aspect-square">
            <!-- Rim (Tak) -->
            <div id="drum-rim" class="absolute inset-0 rounded-full drum-rim flex items-center justify-center cursor-pointer active:brightness-110" data-note="Rim">
                <!-- Skin (Toom) -->
                <div id="drum-skin" class="w-[85%] h-[85%] rounded-full drum-skin flex items-center justify-center shadow-inner cursor-pointer" data-note="Bass">
                    <!-- Decorative Center -->
                    <div class="w-1/4 h-1/4 border-2 border-black/10 rounded-full opacity-50"></div>
                </div>
            </div>
            
            <!-- Visual Markers -->
            <div class="absolute top-2 left-1/2 -translate-x-1/2 text-white/30 text-xs font-bold pointer-events-none">ขอบ (TAK)</div>
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-black/30 text-lg font-bold pointer-events-none">ตุ้ม (TOOM)</div>
        </div>

        <!-- Secondary Instruments -->
        <div class="flex gap-8 items-center justify-center w-full">
            <!-- Wood Block (Gup) -->
            <div id="wood-block" class="w-24 h-24 rounded-lg bg-[#3e2723] border border-[#5d4037] flex flex-col items-center justify-center shadow-lg active:scale-95 transition-transform cursor-pointer" data-note="Wood">
                <div class="w-full h-1 bg-[#5d4037] mb-1"></div>
                <div class="w-full h-1 bg-[#5d4037]"></div>
                <span class="mt-2 text-xs text-white/50">ไม้ (GUP)</span>
            </div>

            <!-- Gong (Mong) -->
            <div id="gong" class="w-28 h-28 rounded-full gong flex items-center justify-center shadow-[0_0_20px_rgba(255,215,0,0.2)] active:scale-95 transition-transform cursor-pointer relative overflow-hidden" data-note="Gong">
                <div class="w-1/2 h-1/2 rounded-full bg-gradient-to-br from-[#ffd700] to-[#b8860b] shadow-[inset_0_0_5px_rgba(0,0,0,0.5)]"></div>
                <span class="absolute bottom-2 text-xs text-black/60 font-bold">โหม่ง (MONG)</span>
            </div>
        </div>

    </main>

    <!-- Controls & Recording -->
    <section class="wood-panel pb-safe pt-4 px-4 rounded-t-2xl shadow-[0_-5px_15px_rgba(0,0,0,0.5)] z-20">
        
        <!-- Controls -->
        <div class="flex justify-between items-center mb-4 max-w-md mx-auto">
            <button id="btn-record" class="flex flex-col items-center gap-1 w-16 group">
                <div class="w-12 h-12 rounded-full bg-gray-800 border-2 border-red-900/50 flex items-center justify-center group-active:scale-95 transition-all shadow-md" id="record-circle">
                    <div class="w-4 h-4 bg-red-500 rounded-full transition-all duration-300"></div>
                </div>
                <span class="text-[10px] text-gray-300">อัดเสียง</span>
            </button>

            <div class="flex-1 mx-4 bg-black/40 h-12 rounded-lg flex items-center justify-center border border-white/5 px-3">
                <div id="timer" class="font-mono text-xl text-yellow-500">00:00</div>
            </div>

            <button id="btn-play" class="flex flex-col items-center gap-1 w-16 group disabled:opacity-50" disabled>
                <div class="w-12 h-12 rounded-full bg-gray-800 border-2 border-green-900/50 flex items-center justify-center group-active:scale-95 transition-all shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <span class="text-[10px] text-gray-300">เล่น/หยุด</span>
            </button>
            
            <button id="btn-download" class="flex flex-col items-center gap-1 w-16 group disabled:opacity-50" disabled>
                <div class="w-12 h-12 rounded-full bg-gray-800 border-2 border-blue-900/50 flex items-center justify-center group-active:scale-95 transition-all shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                </div>
                <span class="text-[10px] text-gray-300">โหลด</span>
            </button>
        </div>

        <!-- Note History Log (Visual Feedback) -->
        <div class="h-8 overflow-hidden relative w-full max-w-md mx-auto mb-2">
            <div id="note-display" class="absolute right-0 top-0 flex gap-2 items-center h-full transition-all">
                <!-- Notes will appear here -->
            </div>
            <div class="absolute inset-0 bg-gradient-to-r from-[#4a3728] via-transparent to-transparent pointer-events-none"></div>
        </div>

    </section>

    <!-- Audio Engine & Logic -->
    <script>
        // --- Audio Engine Class ---
        class DrumEngine {
            constructor() {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                this.masterGain = this.ctx.createGain();
                this.masterGain.gain.value = 0.8;
                
                // For Recording
                this.dest = this.ctx.createMediaStreamDestination();
                this.masterGain.connect(this.ctx.destination);
                this.masterGain.connect(this.dest);
                
                // Sound Buffers (We simulate synthesis for stability, but this structure allows expansion)
                this.sounds = {};
            }

            resume() {
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            }

            // Synthesize Bass Drum (Toom)
            playBass(velocity = 1) {
                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                
                osc.frequency.setValueAtTime(120, t);
                osc.frequency.exponentialRampToValueAtTime(40, t + 0.5);
                
                gain.gain.setValueAtTime(velocity, t);
                gain.gain.exponentialRampToValueAtTime(0.01, t + 0.6);

                osc.connect(gain);
                gain.connect(this.masterGain);

                osc.start(t);
                osc.stop(t + 0.6);
            }

            // Synthesize Rim Click (Tak)
            playRim(velocity = 1) {
                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                const filter = this.ctx.createBiquadFilter();

                // High pitch square wave for sharp attack
                osc.type = 'square';
                osc.frequency.setValueAtTime(800, t);
                osc.frequency.exponentialRampToValueAtTime(400, t + 0.1);

                filter.type = 'highpass';
                filter.frequency.value = 1000;

                gain.gain.setValueAtTime(velocity * 0.5, t);
                gain.gain.exponentialRampToValueAtTime(0.01, t + 0.1);

                osc.connect(filter);
                filter.connect(gain);
                gain.connect(this.masterGain);

                osc.start(t);
                osc.stop(t + 0.1);
            }

            // Synthesize Wood Block (Gup)
            playWood(velocity = 1) {
                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                
                // Short, hollow sound
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, t);
                
                gain.gain.setValueAtTime(velocity * 0.6, t);
                gain.gain.exponentialRampToValueAtTime(0.01, t + 0.08);

                osc.connect(gain);
                gain.connect(this.masterGain);

                osc.start(t);
                osc.stop(t + 0.1);
            }

            // Synthesize Gong (Mong)
            playGong(velocity = 1) {
                const t = this.ctx.currentTime;
                
                // Fundamental + Harmonics (inharmonic)
                const freqs = [220, 280, 600];
                const decays = [1.5, 1.0, 0.4];
                const amps = [0.6, 0.3, 0.1];

                freqs.forEach((f, i) => {
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    
                    osc.frequency.value = f;
                    
                    gain.gain.setValueAtTime(0, t);
                    gain.gain.linearRampToValueAtTime(velocity * amps[i], t + 0.02);
                    gain.gain.exponentialRampToValueAtTime(0.001, t + decays[i]);

                    osc.connect(gain);
                    gain.connect(this.masterGain);
                    
                    osc.start(t);
                    osc.stop(t + decays[i]);
                });
            }
        }

        // --- App Logic ---
        const audio = new DrumEngine();
        let isRecording = false;
        let mediaRecorder;
        let audioChunks = [];
        let startTime;
        let timerInterval;
        let recordedBlob;
        let recordedAudio = new Audio();
        let isPlaying = false;

        // UI Elements
        const statusEl = document.getElementById('status-indicator');
        const timerEl = document.getElementById('timer');
        const noteDisplay = document.getElementById('note-display');
        
        // Buttons
        const btnRecord = document.getElementById('btn-record');
        const btnPlay = document.getElementById('btn-play');
        const btnDownload = document.getElementById('btn-download');
        const recIndicator = document.getElementById('record-circle').firstElementChild;

        // --- Interaction Handlers ---
        
        function handleHit(type, element) {
            audio.resume();
            
            // Visual Feedback
            if (type === 'Bass') {
                element.classList.remove('hit-anim');
                void element.offsetWidth; // Trigger reflow
                element.classList.add('hit-anim');
                createRipple(element);
                audio.playBass();
            } else if (type === 'Rim') {
                element.classList.remove('hit-anim-rim');
                void element.offsetWidth;
                element.classList.add('hit-anim-rim');
                audio.playRim();
            } else if (type === 'Wood') {
                element.style.transform = 'scale(0.95)';
                setTimeout(() => element.style.transform = '', 100);
                audio.playWood();
            } else if (type === 'Gong') {
                element.style.transform = 'scale(0.95)';
                setTimeout(() => element.style.transform = '', 100);
                createRipple(element);
                audio.playGong();
            }

            showNote(type);
        }

        function createRipple(parent) {
            const ripple = document.createElement('div');
            ripple.className = 'visual-ripple ripple-anim';
            ripple.style.width = '100%';
            ripple.style.height = '100%';
            // Center it
            ripple.style.left = '0';
            ripple.style.top = '0';
            
            parent.appendChild(ripple);
            setTimeout(() => ripple.remove(), 500);
        }

        function showNote(text) {
            const span = document.createElement('span');
            span.textContent = text;
            span.className = 'text-xs bg-yellow-600/20 text-yellow-500 px-2 py-1 rounded border border-yellow-600/30 whitespace-nowrap animate-pulse';
            noteDisplay.prepend(span);
            
            // Limit history
            if (noteDisplay.children.length > 5) {
                noteDisplay.lastElementChild.remove();
            }
        }

        // --- Event Listeners (Touch & Click) ---
        
        const instruments = [
            { id: 'drum-skin', type: 'Bass' },
            { id: 'drum-rim', type: 'Rim' },
            { id: 'wood-block', type: 'Wood' },
            { id: 'gong', type: 'Gong' }
        ];

        instruments.forEach(inst => {
            const el = document.getElementById(inst.id);
            
            // Use pointerdown for lowest latency and supporting both mouse/touch
            el.addEventListener('pointerdown', (e) => {
                e.preventDefault(); // Stop mouse emulation
                e.stopPropagation(); // Stop bubbling if nested (like skin inside rim)
                handleHit(inst.type, el);
            });
        });

        // Prevent context menu on long press
        window.oncontextmenu = function(event) {
            event.preventDefault();
            event.stopPropagation();
            return false;
        };

        // --- Recording Logic ---

        btnRecord.addEventListener('click', () => {
            audio.resume();
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        });

        function startRecording() {
            isRecording = true;
            audioChunks = [];
            
            // Setup MediaRecorder
            const stream = audio.dest.stream;
            // Check mimeType support
            let mimeType = 'audio/webm';
            if (!MediaRecorder.isTypeSupported(mimeType)) mimeType = 'audio/ogg';
            
            try {
                mediaRecorder = new MediaRecorder(stream, { mimeType });
            } catch (e) {
                statusEl.innerText = "Error: Browser not supporting recording";
                return;
            }

            mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
            mediaRecorder.onstop = processRecording;
            
            mediaRecorder.start();
            
            // UI Updates
            btnRecord.classList.add('bg-gray-800'); // Active state style can be added here
            recIndicator.classList.remove('bg-red-500');
            recIndicator.classList.add('bg-red-500', 'animate-ping'); // Flashing
            statusEl.innerText = "กำลังอัดเสียง...";
            statusEl.className = "text-xs text-red-500 font-mono animate-pulse";
            
            // Timer
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const diff = Date.now() - startTime;
                const secs = Math.floor(diff / 1000);
                const ms = Math.floor((diff % 1000) / 10);
                timerEl.innerText = `${secs.toString().padStart(2, '0')}:${ms.toString().padStart(2, '0')}`;
            }, 50);

            // Disable other buttons
            btnPlay.disabled = true;
            btnDownload.disabled = true;
        }

        function stopRecording() {
            if(mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            isRecording = false;
            clearInterval(timerInterval);
            
            // UI Updates
            recIndicator.classList.remove('animate-ping');
            statusEl.innerText = "บันทึกเสร็จสิ้น";
            statusEl.className = "text-xs text-green-500 font-mono";
            
            // Enable buttons
            btnPlay.disabled = false;
            btnDownload.disabled = false;
        }

        function processRecording() {
            const blob = new Blob(audioChunks, { type: 'audio/webm' });
            const audioURL = URL.createObjectURL(blob);
            recordedBlob = blob;
            recordedAudio.src = audioURL;
            recordedAudio.onended = () => {
                isPlaying = false;
                btnPlay.innerHTML = `
                <div class="w-12 h-12 rounded-full bg-gray-800 border-2 border-green-900/50 flex items-center justify-center group-active:scale-95 transition-all shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <span class="text-[10px] text-gray-300">เล่น/หยุด</span>`;
                statusEl.innerText = "พร้อมใช้งาน";
            };
        }

        // --- Playback ---
        btnPlay.addEventListener('click', () => {
            if (!recordedAudio.src) return;

            if (isPlaying) {
                recordedAudio.pause();
                recordedAudio.currentTime = 0;
                isPlaying = false;
                statusEl.innerText = "หยุดเล่น";
                // Restore Play Icon
                btnPlay.querySelector('div').innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>`;
            } else {
                recordedAudio.play();
                isPlaying = true;
                statusEl.innerText = "กำลังเล่นเสียงที่อัด...";
                // Change to Stop Icon
                btnPlay.querySelector('div').innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                    </svg>`;
            }
        });

        // --- Download ---
        btnDownload.addEventListener('click', () => {
            if (!recordedBlob) return;
            
            const url = URL.createObjectURL(recordedBlob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `sabat-chai-recording-${new Date().getTime()}.webm`;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 100);
            
            statusEl.innerText = "ดาวน์โหลดเสร็จสิ้น";
        });

    </script>
</body>
</html>