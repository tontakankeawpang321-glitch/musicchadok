<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Realistic Trumpet Simulator</title>
    <style>
        /* Reset & Base Layout */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none; /* Prevent scrolling/zooming */
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #1a1a1a;
            background-image: radial-gradient(circle at center, #2b2b2b 0%, #000 100%);
            color: #fff;
            font-family: 'Sarabun', sans-serif;
            height: 100dvh; /* Dynamic viewport height */
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
        }

        /* Top Control Panel */
        .controls-header {
            width: 100%;
            padding: 15px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #444;
            z-index: 10;
        }

        h1 {
            font-size: 1.2rem;
            margin: 0;
            color: #f0c420; /* Gold text */
            text-shadow: 0 0 5px rgba(240, 196, 32, 0.5);
        }

        .record-panel {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-control {
            padding: 8px 15px;
            border-radius: 20px;
            border: none;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-record {
            background: #ff4444;
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .btn-record.recording {
            animation: pulse-red 1.5s infinite;
            background: #cc0000;
        }

        .btn-download {
            background: #4488ff;
            color: #fff;
        }
        .btn-download:disabled {
            background: #555;
            color: #888;
            cursor: not-allowed;
        }

        /* Trumpet Visual Body */
        .trumpet-body {
            flex-grow: 1;
            width: 100%;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            perspective: 800px;
        }

        /* Stylized Brass Tubing Background */
        .brass-tubing {
            position: absolute;
            width: 90%;
            height: 60%;
            z-index: 0;
            opacity: 0.8;
            pointer-events: none;
            border: 8px solid transparent;
            border-image: linear-gradient(to right, #b8860b, #ffd700, #b8860b, #8b4500) 1;
            border-radius: 50px;
            box-shadow: 
                inset 0 0 20px rgba(0,0,0,0.5),
                0 0 15px rgba(255, 215, 0, 0.2);
            /* Complex gradient to simulate metal pipes */
            background: 
                linear-gradient(90deg, transparent 48%, #aa7700 49%, #ffd700 50%, #aa7700 51%, transparent 52%),
                linear-gradient(180deg, transparent 40%, rgba(184, 134, 11, 0.3) 50%, transparent 60%);
        }
        
        /* The Bell */
        .trumpet-bell {
            position: absolute;
            right: -20px;
            top: 50%;
            transform: translateY(-50%);
            width: 100px;
            height: 150px;
            background: radial-gradient(ellipse at center, #ffd700 0%, #b8860b 60%, #5e3a00 100%);
            border-radius: 0 100% 100% 0 / 50%;
            z-index: -1;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        /* Note Buttons Container (The "Valves") */
        .valve-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 2 rows of 4 */
            gap: 12px;
            width: 100%;
            max-width: 600px;
            padding: 20px;
            z-index: 5;
            padding-bottom: 40px; /* Safe area for bottom swipe */
        }

        /* Individual Valve Button */
        .valve-btn {
            position: relative;
            width: 100%;
            aspect-ratio: 1 / 1; /* Circle */
            border-radius: 50%;
            border: none;
            outline: none;
            background: radial-gradient(circle at 30% 30%, #fffbe0 0%, #ffd700 40%, #b8860b 80%, #5e3a00 100%);
            box-shadow: 
                0 8px 10px rgba(0,0,0,0.5),
                inset 0 2px 3px rgba(255,255,255,0.5);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: transform 0.1s, box-shadow 0.1s;
        }

        /* Mother of Pearl inlay look */
        .valve-btn::after {
            content: '';
            position: absolute;
            width: 70%;
            height: 70%;
            background: radial-gradient(circle at center, #fff 0%, #eee 40%, #ccc 100%);
            border-radius: 50%;
            border: 2px solid #b8860b;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
        }

        .valve-btn span {
            position: relative;
            z-index: 2;
            color: #333;
            font-weight: 900;
            font-size: 1.5rem;
            text-shadow: 0 1px 0 rgba(255,255,255,0.8);
            pointer-events: none;
        }

        .valve-btn .note-name {
            font-size: 1.2rem;
        }
        
        .valve-btn .note-latin {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: -2px;
        }

        /* Active State (Pressed) */
        .valve-btn.active {
            transform: translateY(10px) scale(0.95);
            box-shadow: 
                0 2px 4px rgba(0,0,0,0.5),
                inset 0 5px 10px rgba(0,0,0,0.4);
            background: radial-gradient(circle at 30% 30%, #e6c200 0%, #b8860b 100%);
        }

        /* Overlay for "Click to Start" */
        #start-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: #ffd700;
            text-align: center;
        }
        
        .start-btn {
            margin-top: 20px;
            padding: 15px 40px;
            font-size: 1.5rem;
            background: linear-gradient(to bottom, #ffd700, #b8860b);
            border: none;
            border-radius: 50px;
            color: #3f2a00;
            font-weight: bold;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
            cursor: pointer;
            animation: pulse-gold 2s infinite;
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0); }
        }
        
        @keyframes pulse-gold {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Visual Feedback when playing */
        .sound-wave {
            position: absolute;
            right: -50px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(255, 215, 0, 0.5);
            z-index: -2;
            opacity: 0;
        }
        
        .sound-wave.emitting {
            animation: emit-sound 0.5s linear;
        }

        @keyframes emit-sound {
            0% { transform: translateY(-50%) scale(1); opacity: 0.8; right: -20px; }
            100% { transform: translateY(-50%) scale(10); opacity: 0; right: -150px; }
        }

    </style>
</head>
<body>

    <!-- Start Overlay (Required for AudioContext) -->
    <div id="start-overlay">
        <h1 style="font-size: 2rem; margin-bottom: 10px;">Trumpet Pro</h1>
        <p>‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏£‡∏±‡∏°‡πÄ‡∏õ‡πá‡∏ï‡∏™‡∏°‡∏à‡∏£‡∏¥‡∏á</p>
        <button class="start-btn" id="start-btn">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button>
    </div>

    <!-- Controls -->
    <div class="controls-header">
        <h1>üé∫ Trumpet</h1>
        <div class="record-panel">
            <button id="btn-record" class="btn-control btn-record">
                <span>‚óè</span> ‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á
            </button>
            <button id="btn-download" class="btn-control btn-download" disabled>
                <span>‚¨á</span> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
            </button>
        </div>
    </div>

    <!-- Instrument Graphic Area -->
    <div class="trumpet-body">
        <div class="brass-tubing"></div>
        <div class="trumpet-bell"></div>
        <div id="sound-emitter" class="sound-wave"></div>
        <!-- Decorative Valves pipes -->
        <div style="position: absolute; width: 60px; height: 120px; border-left: 10px solid #775500; border-right: 10px solid #775500; left: 30%;"></div>
        <div style="position: absolute; width: 60px; height: 120px; border-left: 10px solid #775500; border-right: 10px solid #775500; left: 50%; transform: translateX(-50%);"></div>
        <div style="position: absolute; width: 60px; height: 120px; border-left: 10px solid #775500; border-right: 10px solid #775500; right: 30%;"></div>
    </div>

    <!-- Interactive Valves (Note Buttons) -->
    <div class="valve-container">
        <!-- Low Register -->
        <button class="valve-btn" data-note="C4">
            <span class="note-name">‡πÇ‡∏î</span>
            <span class="note-latin">C</span>
        </button>
        <button class="valve-btn" data-note="D4">
            <span class="note-name">‡πÄ‡∏£</span>
            <span class="note-latin">D</span>
        </button>
        <button class="valve-btn" data-note="E4">
            <span class="note-name">‡∏°‡∏µ</span>
            <span class="note-latin">E</span>
        </button>
        <button class="valve-btn" data-note="F4">
            <span class="note-name">‡∏ü‡∏≤</span>
            <span class="note-latin">F</span>
        </button>
        
        <!-- High Register -->
        <button class="valve-btn" data-note="G4">
            <span class="note-name">‡∏ã‡∏≠‡∏•</span>
            <span class="note-latin">G</span>
        </button>
        <button class="valve-btn" data-note="A4">
            <span class="note-name">‡∏•‡∏≤</span>
            <span class="note-latin">A</span>
        </button>
        <button class="valve-btn" data-note="B4">
            <span class="note-name">‡∏ó‡∏µ</span>
            <span class="note-latin">B</span>
        </button>
        <button class="valve-btn" data-note="C5">
            <span class="note-name">‡πÇ‡∏î‡∏™‡∏π‡∏á</span>
            <span class="note-latin">C5</span>
        </button>
    </div>

    <script>
        /**
         * Trumpet Audio Engine
         * Uses Web Audio API to synthesize a brass-like sound
         */
        const AudioEngine = {
            ctx: null,
            masterGain: null,
            reverbNode: null,
            dest: null, // For recording
            activeOscillators: {},

            init() {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AudioContext();
                
                // Destination for output (Speaker + Recorder)
                this.dest = this.ctx.createMediaStreamDestination();
                
                // Master Gain
                this.masterGain = this.ctx.createGain();
                this.masterGain.gain.value = 0.6;
                
                // Reverb (Convolver)
                this.reverbNode = this.ctx.createConvolver();
                this.createImpulseResponse(1.5, 1.5, false); // Length, Decay, Reverse

                // Chain: Master -> Reverb -> (Speakers & Recorder)
                // Also: Master -> (Speakers & Recorder) (Dry signal)
                this.masterGain.connect(this.ctx.destination);
                this.masterGain.connect(this.dest);
                
                this.masterGain.connect(this.reverbNode);
                this.reverbNode.connect(this.ctx.destination);
                this.reverbNode.connect(this.dest);
            },

            // Create a simple reverb impulse
            createImpulseResponse(duration, decay, reverse) {
                const sampleRate = this.ctx.sampleRate;
                const length = sampleRate * duration;
                const impulse = this.ctx.createBuffer(2, length, sampleRate);
                const left = impulse.getChannelData(0);
                const right = impulse.getChannelData(1);

                for (let i = 0; i < length; i++) {
                    let n = reverse ? length - i : i;
                    // Exponential decay noise
                    left[i] = (Math.random() * 2 - 1) * Math.pow(1 - n / length, decay);
                    right[i] = (Math.random() * 2 - 1) * Math.pow(1 - n / length, decay);
                }
                this.reverbNode.buffer = impulse;
            },

            playNote(freq, noteId) {
                if (!this.ctx) return;
                if (this.ctx.state === 'suspended') this.ctx.resume();

                // Stop existing note if playing (Monophonic feel per button, though polyphonic capability)
                if (this.activeOscillators[noteId]) {
                    this.stopNote(noteId);
                }

                const t = this.ctx.currentTime;

                // 1. Oscillators
                // Sawtooth is the base for brass
                const osc = this.ctx.createOscillator();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(freq, t);

                // Add a second oscillator for richness (slightly detuned)
                const osc2 = this.ctx.createOscillator();
                osc2.type = 'triangle';
                osc2.frequency.setValueAtTime(freq, t);
                osc2.detune.value = 5; // Slight detune

                // 2. Filter (Lowpass) - The "Wah" / "Blare" effect of brass
                // Opens up quickly on attack
                const filter = this.ctx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.Q.value = 1; // Resonance
                filter.frequency.setValueAtTime(400, t);
                filter.frequency.exponentialRampToValueAtTime(freq * 4, t + 0.05); // Attack brightness
                filter.frequency.exponentialRampToValueAtTime(freq * 2, t + 0.4); // Decay brightness

                // 3. Amplitude Envelope (ADSR)
                const gainNode = this.ctx.createGain();
                gainNode.gain.setValueAtTime(0, t);
                gainNode.gain.linearRampToValueAtTime(0.8, t + 0.05); // Attack
                gainNode.gain.linearRampToValueAtTime(0.6, t + 0.2); // Decay to sustain
                
                // Connections
                osc.connect(filter);
                osc2.connect(filter); // Mix triangle in
                filter.connect(gainNode);
                gainNode.connect(this.masterGain);

                osc.start(t);
                osc2.start(t);

                // Store reference to stop later
                this.activeOscillators[noteId] = { osc, osc2, gainNode, filter };
            },

            stopNote(noteId) {
                if (!this.activeOscillators[noteId]) return;

                const { osc, osc2, gainNode } = this.activeOscillators[noteId];
                const t = this.ctx.currentTime;

                // Release envelope
                gainNode.gain.cancelScheduledValues(t);
                gainNode.gain.setValueAtTime(gainNode.gain.value, t);
                gainNode.gain.exponentialRampToValueAtTime(0.001, t + 0.1); // Quick release

                osc.stop(t + 0.15);
                osc2.stop(t + 0.15);

                // Clean up memory
                setTimeout(() => {
                    if (this.activeOscillators[noteId] && this.activeOscillators[noteId].osc === osc) {
                        delete this.activeOscillators[noteId];
                    }
                }, 200);
            }
        };

        /**
         * Recording Logic
         */
        const Recorder = {
            mediaRecorder: null,
            chunks: [],
            audioBlob: null,
            audioUrl: null,
            isRecording: false,

            toggleRecord() {
                if (this.isRecording) {
                    this.stop();
                } else {
                    this.start();
                }
            },

            start() {
                if (!AudioEngine.dest) return;
                this.chunks = [];
                // Use the MediaStreamDestination from AudioEngine
                try {
                    // Try to use webm for better compatibility on Android/Chrome
                    const options = MediaRecorder.isTypeSupported('audio/webm') ? { mimeType: 'audio/webm' } : undefined;
                    this.mediaRecorder = new MediaRecorder(AudioEngine.dest.stream, options);
                } catch (e) {
                    alert("‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ú‡πà‡∏≤‡∏ô Web Audio");
                    return;
                }

                this.mediaRecorder.ondataavailable = (e) => this.chunks.push(e.data);
                this.mediaRecorder.onstop = (e) => {
                    const mimeType = this.mediaRecorder.mimeType || 'audio/webm';
                    this.audioBlob = new Blob(this.chunks, { 'type' : mimeType });
                    this.audioUrl = URL.createObjectURL(this.audioBlob);
                    
                    const btnDownload = document.getElementById('btn-download');
                    btnDownload.disabled = false;
                    btnDownload.innerHTML = '<span>‚¨á</span> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î';
                };

                this.mediaRecorder.start();
                this.isRecording = true;
                updateRecordUI(true);
                
                // Disable download while recording
                const btnDownload = document.getElementById('btn-download');
                btnDownload.disabled = true;
            },

            stop() {
                if (this.mediaRecorder && this.mediaRecorder.state !== 'inactive') {
                    this.mediaRecorder.stop();
                    this.isRecording = false;
                    updateRecordUI(false);
                }
            },

            download() {
                if (!this.audioUrl) return;
                
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = this.audioUrl;
                
                // Determine extension based on mime type
                const extension = (this.audioBlob.type.includes('ogg')) ? 'ogg' : 'webm';
                
                const date = new Date();
                const timeStr = `${date.getHours()}-${date.getMinutes()}-${date.getSeconds()}`;
                a.download = `trumpet-solo-${timeStr}.${extension}`;
                
                document.body.appendChild(a);
                a.click();
                
                // Cleanup
                setTimeout(() => {
                    document.body.removeChild(a);
                }, 100);
            }
        };

        /**
         * UI Interactions
         */
        const notes = {
            'C4': 261.63,
            'D4': 293.66,
            'E4': 329.63,
            'F4': 349.23,
            'G4': 392.00,
            'A4': 440.00,
            'B4': 493.88,
            'C5': 523.25
        };

        function updateRecordUI(isRecording) {
            const btn = document.getElementById('btn-record');
            if (isRecording) {
                btn.classList.add('recording');
                btn.innerHTML = '<span>‚ñ†</span> ‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏î';
            } else {
                btn.classList.remove('recording');
                btn.innerHTML = '<span>‚óè</span> ‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á';
            }
        }

        function triggerVisual(noteId) {
            const soundWave = document.getElementById('sound-emitter');
            // Reset animation
            soundWave.classList.remove('emitting');
            void soundWave.offsetWidth; // trigger reflow
            soundWave.classList.add('emitting');
        }

        // Setup Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            const startOverlay = document.getElementById('start-overlay');
            const startBtn = document.getElementById('start-btn');
            const btns = document.querySelectorAll('.valve-btn');

            // Initialize Audio on user gesture
            startBtn.addEventListener('click', () => {
                AudioEngine.init();
                startOverlay.style.opacity = '0';
                setTimeout(() => startOverlay.remove(), 500);
            });

            // Note Buttons Interaction
            btns.forEach(btn => {
                const note = btn.dataset.note;
                const freq = notes[note];

                const startPlay = (e) => {
                    e.preventDefault(); // Prevent ghost clicks
                    btn.classList.add('active');
                    AudioEngine.playNote(freq, note);
                    triggerVisual();
                };

                const stopPlay = (e) => {
                    e.preventDefault();
                    btn.classList.remove('active');
                    AudioEngine.stopNote(note);
                };

                // Touch Events (Mobile)
                btn.addEventListener('touchstart', startPlay, { passive: false });
                btn.addEventListener('touchend', stopPlay, { passive: false });
                btn.addEventListener('touchcancel', stopPlay, { passive: false });

                // Mouse Events (Desktop)
                btn.addEventListener('mousedown', startPlay);
                btn.addEventListener('mouseup', stopPlay);
                btn.addEventListener('mouseleave', stopPlay);
            });

            // Recording Controls
            document.getElementById('btn-record').addEventListener('click', () => Recorder.toggleRecord());
            document.getElementById('btn-download').addEventListener('click', () => Recorder.download());
        });

    </script>
</body>
</html>