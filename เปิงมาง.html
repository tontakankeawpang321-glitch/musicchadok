<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡πÄ‡∏õ‡∏¥‡∏á‡∏°‡∏≤‡∏á‡∏Ñ‡∏≠‡∏Å‡πÄ‡∏™‡∏°‡∏∑‡∏≠‡∏ô‡∏à‡∏£‡∏¥‡∏á (Poeng Mang Khok)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');

        :root {
            --wood-dark: #3e2723;
            --wood-light: #8d6e63;
            --skin-color: #f5deb3;
            --skin-shadow: #d2b48c;
            --khao-paste: #212121; /* ‡∏™‡∏µ‡∏Ç‡πâ‡∏≤‡∏ß‡∏™‡∏∏‡∏Å‡∏ï‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡∏≠‡∏á */
            --bg-color: #1a1a1a;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ */
        }

        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at center, #2a2a2a 0%, #000000 100%);
            font-family: 'Sarabun', sans-serif;
            overflow: hidden; /* ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
        }

        /* --- Control Panel --- */
        .controls {
            width: 100%;
            padding: 15px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            gap: 10px;
            z-index: 100;
            border-bottom: 2px solid var(--wood-dark);
        }

        .btn {
            background: linear-gradient(145deg, var(--wood-light), var(--wood-dark));
            color: white;
            border: 2px solid #5d4037;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5);
            transition: all 0.2s;
            outline: none;
            white-space: nowrap;
        }

        .btn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 3px rgba(0,0,0,0.5);
        }

        .btn.recording {
            background: linear-gradient(145deg, #e53935, #b71c1c);
            animation: pulse 1.5s infinite;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(100%);
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(229, 57, 53, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(229, 57, 53, 0); }
            100% { box-shadow: 0 0 0 0 rgba(229, 57, 53, 0); }
        }

        /* --- Main Instrument Area --- */
        .khok-container {
            flex-grow: 1;
            width: 100%;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 5vh;
        }

        /* The Frame (Khok) Visualization */
        .khok-frame {
            position: absolute;
            bottom: -20%;
            width: 120vw; /* ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏≠‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÇ‡∏≠‡∏ö‡∏•‡πâ‡∏≠‡∏° */
            height: 60vh;
            border: 15px solid var(--wood-dark);
            border-radius: 50%;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
            pointer-events: none; /* ‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏ó‡∏∞‡∏•‡∏∏‡πÑ‡∏õ‡πÇ‡∏î‡∏ô‡∏Å‡∏•‡∏≠‡∏á‡πÑ‡∏î‡πâ */
            z-index: 0;
            background: url('data:image/svg+xml;utf8,<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><rect width="100" height="100" fill="%233e2723"/><path d="M0 0 L100 100 M100 0 L0 100" stroke="%234e342e" stroke-width="2"/></svg>');
        }

        /* Drum Positioning */
        .drum-wrapper {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            pointer-events: none; /* Container ‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™ */
        }

        .drum {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, var(--skin-color), var(--skin-shadow));
            border: 6px solid var(--wood-dark);
            box-shadow: 
                0 10px 20px rgba(0,0,0,0.5),
                inset 0 0 15px rgba(0,0,0,0.2);
            cursor: pointer;
            pointer-events: auto; /* ‡∏Å‡∏•‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™ */
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.05s, filter 0.1s;
            touch-action: none;
            /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏≠‡∏á‡∏î‡∏π‡∏°‡∏µ‡∏°‡∏¥‡∏ï‡∏¥ */
        }

        .drum:active, .drum.active {
            transform: scale(0.92) !important; /* Scale ‡∏•‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î */
            filter: brightness(0.9);
        }

        /* Tuning Paste (Khao) - ‡∏à‡∏∏‡∏î‡∏î‡∏≥‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á */
        .drum::after {
            content: '';
            width: 25%;
            height: 25%;
            background: radial-gradient(circle, #444, #111);
            border-radius: 50%;
            opacity: 0.9;
            box-shadow: 0 1px 2px rgba(255,255,255,0.2);
        }

        /* Note Label */
        .note-label {
            position: absolute;
            top: -30px;
            color: #fff;
            background: rgba(0,0,0,0.7);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            text-shadow: 0 1px 2px black;
        }

        .show-notes .note-label {
            opacity: 1;
        }

        /* Positioning the 7 drums in an arc */
        /* ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏á‡∏Å‡∏•‡∏° */
        .d1 { width: 16vh; height: 16vh; bottom: 5%;  left: 5%;   transform: translate(0, -20px); }
        .d2 { width: 15.5vh; height: 15.5vh; bottom: 12%; left: 18%;  transform: translate(0, -10px); }
        .d3 { width: 15vh; height: 15vh; bottom: 18%; left: 32%;  transform: translate(0, 0); }
        .d4 { width: 14.5vh; height: 14.5vh; bottom: 20%; left: 50%;  transform: translate(-50%, 0); } /* Center */
        .d5 { width: 14vh; height: 14vh; bottom: 18%; right: 32%; transform: translate(0, 0); }
        .d6 { width: 13.5vh; height: 13.5vh; bottom: 12%; right: 18%; transform: translate(0, -10px); }
        .d7 { width: 13vh; height: 13vh; bottom: 5%;  right: 5%;  transform: translate(0, -20px); }

        /* Mobile specific adjustments */
        @media (max-width: 600px) {
            .controls { padding: 8px; gap: 4px; flex-wrap: wrap; justify-content: space-around; }
            .btn { font-size: 11px; padding: 8px 10px; flex: 1 1 auto; margin: 2px; }
            
            /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏•‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠ ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î‡∏Ç‡∏≠‡∏ö‡∏à‡∏≠‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô */
            .d1 { width: 19vh; height: 19vh; left: -2%; bottom: 14%; transform: none; }
            .d2 { width: 18.5vh; height: 18.5vh; left: 14%; bottom: 23%; transform: none; }
            .d3 { width: 18vh; height: 18vh; left: 30%; bottom: 29%; transform: none; }
            .d4 { width: 17.5vh; height: 17.5vh; bottom: 31%; transform: translateX(-50%); }
            .d5 { width: 18vh; height: 18vh; right: 30%; bottom: 29%; transform: none; }
            .d6 { width: 18.5vh; height: 18.5vh; right: 14%; bottom: 23%; transform: none; }
            .d7 { width: 19vh; height: 19vh; right: -2%; bottom: 14%; transform: none; }
            
            /* ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏ü‡∏£‡∏°‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô */
            .khok-frame { height: 45vh; width: 100vw; bottom: 0; border-radius: 40% 40% 0 0; border-width: 10px; }
            
            /* ‡∏•‡πá‡∏≠‡∏Ñ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏ô‡πà‡∏ô‡∏´‡∏ô‡∏≤ ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô */
            body { position: fixed; width: 100%; height: 100%; overflow: hidden; touch-action: none; }
        }

        /* Indicator for recording */
        #recStatus {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 15px;
            height: 15px;
            background-color: red;
            border-radius: 50%;
            display: none;
            box-shadow: 0 0 10px red;
            animation: blink 1s infinite;
        }

        @keyframes blink { 50% { opacity: 0; } }

    </style>
</head>
<body>

    <div class="controls">
        <button class="btn" id="btnNotes" onclick="toggleNotes()">‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏ô‡πâ‡∏ï</button>
        <button class="btn" id="btnRecord" onclick="toggleRecording()">üî¥ ‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
        <button class="btn" id="btnPlay" onclick="playRecording()" disabled>‚ñ∂Ô∏è ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏î</button>
        <button class="btn" id="btnDownload" onclick="downloadRecording()" disabled>üíæ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</button>
    </div>

    <div id="recStatus"></div>

    <div class="khok-container" id="instrumentArea">
        <div class="khok-frame"></div>
        <div class="drum-wrapper">
            <!-- Drums 1-7 (Low to High pitch approximately) -->
            <!-- ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏õ‡∏¥‡∏á‡∏°‡∏≤‡∏á: ‡∏ï‡∏¥‡∏á, ‡πÄ‡∏û‡∏¥‡∏á, ‡∏û‡∏¥‡∏á, ... -->
            <div class="drum d1" data-pitch="200" data-note="‡∏•‡∏π‡∏Å‡∏¢‡∏≠‡∏î (7)" ontouchstart="playDrum(this, event)" onmousedown="playDrum(this, event)">
                <div class="note-label">‡∏•‡∏π‡∏Å‡∏¢‡∏≠‡∏î</div>
            </div>
            <div class="drum d2" data-pitch="185" data-note="6" ontouchstart="playDrum(this, event)" onmousedown="playDrum(this, event)">
                <div class="note-label">6</div>
            </div>
            <div class="drum d3" data-pitch="170" data-note="5" ontouchstart="playDrum(this, event)" onmousedown="playDrum(this, event)">
                <div class="note-label">5</div>
            </div>
            <div class="drum d4" data-pitch="155" data-note="4 (‡∏à‡πà‡∏≤‡∏ù‡∏π‡∏á)" ontouchstart="playDrum(this, event)" onmousedown="playDrum(this, event)">
                <div class="note-label">‡∏à‡πà‡∏≤‡∏ù‡∏π‡∏á</div>
            </div>
            <div class="drum d5" data-pitch="140" data-note="3" ontouchstart="playDrum(this, event)" onmousedown="playDrum(this, event)">
                <div class="note-label">3</div>
            </div>
            <div class="drum d6" data-pitch="125" data-note="2" ontouchstart="playDrum(this, event)" onmousedown="playDrum(this, event)">
                <div class="note-label">2</div>
            </div>
            <div class="drum d7" data-pitch="110" data-note="‡∏•‡∏π‡∏Å‡∏ó‡∏ß‡∏ô (1)" ontouchstart="playDrum(this, event)" onmousedown="playDrum(this, event)">
                <div class="note-label">‡∏•‡∏π‡∏Å‡∏ó‡∏ß‡∏ô</div>
            </div>
        </div>
    </div>

    <script>
        // --- Audio Engine ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;
        let masterGain;
        let destStream; // For recording
        let mediaRecorder;
        let recordedChunks = [];
        let audioBlob = null;
        let isRecording = false;

        // Init Audio Context on first user interaction
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new AudioContext();
                
                // Master Volume & Compression setup
                masterGain = audioCtx.createGain();
                masterGain.gain.value = 2.5; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏á (Boost Volume)

                // ‡πÄ‡∏û‡∏¥‡πà‡∏° Compressor ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏ô‡πà‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á
                const compressor = audioCtx.createDynamicsCompressor();
                compressor.threshold.value = -20;
                compressor.knee.value = 40;
                compressor.ratio.value = 12;
                compressor.attack.value = 0.003;
                compressor.release.value = 0.25;

                // Chain: MasterGain -> Compressor -> Destination
                masterGain.connect(compressor);
                compressor.connect(audioCtx.destination);

                // Setup Recording Stream (Record from compressor output)
                destStream = audioCtx.createMediaStreamDestination();
                compressor.connect(destStream);
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        // Synthesize Drum Sound (Poeng Mang Style)
        function triggerSound(freq) {
            initAudio();

            const t = audioCtx.currentTime;
            
            // 1. Fundamental Tone (The "Pong" sound)
            const osc = audioCtx.createOscillator();
            const gainOsc = audioCtx.createGain();
            
            osc.type = 'sine';
            // Pitch envelope: Start slightly higher and drop (simulation of skin tension change)
            osc.frequency.setValueAtTime(freq * 1.2, t);
            osc.frequency.exponentialRampToValueAtTime(freq, t + 0.1);

            // Amplitude envelope: Sharp attack, quick decay (because of the tuning paste)
            gainOsc.gain.setValueAtTime(0, t);
            gainOsc.gain.linearRampToValueAtTime(1, t + 0.005);
            gainOsc.gain.exponentialRampToValueAtTime(0.01, t + 0.4); // Decay time

            osc.connect(gainOsc);
            gainOsc.connect(masterGain);
            
            osc.start(t);
            osc.stop(t + 0.5);

            // 2. Impact Noise (The slap/skin sound)
            const bufferSize = audioCtx.sampleRate * 0.1; // Short burst
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                data[i] = Math.random() * 2 - 1;
            }

            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;
            const noiseGain = audioCtx.createGain();
            
            // Filter noise to sound more like skin
            const noiseFilter = audioCtx.createBiquadFilter();
            noiseFilter.type = 'lowpass';
            noiseFilter.frequency.value = 1000;

            noiseGain.gain.setValueAtTime(0.5, t);
            noiseGain.gain.exponentialRampToValueAtTime(0.01, t + 0.1);

            noise.connect(noiseFilter);
            noiseFilter.connect(noiseGain);
            noiseGain.connect(masterGain);
            
            noise.start(t);
        }

        // --- UI Interactions ---
        
        function playDrum(element, event) {
            if(event) {
                // Prevent default touches to avoid scrolling or double firing
                if(event.type === 'touchstart') {
                    event.preventDefault(); 
                }
            }

            // Visual feedback
            element.classList.add('active');
            setTimeout(() => element.classList.remove('active'), 100);

            // Audio trigger
            const pitch = parseFloat(element.getAttribute('data-pitch'));
            triggerSound(pitch);

            // Logic for recording check not needed here as we record the Master Output directly
        }

        // --- Recording Logic (MediaRecorder) ---

        function toggleRecording() {
            initAudio();
            const btn = document.getElementById('btnRecord');
            const status = document.getElementById('recStatus');

            if (!isRecording) {
                // Start Recording
                recordedChunks = [];
                // Check browser support
                const mimeType = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/mp4';
                
                try {
                    mediaRecorder = new MediaRecorder(destStream.stream, { mimeType: mimeType });
                } catch (e) {
                    alert("Browser doesn't support MediaRecorder with this mimeType.");
                    return;
                }

                mediaRecorder.ondataavailable = (evt) => {
                    if (evt.data.size > 0) recordedChunks.push(evt.data);
                };

                mediaRecorder.onstop = () => {
                    audioBlob = new Blob(recordedChunks, { type: mimeType });
                    document.getElementById('btnPlay').disabled = false;
                    document.getElementById('btnDownload').disabled = false;
                };

                mediaRecorder.start();
                isRecording = true;
                btn.innerHTML = "‚èπ ‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏î";
                btn.classList.add('recording');
                status.style.display = "block";
                
                // Disable play/download while recording
                document.getElementById('btnPlay').disabled = true;
                document.getElementById('btnDownload').disabled = true;

            } else {
                // Stop Recording
                mediaRecorder.stop();
                isRecording = false;
                btn.innerHTML = "üî¥ ‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á";
                btn.classList.remove('recording');
                status.style.display = "none";
            }
        }

        // --- Playback ---
        
        function playRecording() {
            if (!audioBlob) return;
            const audioUrl = URL.createObjectURL(audioBlob);
            const audio = new Audio(audioUrl);
            audio.play();
        }

        // --- Download ---

        function downloadRecording() {
            if (!audioBlob) return;
            const url = URL.createObjectURL(audioBlob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            
            // Get timestamp for filename
            const now = new Date();
            const timeStr = now.getHours() + "-" + now.getMinutes() + "-" + now.getSeconds();
            a.download = `poeng_mang_${timeStr}.webm`; // or .wav depending on codec
            
            document.body.appendChild(a);
            a.click();
            
            // Cleanup
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 100);
        }

        // --- Notes Toggle ---
        function toggleNotes() {
            const wrapper = document.querySelector('.drum-wrapper');
            const btn = document.getElementById('btnNotes');
            wrapper.classList.toggle('show-notes');
            if (wrapper.classList.contains('show-notes')) {
                btn.style.background = "#4caf50";
            } else {
                btn.style.background = ""; // Reset to CSS default
            }
        }
        
        // Prevent context menu on right click
        document.addEventListener('contextmenu', event => event.preventDefault());

    </script>
</body>
</html>
