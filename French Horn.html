<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>French Horn Simulator</title>
    <style>
        :root {
            --brass-gold: #d4af37;
            --brass-dark: #8a6e18;
            --brass-light: #f9e38e;
            --bg-color: #1a1a1a;
        }

        * {
            box-sizing: border-box;
            touch-action: none; /* ป้องกันการเลื่อนหน้าจอ */
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at center, #2a2a2a 0%, #000000 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            overflow: hidden;
            font-family: 'Sarabun', sans-serif;
            color: white;
        }

        /* ส่วนหัวและแผงควบคุม */
        header {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(5px);
            z-index: 10;
            height: 60px;
        }

        h1 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--brass-gold);
            text-shadow: 0 0 5px var(--brass-dark);
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        .btn-control {
            background: #333;
            border: 1px solid #555;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-control:active {
            transform: scale(0.95);
        }

        .btn-record.recording {
            background: #ff4444;
            border-color: #ff0000;
            animation: pulse 1.5s infinite;
        }

        .btn-play:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0); }
        }

        /* พื้นที่แสดงผลเฟรนช์ฮอร์น (SVG) */
        .instrument-container {
            flex-grow: 1;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        #horn-svg {
            max-width: 90%;
            max-height: 50vh;
            filter: drop-shadow(0 0 15px rgba(212, 175, 55, 0.3));
        }

        /* ส่วนของ Valve Animation */
        .valve-piston {
            transition: transform 0.1s ease-out;
            fill: #c0c0c0;
        }
        .valve-pressed {
            transform: translateY(15px);
        }

        /* แป้นคีย์บอร์ดโน้ต */
        .keyboard-container {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-top: 2px solid var(--brass-dark);
            height: 35vh; /* พื้นที่กด */
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .octave-label {
            text-align: center;
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 5px;
        }

        .keys-row {
            display: flex;
            justify-content: space-around;
            height: 100%;
            gap: 5px;
        }

        .key-btn {
            flex: 1;
            background: linear-gradient(180deg, var(--brass-light) 0%, var(--brass-gold) 50%, var(--brass-dark) 100%);
            border: none;
            border-radius: 0 0 10px 10px;
            position: relative;
            cursor: pointer;
            box-shadow: inset 0 2px 5px rgba(255,255,255,0.5), 0 5px 10px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding-bottom: 15px;
            transition: transform 0.1s, background 0.1s;
        }

        .key-btn::before {
            content: '';
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 70%;
            height: 10px;
            background: rgba(255,255,255,0.4);
            border-radius: 5px;
        }

        .key-btn:active, .key-btn.active {
            transform: translateY(5px);
            background: linear-gradient(180deg, var(--brass-dark) 0%, var(--brass-gold) 100%);
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.8);
        }

        .key-label {
            font-weight: bold;
            font-size: 1rem;
            color: #2c2100;
            text-shadow: 0 1px 0 rgba(255,255,255,0.5);
        }
        
        .key-sub {
            font-size: 0.7rem;
            color: #4a3b00;
        }

        /* Overlay เริ่มต้น */
        #start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: white;
            text-align: center;
        }

        #start-btn {
            background: var(--brass-gold);
            color: black;
            border: none;
            padding: 15px 40px;
            font-size: 1.5rem;
            border-radius: 50px;
            margin-top: 20px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 0 20px var(--brass-gold);
            animation: glow 2s infinite;
        }

        @keyframes glow {
            0% { box-shadow: 0 0 20px var(--brass-gold); }
            50% { box-shadow: 0 0 40px var(--brass-light); }
            100% { box-shadow: 0 0 20px var(--brass-gold); }
        }

    </style>
</head>
<body>

    <div id="start-overlay">
        <h1>French Horn Simulator</h1>
        <p>แตะเพื่อเริ่มเล่น (Tap to Start)</p>
        <button id="start-btn">เริ่มเลย</button>
    </div>

    <header>
        <h1>French Horn</h1>
        <div class="controls">
            <button class="btn-control btn-record" id="record-btn">
                <span>●</span> อัดเสียง
            </button>
            <button class="btn-control btn-play" id="play-btn" disabled>
                <span>▶</span> เล่น
            </button>
            <a id="download-link" style="display:none"></a>
            <button class="btn-control" id="download-btn" disabled>
                <span>⬇</span> โหลด
            </button>
        </div>
    </header>

    <div class="instrument-container">
        <!-- SVG French Horn Graphic -->
        <svg id="horn-svg" viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <linearGradient id="gold-grad" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#f9e38e;stop-opacity:1" />
                    <stop offset="50%" style="stop-color:#d4af37;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#8a6e18;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="silver-grad" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#eeeeee;stop-opacity:1" />
                    <stop offset="50%" style="stop-color:#999999;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#eeeeee;stop-opacity:1" />
                </linearGradient>
            </defs>
            
            <!-- Main Body (Coils) -->
            <path d="M150,150 Q100,50 200,50 T250,150 T150,250 T50,150" fill="none" stroke="url(#gold-grad)" stroke-width="20" stroke-linecap="round"/>
            <path d="M160,150 Q120,80 190,80 T230,150 T160,220 T80,150" fill="none" stroke="url(#gold-grad)" stroke-width="15" stroke-linecap="round" opacity="0.8"/>

            <!-- Bell -->
            <path d="M50,150 Q20,150 10,250 Q60,280 100,220" fill="url(#gold-grad)" stroke="var(--brass-dark)" stroke-width="2"/>
            <ellipse cx="55" cy="220" rx="45" ry="30" fill="#220000" transform="rotate(-30 55 220)"/>

            <!-- Leadpipe to Valves -->
            <path d="M250,150 L280,150 L280,100" fill="none" stroke="url(#gold-grad)" stroke-width="12"/>

            <!-- Valve Casings -->
            <rect x="270" y="80" width="20" height="60" rx="2" fill="url(#gold-grad)" />
            <rect x="300" y="80" width="20" height="60" rx="2" fill="url(#gold-grad)" />
            <rect x="330" y="80" width="20" height="60" rx="2" fill="url(#gold-grad)" />

            <!-- Pistons (Moving Parts) -->
            <rect id="valve-1" class="valve-piston" x="275" y="60" width="10" height="30" rx="2" fill="url(#silver-grad)" />
            <rect id="valve-2" class="valve-piston" x="305" y="60" width="10" height="30" rx="2" fill="url(#silver-grad)" />
            <rect id="valve-3" class="valve-piston" x="335" y="60" width="10" height="30" rx="2" fill="url(#silver-grad)" />

            <!-- Finger Buttons -->
            <circle cx="280" cy="60" r="8" fill="white" stroke="#999"/>
            <circle cx="310" cy="60" r="8" fill="white" stroke="#999"/>
            <circle cx="340" cy="60" r="8" fill="white" stroke="#999"/>
        </svg>
    </div>

    <div class="keyboard-container">
        <div class="octave-label">Low Register</div>
        <div class="keys-row">
            <button class="key-btn" data-note="F2" data-valves="1">
                <span class="key-label">F</span>
                <span class="key-sub">ฟา</span>
            </button>
            <button class="key-btn" data-note="G2" data-valves="1,3">
                <span class="key-label">G</span>
                <span class="key-sub">ซอล</span>
            </button>
            <button class="key-btn" data-note="A2" data-valves="1,2">
                <span class="key-label">A</span>
                <span class="key-sub">ลา</span>
            </button>
            <button class="key-btn" data-note="Bb2" data-valves="1">
                <span class="key-label">Bb</span>
                <span class="key-sub">ทีb</span>
            </button>
            <button class="key-btn" data-note="C3" data-valves="0">
                <span class="key-label">C</span>
                <span class="key-sub">โด</span>
            </button>
            <button class="key-btn" data-note="D3" data-valves="1">
                <span class="key-label">D</span>
                <span class="key-sub">เร</span>
            </button>
            <button class="key-btn" data-note="E3" data-valves="0">
                <span class="key-label">E</span>
                <span class="key-sub">มี</span>
            </button>
             <button class="key-btn" data-note="F3" data-valves="1">
                <span class="key-label">F</span>
                <span class="key-sub">ฟา</span>
            </button>
        </div>
    </div>

    <script>
        // --- Audio Engine (Brass Synthesizer) ---
        let audioCtx;
        let masterGain;
        let mediaRecorder;
        let audioChunks = [];
        let recordedAudioBlob;
        let dest; // For recording

        // Frequencies for French Horn Range (F2 to F3 simplified)
        const noteFreqs = {
            'F2': 87.31,
            'G2': 98.00,
            'A2': 110.00,
            'Bb2': 116.54,
            'C3': 130.81,
            'D3': 146.83,
            'E3': 164.81,
            'F3': 174.61
        };

        let activeOscillators = {};

        function initAudio() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
                
                // Master Gain (Volume Control)
                masterGain = audioCtx.createGain();
                masterGain.gain.value = 0.8;
                
                // Destination for recording
                dest = audioCtx.createMediaStreamDestination();
                masterGain.connect(audioCtx.destination);
                masterGain.connect(dest); // Connect to recorder
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function playNote(note) {
            if (!audioCtx) initAudio();
            if (activeOscillators[note]) return; // Don't re-trigger if holding

            const freq = noteFreqs[note];
            const now = audioCtx.currentTime;

            // 1. Main Oscillator (Sawtooth for brass buzz)
            const osc1 = audioCtx.createOscillator();
            osc1.type = 'sawtooth';
            osc1.frequency.setValueAtTime(freq, now);

            // 2. Sub Oscillator (Triangle for body/mellow)
            const osc2 = audioCtx.createOscillator();
            osc2.type = 'triangle';
            osc2.frequency.setValueAtTime(freq, now);

            // Filter (Lowpass to dampen the harsh sawtooth)
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(400, now);
            filter.frequency.exponentialRampToValueAtTime(freq * 4, now + 0.1); // Attack "Blart" sound
            filter.frequency.exponentialRampToValueAtTime(freq * 2, now + 0.4); // Sustain brightness

            // Envelope (Gain)
            const gainNode = audioCtx.createGain();
            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(0.5, now + 0.1); // Attack
            gainNode.gain.linearRampToValueAtTime(0.4, now + 0.3); // Decay

            // Connections
            osc1.connect(filter);
            osc2.connect(filter);
            filter.connect(gainNode);
            gainNode.connect(masterGain);

            osc1.start(now);
            osc2.start(now);

            activeOscillators[note] = { osc1, osc2, gainNode, filter };
        }

        function stopNote(note) {
            if (!activeOscillators[note]) return;

            const { osc1, osc2, gainNode, filter } = activeOscillators[note];
            const now = audioCtx.currentTime;

            // Release envelope
            const releaseTime = 0.2;
            gainNode.gain.cancelScheduledValues(now);
            gainNode.gain.setValueAtTime(gainNode.gain.value, now);
            gainNode.gain.linearRampToValueAtTime(0, now + releaseTime);
            
            // Close filter slightly
            filter.frequency.cancelScheduledValues(now);
            filter.frequency.exponentialRampToValueAtTime(100, now + releaseTime);

            osc1.stop(now + releaseTime);
            osc2.stop(now + releaseTime);

            setTimeout(() => {
                delete activeOscillators[note];
            }, releaseTime * 1000 + 50);
        }

        // --- UI & Animation Logic ---
        
        const valves = {
            1: document.getElementById('valve-1'),
            2: document.getElementById('valve-2'),
            3: document.getElementById('valve-3')
        };

        function animateValves(valveString) {
            // Reset all
            valves[1].classList.remove('valve-pressed');
            valves[2].classList.remove('valve-pressed');
            valves[3].classList.remove('valve-pressed');

            if (valveString === "0") return;

            const v = valveString.split(',');
            v.forEach(num => {
                if (valves[num.trim()]) {
                    valves[num.trim()].classList.add('valve-pressed');
                }
            });
        }

        function releaseValves() {
             valves[1].classList.remove('valve-pressed');
             valves[2].classList.remove('valve-pressed');
             valves[3].classList.remove('valve-pressed');
        }

        // --- Event Listeners ---

        const keys = document.querySelectorAll('.key-btn');
        
        keys.forEach(key => {
            const note = key.dataset.note;
            const valveData = key.dataset.valves;

            const startHandler = (e) => {
                e.preventDefault(); // Prevent ghost clicks
                key.classList.add('active');
                playNote(note);
                animateValves(valveData);
            };

            const endHandler = (e) => {
                e.preventDefault();
                key.classList.remove('active');
                stopNote(note);
                // Check if other keys are still pressed, if not release valves
                const activeKeys = document.querySelectorAll('.key-btn.active');
                if (activeKeys.length === 0) {
                    releaseValves();
                } else {
                    // Update valves to the last held note (simplified)
                    const lastKey = activeKeys[activeKeys.length-1];
                    animateValves(lastKey.dataset.valves);
                }
            };

            // Mouse
            key.addEventListener('mousedown', startHandler);
            key.addEventListener('mouseup', endHandler);
            key.addEventListener('mouseleave', endHandler);

            // Touch
            key.addEventListener('touchstart', startHandler, {passive: false});
            key.addEventListener('touchend', endHandler, {passive: false});
            key.addEventListener('touchcancel', endHandler, {passive: false});
        });

        // --- Start Overlay ---
        document.getElementById('start-btn').addEventListener('click', () => {
            initAudio();
            document.getElementById('start-overlay').style.display = 'none';
        });

        // --- Recording Logic ---
        const recordBtn = document.getElementById('record-btn');
        const playBtn = document.getElementById('play-btn');
        const downloadBtn = document.getElementById('download-btn');
        const downloadLink = document.getElementById('download-link');

        let isRecording = false;

        recordBtn.addEventListener('click', () => {
            if (!isRecording) {
                // Start Recording
                if (!audioCtx) initAudio();
                
                audioChunks = [];
                // Create recorder with supported mime type
                const mimeTypes = ['audio/webm', 'audio/ogg', 'audio/mp4'];
                let selectedType = 'audio/webm';
                for(let type of mimeTypes) {
                    if (MediaRecorder.isTypeSupported(type)) {
                        selectedType = type;
                        break;
                    }
                }

                mediaRecorder = new MediaRecorder(dest.stream, { mimeType: selectedType });
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    recordedAudioBlob = new Blob(audioChunks, { type: selectedType });
                    const audioUrl = URL.createObjectURL(recordedAudioBlob);
                    
                    // Enable buttons
                    playBtn.disabled = false;
                    downloadBtn.disabled = false;
                    
                    // Setup Download
                    downloadLink.href = audioUrl;
                    downloadLink.download = `french-horn-recording-${Date.now()}.webm`;
                };

                mediaRecorder.start();
                isRecording = true;
                recordBtn.innerHTML = "<span>■</span> หยุด";
                recordBtn.classList.add('recording');
                playBtn.disabled = true;
                downloadBtn.disabled = true;

            } else {
                // Stop Recording
                mediaRecorder.stop();
                isRecording = false;
                recordBtn.innerHTML = "<span>●</span> อัดเสียง";
                recordBtn.classList.remove('recording');
            }
        });

        playBtn.addEventListener('click', () => {
            if (recordedAudioBlob) {
                const audioUrl = URL.createObjectURL(recordedAudioBlob);
                const audio = new Audio(audioUrl);
                audio.play();
            }
        });

        downloadBtn.addEventListener('click', () => {
            downloadLink.click();
        });

    </script>
</body>
</html>