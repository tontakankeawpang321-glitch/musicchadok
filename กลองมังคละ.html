<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>กลองมังคละเสมือนจริง (Virtual Mangkhala)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');

        body {
            font-family: 'Sarabun', sans-serif;
            touch-action: manipulation; /* ป้องกันการซูมเมื่อแตะรัวๆ */
            background-color: #1a1a1a;
            background-image: radial-gradient(circle at 50% 50%, #2a2a2a 0%, #111 100%);
            overflow: hidden; /* ป้องกันการเลื่อนหน้าจอ */
        }

        /* Drum Skin Effect */
        .drum-skin {
            background: radial-gradient(circle, #e6ccb2 0%, #d4a373 60%, #8b5e3c 100%);
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5), 0 10px 15px rgba(0,0,0,0.3);
            border: 8px solid #5D4037;
            transition: transform 0.05s, filter 0.05s;
        }

        .drum-skin:active, .drum-skin.active {
            transform: scale(0.95);
            filter: brightness(0.9);
        }

        /* Gong Effect */
        .gong-metal {
            background: radial-gradient(circle, #ffd700 0%, #b8860b 40%, #8b4500 100%);
            box-shadow: inset 0 0 15px rgba(0,0,0,0.6), 0 8px 12px rgba(0,0,0,0.4);
            border: 4px solid #4a3b2a;
            position: relative;
        }
        
        .gong-metal::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30%;
            height: 30%;
            background: radial-gradient(circle, #ffecb3 0%, #daa520 100%);
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        .gong-metal:active, .gong-metal.active {
            transform: scale(0.95);
        }

        /* Cymbal Effect */
        .cymbal-metal {
            background: repeating-radial-gradient(#C0C0C0, #A9A9A9 10%, #C0C0C0 15%);
            border: 2px solid #696969;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .cymbal-metal:active, .cymbal-metal.active {
            transform: rotate(5deg) scale(0.95);
        }

        /* Animations */
        @keyframes ripple {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
            100% { box-shadow: 0 0 0 20px rgba(255, 215, 0, 0); }
        }
        .playing {
            animation: ripple 0.3s linear;
        }

        .control-btn {
            transition: all 0.2s;
        }
        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Note Display Text */
        #note-display {
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col items-center justify-between py-4 text-white select-none">

    <!-- Start Overlay -->
    <div id="start-overlay" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-black/90 backdrop-blur-sm">
        <h1 class="text-4xl font-bold text-yellow-500 mb-4 text-center">กลองมังคละเสมือนจริง</h1>
        <p class="text-gray-300 mb-8 text-center px-4">แตะเพื่อเริ่มใช้งาน (กรุณาเปิดเสียง)</p>
        <button id="start-btn" class="px-8 py-4 bg-yellow-600 hover:bg-yellow-500 text-black font-bold rounded-full text-xl shadow-[0_0_20px_rgba(234,179,8,0.5)] transition transform hover:scale-105">
            เริ่มเล่นดนตรี
        </button>
    </div>

    <!-- Header & Note Display -->
    <div class="w-full max-w-md px-4 flex flex-col items-center space-y-2">
        <div class="flex justify-between w-full items-center">
            <h1 class="text-xl text-yellow-500 font-bold tracking-wider">MANGKHALA</h1>
            <div id="recording-status" class="hidden animate-pulse text-red-500 font-bold text-sm">● กำลังบันทึก...</div>
        </div>
        <div id="note-display" class="h-12 w-full bg-gray-800/50 rounded-lg border border-gray-700 flex items-center justify-center text-2xl font-bold text-yellow-400">
            พร้อมเล่น
        </div>
    </div>

    <!-- Main Instrument Area -->
    <div class="flex-1 w-full max-w-3xl flex flex-col justify-center items-center relative p-2">
        
        <!-- Top Row: Gongs & Cymbals -->
        <div class="flex justify-center gap-4 mb-6 w-full">
            <div data-note="ฉาบ" data-sound="cymbal" class="instrument cymbal-metal w-20 h-20 rounded-full flex items-center justify-center cursor-pointer">
                <span class="text-black font-bold text-xs pointer-events-none">ฉาบ</span>
            </div>
            <div data-note="ฆ้องใหญ่" data-sound="gong-low" class="instrument gong-metal w-24 h-24 rounded-full flex items-center justify-center cursor-pointer">
                <span class="text-black font-bold text-xs z-10 pointer-events-none">ฆ้องใหญ่</span>
            </div>
            <div data-note="ฆ้องเล็ก" data-sound="gong-high" class="instrument gong-metal w-20 h-20 rounded-full flex items-center justify-center cursor-pointer">
                <span class="text-black font-bold text-xs z-10 pointer-events-none">ฆ้องเล็ก</span>
            </div>
            <div data-note="ฉิ่ง" data-sound="ching" class="instrument cymbal-metal w-16 h-16 rounded-full flex items-center justify-center cursor-pointer bg-yellow-100">
                <span class="text-black font-bold text-xs pointer-events-none">ฉิ่ง</span>
            </div>
        </div>

        <!-- Main Drums -->
        <div class="flex justify-center items-end gap-2 sm:gap-6 w-full">
            <!-- Mong (Bass Drum) -->
            <div data-note="โหม่ง (ทุ้ม)" data-sound="mong" class="instrument drum-skin w-32 h-32 sm:w-40 sm:h-40 rounded-full flex items-center justify-center cursor-pointer relative">
                <span class="text-amber-900 font-bold text-lg pointer-events-none">โหม่ง</span>
            </div>

            <!-- Klong Mangkhala (Main Drum) -->
            <div class="flex flex-col items-center gap-2">
                <div class="relative">
                    <!-- Rim/High pitch area -->
                    <div data-note="มังคละ (ขอบ)" data-sound="mang-high" class="instrument drum-skin w-40 h-40 sm:w-48 sm:h-48 rounded-full flex items-center justify-center cursor-pointer border-yellow-900">
                        <!-- Center/Low pitch area overlay -->
                        <div data-note="มังคละ (กลาง)" data-sound="mang-low" class="instrument absolute w-24 h-24 sm:w-28 sm:h-28 bg-black/10 rounded-full flex items-center justify-center hover:bg-black/20 transition">
                            <span class="text-amber-900 font-bold text-xl pointer-events-none">มังคละ</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Klong Nui (Support Drum) -->
            <div data-note="กลองหนุ่ย" data-sound="nui" class="instrument drum-skin w-28 h-28 sm:w-36 sm:h-36 rounded-full flex items-center justify-center cursor-pointer">
                <span class="text-amber-900 font-bold text-base pointer-events-none">หนุ่ย</span>
            </div>
        </div>
    </div>

    <!-- Controls -->
    <div class="w-full max-w-md px-4 pb-6">
        <div class="bg-gray-800/80 rounded-2xl p-4 backdrop-blur-md border border-gray-700 shadow-lg">
            <div class="grid grid-cols-4 gap-2">
                <button id="record-btn" class="control-btn flex flex-col items-center justify-center p-2 rounded-lg bg-red-900/50 text-red-400 hover:bg-red-900/80">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                    </svg>
                    <span class="text-xs">อัดเสียง</span>
                </button>
                
                <button id="stop-btn" class="control-btn flex flex-col items-center justify-center p-2 rounded-lg bg-gray-700 text-gray-400 hover:bg-gray-600" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                    </svg>
                    <span class="text-xs">หยุด</span>
                </button>

                <button id="play-btn" class="control-btn flex flex-col items-center justify-center p-2 rounded-lg bg-green-900/50 text-green-400 hover:bg-green-900/80" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span class="text-xs">เล่นเสียง</span>
                </button>

                <button id="download-btn" class="control-btn flex flex-col items-center justify-center p-2 rounded-lg bg-blue-900/50 text-blue-400 hover:bg-blue-900/80" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    <span class="text-xs">โหลด</span>
                </button>
            </div>
            <audio id="audio-player" class="hidden"></audio>
        </div>
    </div>

    <script>
        // --- Audio Context & Synthesis Engine ---
        let audioCtx;
        let masterGain;
        let dest; // For recording
        let mediaRecorder;
        let audioChunks = [];
        let audioBlob;
        let isRecording = false;

        const startOverlay = document.getElementById('start-overlay');
        const startBtn = document.getElementById('start-btn');
        const noteDisplay = document.getElementById('note-display');
        const recordingStatus = document.getElementById('recording-status');

        // Buttons
        const recordBtn = document.getElementById('record-btn');
        const stopBtn = document.getElementById('stop-btn');
        const playBtn = document.getElementById('play-btn');
        const downloadBtn = document.getElementById('download-btn');
        const audioPlayer = document.getElementById('audio-player');

        // Initialize Audio
        async function initAudio() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
            
            // Master Gain
            masterGain = audioCtx.createGain();
            masterGain.gain.value = 0.8;
            masterGain.connect(audioCtx.destination);

            // Setup recording stream
            dest = audioCtx.createMediaStreamDestination();
            masterGain.connect(dest);

            startOverlay.classList.add('hidden');
            if(audioCtx.state === 'suspended') {
                await audioCtx.resume();
            }
        }

        startBtn.addEventListener('click', initAudio);

        // --- Synthesis Functions ---

        // Generic Noise Buffer for Cymbals
        let noiseBuffer;
        function createNoiseBuffer() {
            if (!audioCtx) return;
            const bufferSize = audioCtx.sampleRate * 2; // 2 seconds
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                data[i] = Math.random() * 2 - 1;
            }
            noiseBuffer = buffer;
        }

        function playDrum(pitch, decay, type = 'sine', snap = 0) {
            if (!audioCtx) return;
            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.type = type;
            osc.frequency.setValueAtTime(pitch, t);
            
            // Pitch drop for "thud" effect
            if(snap > 0) {
                osc.frequency.exponentialRampToValueAtTime(pitch * 0.5, t + 0.1);
            }

            gain.gain.setValueAtTime(1, t);
            gain.gain.exponentialRampToValueAtTime(0.01, t + decay);

            osc.connect(gain);
            gain.connect(masterGain);
            
            osc.start(t);
            osc.stop(t + decay);
        }

        function playGong(baseFreq, decay) {
            if (!audioCtx) return;
            const t = audioCtx.currentTime;
            
            // FM Synthesis for metallic sound
            const carrier = audioCtx.createOscillator();
            const modulator = audioCtx.createOscillator();
            const modGain = audioCtx.createGain();
            const masterGongGain = audioCtx.createGain();

            // Inharmonic ratios for metal
            carrier.frequency.value = baseFreq;
            modulator.frequency.value = baseFreq * 1.47;
            
            modGain.gain.value = 300; // Modulation depth
            modGain.gain.linearRampToValueAtTime(0, t + decay); // Mod depth decays

            modulator.connect(modGain);
            modGain.connect(carrier.frequency);

            masterGongGain.gain.setValueAtTime(0.8, t);
            masterGongGain.gain.exponentialRampToValueAtTime(0.001, t + decay);

            carrier.connect(masterGongGain);
            masterGongGain.connect(masterGain);

            carrier.start(t);
            modulator.start(t);
            carrier.stop(t + decay);
            modulator.stop(t + decay);
        }

        function playCymbal(type) {
            if (!audioCtx) return;
            if (!noiseBuffer) createNoiseBuffer();

            const t = audioCtx.currentTime;
            const source = audioCtx.createBufferSource();
            source.buffer = noiseBuffer;
            
            const filter = audioCtx.createBiquadFilter();
            if (type === 'ching') {
                filter.type = 'bandpass';
                filter.frequency.value = 2000;
                filter.Q.value = 5;
            } else { // Cymbal/Chab
                filter.type = 'highpass';
                filter.frequency.value = 800;
            }

            const gain = audioCtx.createGain();
            
            // Envelope
            gain.gain.setValueAtTime(0.6, t);
            const duration = type === 'ching' ? 1.5 : 0.8;
            gain.gain.exponentialRampToValueAtTime(0.01, t + duration);

            source.connect(filter);
            filter.connect(gain);
            gain.connect(masterGain);
            
            source.start(t);
            source.stop(t + duration);
        }

        // --- Instrument Mapping ---
        function triggerSound(soundType, noteName) {
            if (!audioCtx) return;

            noteDisplay.textContent = noteName;
            noteDisplay.classList.remove('text-yellow-400');
            noteDisplay.classList.add('text-white');
            setTimeout(() => {
                noteDisplay.classList.add('text-yellow-400');
                noteDisplay.classList.remove('text-white');
            }, 100);

            switch(soundType) {
                case 'mang-low': // Klong Mangkhala Center
                    playDrum(120, 0.4, 'sine', 1);
                    playDrum(80, 0.6, 'triangle', 0); // Layer for body
                    break;
                case 'mang-high': // Klong Mangkhala Rim
                    playDrum(250, 0.2, 'square', 0); // Sharp slap
                    playDrum(200, 0.2, 'sine', 0);
                    break;
                case 'mong': // Deep bass gong/drum
                    playDrum(60, 1.2, 'sine', 0);
                    break;
                case 'nui': // Side drum
                    playDrum(180, 0.3, 'sine', 1);
                    break;
                case 'gong-low':
                    playGong(220, 2.0);
                    break;
                case 'gong-high':
                    playGong(440, 1.5);
                    break;
                case 'ching':
                    playCymbal('ching');
                    break;
                case 'cymbal':
                    playCymbal('cymbal');
                    break;
            }
        }

        // --- Input Handling ---
        const instruments = document.querySelectorAll('.instrument');

        instruments.forEach(inst => {
            const handleInput = (e) => {
                e.preventDefault(); // Prevent ghost clicks
                
                // Visual effect
                inst.classList.add('active', 'playing');
                setTimeout(() => inst.classList.remove('active', 'playing'), 100);

                // Sound effect
                const sound = inst.dataset.sound;
                const note = inst.dataset.note;
                triggerSound(sound, note);
            };

            inst.addEventListener('touchstart', handleInput, {passive: false});
            inst.addEventListener('mousedown', handleInput);
        });

        // --- Recording Logic ---
        recordBtn.addEventListener('click', () => {
            if (!audioCtx) return;
            audioChunks = [];
            
            // Create recorder with supported mime type
            const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') 
                ? 'audio/webm;codecs=opus' 
                : 'audio/ogg;codecs=opus';

            mediaRecorder = new MediaRecorder(dest.stream, { mimeType });

            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) audioChunks.push(e.data);
            };

            mediaRecorder.onstop = () => {
                audioBlob = new Blob(audioChunks, { type: mimeType });
                const audioUrl = URL.createObjectURL(audioBlob);
                audioPlayer.src = audioUrl;
                
                playBtn.disabled = false;
                downloadBtn.disabled = false;
                recordingStatus.classList.add('hidden');
            };

            mediaRecorder.start();
            isRecording = true;
            
            // UI Updates
            recordBtn.disabled = true;
            stopBtn.disabled = false;
            playBtn.disabled = true;
            downloadBtn.disabled = true;
            recordingStatus.classList.remove('hidden');
            noteDisplay.textContent = "กำลังบันทึก...";
        });

        stopBtn.addEventListener('click', () => {
            if (isRecording && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                isRecording = false;
                
                recordBtn.disabled = false;
                stopBtn.disabled = true;
                noteDisplay.textContent = "บันทึกเสร็จสิ้น";
            }
        });

        playBtn.addEventListener('click', () => {
            audioPlayer.play();
            noteDisplay.textContent = "กำลังเล่นเสียง...";
            audioPlayer.onended = () => {
                noteDisplay.textContent = "เล่นจบแล้ว";
            };
        });

        downloadBtn.addEventListener('click', () => {
            if (!audioBlob) return;
            const url = URL.createObjectURL(audioBlob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `mangkhala-jam-${new Date().getTime()}.webm`; // Most browsers use webm
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            noteDisplay.textContent = "ดาวน์โหลดแล้ว";
        });

    </script>
</body>
</html>