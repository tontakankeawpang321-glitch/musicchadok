<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ/‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏° ‚Äì ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ + ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Stable+SweetAlert2)</title>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  :root{
    --bg:#fffdf7; --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb;
    --brand:#2563eb; --brand-ink:#ffffff; --paper:#ffffff; --radius:14px;
    --danger:#ef4444; --ok:#16a34a; --ghost:#eef2ff;
  }
  *{box-sizing:border-box}
  html,body{
    margin:0;background:var(--bg);color:var(--ink);
    font-family:"Sarabun", system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", Arial, sans-serif
  }

  header{position:sticky;top:0;z-index:20;background:var(--paper);border-bottom:1px solid var(--line);backdrop-filter:saturate(1.2) blur(6px)}
  .wrap{max-width:960px;margin:auto;padding:14px}

  .toolbar{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
  .search{display:flex;gap:8px}
  input[type="search"]{flex:1;padding:11px 12px;border:1px solid var(--line);border-radius:12px;background:#fafafa}
  select{padding:11px;border:1px solid var(--line);border-radius:12px;background:#fafafa}
  button{
    border:0;border-radius:12px;padding:10px 14px;background:var(--brand);color:var(--brand-ink);
    cursor:pointer; display:inline-flex; gap:8px; align-items:center; justify-content:center;
    box-shadow:0 8px 22px -12px rgba(37,99,235,.55);
    transition:transform .06s ease, filter .2s ease;
  }
  button:hover{transform:translateY(-1px)}
  button[disabled]{opacity:.6;cursor:not-allowed;filter:grayscale(.2)}
  .btn-ghost{background:#f3f4f6;color:#111;box-shadow:none}
  .btn-danger{background:var(--danger);box-shadow:0 8px 22px -12px rgba(239,68,68,.55)}
  .btn-outline{background:#fff;color:#1e40af;border:1px solid #c7d2fe;box-shadow:none}

  .list{display:grid;gap:12px;margin-top:14px}
  .card{
    background:var(--paper);border:1px solid var(--line);border-radius:var(--radius);padding:12px;
    display:grid;grid-template-columns:72px 1fr;gap:12px;
    box-shadow:0 12px 30px -22px rgba(0,0,0,.25);
  }
  .thumb{width:72px;height:72px;border-radius:12px;object-fit:cover;background:#eee}
  .title{font-weight:700;margin:0 0 4px 0; line-height:1.25}
  .meta{font-size:12px;color:var(--muted)}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .chip{border:1px solid var(--line);background:#fff;color:#111;padding:6px 10px;border-radius:999px;font-size:13px;cursor:pointer}
  .chip.active{background:#eef2ff;border-color:#c7d2fe}
  .chip[disabled]{opacity:.5;cursor:not-allowed}

  .pager{display:flex;gap:8px;justify-content:center;margin:16px 0}
  .pageInfo{padding:10px 12px;border-radius:10px;background:#eef2ff;color:#1e3a8a}

  /* Dialog */
  .dialog-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:30}
  .dialog{background:var(--paper);border-radius:16px;max-width:560px;width:100%;padding:16px;border:1px solid var(--line)}
  .dialog h3{margin:0 0 8px 0}
  .grid{display:grid;gap:10px}
  textarea, input[type="text"], input[type="file"], select{
    width:100%;padding:10px;border:1px solid var(--line);border-radius:12px;background:#fafafa
  }

  /* Loading Overlay */
  .overlay{position:fixed;inset:0;display:none;place-items:center;background:rgba(255,255,255,.65);z-index:40}
  .spinner{width:42px;height:42px;border-radius:50%;border:4px solid #c7d2fe;border-top-color:#2563eb;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Skeleton */
  .skeleton{display:grid;grid-template-columns:72px 1fr;gap:12px;background:var(--paper);border:1px solid var(--line);border-radius:var(--radius);padding:12px}
  .sk-thumb{width:72px;height:72px;border-radius:12px;background:linear-gradient(90deg,#eee,#f5f5f5,#eee);background-size:200% 100%;animation:shimmer 1.2s infinite}
  .sk-line{height:12px;border-radius:8px;background:linear-gradient(90deg,#eee,#f5f5f5,#eee);background-size:200% 100%;animation:shimmer 1.2s infinite}
  .sk-line.wide{height:16px}
  @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

  /* Avatars */
  .avatar{width:28px;height:28px;border-radius:50%;object-fit:cover;display:none}
  .sign{display:flex;gap:8px;align-items:center;justify-content:flex-end}
  @media (max-width:540px){
    .toolbar{grid-template-columns:1fr}
    .card{grid-template-columns:56px 1fr}
    .thumb{width:56px;height:56px}
  }
</style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="toolbar">
      <div class="search">
        <input id="q" type="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á..."/>
        <select id="catFilter"><option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î</option></select>
        <button class="btn-outline" id="btnSearch">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      </div>
      <div class="sign">
        <img id="avatar" class="avatar" alt="">
        <div id="signin"></div>
        <button id="btnSignOut" class="btn-ghost" style="display:none">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å</button>
        <button id="btnAdd" disabled>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div id="list" class="list"></div>
  <div class="pager">
    <button id="prev" class="btn-ghost">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
    <div id="pageInfo" class="pageInfo"></div>
    <button id="next">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
  </div>
</main>

<!-- Dialog ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç -->
<div id="dlg" class="dialog-backdrop" role="dialog" aria-modal="true">
  <div class="dialog">
    <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
      <h3 id="dlgTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
      <button id="closeDlg" class="btn-ghost">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div class="grid">
      <input id="title" type="text" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠"/>
      <textarea id="body" rows="5" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"></textarea>
      <select id="postCategory"><option value="">(‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏°‡∏ß‡∏î‚Ä¶)</option></select>
      <input id="file" type="file" accept="image/*"/>
      <button id="save"><span id="saveSpin" class="spinner" style="width:18px;height:18px;border-width:3px;display:none"></span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div id="overlay" class="overlay"><div class="spinner"></div></div>

<script>
  // ===== CONFIG (‡πÉ‡∏™‡πà‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏Ñ‡∏∏‡∏ì) =====
  const WEB_APP_BASE = 'https://script.google.com/macros/s/AKfycbySSYD2QpQxWsX7Len5J2k_PlFdgdqZyZV7q-TiBXXj9bkg93hfsZYCT9DBvlWi7slMJg/exec';
  const CLIENT_ID    = '986811661821-d65agv1s2rmdcq743nif06a3ek0a01b5.apps.googleusercontent.com';
  // =======================================

  let idToken = '';
  let me = null;
  let page = 1;
  const pageSize = 10;
  let editingId = null;
  let isBusy = false; // ‡∏•‡πá‡∏≠‡∏Å global action (‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î/‡∏•‡∏ö)
  const EMOJIS = ['üëç','‚ù§Ô∏è','üòÇ','üëè'];

  // ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° fetch ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö list/search)
  let listController = null;

  // serialize ‡∏Ñ‡∏¥‡∏ß‡∏£‡∏µ‡πÅ‡∏≠‡∏Ñ‡∏ä‡∏±‡∏ô‡∏ï‡πà‡∏≠‡πÇ‡∏û‡∏™‡∏ï‡πå (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏£‡∏±‡∏ß)
  const reactQueues = new Map(); // postId -> promise chain

  // ===== Utilities =====
  const $ = (id)=>document.getElementById(id);
  const qs = (o)=>Object.entries(o).map(([k,v])=>encodeURIComponent(k)+'='+encodeURIComponent(v)).join('&');
  const showOverlay = (on)=>{ $('overlay').style.display = on ? 'grid' : 'none'; };
  const showDlg = (on)=>{ $('dlg').style.display = on ? 'flex' : 'none'; };
  const toast = (icon, title)=> Swal.fire({toast:true, position:'top-end', icon, title, showConfirmButton:false, timer:1800, timerProgressBar:true});
  const ask = (title, text, icon='warning')=> Swal.fire({title, text, icon, showCancelButton:true, confirmButtonText:'‡∏ï‡∏Å‡∏•‡∏á', cancelButtonText:'‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'});

  function swalError(message, extra=''){
    console.error('[ERROR]', message, extra);
    Swal.fire({icon:'error', title:'‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: message});
  }

  function guardSignedIn(){
    if (!idToken) { Swal.fire({icon:'info', title:'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ'}); return false; }
    return true;
  }

  function setSignedInUI(on){
    const avatar = $('avatar');
    const signin = $('signin');
    const btnAdd = $('btnAdd');
    const btnSignOut = $('btnSignOut');
    if (on) {
      signin.style.display = 'none';
      btnSignOut.style.display = 'inline-flex';
      btnAdd.disabled = false;
      avatar.style.display = (me && me.picture) ? 'block' : 'none';
      if (me && me.picture) avatar.src = me.picture;
    } else {
      signin.style.display = 'block';
      btnSignOut.style.display = 'none';
      btnAdd.disabled = true;
      avatar.style.display = 'none';
    }
  }

  // ===== GIS =====
  window.onload = async function(){
    try {
      const savedToken = localStorage.getItem('idToken');
      const savedMe = localStorage.getItem('me');
      if (savedToken) idToken = savedToken;
      if (savedMe) me = JSON.parse(savedMe);
      if (idToken && me && me.email) setSignedInUI(true);
    } catch(e){}

    google.accounts.id.initialize({
      client_id: CLIENT_ID,
      callback: handleCredentialResponse,
      auto_select: false
    });
    google.accounts.id.renderButton(
      $('signin'),
      { theme:"outline", size:"large", text:"signin_with", locale:"th" }
    );

    await loadCategoriesToUI();

    if (idToken) {
      try { await fetchMe(); if (me && me.email) { setSignedInUI(true); loadList(); } else setSignedInUI(false); }
      catch(e){ setSignedInUI(false); }
    } else {
      renderSkeletons(6);
    }
  };

  async function handleCredentialResponse(resp){
    if (!resp || !resp.credential) { swalError('‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); return; }
    idToken = resp.credential;
    await fetchMe();
    if (me && me.email) {
      localStorage.setItem('idToken', idToken);
      localStorage.setItem('me', JSON.stringify(me));
      setSignedInUI(true);
      toast('success','‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß');
      loadList();
    } else {
      setSignedInUI(false);
      swalError('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô');
    }
  }

  $('btnSignOut').addEventListener('click', ()=>{
    try { google.accounts.id.disableAutoSelect(); } catch(e){}
    idToken=''; me=null; localStorage.removeItem('idToken'); localStorage.removeItem('me');
    setSignedInUI(false);
    $('list').innerHTML = '';
    $('pageInfo').textContent = '';
    toast('success','‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
  });

  async function fetchMe(){
    const url = WEB_APP_BASE + '?' + qs({ action:'me', idToken });
    const r = await fetch(url);
    let j = null; try{ j = await r.json(); }catch(_){}
    if (!r.ok || (j && j.error)) { me=null; return; }
    me = j || null;
  }

  // ===== Categories =====
  async function loadCategoriesToUI(){
    const url = WEB_APP_BASE + '?' + qs({ action:'categories', idToken: idToken || 'dummy' });
    try{
      const r = await fetch(url);
      const j = await r.json();
      if (!r.ok || !j || j.error) throw new Error(j?JSON.stringify(j):'');
      const filterSel = $('catFilter');
      j.categories.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; filterSel.appendChild(o); });
      filterSel.addEventListener('change', ()=>{ page=1; loadList(); });

      const catSel = $('postCategory');
      catSel.innerHTML = '';
      j.categories.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; catSel.appendChild(o); });
    }catch(e){
      swalError('‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏°‡∏ß‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }
  }

  // ===== Reactions (with queue & retry) =====
  async function fetchReactions(postId){
    const url = WEB_APP_BASE + '?' + qs({ action:'reactions', idToken, postId });
    const r = await fetch(url);
    const j = await r.json().catch(()=>null);
    if (!r.ok || !j || j.error) throw new Error(j?JSON.stringify(j):'');
    EMOJIS.forEach(e=>{ if(typeof j.counts[e] !== 'number') j.counts[e]=0; });
    return j;
  }

  function withReactQueue(postId, fn){
    const prev = reactQueues.get(postId) || Promise.resolve();
    const next = prev.then(()=>fn()).catch(()=>{}); // swallow error to not break chain
    reactQueues.set(postId, next);
    return next;
  }

  async function sendReaction(postId, emoji){
    // retry 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏ö‡∏ö backoff
    const exec = async ()=>{
      const form = new URLSearchParams();
      form.set('action','react'); form.set('idToken', idToken);
      form.set('postId', postId); form.set('emoji', emoji);
      const r = await fetch(WEB_APP_BASE, {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body: form.toString()
      });
      const j = await r.json().catch(()=>null);
      if (!r.ok || !j || j.error) throw new Error(j?JSON.stringify(j):'react failed');
      EMOJIS.forEach(e=>{ if(typeof j.counts[e] !== 'number') j.counts[e]=0; });
      return j;
    };

    let attempt = 0, delay = 300;
    while (true){
      try { return await exec(); }
      catch(e){
        attempt++;
        if (attempt>2) throw e;
        await new Promise(rs=>setTimeout(rs, delay));
        delay *= 2;
      }
    }
  }

  function renderReactions(container, postId, data){
    container.innerHTML = '';
    EMOJIS.forEach(e=>{
      const b = document.createElement('button');
      b.className = 'chip' + (data.mine === e ? ' active' : '');
      b.textContent = `${e} ${data.counts[e]||0}`;
      b.addEventListener('click', ()=>{
        if (!guardSignedIn()) return;
        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ overlay (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î/‡∏•‡∏ö) ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏î
        if (isBusy) return;

        // disable chips ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏à‡∏ô‡∏à‡∏ö
        [...container.querySelectorAll('button')].forEach(x=>x.disabled=true);
        withReactQueue(postId, async ()=>{
          try {
            const updated = await sendReaction(postId, e);
            renderReactions(container, postId, updated);
          } catch(err){
            swalError('‡∏™‡πà‡∏á‡∏£‡∏µ‡πÅ‡∏≠‡∏Ñ‡∏ä‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            // ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö
            [...container.querySelectorAll('button')].forEach(x=>x.disabled=false);
          }
        });
      });
      container.appendChild(b);
    });
  }

  // ===== List / Render =====
  function renderSkeletons(n=6){
    const list = $('list'); list.innerHTML='';
    for(let i=0;i<n;i++){
      const sk = document.createElement('div'); sk.className='skeleton';
      const t = document.createElement('div'); t.className='sk-thumb';
      const r = document.createElement('div');
      const l1 = document.createElement('div'); l1.className='sk-line wide';
      const l2 = document.createElement('div'); l2.className='sk-line'; l2.style.width='70%';
      const l3 = document.createElement('div'); l3.className='sk-line'; l3.style.width='45%';
      r.appendChild(l1); r.appendChild(l2); r.appendChild(l3);
      sk.appendChild(t); sk.appendChild(r);
      list.appendChild(sk);
    }
    $('pageInfo').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
    $('prev').disabled = true; $('next').disabled = true;
  }

  async function loadList(){
    if (!idToken) { renderSkeletons(4); return; }
    if (listController) listController.abort();
    listController = new AbortController();

    const q = $('q').value.trim();
    const category = $('catFilter').value || '';
    const url = WEB_APP_BASE + '?' + qs({ action:'list', idToken, q, page, pageSize, category });

    renderSkeletons(6);
    try{
      const r = await fetch(url, { signal: listController.signal });
      const j = await r.json().catch(()=>null);
      if (!r.ok || !j || j.error) throw new Error(j?JSON.stringify(j):'LIST error');
      renderList(j);
    }catch(e){
      if (e.name === 'AbortError') return;
      swalError('‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }
  }

  function renderList(data){
    const list = $('list'); list.innerHTML='';
    (data.items || []).forEach(item=>{
      const card = document.createElement('div'); card.className='card';
      const img = document.createElement('img'); img.className='thumb';
      img.src = item.imageUrl ? item.imageUrl : (item.imageId ? ('https://lh3.googleusercontent.com/d/'+item.imageId) : '');
      img.alt='';

      const right = document.createElement('div');
      const h = document.createElement('div'); h.className='title'; h.textContent = item.title || '(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠)';
      const meta = document.createElement('div'); meta.className='meta';
      const owner = item.ownerEmail ? ` ‚Ä¢ ‡πÇ‡∏î‡∏¢ ${item.ownerEmail}` : '';
      const cat = item.category ? ` ‚Ä¢ ‡∏´‡∏°‡∏ß‡∏î ${item.category}` : '';
      meta.textContent = (item.createdAt ? new Date(item.createdAt).toLocaleString() : '') + owner + cat;
      const body = document.createElement('div');
      body.textContent = (item.body || '').slice(0, 180) + ((item.body||'').length>180?'...':'');

      const actions = document.createElement('div'); actions.className='actions';
      const reacts = document.createElement('div');
      // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏µ‡πÅ‡∏≠‡∏Ñ‡∏ä‡∏±‡∏ô‡πÅ‡∏ö‡∏ö‡πÅ‡∏¢‡∏Å ‡πÅ‡∏•‡∏∞ render
      (async()=>{
        try{
          const rx = await fetchReactions(item.id);
          renderReactions(reacts, item.id, rx);
        }catch(_){}
      })();
      actions.appendChild(reacts);

      if (me && item.ownerEmail && me.email === item.ownerEmail){
        const editBtn = document.createElement('button'); editBtn.className='btn-ghost'; editBtn.textContent='‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
        editBtn.addEventListener('click', ()=>openEdit(item));
        const delBtn = document.createElement('button'); delBtn.className='btn-danger'; delBtn.textContent='‡∏•‡∏ö';
        delBtn.addEventListener('click', ()=>doDelete(item.id));
        actions.appendChild(editBtn); actions.appendChild(delBtn);
      }

      right.appendChild(h); right.appendChild(meta); right.appendChild(body); right.appendChild(actions);
      card.appendChild(img); card.appendChild(right);
      list.appendChild(card);
    });

    $('pageInfo').textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${data.page} / ${data.totalPages} ‚Äì ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${data.total} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
    $('prev').disabled = data.page <= 1;
    $('next').disabled = data.page >= data.totalPages;
  }

  // Search & Pager
  $('btnSearch').addEventListener('click', ()=>{ page=1; loadList(); });
  $('q').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ page=1; loadList(); } });
  $('prev').addEventListener('click', ()=>{ if(page>1){ page--; loadList(); }});
  $('next').addEventListener('click', ()=>{ page++; loadList(); });

  // Dialog Add/Edit
  const dlgTitle = $('dlgTitle');
  $('btnAdd').addEventListener('click', openCreate);
  $('closeDlg').addEventListener('click', ()=> showDlg(false));

  function openCreate(){
    if (!guardSignedIn()) return;
    editingId = null;
    dlgTitle.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
    $('title').value = ''; $('body').value = ''; $('file').value = '';
    const catSel = $('postCategory'); if (catSel && catSel.options.length) catSel.selectedIndex = 0;
    showDlg(true);
  }
  function openEdit(item){
    editingId = item.id;
    dlgTitle.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏û‡∏™‡∏ï‡πå';
    $('title').value = item.title || ''; $('body').value = item.body || ''; $('file').value = '';
    const catSel = $('postCategory');
    if (catSel) {
      const ix = [...catSel.options].findIndex(o=>o.value===item.category);
      catSel.selectedIndex = ix>=0 ? ix : 0;
    }
    showDlg(true);
  }

  $('save').addEventListener('click', doSave);

  async function doSave(){
    if (!guardSignedIn()) return;
    if (isBusy) return;
    const title = $('title').value.trim();
    const body  = $('body').value.trim();
    const file  = $('file').files[0];
    const category = ($('postCategory')?.value || '').trim();
    if (!title) { Swal.fire({icon:'info', title:'‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞'}); return; }

    // ‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥ (‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥/‡∏Å‡∏î‡∏ã‡πâ‡∏≥)
    isBusy = true; showOverlay(true); $('saveSpin').style.display='inline-block';

    try{
      let imageData = '';
      if (file){
        const compressed = await compressImage(file, 1280);
        imageData = await fileToDataURL(compressed);
      }
      const form = new URLSearchParams();
      form.set('idToken', idToken);
      form.set('title', title);
      form.set('body', body);
      if (category) form.set('category', category);
      if (imageData) form.set('imageData', imageData);
      if (editingId) { form.set('action','update'); form.set('id', editingId); }
      else { form.set('action','create'); }

      const r = await fetch(WEB_APP_BASE, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: form.toString() });
      const j = await r.json().catch(()=>null);
      if (!r.ok || (j && j.error)) throw new Error(j?JSON.stringify(j):'save failed');

      showDlg(false);
      page = 1;
      await loadList();
      toast('success', editingId ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }catch(e){
      swalError('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }finally{
      isBusy = false; showOverlay(false); $('saveSpin').style.display='none';
    }
  }

  async function doDelete(id){
    if (!guardSignedIn()) return;
    const ret = await ask('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ô‡∏µ‡πâ?', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÅ‡∏≠‡∏Ñ‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏î‡πâ‡∏ß‡∏¢', 'warning');
    if (!ret.isConfirmed) return;
    if (isBusy) return;

    isBusy = true; showOverlay(true);
    try{
      const form = new URLSearchParams();
      form.set('action','delete'); form.set('idToken', idToken); form.set('id', id);
      const r = await fetch(WEB_APP_BASE, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: form.toString() });
      const j = await r.json().catch(()=>null);
      if (!r.ok || (j && j.error)) throw new Error(j?JSON.stringify(j):'delete failed');
      await loadList();
      toast('success','‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
    }catch(e){
      swalError('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }finally{
      isBusy = false; showOverlay(false);
    }
  }

  // ===== Image helpers =====
  function fileToDataURL(file){
    return new Promise((resolve,reject)=>{
      const fr = new FileReader();
      fr.onload = ()=>resolve(fr.result);
      fr.onerror = reject;
      fr.readAsDataURL(file);
    });
  }

  async function compressImage(file, maxSide=1280){
    // ‡∏¢‡πà‡∏≠‡∏£‡∏π‡∏õ‡∏î‡πâ‡∏ß‡∏¢ canvas (‡∏£‡∏±‡∏Å‡∏©‡∏≤ EXIF orientation ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÜ: ‡πÑ‡∏°‡πà‡∏´‡∏°‡∏∏‡∏ô)
    const img = await new Promise((res,rej)=>{
      const i = new Image();
      i.onload = ()=>res(i);
      i.onerror = rej;
      i.src = URL.createObjectURL(file);
    });
    const {width, height} = img;
    const scale = Math.min(1, maxSide / Math.max(width, height));
    if (scale === 1) return file;

    const canvas = document.createElement('canvas');
    canvas.width = Math.round(width * scale);
    canvas.height = Math.round(height * scale);
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    const blob = await new Promise(res=> canvas.toBlob(res, 'image/jpeg', 0.85));
    return new File([blob], file.name.replace(/\.\w+$/, '.jpg'), {type:'image/jpeg'});
  }

  // Bind basic actions
  $('btnSearch').addEventListener('click', ()=>{ page=1; loadList(); });
</script>
</body>
</html>
