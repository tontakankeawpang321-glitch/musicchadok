<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Concert Bass Drum - Deep Roar</title>
    <style>
        /* รีเซ็ตค่าพื้นฐาน */
        * {
            box-sizing: border-box;
            user-select: none; /* ป้องกันการเลือกข้อความเวลาตีรัวๆ */
            -webkit-tap-highlight-color: transparent; /* ปิดสีฟ้าเวลาแตะบนมือถือ */
        }

        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            background: #050505;
            background-image: radial-gradient(circle at center, #1f1f1f 0%, #000000 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden; /* ป้องกันการเลื่อนหน้าจอ */
            touch-action: none; /* ป้องกัน gesture ของ browser */
        }

        /* พื้นที่แสดงข้อความ */
        .info {
            color: #aaa;
            margin-bottom: 20px;
            text-align: center;
            pointer-events: none;
            z-index: 10;
        }
        .info h1 {
            margin: 0;
            font-size: 1.5rem;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .info p {
            margin: 5px 0 0;
            font-size: 0.9rem;
        }

        /* ตัวกลอง */
        .drum-container {
            position: relative;
            width: 300px;
            height: 300px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.05s ease;
            margin-bottom: 30px; /* เพิ่มระยะห่างสำหรับปุ่มอัดเสียง */
        }

        /* ขอบไม้/โลหะของกลอง */
        .drum-rim {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(145deg, #3e1e05, #1a0d02);
            box-shadow: 
                0 10px 50px rgba(0,0,0,1.0),
                inset 0 2px 5px rgba(255,255,255,0.1);
            z-index: 1;
            border: 2px solid #111;
        }

        /* น็อตยึดหน้ากลอง (ตกแต่ง) */
        .lug {
            position: absolute;
            width: 14px;
            height: 14px;
            background: radial-gradient(circle at 30% 30%, #ddd, #666);
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.8);
            z-index: 3;
        }

        /* หนังกลอง */
        .drum-head {
            position: absolute;
            width: 92%;
            height: 92%;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #f0f0f0, #d0d0d0 60%, #b0b0b0 100%);
            z-index: 2;
            box-shadow: inset 0 0 40px rgba(0,0,0,0.4);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* โลโก้กลางกลอง */
        .brand {
            font-size: 1.2rem;
            font-weight: bold;
            color: rgba(0,0,0,0.15);
            font-family: serif;
            letter-spacing: 2px;
            pointer-events: none;
            text-shadow: 0 1px 1px rgba(255,255,255,0.3);
        }

        /* เอฟเฟกต์ตอนตี */
        .drum-container:active, .drum-container.hit {
            transform: scale(0.95);
        }
        
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: scale(0);
            animation: ripple-anim 0.5s ease-out;
            pointer-events: none;
            z-index: 4;
        }

        @keyframes ripple-anim {
            to {
                transform: scale(3.0);
                opacity: 0;
            }
        }

        /* ส่วนควบคุมการบันทึกเสียง */
        .controls {
            z-index: 20;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .record-btn {
            background: #222;
            color: white;
            border: 1px solid #444;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            outline: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5);
        }

        .record-btn:hover {
            background: #333;
        }

        .record-btn .dot {
            width: 12px;
            height: 12px;
            background-color: #ff4444;
            border-radius: 50%;
            transition: all 0.3s;
        }

        /* สถานะกำลังบันทึก */
        .record-btn.recording {
            background: #a00;
            color: white;
            border-color: #f00;
            animation: pulse-red 2s infinite;
        }

        .record-btn.recording .dot {
            background-color: white;
            border-radius: 2px; /* เปลี่ยนเป็นสี่เหลี่ยม (Stop Icon) */
            transform: scale(0.9);
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(170, 0, 0, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(170, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(170, 0, 0, 0); }
        }

        .status-text {
            color: #ff4444;
            font-size: 0.9rem;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .status-text.visible {
            opacity: 1;
        }

        /* ปุ่มเริ่ม (สำหรับ Browser ที่บล็อกเสียงอัตโนมัติ) */
        #start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            flex-direction: column;
        }
        
        #start-btn {
            padding: 20px 50px;
            font-size: 1.3rem;
            background: linear-gradient(135deg, #d4a017, #b8860b);
            color: #000;
            border: none;
            border-radius: 40px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 0 25px rgba(212, 160, 23, 0.4);
            transition: transform 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #start-btn:active {
            transform: scale(0.95);
        }

        /* Responsive สำหรับมือถือ */
        @media (max-width: 600px) {
            .drum-container {
                width: 85vw;
                height: 85vw;
                max-width: 350px;
                max-height: 350px;
            }
        }
    </style>
</head>
<body>

    <div class="info">
        <h1>Concert Bass Drum (Deep Roar)</h1>
        <p>ตีรัวๆ เพื่อสะสมพลังเสียงให้กระหึ่ม</p>
    </div>

    <div id="drum" class="drum-container">
        <div class="drum-rim"></div>
        <div class="drum-head">
            <div class="brand">FORTISSIMO</div>
        </div>
    </div>

    <div class="controls">
        <button id="recordBtn" class="record-btn">
            <div class="dot"></div>
            <span id="recordText">บันทึกเสียง</span>
        </button>
        <div id="statusText" class="status-text">● กำลังบันทึก...</div>
    </div>

    <div id="start-overlay">
        <button id="start-btn">แตะเพื่อเริ่มใช้งาน</button>
        <p style="color: #ccc; margin-top: 15px; font-size: 0.9rem;">(จำเป็นต้องเปิดระบบเสียง)</p>
    </div>

    <script>
        // --- Audio Context & Recording Setup ---
        let audioCtx;
        let masterBus; // Main mixing bus
        let compressor;
        let convolver; // สำหรับ Reverb
        let reverbGain; // ปรับความดัง Reverb
        let mediaDest;  
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        // ฟังก์ชันสร้าง Impulse Response (Hall Reverb) - ขยายให้กว้างและยาวขึ้น
        function createHallReverbBuffer(context) {
            const duration = 4.5; // ยาวขึ้นเพื่อให้เสียงสะสมกัน (Wall of sound)
            const rate = context.sampleRate;
            const length = rate * duration;
            const buffer = context.createBuffer(2, length, rate);
            const left = buffer.getChannelData(0);
            const right = buffer.getChannelData(1);

            for (let i = 0; i < length; i++) {
                const t = i / rate;
                // Decay ช้าลง เพื่อให้เสียงอื้ออึงนานขึ้น
                const decay = Math.pow(1 - (i / length), 1.5); 
                
                left[i] = (Math.random() * 2 - 1) * decay;
                right[i] = (Math.random() * 2 - 1) * decay;
            }
            return buffer;
        }

        // Concert Bass Drum Sound Synthesis (Deep & Building Up)
        function playBassDrum(velocity = 1.0) {
            if (!audioCtx) return;

            const t = audioCtx.currentTime;
            
            // Mix Bus สำหรับเสียงนี้
            const sourceBus = audioCtx.createGain();
            sourceBus.gain.value = 1.0;
            sourceBus.connect(masterBus);
            sourceBus.connect(reverbGain);

            // --- LAYER 1: Fundamental (Deep Thud - ทุ้มลึก) ---
            const fundOsc = audioCtx.createOscillator();
            const fundGain = audioCtx.createGain();
            fundOsc.type = 'sine';
            // ปรับ Pitch ให้ต่ำลงอีก (80Hz -> 30Hz) เพื่อความทุ้ม
            fundOsc.frequency.setValueAtTime(80, t); 
            fundOsc.frequency.exponentialRampToValueAtTime(30, t + 0.2); 
            
            fundGain.gain.setValueAtTime(0, t);
            fundGain.gain.linearRampToValueAtTime(1.0 * velocity, t + 0.01);
            // ลากหางยาวขึ้น (3.5 วินาที) เพื่อให้ตีรัวๆ แล้วเสียงสะสมกัน
            fundGain.gain.exponentialRampToValueAtTime(0.01, t + 3.5);
            
            fundOsc.connect(fundGain);
            fundGain.connect(sourceBus);
            fundOsc.start(t);
            fundOsc.stop(t + 4.0);

            // --- LAYER 2: Sub-Low (Earthquake - เบสเดินพื้น) ---
            const subOsc = audioCtx.createOscillator();
            const subGain = audioCtx.createGain();
            subOsc.type = 'sine';
            subOsc.frequency.value = 25; // ต่ำมาก จนรู้สึกสั่นมากกว่าได้ยิน
            
            subGain.gain.setValueAtTime(0, t);
            subGain.gain.linearRampToValueAtTime(1.0 * velocity, t + 0.1); // เข้าช้ากว่านิดนึง
            // หางยาวมาก (5.0 วินาที) นี่คือหัวใจของ "ดังขึ้นเรื่อยๆ"
            subGain.gain.exponentialRampToValueAtTime(0.01, t + 5.0); 
            
            subOsc.connect(subGain);
            subGain.connect(sourceBus);
            subOsc.start(t);
            subOsc.stop(t + 5.5);

            // --- LAYER 3: Harmonics (Resonance - ความกังวาล) ---
            const harm1Osc = audioCtx.createOscillator();
            const harm1Gain = audioCtx.createGain();
            harm1Osc.type = 'sine';
            harm1Osc.frequency.setValueAtTime(120, t); 
            harm1Osc.frequency.exponentialRampToValueAtTime(70, t + 0.3); 
            
            harm1Gain.gain.setValueAtTime(0, t);
            harm1Gain.gain.linearRampToValueAtTime(0.3 * velocity, t + 0.02);
            harm1Gain.gain.exponentialRampToValueAtTime(0.01, t + 2.0);
            
            harm1Osc.connect(harm1Gain);
            harm1Gain.connect(sourceBus);
            harm1Osc.start(t);
            harm1Osc.stop(t + 2.5);

            // --- LAYER 4: Impact Noise (Attack - หัวไม้กระทบ) ---
            // ปรับให้มีความคมแต่ทุ้ม (Thuddy Attack)
            const bufferSize = audioCtx.sampleRate * 0.1;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                data[i] = (Math.random() * 2 - 1);
            }

            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;
            
            const noiseFilter = audioCtx.createBiquadFilter();
            noiseFilter.type = 'lowpass';
            noiseFilter.frequency.setValueAtTime(800, t); // ต่ำลงเพื่อให้หัวเสียงนุ่มและทุ้ม
            noiseFilter.frequency.exponentialRampToValueAtTime(100, t + 0.1);

            const noiseGain = audioCtx.createGain();
            noiseGain.gain.setValueAtTime(1.2 * velocity, t);
            noiseGain.gain.exponentialRampToValueAtTime(0.01, t + 0.08);

            noise.connect(noiseFilter);
            noiseFilter.connect(noiseGain);
            noiseGain.connect(sourceBus);
            noise.start(t);

            // Cleanup Gain Node
            setTimeout(() => {
                sourceBus.disconnect();
            }, 6000);
        }

        // --- Interaction & Recording Logic ---
        const drum = document.getElementById('drum');
        const startOverlay = document.getElementById('start-overlay');
        const startBtn = document.getElementById('start-btn');
        const recordBtn = document.getElementById('recordBtn');
        const recordText = document.getElementById('recordText');
        const statusText = document.getElementById('statusText');

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                
                // 1. Master Compressor (ปรับให้รองรับเสียงที่สะสมกัน)
                compressor = audioCtx.createDynamicsCompressor();
                compressor.threshold.value = -15; // เริ่มกดเมื่อเสียงดังระดับกลาง
                compressor.knee.value = 20; // Smooth
                compressor.ratio.value = 6; // ไม่บีบแรงเกินไป ปล่อยให้เสียง Boom ได้
                compressor.attack.value = 0.05; // ช้าลงเพื่อให้หัวเสียงผ่าน
                compressor.release.value = 0.3;

                // 2. Reverb System
                convolver = audioCtx.createConvolver();
                convolver.buffer = createHallReverbBuffer(audioCtx);
                reverbGain = audioCtx.createGain();
                reverbGain.gain.value = 1.3; // เพิ่ม Reverb ให้กังวาล
                reverbGain.connect(convolver);
                convolver.connect(compressor); 

                // 3. Main Mix Bus
                masterBus = audioCtx.createGain();
                masterBus.gain.value = 1.0; 
                masterBus.connect(compressor); 

                // 4. Output
                compressor.connect(audioCtx.destination);

                // 5. Recorder
                mediaDest = audioCtx.createMediaStreamDestination();
                compressor.connect(mediaDest); 
            }

            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            startOverlay.style.opacity = '0';
            setTimeout(() => {
                startOverlay.style.display = 'none';
            }, 300);
        }

        function toggleRecording() {
            if (!audioCtx) initAudio();

            if (!isRecording) {
                audioChunks = [];
                try {
                    mediaRecorder = new MediaRecorder(mediaDest.stream);
                } catch (err) {
                    alert("Browser ของคุณไม่รองรับการบันทึกเสียงนี้");
                    return;
                }

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks, { type: 'audio/webm' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    a.download = `ConcertDrum_DeepRoar_${timestamp}.webm`;
                    
                    document.body.appendChild(a);
                    a.click();
                    
                    setTimeout(() => {
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                    }, 100);
                };

                mediaRecorder.start();
                isRecording = true;
                
                recordBtn.classList.add('recording');
                recordText.textContent = "หยุดและบันทึก";
                statusText.classList.add('visible');

            } else {
                mediaRecorder.stop();
                isRecording = false;

                recordBtn.classList.remove('recording');
                recordText.textContent = "บันทึกเสียง";
                statusText.classList.remove('visible');
            }
        }

        // --- Visuals ---
        function createLugs() {
            const rim = document.querySelector('.drum-rim');
            const totalLugs = 12;
            
            for(let i=0; i<totalLugs; i++) {
                const lug = document.createElement('div');
                lug.className = 'lug';
                const angle = (i / totalLugs) * 2 * Math.PI;
                const x = 50 + 46.5 * Math.cos(angle); 
                const y = 50 + 46.5 * Math.sin(angle);
                
                lug.style.left = `calc(${x}% - 7px)`;
                lug.style.top = `calc(${y}% - 7px)`;
                lug.style.transform = `rotate(${angle * 180 / Math.PI}deg)`;
                
                rim.appendChild(lug);
            }
        }

        function createRipple(e) {
            const circle = document.createElement('div');
            circle.classList.add('ripple');
            const rect = drum.getBoundingClientRect();
            let x, y;
            
            if (e.touches && e.touches.length > 0) {
                 x = e.touches[0].clientX - rect.left;
                 y = e.touches[0].clientY - rect.top;
            } else {
                 x = e.clientX - rect.left;
                 y = e.clientY - rect.top;
            }
            
            if (x === undefined || isNaN(x)) {
                x = rect.width / 2;
                y = rect.height / 2;
            }

            const size = 60;
            circle.style.width = circle.style.height = `${size}px`;
            circle.style.left = `${x - size/2}px`;
            circle.style.top = `${y - size/2}px`;
            
            drum.querySelector('.drum-head').appendChild(circle); 
            setTimeout(() => circle.remove(), 400);
        }

        function hitDrum(e) {
            if (e.type === 'touchstart') e.preventDefault(); 
            playBassDrum();
            createRipple(e);
            drum.classList.add('hit');
            setTimeout(() => drum.classList.remove('hit'), 50);
        }

        // Event Listeners
        startBtn.addEventListener('click', initAudio);
        recordBtn.addEventListener('click', toggleRecording);
        
        drum.addEventListener('touchstart', (e) => {
            initAudio(); 
            hitDrum(e);
        }, { passive: false });

        drum.addEventListener('mousedown', hitDrum);

        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' || e.key === ' ') {
                initAudio();
                hitDrum({});
            }
        });

        createLugs();

    </script>
</body>
</html>

